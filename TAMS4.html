<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Trojan Asset Management</title>
<link rel="icon" type="image/x-icon" href="TRWeb.png">

<!-- projects -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase -->
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script type="text/javascript">
   (function(){
      emailjs.init("DykK94msC_KvQNpl2"); // Replace with your key
   })();
</script>


<style>
  :root{
    --brand:#1e3a8a; --brand-2:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --info:#0ea5e9;
    --bg:#f4f6f9; --card:#ffffff; --text:#0f172a; --muted:#64748b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  
  /* Light blue gradient transition from top to bottom */
  background: linear-gradient(180deg, #e0f2fe 0%, #f1f5f9 100%);
  
  /* This ensures the background stays smooth even when scrolling */
  background-attachment: fixed;
  
  color: var(--text);
}
.dashboard-cards {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.dashboard-cards .card {
  background: #f8fafc;
  border: 1px solid #cbd5e1;
  border-radius: 10px;
  flex: 1 1 200px;
  padding: 16px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}
.dashboard-cards .card h3 {
  font-size: 16px;
  margin-bottom: 8px;
  color: #334155;
}
.dashboard-cards .card p {
  font-size: 20px;
  font-weight: bold;
  color: #1e293b;
}
/* Base card hover effect */
.dashboard-cards .card {
  transition: transform 0.3s, box-shadow 0.3s;
}
/* Pulse animation keyframes */
@keyframes pulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.03); }
  100% { transform: scale(1); }
}

/* Apply on hover */
.dashboard-cards .card:hover {
  animation: pulse 1.2s ease-in-out infinite;
  box-shadow: 0 12px 28px rgba(0,0,0,0.18);
}

/* Light gradient backgrounds */
.card.drivers {
  background: linear-gradient(135deg, #93c5fd, #60a5fa); /* light blue */
  color: #0f172a;
}
.card.operators {
  background: linear-gradient(135deg, #86efac, #34d399); /* light green */
  color: #064e3b;
}
.card.leave {
  background: linear-gradient(135deg, #fde68a, #fbbf24); /* light orange */
  color: #78350f;
}
.card.resigned {
  background: linear-gradient(135deg, #fecaca, #f87171); /* light red */
  color: #7f1d1d;
}

/* Modal Overlay Background */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none; /* Hidden by default */
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

/* Modal Content Box */
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 800px;
  position: relative;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

  /* Login */
  .login-wrap {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: url('background2.jpg') no-repeat center center;
  background-size: cover;
  overflow: hidden;
}

/* Overlay */
.login-wrap::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.5); /* dark overlay */
  z-index: 0;
}

/* Make sure login card stays above overlay */
.login-card {
  position: relative;
  z-index: 1;
}

/* Login Card with Glassmorphism */
.login-card {
  width: 360px;
  padding: 22px;
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.15);   /* semi-transparent white */
  backdrop-filter: blur(12px);             /* glass blur effect */
  -webkit-backdrop-filter: blur(12px);     /* Safari support */
  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  color: #f1f5f9;                          /* light text */
  text-align: center;
}

  .login-card h1{margin:0 0 6px;font-size:20px}
.login-card input {
  width: 100%;
  padding: 12px 14px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
}

.login-btn {
  margin-top: 14px;
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 10px;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
.login-btn:hover {
  transform: scale(1.05);
}
  .login-hint{font-size:12px;color:#94a3b8;margin-top:10px}
.login-logo {
  width: 250px;          /* size of logo */
  height: auto;
  margin-bottom: 15px;
  border-radius: 12px;  /* optional rounded corners */
}

  /* Layout */
  .app {
  display: flex; 
  flex-direction: column; /* Stack top bar above content */
  min-height: 20vh;
}
/* Sidebar (Top Bar) Update */
/* --- SIDEBAR (TOP BAR) --- */
.sidebar {
  width: 100%;
  height: 60px; 
  background: #0A2A6A;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  position: sticky;
  top: 0;
  display: flex;
  flex-direction: row;
  align-items: center; /* Vertically center the brand and nav */
  justify-content:  flex-start;
  z-index: 1000;
  padding: 0 40px; /* Reduced padding for more link space */
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}


.sidebar-footer {
  margin-left: auto; /* THIS IS KEY */
  margin-top: 0;
  padding-top: 0;
  border-top: none;
  display: flex;
  flex-direction: row; /* Align items side by side */
  align-items: center;
  padding-right: 20px;
}

.user-bar {
  flex-direction: row; /* Name and Logout side by side */
  gap: 15px;
  margin-bottom: 0;
}

#userLabel {
  color: #ffffff !important;
  font-size: 0.9rem;
  font-weight: 500;
  opacity: 1;	
margin-bottom: 5px;
}

/* Professional Signature */
.owner-claim {
  margin-top: 15px;
  font-size: 10px;
  color: rgba(255, 255, 255, 0.4);
  line-height: 1.3;
}

/* Adjust button sizes for sidebar fit */
.sidebar .btn {
  padding: 6px 15px;
  font-size: 12px;
  width: fit-content; /* Prevents buttons from taking full width */
}
/* --- NAVIGATION MENU --- */
.nav {
  display: flex;           
  flex-direction: row;
  margin-left: 50px; /* Space between logo and first link */
  height: 70px;      /* Explicit height to match sidebar */
  align-items: center;
}

.nav a {
  text-decoration: none !important;
  color: rgba(255, 255, 255, 1);
  display: flex !important;   /* Force flex */
  align-items: center !important;
  justify-content: center;
  height: 100%;             
  padding: 0 10px;
  font-size: 16px;            /* Slightly smaller to fit many links */
  font-weight: 400;
 // transition: all 0.3s ease;
  position: relative;
  white-space: nowrap;        /* Prevent text from breaking into 2 lines */
}
.nav a.active {
  color: #ffffff !important;
  /* CHANGE 2: Make it BOLD only when active */
  font-weight: 800; 
  background: rgba(255, 255, 255, 0.1);
}
/* --- ACTIVE LINK INDICATOR --- */
.nav a.active::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 10%;
  width: 80%;
  height: 2px;
  background: #60a5fa;
  border-radius: 4px 4px 0 0;
  box-shadow: 0 -2px 10px rgba(96, 165, 250, 0.5);
}
/* --- MAIN CONTENT TRANSITION --- */
.content {
  padding: 40px 60px;
  animation: slideUp 0.6s ease-out;
  margin-left: 0;
  flex: 1;
  color: #1e293b;
  font-weight: 400; /* Change from 600 to 400 (Normal) */
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Specifically target table data to make it stand out */
td {
  color: #0f172a;
  font-weight: 400; /* Change from 700 to 400 (Normal) */
}
/* Target Labels to make them look professional */
label {
  display: block;
  margin-bottom: 5px;
  color: var(--brand); /* Uses your blue brand color */
  font-weight: 800; /* Extra bold for headers/labels */
  font-size: 13px;
  text-transform: uppercase;
}
input, select, textarea {
  color: #1e293b !important;
  font-weight: 400 !important;
  border: 1.5px solid #cbd5e1; /* Thicker border to match the bold text */
}

/* Makes placeholder text slightly lighter but still visible */
input::placeholder {
  font-weight: 400;
  color: #94a3b8;
}
  .footer{position:fixed;right:12px;bottom:8px;font-size:12px;color:#475569}
  /*.user-info{position:absolute;top:10px;right:20px;font-size:14px;font-weight:600;color:#1e293b}*/
.user-bar {
  display: flex;
  align-items: center;
  gap: 15px;           /* space between username & button */
  margin-bottom: 10px; /* space below, before Dashboard */
}
.user-bar #userLabel {
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
}

  /* Cards / Grid */
  .grid{display:grid;gap:16px}
  .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:1100px){.grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:700px){.grid-4,.grid-2{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,.06);padding:16px}
  .kpi{display:flex;justify-content:space-between;align-items:center}
  .kpi .big{font-size:30px;font-weight:800}
  .kpi small{color:var(--muted)}
  .kpi .badge{padding:6px 10px;border-radius:999px;font-size:12px}
  .b-ok{background:rgba(22,163,74,.12);color:var(--ok)}
  .b-warn{background:rgba(245,158,11,.12);color:var(--warn)}
  .b-bad{background:rgba(239,68,68,.12);color:var(--bad)}
  .b-info{background:rgba(14,165,233,.12);color:var(--info)}

  /* Toolbar */
  .toolbar {
  display: flex;
  justify-content: space-between; /* Pushes groups apart */
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}
.toolbar-left, .toolbar-right {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}
.toolbar-right .btn {
  height: 42px;
  display: flex;
  align-items: center;
  justify-content: center;
}
.date-range-group {
    display: flex;
    align-items: center;
    gap: 5px;
    background: #fff;
    padding: 5px;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
}
.spacer {
  margin-right: auto;
}
  .toolbar input,.toolbar select{padding:10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:var(--brand-2);color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#0ea5e9}
  .btn.warn{background:#ef4444}

  /* Table */
  .table-wrap{overflow:auto;background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,.06)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:center}
  thead th{position:sticky;top:0;background:#eff6ff;font-weight:700}

  /* Pagination */
  .pagination{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:10px}
  .page-btn{padding:8px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
  .page-btn[disabled]{opacity:.5;cursor:not-allowed}
  .page-size{margin-left:auto}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
  .modal .dialog{background:#fff;border-radius:14px;max-width:720px;width:95%;padding:16px}
  .dialog h3{margin-top:0}
  .dialog .grid-2{gap:10px}
  .dialog input,.dialog select{width:100%;padding:10px;border-radius:10px;border:1px solid #cbd5e1}
  .dialog .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

 
@media print {
  body * {
    visibility: hidden; /* hide everything */
  }
}
 .search-dd {
  position: relative;
  width: 100%;
}

.search-dd .selected {
  padding: 10px;
  border: 1.5px solid #cbd5e1;
  border-radius: 10px;
  background: #fff;
  cursor: pointer;
}

.search-dd .panel {
  position: absolute;
  top: 110%;
  width: 100%;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  z-index: 5000;
  display: none;
}

.search-dd input {
  width: 100%;
  padding: 8px 10px;
  border: none;
  border-bottom: 1px solid #e2e8f0;
  outline: none;
}

.search-dd .list {
  max-height: 220px;
  overflow-y: auto;
}

.search-dd .item {
  padding: 8px 10px;
  cursor: pointer;
}

.search-dd .item:hover {
  background: #eff6ff;
}
/* Styling the Date/Time inputs to look like your text inputs */
input[type="text"], 
input[type="date"], 
input[type="datetime-local"] {
  height: 42px;
  padding: 8px 12px;
  border: 1.5px solid #cbd5e1;
  border-radius: 10px;
  font-size: 14px;
  width: 100%;
  box-sizing: border-box;
}

/* Ensures the calendar icon inside the native picker stays on the right */
input::-webkit-calendar-picker-indicator {
  cursor: pointer;
  filter: invert(0.5); /* Makes the icon subtle */
}

input:focus {
    border-color: #3b82f6 !important;
    outline: none;
    background-color: #f0f7ff;
}
/* Increase width of the Asset Modal Card */
#assetModal .modal-content {
    max-width: 1000px; /* Increased from default (usually 500px-600px) */
    width: 95%;      /* Responsive for smaller screens */
    padding: 10px;   /* Added padding for a cleaner look */
}

/* Optional: Adjust grid gap for better spacing with the new width */
#assetModal .grid-4 {
    gap: 10px;
    grid-template-columns: repeat(4, 1fr);
}

/* --- UNDERTAKING FORM STYLES --- */
.undertaking-paper {
  background: white;
  width: 210mm; /* A4 Width */
  min-height: 297mm;
  padding: 10mm;
  margin: 0 auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  color: #000;
  font-family: 'Times New Roman', serif;
}
.ut-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
.ut-header h2, .ut-header h3 { margin: 2px 0; text-transform: uppercase; }
.ut-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.ut-box { border: 1px solid #000; padding: 5px; }
.ut-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dotted #ccc; }
.ut-label { font-weight: bold; font-size: 12px; }
.ut-val { font-weight: normal; font-size: 13px; }
.checklist-grid { display: grid; grid-template-columns: 1fr 1fr; border: 1px solid #000; margin-top: 10px; }
.cl-header { font-weight: bold; border-bottom: 1px solid #000; padding: 5px; background: #eee; text-align: center; }
.cl-item { border-bottom: 1px solid #ccc; padding: 2px 5px; font-size: 11px; display: flex; justify-content: space-between; }
.ut-section-title { background: #000; color: #fff; padding: 2px 5px; font-weight: bold; margin-top: 10px; font-size: 12px; }
.ut-footer-row { display: flex; justify-content: space-between; margin-top: 30px; }
.ut-sig-box { width: 45%; border-top: 1px solid #000; padding-top: 5px; text-align: center; }

@media print {
  @page { size: A4; margin: 0; }
  body * { visibility: hidden; }
  #undertaking, #undertaking * { visibility: visible; }
  #undertaking { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
  .undertaking-paper { box-shadow: none;-webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important; width: 100%; margin: 0; padding: 10mm; }
  .no-print { display: none !important; }
}
/* --- Editable Text Areas for Print --- */
.writable-input {
  width: 100%;
  border: 1px dashed #ccc; /* Dashed border on screen to show where to type */
  background: rgba(255, 255, 255, 0.5);
  font-family: 'Times New Roman', serif; /* Match form font */
  font-size: 12px;
  resize: none; /* Disable resizing */
  outline: none;
  padding: 5px;
  box-sizing: border-box;
  overflow: hidden;
}

@media print {
  .writable-input {
    border: none; /* Hide the dashed border when printing */
    background: transparent;
    padding: 0;
  }
  /* Ensure placeholders don't print (browsers usually hide them, but just in case) */
  .writable-input::placeholder {
    color: transparent;
  }
}
/* Apply uniform sizing ONLY to the Asset Modal fields */
#assetModal input, 
#assetModal select, 
#assetModal textarea, 
#assetModal .search-dd .selected {
  width: 100% !important;
  height: 40px !important; /* Forces all boxes to the same height */
  padding: 8px 12px !important;
  font-size: 14px !important;
  border: 1px solid #cbd5e1 !important;
  border-radius: 6px !important;
  box-sizing: border-box !important;
  display: flex !important;
  align-items: center !important;
  background-color: white;
}

/* Specific handling for the remarks box so it starts at the same height */
#assetModal textarea {
  min-height: 40px;
  max-height: 120px; /* Allows it to grow if they type a lot */
  resize: vertical;
  line-height: 1.4;
}

/* Ensures labels don't push the boxes out of alignment */
#assetModal label {
  display: block;
  margin-bottom: 4px;
  font-size: 11px;
  font-weight: 700;
  color: #475569;
  text-transform: uppercase;
}

/* Special alignment for the search dropdown text to match standard inputs */
#assetModal .search-dd .selected {
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Update the Log Modal to be wider for tables */
#logsModal .dialog {
  max-width: 1100px; /* Increased from default */
  width: 95%;
}

/* Scrollable table within logs */
#logsTimeline {
  max-height: 60vh;
  overflow: auto;
}

#logsTimeline table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

#logsTimeline th, #logsTimeline td {
  border: 1px solid #e2e8f0;
  padding: 8px;
  text-align: left;
}

#logsTimeline th {
  background: #eff6ff;
  position: sticky;
  top: 0;
}
/* Watermark Styling */
.undertaking-paper {
  position: relative;
  background-color: #white;
}

.undertaking-paper::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  /* Replace 'NPClogo.png' with your watermark file */
  background-image: url('NPClogo.png'); 
  background-repeat: no-repeat;
  background-position: center center;
  background-size: 720px; /* Adjust size of watermark here */
  opacity: 0.12; /* Controls how faint the watermark is (0.1 is 10%) */
  pointer-events: none; /* Ensures you can still click/select text */
  z-index: 0;
}

/* Ensure the content stays above the watermark */
.ut-header, .ut-body, .ut-footer, table {
  position: relative;
  z-index: 1;
}
/* --- NEW: Dropdown Menu in Sidebar --- */
.nav-item { position: relative; display: flex; align-items: center; height: 100%; }
.dropdown-content {
  display: none;
  position: absolute;
  top: 60px; /* Below the navbar */
  left: 0;
  background-color: #0A2A6A; /* Match Sidebar */
  min-width: 220px;
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  z-index: 2000;
  border-radius: 0 0 8px 8px;
}
.dropdown-content a {
  color: white;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  font-size: 14px;
  text-align: left;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.dropdown-content a:hover { background-color: rgba(255,255,255,0.1); }
.nav-item:hover .dropdown-content { display: block; }

/* --- NEW: Compact Dashboard Layout (Fit Screen) --- */
.dash-container {
  height: calc(100vh - 140px); /* Adjust based on header/padding */
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow: hidden; /* Prevent scrolling */
}

/* Summary Cards Row (Top) */
.summary-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  height: 15%; /* Takes top 15% of screen */
  min-height: 90px;
}
.kpi-card {
  background: white; border-radius: 8px; padding: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  display: flex; flex-direction: column; justify-content: center;
  position: relative; overflow: hidden;
}
.kpi-title { font-size: 14px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
.kpi-value { font-size: 24px; font-weight: 800; color: #0f172a; }
.kpi-sub   { font-size: 14px; color: #0f172a; margin-top: 4px; }

/* status colors bars on left of card */
.kpi-card.c-blue { border-left: 4px solid #3b82f6; }
.kpi-card.c-green { border-left: 4px solid #22c55e; }
.kpi-card.c-orange { border-left: 4px solid #f59e0b; }
.kpi-card.c-red { border-left: 4px solid #ef4444; }

/* Charts Grid (Bottom) */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(2, 1fr);
  gap: 10px;
  height: 85%; /* Takes remaining height */
}
.chart-box {
  background: white; border-radius: 8px; padding: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  position: relative;
  display: flex; flex-direction: column;
}
.chart-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
.chart-title { font-size: 13px; font-weight: 700; color: #334155; }
.expand-btn { background: none; border: none; cursor: pointer; font-size: 14px; }

.chart-container { flex: 1; position: relative; width: 100%; height: 100%; }

/* Modal for Expanded Chart */
#chartModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
#chartModalContent { background: white; width: 90%; height: 80%; padding: 20px; border-radius: 12px; display: flex; flex-direction: column; }
.password-container {
  position: relative;
  width: 100%;
}
.toggle-password {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%); /* Center vertically relative to input, not container */
  cursor: pointer;
  font-size: 18px;
  color: #cbd5e1;
  user-select: none;
  margin-top: 5px; /* Slight adjustment based on your input margin */
}
.toggle-password:hover { color: #fff; }
/* Multi-Select Styles */
.multi-select {
  position: relative;
  width: 100%;
}
.select-box {
  border: 1.5px solid #cbd5e1;
  border-radius: 10px;
  padding: 10px;
  background: white;
  display: flex;
  justify-content: space-between;
  cursor: pointer;
  font-size: 14px;
}
.options-container {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  background: white;
  border: 1px solid #cbd5e1;
  border-radius: 8px;
  max-height: 200px;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.options-container.active {
  display: block;
}
.options-container .option {
  display: block;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 13px;
  border-bottom: 1px solid #f1f5f9;
}
.options-container .option:hover {
  background: #f8fafc;
}
.options-container input {
  margin-right: 10px;
  width: auto !important; /* Override global input width */
  height: auto !important;
}

</style>
</head>


<!-- Loader Overlay -->
<div id="loaderOverlay" style="
  display:flex;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  z-index:9999;
   align-items:center;
  justify-content:center;
">
  <div style="text-align:center;color:#fff;font-size:18px;">
    <div class="spinner"></div>
    <p>Please wait...</p>
  </div>
</div>



<body>

<!-- LOGIN -->
<div id="loginWrap" class="login-wrap">
<div class="login-card">
  <img src="TAMS_logo1.png" alt="Trojan Contracting" class="login-logo" />
  <input id="u" placeholder="Username" />
  <div class="password-container">
    <input id="p" placeholder="Password" type="password" />
    <span id="togglePassword" class="toggle-password" onclick="togglePass()">üëÅÔ∏è</span>
  </div>
  <button id="loginBtn" class="login-btn">Login</button>
  <div class="login-hint"></div>
</div>
</div>


<div class="app" id="app" style="display:none">
  <!-- SIDEBAR -->
<aside class="sidebar">
  <div class="brand">
    <img src="TAMS_logo1.png" style="height:65px; vertical-align:middle; margin-right:15px;">
  </div>

  <nav class="nav">
    <a href="#" id="nav-dashboard" class="active" onclick="nav('dashboard')">Dashboard</a>
    <a href="#" id="nav-assets" onclick="nav('assets')">Asset Management</a>
    <a href="#" id="nav-list" onclick="nav('list')">Drivers/Operators List</a>
<a href="#" id="nav-al6m" onclick="nav('al6m')">Drivers/Operators Overstay</a>
    <div class="nav-item">
      <a href="#" id="nav-reports" onclick="void(0)">Reports ‚ñæ</a>
      <div class="dropdown-content">
<a href="#" onclick="nav('reportActivity')">1. Activity & Custom Reports</a>
        <a href="#" onclick="nav('reportRegExp')">2. Registration Expiry</a>
        <a href="#" onclick="nav('reportRegRenewal')">3. Registration Renewal</a> 
<a href="#" onclick="nav('')">4. License Expiry (Featuring Soon)</a> 
</div>
    </div>
  <a href="#" id="nav-undertaking" onclick="nav('undertaking')">Undertaking</a>
  <a href="#" id="nav-projectsSection" onclick="nav('projectsSection')">Projects</a>
  <a href="#" id="nav-users" onclick="nav('users')">Manage Users</a>
<a href="#" id="nav-alerts" data-hide-for="Admin,Viewer" onclick="nav('alertsSection')">Alerts</a>
<a href="#" id="nav-alertsConfig" data-hide-for="Admin,Viewer" onclick="nav('alertsConfigSection')">Alert Config</a>
    </nav>

  <div class="sidebar-footer">
    <div id="userBar" class="user-bar">
      <span id="userLabel"></span>
      <button id="logoutBtn" class="btn warn" onclick="doLogout()">Logout</button>
    </div>
  </div>
</aside>

  <!-- MAIN -->
  <main class="content">
  

<button class="btn secondary" onclick="hardRefresh()">üîÑ Refresh Now</button>


<!-- DASHBOARD -->
<section id="dashboard" class="section">
  <div class="dash-container">
    
    <div class="summary-row">
      <div class="kpi-card c-blue">
        <div class="kpi-title">Assets Status</div>
        <div class="kpi-value" id="kpi_asset_total">0</div>
        <div class="kpi-sub" id="kpi_asset_sub">Op: 0 | Idle: 0</div>
      </div>
      <div class="kpi-card c-green">
        <div class="kpi-title">Operator/Driver Status</div>
        <div class="kpi-value" id="kpi_driver_total">0</div>
        <div class="kpi-sub" id="kpi_driver_sub">Active: 0 | Leave: 0</div>
      </div>
      <div class="kpi-card c-orange">
        <div class="kpi-title">Registration Status</div>
        <div class="kpi-value" id="kpi_reg_total">0</div>
        <div class="kpi-sub" id="kpi_reg_sub">Valid: 0 | Exp: 0</div>
      </div>
      <div class="kpi-card c-red">
        <div class="kpi-title">License Status (Drivers)</div>
        <div class="kpi-value" id="kpi_lic_total">N/A</div>
        <div class="kpi-sub" id="kpi_lic_sub">Feature coming soon</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Project-wise Assets</span> <button class="expand-btn" onclick="expandChart('projectAssetChart')">‚§¢</button></div>
        <div class="chart-container"><canvas id="projectAssetChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Asset Status</span></div>
        <div class="chart-container"><canvas id="assetStatusChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Operator/Driver Status</span></div>
        <div class="chart-container"><canvas id="opStatusChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Asset Category</span></div>
        <div class="chart-container"><canvas id="assetCatChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Projects Status</span></div>
        <div class="chart-container"><canvas id="projStatusChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Project Division</span></div>
        <div class="chart-container"><canvas id="projDivChart"></canvas></div>
      </div>
    </div>
  </div>
</section>

<div id="chartModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:5000; align-items:center; justify-content:center;">
  <div style="background:white; width:90%; height:80%; padding:20px; border-radius:12px; display:flex; flex-direction:column;">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h3 id="expandedChartTitle">Detailed View</h3>
      <button class="btn warn" onclick="document.getElementById('chartModal').style.display='none'">Close</button>
    </div>
    <div style="flex:1; position:relative;">
      <canvas id="expandedCanvas"></canvas>
    </div>
  </div>
</div>

    <!-- Asset Management -->

<section id="assets" class="section" style="display:none">
  <h2>Asset Management</h2>
  
  <div class="toolbar card">
<div class="toolbar-left">
   <input id="assetSearch" placeholder="Search Plate, Asset No..." oninput="debouncedAssetSearch()" />
    <select id="fAssetCat" onchange="applyAssetFilters()">
      <option value="">All Categories</option>
      <option>Vehicle</option>
      <option>Machine</option>
      <option>Gensets</option>
      <option>Minor</option>
    </select>
    <select id="fAssetProject" onchange="applyAssetFilters()"><option value="">All Projects</option></select>
    <select id="fAssetStatus" onchange="applyAssetFilters()">
      <option value="">All Status</option>
      <option>In operation</option><option>IDLE</option><option>maintenance</option>
      <option>service</option><option>passing work</option><option>Scrap</option>
      <option>cancelled</option><option>to be sold</option><option>sold</option>
    </select>
 </div>

    <div class="toolbar-right">
    <button class="btn" onclick="openAssetModal()">+ Add Asset</button>
   <button class="btn secondary" data-hide-for="Admin,Viewer" onclick="openImportModal('asset')">Import Excel</button>
    <button class="btn"data-hide-for="Admin,Viewer" onclick="exportAssetExcel()">üì§ Export Excel</button>
  </div>
</div>
 


  <div class="table-wrap">
    <table id="assetTable">
      <thead>
        <tr>
          <th>Vehicle/Machine No</th>
          <th>Asset No</th>        
	<th>Brand/Model</th>
	<th>Category</th>
          <th>User Name</th>
          <th>Designation</th>
          <th>Contact</th>
          <th>Project</th>
          <th>Reg No</th>
          <th>Reg Expiry</th>
          <th>From</th>
          <th>Till</th>
<th>Status</th> <th>Shift</th>
          <th>Remarks</th>

          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="assetTbody"></tbody>
    </table>
  </div>



<div class="pagination">
    Rows/page:
    <select id="pageSize" onchange="state.assetPageSize=parseInt(this.value); state.assetLocalPage=1; renderAssetTable();">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
    </select>
    <button class="page-btn" onclick="fetchAssets(null)">‚èÆ First</button>
    <button class="page-btn" onclick="prevAssetPage()">‚óÄ Prev</button> 
    <span id="assetPageInfo">Loading...</span>
    <button class="page-btn" onclick="nextAssetPage()">Next ‚ñ∂</button>
</div>


</section>



<div id="assetModal" class="modal-overlay">
  <div class="modal-content card">
    <h3>Asset Details</h3>
    <div class="grid grid-4">
      <div>
        <label>Vehicle/Machine No</label>
        <input id="a_vmNo" />
      </div>
      <div>
        <label>Asset No</label>
        <input id="a_assetNo" />
      </div>
<div>
  <label>Brand/Model</label>
  <input id="a_brand" placeholder="e.g. Toyota/CAT" />
</div>
      <div>
        <label>Category</label>
        <select id="a_category">
          <option value="">Select Category</option>
          <option>Vehicle</option><option>Machine</option><option>Gensets</option><option>Minor</option>
        </select>
      </div>
      <div>
        <label>Assign User</label>
        <div class="search-dd" id="a_userDD">
          <div class="selected">Select User (ID - Name)</div>
          <div class="panel">
            <input placeholder="Search user..." oninput="filterDD(this)">
            <div class="list"></div>
          </div>
        </div>
      </div>

      <div>
        <label>Designation</label>
        <input id="a_designation" readonly />
      </div>
      <div>
        <label>Contact</label>
        <input id="a_contact" readonly />
      </div>
      <div>
        <label>Project</label>
        <div class="search-dd" id="a_projectDD">
          <div class="selected">Select Project</div>
          <div class="panel">
            <input placeholder="Search project..." oninput="filterDD(this)">
            <div class="list"></div>
          </div>
        </div>
      </div>
      <div>
        <label>Registration No</label>
        <input id="a_regNo" />
      </div>

      <div>
        <label>Reg Expiry</label>
        <input id="a_regExp" type="text" placeholder="üìÖ Select Date" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
      </div>
      <div>
        <label>From Date/Time</label>
        <input id="a_from" type="text" placeholder="üìÖ Select Date/Time" onfocus="(this.type='datetime-local')" oninput="this.blur()" onblur="if(!this.value) this.type='text'" />
      </div>
      <div>
        <label>Till Date/Time</label>
        <input id="a_till" type="text" placeholder="üìÖ Select Date/Time" onfocus="(this.type='datetime-local')" oninput="this.blur()" onblur="if(!this.value) this.type='text'" />
      </div>
      <div>
        <label>Status</label>
<select id="a_status" onchange="handleAssetStatusChange()">
          <option value="">Select Status</option>
          <option>In operation</option><option>IDLE</option><option>Maintenance</option>
          <option>Scrap</option><option>Passing Work</option><option>To be Sold</option><option>Sold</option>
        </select>
      </div>
      <div>
        <label>Shift</label>
        <select id="a_shift">
          <option value="">Select Shift</option>
          <option>Day</option><option>Night</option>
        </select>
      </div>
      <div style="grid-column: span 3;">
        <label>Remarks</label>
        <textarea id="a_remarks" style="height: 42px;"></textarea>
      </div>

      <div style="grid-column: span 4; background: #eff6ff; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #bfdbfe;">
        <label style="font-size:12px;">Update Driver Status (If User Assigned)</label>
        <div class="grid grid-2" style="gap:10px;">
          <div>
            <label style="font-size:11px; color:#64748b;">Action</label>
            <select id="a_driverStatus" onchange="handleAssetStatusChange()"> 
              <option value="Active">Keep Driver Active</option>
		<option value="IDLE">Set Driver: IDLE</option>
              <option value="On Leave">Set Driver: On Leave</option>
              <option value="Resigned">Set Driver: Resigned</option>
              <option value="Transfer">Set Driver: Transfer</option>
            </select>
          </div>
          <div>
            <label style="font-size:11px; color:#64748b;">Leave Till Date</label>
            <input id="a_driverLeaveTill" type="text" placeholder="üìÖ Manual: Leave Till" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
          </div>
        </div>
        <small style="color:#64748b; display:block; margin-top:8px;">
          * Selecting "On Leave","IDLE","Transfer"  or "Resigned" uses the Asset "Till Date" as the Leave event end date.

        </small>
      </div>
    </div>
    <div style="margin-top:20px; text-align:right;">
      <button class="btn warn" onclick="closeAssetModal()">Cancel</button>
      <button class="btn" onclick="saveOrUpdateAsset()">Save Asset</button>
    </div>
  </div>
</div>


    <!-- DRIVER/OPERATOR LIST -->
    <section id="list" class="section" style="display:none">
      <h2>Driver/Operator List</h2>
      <div class="toolbar card">
<div class="toolbar-left">
       <input id="search" placeholder="Search ID or Name..." oninput="debouncedDriverSearch()" />
        <select id="fDesignation" onchange="applyFilters()">
          <option value="">All Designations</option>
          <option>Heavy Duty Driver</option>
          <option>Bus Driver</option>
          <option>Operator - Heavy Equipment</option>
          <option>Light Vehicle Driver</option>
	<option>Workshop</option>
        </select>

  <select id="fProject" onchange="applyFilters()">
  <option value="">All Projects</option>
</select>

        <select id="fStatus" onchange="applyFilters()">
          <option value="">All Status</option>
          <option>Active</option>
          <option>On Leave</option>
          <option>Resigned</option>
          <option>Transfer</option>
          <option>IDLE</option>
          <option>Others...</option>
        </select>
 </div>

<div class="toolbar-right">
       <input type="file" id="excelFile" accept=".xlsx,.xls" />
<button class="btn secondary" data-hide-for="Admin,Viewer" onclick="openImportModal('driver')">Import Excel</button>
<button class="btn" data-hide-for="Admin,Viewer" onclick="exportExcel()">üì§ Export Excel</button>
      
        <button class="btn"data-hide-for="Admin,Viewer" onclick="exportPDF()">Export PDF</button>
      </div>
</div>
      <div class="card" id="addCard">
        <h3>Add Driver/Operator</h3>
        <div class="grid grid-4">
          <input id="empId" placeholder="Employee ID" />
          <input id="name" placeholder="Proper Name"autocomplete="name" />

          <select id="designation">
            <option value="">Designation</option>
            <option>Heavy Duty Driver</option>
            <option>Bus Driver</option>
            <option>Operator - Heavy Equipment</option>
            <option>Light Vehicle Driver</option>
		<option>Workshop</option>
          </select>
<div class="search-dd" id="driverProjectDD">
  <div class="selected">Select Project</div>
  <div class="panel">
    <input placeholder="Search project..." oninput="filterDD(this)">
    <div class="list"></div>
  </div>
</div>


          <input id="vehicleNo" placeholder="Vehicle / Machine No" />
          <input id="assetCode" placeholder="Asset T Code" />

          <input id="contact" placeholder="+9715XXXXXXXX" />
<input id="joiningDate" type="text" placeholder="üìÖ Joining Date" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
<input id="leaveSince" type="text" placeholder="üìÖ Leave Since/Resigned Date" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />

          <select id="status">
            <option>Active</option>
            <option>On Leave</option>
            <option>Resigned</option>
            <option>Transfer</option>
            <option>IDLE</option>
            <option>Others...</option>
          </select>
          <input id="remarks" placeholder="Remarks" />
          <button class="btn" onclick="addEntry()">Add</button>
        </div>
      </div>  


<p style="color:#2563eb; font-weight:600; margin:8px 0;">
  üí° Tip: Right-click a row to open Driver/Operator Logs
</p>

      <div class="table-wrap">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Employee ID</th>
              <th>Name</th>
              <th>Designation</th>
              <th>Project</th>
              <th>Vehicle / Machine No</th>
              <th>Asset T Code</th>
              <th>Contact</th>
              <th>Joining Date</th>
	      <th>Leave Since/ Resigned Date</th>
	      <th>Leave Till</th>
              <th>Status</th>
              <th>Remarks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
 <div class="pagination">
    Rows/page:
    <select onchange="state.driverPageSize=parseInt(this.value); state.driverLocalPage=1; renderTablePage();">
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
    </select>
    <button class="page-btn" onclick="fetchDrivers(null)">‚èÆ First</button>
    <button class="page-btn" onclick="prevDriverPage()">‚óÄ Prev</button> 
    <span id="pageInfo">Loading...</span>
    <button class="page-btn" onclick="nextDriverPage()">Next ‚ñ∂</button>
</div>
    </section>

<!-- Project Section -->

<section id="projectsSection" class="section" style="display:none">
  <h2>Projects List</h2>
  <div class="toolbar card">
<div class="toolbar-left">
    <input id="projSearch" placeholder="Search Projects..." oninput="applyProjFilters()" />
    <select id="fProjStatus" onchange="applyProjFilters()">
      <option value="">All Status</option>
      <option>Active</option>
      <option>Inactive</option>
      <option>On Hold</option>
    </select>
 </div>
<div class="toolbar-right">
    <input type="file" id="projExcelFile" accept=".xlsx,.xls" style="display:none" />
    <button class="btn secondary"data-hide-for="Admin,Viewer" onclick="document.getElementById('projExcelFile').click()">Import Excel</button>
    <button class="btn" onclick="exportProjExcel()">üì§ Export Excel</button>
  </div>
</div>
  <div class="card" id="addProjCard">
    <h3>Add Project</h3>
    <div class="grid grid-4">
      <input id="p_id" placeholder="Project ID" />
      <input id="p_name" placeholder="Project Name" />
      <input id="p_loc" placeholder="Location" />
      <input id="p_div" placeholder="Division" />
      <input id="p_date" type="date" title="Creation Date" />
      <select id="p_status">
        <option>Active</option>
        <option>Inactive</option>
        <option>On Hold</option>
      </select>
      <button class="btn" onclick="addProject()">Add Project</button>
    </div>
  </div>
<div id="projectEditModal" class="modal-overlay">
  <div class="modal-content card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0;">Edit Project Details</h3>
      <button class="btn warn" onclick="closeProjEdit()">‚úï</button>
    </div>
    
    <div class="grid grid-2">
      <div>
        
        <input id="ep_id" placeholder="Project ID" />
      </div>
      <div>
       
        <input id="ep_name" placeholder="Project Name" />
      </div>
      <div>
       
        <input id="ep_loc" placeholder="Location" />
      </div>
      <div>
        
        <input id="ep_div" placeholder="Division" />
      </div>
      <div>
        
        <input id="ep_date" type="date" />
      </div>
      <div>
        
        <select id="ep_status">
          <option>Active</option>
          <option>Inactive</option>
          <option>On Hold</option>
        </select>
      </div>
    </div>

    <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn secondary" onclick="closeProjEdit()">Cancel</button>
      <button class="btn" onclick="saveProjUpdate()">Update Project</button>
    </div>
  </div>
</div>

  <div class="table-wrap">
    <table id="projTable">
      <thead>
        <tr>
          <th>Project ID</th>
          <th>Project Name</th>
          <th>Location</th>
          <th>Division</th>
          <th>Creation Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="projTbody"></tbody>
    </table>
  </div>
  
  <div class="pagination">
    <span class="page-size">Rows/page:
      <select id="projPageSize" onchange="applyProjFilters()">
        <option>10</option><option>20</option><option>50</option>
      </select>
    </span>
    <button class="page-btn" onclick="gotoProjPage(1)">‚èÆ First</button>
    <button id="prevProjBtn" class="page-btn" onclick="gotoProjPage(state.projPage-1)">‚óÄ Prev</button>
    <span id="projPageInfo"></span>
    <button id="nextProjBtn" class="page-btn" onclick="gotoProjPage(state.projPage+1)">Next ‚ñ∂</button>

  </div>
</section>



<!--  LEAVE > 6 MONTHS -->
<section id="al6m" class="section" style="display:none">
  <h2>On Leave > 6 Months</h2>
  <div class="card">
    <button class="btn" onclick="exportAL6mExcel()">üì§ Export Excel</button>
  </div>
  <div class="table-wrap">
    <table id="al6mTable">
<thead>
  <tr>
    <th>Employee ID</th>
    <th>Name</th>
    <th>Designation</th>
    <th>Project</th>
    <th>Plate Noth>
    <th>assetCode</th>
    <th>Contact</th>
    <th>Joining Date</th>
    <th>Leave Since/ Resigned Date</th>
    <th>Leave Till</th>
    <th>Status</th>
    <th>Remarks</th>
    <th>Category</th>
    <th>Overstay Days</th>
  </tr>
</thead>

      <tbody id="al6mBody"></tbody>
    </table>
  </div>
</section>

<!-- Report -->
<section id="reportRegExp" class="section" style="display:none">
  <h2>Registration Expiry Report</h2>
  <div class="toolbar card" style="background:#fee2e2; border-color:#fca5a5;">
    <p style="margin:0; font-weight:bold; color:#b91c1c;">
      ‚ö†Ô∏è Displaying Assets with Expired Registration or Expiring within 15 Days.
    </p>
    <button class="btn" style="margin-left:auto;" onclick="exportRegReport()">üì§ Export Excel</button>
  </div>
  <div class="table-wrap">
    <table id="regReportTable">
      <thead>
        <tr>
          <th>Vehicle/Machine No</th>
          <th>Asset No</th>
          <th>Project</th>
          <th>Reg No</th>
          <th>Reg Expiry</th>
          <th>Days Remaining</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="regReportBody"></tbody>
    </table>
  </div>
</section>



<section id="reportRegRenewal" class="section" style="display:none">
  <h2>Asset Registration Renewal</h2>
  
  <div class="toolbar card">
    <div class="toolbar-left">
        <div class="date-range-group">
            <label style="margin:0; font-size:12px;">From:</label>
            <input type="date" id="rep_start" />
        </div>
        <div class="date-range-group">
            <label style="margin:0; font-size:12px;">To:</label>
            <input type="date" id="rep_end" />
        </div>
        <button class="btn secondary" onclick="setRepDate('today')">Today</button>
        <button class="btn secondary" onclick="setRepDate('month')">This Month</button>
        <button class="btn" onclick="fetchRenewalData()">üîç Generate Report</button>
    </div>
    
    <div class="toolbar-right">
        <button class="btn" onclick="exportRenewalExcel()">üì§ Export Excel</button>
    </div>
  </div>

  <div class="table-wrap">
    <table id="renewalTable">
      <thead>
        <tr>
          <th>Date of Renewal</th> <th>Vehicle/Machine No</th>
          <th>Asset No</th>
          <th>Project</th>
          <th>New Expiry Date</th>
          <th>Remarks</th>
          <th>Done By</th>
        </tr>
      </thead>
      <tbody id="renewalBody"></tbody>
    </table>
  </div>
</section>


    <!-- USERS -->
    <section id="users" class="section" style="display:none">
      <h2>Users</h2>
      <div class="card">
        <h3>Add User</h3>
        <div class="grid grid-4">
          <input id="newU" placeholder="Username" />
          <input id="newP" placeholder="Password" type="password" />
          <select id="newRole">
            <option>Viewer</option>
            <option>Admin</option>
            <option>SuperAdmin</option>
          </select>
          <button class="btn" onclick="addUser()">Add User</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="userTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTbody"></tbody>
        </table>
      </div>
    </section>


<section id="alertsConfigSection" class="section" style="display:none">
  <h2>Alert Configuration</h2>
  <div class="grid grid-2" style="align-items: flex-start;">
    
    <div class="card">
      <h3>üìß Email Recipients</h3>
      <p style="font-size:12px; color:var(--muted); margin-bottom:15px;">Add emails that should receive automated reports.</p>
      <div style="display:flex; gap:10px; margin-bottom:15px;">
        <input id="newAlertEmail" placeholder="Enter email address..." style="flex:1;" />
        <button class="btn" onclick="addEmailRecipient()">Add</button>
      </div>
      <div id="emailRecipientList" style="background:#f8fafc; border-radius:8px; padding:10px; min-height:100px; border:1px solid #cbd5e1;">
        </div>
    </div>

    <div class="card">
      <h3>‚öôÔ∏è Active Alerts</h3>
      <p style="font-size:12px; color:var(--muted); margin-bottom:15px;">Select which reports to generate automatically.</p>
      
      <div style="display:flex; flex-direction:column; gap:12px;">
        <label style="display:flex; align-items:center; gap:10px; text-transform:none; font-weight:600; color:var(--text); cursor:pointer;">
          <input type="checkbox" id="cfg_idle_ops" style="width:18px; height:18px;"> Daily 8AM: IDLE Operators
        </label>
        <label style="display:flex; align-items:center; gap:10px; text-transform:none; font-weight:600; color:var(--text); cursor:pointer;">
          <input type="checkbox" id="cfg_idle_assets" style="width:18px; height:18px;"> Daily 8AM: IDLE Assets
        </label>
        <label style="display:flex; align-items:center; gap:10px; text-transform:none; font-weight:600; color:var(--text); cursor:pointer;">
          <input type="checkbox" id="cfg_reg_exp" style="width:18px; height:18px;"> Real-time: Reg Near Expiry / Expired (One-time)
        </label>
        <hr style="border:0; border-top:1px dashed #cbd5e1; margin:5px 0;">
        <label style="display:flex; align-items:center; gap:10px; text-transform:none; font-weight:600; color:var(--text); cursor:pointer;">
          <input type="checkbox" id="cfg_weekly_ops" style="width:18px; height:18px;"> Weekly (Monday): Operator Count Report
        </label>
        <label style="display:flex; align-items:center; gap:10px; text-transform:none; font-weight:600; color:var(--text); cursor:pointer;">
          <input type="checkbox" id="cfg_weekly_assets" style="width:18px; height:18px;"> Weekly (Monday): Asset Count Report
        </label>
      </div>

      <div style="margin-top:20px; text-align:right;">
        <button class="btn" onclick="saveAlertConfig()">üíæ Save Configuration</button>
      </div>
    </div>
  </div>
</section>

<section id="alertsSection" class="section" style="display:none">
  <h2>Alerts Management</h2>
  <div class="card" style="text-align:center; padding:40px;">
    <h3>Manual Override</h3>
    <p style="color:var(--muted); margin-bottom:20px;">
      Alerts are checked automatically when a user logs in. If you want to force the system to check and send pending emails right now, click below.
    </p>
    <button class="btn secondary" style="padding:12px 24px; font-size:16px;" onclick="runAlertCheck(true)">
      üöÄ Force Check & Send Alerts
    </button>
    <p id="alertStatusText" style="margin-top:15px; font-weight:bold; color:var(--brand);"></p>
  </div>
</section>


  </main>
</div>

<div class="footer">
  ¬© 2026 Engr. Farrukh. All Rights Reserved.
  <span id="dataStatus" style="margin-left:12px; font-weight:600;"></span>
</div>


<!-- Edit Driver Modal -->
<div id="editModal" class="modal">
  <div class="dialog">
    <h3>Edit Entry</h3>
    <div class="grid grid-2">
      <input id="e_empId" placeholder="Employee ID" />
      <input id="e_name" placeholder="Name" />
      <select id="e_designation">
        <option>Heavy Duty Driver</option>
        <option>Bus Driver</option>
        <option>Operator - Heavy Equipment</option>
        <option>Light Vehicle Driver</option>
<option>Workshop</option>
      </select>
      <select id="e_project">
        <option>Creation</option>
        <option>Gatex</option>
        <option>Samtech</option>
      </select>
      <input id="e_vehicleNo" placeholder="Vehicle / Machine No" />
      <input id="e_assetCode" placeholder="Asset T Code" />
      <input id="e_contact" placeholder="Contact" />
      <input id="e_joiningDate" type="date" />
<input id="e_leaveSince" type="date" placeholder="Tochkey Returned Date (optional)" />
<input id="e_leaveTill" type="date" placeholder="Leave Till (optional)" />
      <select id="e_status">
        <option>Active</option>
        <option>On Leave</option>
        <option>Resigned</option>
        <option>Transfer</option>
        <option>IDLE</option>
        <option>Others...</option>
      </select>
      <input id="e_remarks" placeholder="Remarks" />
    </div>
    <div class="actions">
      <button class="btn warn" onclick="closeEdit()">Cancel</button>
      <button class="btn" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>



<section id="undertaking" class="section" style="display:none">
  <div class="no-print" style="padding: 20px; text-align:right;">
    <button class="btn" onclick="window.print()">üñ®Ô∏è Print Undertaking</button>
<!-- <button class="btn secondary" onclick="saveUndertakingDigital()">üíæ Save Signed Copy</button>-->
  </div>

  <div class="undertaking-paper">
<div class="ut-header">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <img src="NPClogo.png" style="height: 60px; width: auto; object-fit: contain;" alt="Logo Left">
    
    <img src="UndertakingMiddle.jpg" style="height: 60px; width: auto; object-fit: contain;" alt="Logo Middle">
    
    <img src="UndertakingRight.png" style="height: 60px; width: auto; object-fit: contain;" alt="Logo Right">
  </div>

  <div style="text-align: center; border-top: 1px solid #eee; padding-top: 15px;">
    <h2 style="margin: 0; font-size: 22px; letter-spacing: 1px;">PLANT DEPARTMENT</h2>
    <h3 style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">UNDERTAKING (RECEIVING) OF NPC OWNED VEHICLES</h3>
  </div>
</div>

    <div class="ut-grid">
      <div class="ut-box">
        <div class="ut-section-title">RECEIVING PERSON DETAILS / ŸàÿµŸàŸÑ ⁄©ÿ±ŸÜ€í ŸàÿßŸÑ€í ÿ¥ÿÆÿµ ⁄©€å ÿ™ŸÅÿµ€åŸÑÿßÿ™</div>
        <div class="ut-row"><span class="ut-label">NAME / ŸÜÿßŸÖ:</span> <span class="ut-val" id="ut_name"></span></div>
        <div class="ut-row"><span class="ut-label">EMP. NO / ŸÖŸÑÿßÿ≤ŸÖ ⁄©ÿß ŸÜŸÖÿ®ÿ±:</span> <span class="ut-val" id="ut_empId"></span></div>
        <div class="ut-row"><span class="ut-label">DESIGNATION / ÿπ€ÅÿØ€Å:</span> <span class="ut-val" id="ut_desig"></span></div>
        <div class="ut-row"><span class="ut-label">PROJECT / Ÿæÿ±Ÿàÿ¨€å⁄©Ÿπ:</span> <span class="ut-val" id="ut_proj"></span></div>
        <div class="ut-row"><span class="ut-label">LICENSE / ŸÑÿßÿ¶ÿ≥ŸÜÿ≥:</span> <span class="ut-val" id="ut_license"></span></div>
        <div class="ut-row"><span class="ut-label">CONTACT / ŸÜŸÖÿ®ÿ±:</span> <span class="ut-val" id="ut_contact"></span></div>
      </div>

      <div class="ut-box">
        <div class="ut-section-title">VEHICLE DETAILS / ⁄Øÿß⁄ë€å ⁄©€å ÿ™ŸÅÿµ€åŸÑÿßÿ™</div>
        <div class="ut-row"><span class="ut-label">MAKE & MODEL / ŸÖÿß⁄àŸÑ:</span> <span class="ut-val" id="ut_model"></span></div>
        <div class="ut-row"><span class="ut-label">PLATE NO / ŸæŸÑ€åŸπ ŸÜŸÖÿ®ÿ±:</span> <span class="ut-val" id="ut_plate"></span></div>
        <div class="ut-row"><span class="ut-label">ASSET NO / ÿßÿ´ÿßÿ´€Å ŸÜŸÖÿ®ÿ±:</span> <span class="ut-val" id="ut_asset"></span></div>
        <div class="ut-row"><span class="ut-label">REG. VALIDITY / ÿ±ÿ¨ÿ≥Ÿπÿ±€åÿ¥ŸÜ:</span> <span class="ut-val" id="ut_reg"></span></div>
        <div class="ut-row"><span class="ut-label">INSURANCE / ÿßŸÜÿ¥Ÿàÿ±ŸÜÿ≥:</span> <span class="ut-val" id="ut_ins"></span></div>
        <div class="ut-row"><span class="ut-label">K.M. READING / ⁄©ŸÑŸàŸÖ€åŸπÿ±:</span> <span class="ut-val" id="ut_km"></span></div>
      </div>
    </div>

    <div class="checklist-grid">
      <div>
        <div class="cl-header">CHECKLIST (RECEIVE / RETURN)</div>
        <div class="cl-item"><span>FIRST AID BOX / ÿ∑ÿ®€å ÿßŸÖÿØÿßÿØ ⁄©ÿß ⁄àÿ®€Å</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>WIPER / WASHER / Ÿàÿßÿ¶Ÿæÿ±</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>RADIO / CD / ÿ±€å⁄à€åŸà</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>TOOL KIT / ŸπŸàŸÑ ⁄©Ÿπ</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>JACK / ÿ¨€å⁄©</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>SPARE WHEEL / ÿßÿ≥Ÿæ€åÿ¶ÿ± Ÿà€Å€åŸÑ</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>MIRRORS / ÿ¢ÿ¶€åŸÜ€Å</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>A/C CONTROL / ÿß€åÿ¶ÿ± ⁄©ŸÜ⁄à€åÿ¥ŸÜ⁄Ø</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>PETROL CARD NO. /Ÿæ€åŸπÿ±ŸàŸÑ</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>SALIK TAG / ÿ≥ÿßŸÑ⁄© </span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>FLOOR MATS / ŸÅÿ±ÿ¥</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>WHEEL CAPS / Ÿà€Å€åŸÑ ⁄©€åŸæ	</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>FIRE EXTINGUISHER /ÿß⁄Ø ÿ®ÿ¨⁄æÿßŸÜ€í ⁄©ÿß ÿßŸÑ€Å</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>LIGHTS / INDICATORS  /ÿ±Ÿàÿ¥ŸÜ€å / ÿßÿ¥ÿßÿ±€í</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
      </div>
      <div>
  <div class="cl-header">TRAFFIC FINE DETAILS & NOTES</div>
  <div style="padding:10px; font-size:11px; height:100%; box-sizing:border-box;">
    <p style="margin:0 0 5px 0;"><strong>OFFENCE DATE / FINE REF:</strong></p>
    
    <textarea id="ut_fines" class="writable-input" rows="6" 
      placeholder="Type fine details here..."></textarea>
      
    <p style="margin-top:10px; font-style:italic; font-size:10px;">
      "Note: All Traffic fines has to be paid by the individual user, if not equal amount shall be deducted from their salary."
    </p>
  </div>
</div>
    </div>

    <div style="margin-top:15px; font-size:12px; font-weight:bold;">
      RECEIVED THE ABOVE VEHICLE IN GOOD CONDITION. I UNDERTAKE RESPONSIBILITY OF THE VEHICLE.
    </div>

<div class="ut-footer-row">
      <div class="ut-sig-box">
  <div>SIGNATURE / ÿØÿ≥ÿ™ÿÆÿ∑</div>
  
  <div id="sig-container" style="position: relative; width: 200px; height: 100px; border: 1px solid #ccc; margin: 10px auto; background: #fff;">
     <canvas id="sigCanvas" width="200" height="100" style="cursor: crosshair; touch-action: none;"></canvas>
     <span id="sig-placeholder" style="position:absolute; top:40%; left:20%; color:#ccc; pointer-events:none;">Sign Here</span>
  </div>

  <div class="no-print" style="margin-bottom: 10px;">
    <button class="btn secondary" style="padding: 2px 8px; font-size: 10px;" onclick="clearSignature()">Clear</button>
  </div>
  
  <div style="margin-top:5px;" id="ut_date_receive">Date: </div>
</div>


<div class="ut-sig-box" style="border:none; text-align:left; width: 45%;">
  <div><strong>REMARKS:</strong></div>
  
  <textarea id="ut_remarks" class="writable-input" rows="3" 
    style="border-bottom: 1px solid #000; margin-top: 5px;" 
    placeholder="Type remarks here..."></textarea>
</div>
    </div>

    <div class="ut-section-title" style="margin-top:30px;">VEHICLE RETURN DETAILS / ⁄Øÿß⁄ë€å ⁄©€å ŸàÿßŸæÿ≥€å ⁄©€å ÿ™ŸÅÿµ€åŸÑÿßÿ™</div>
    <div class="ut-grid" style="margin-top:10px;">
      <div class="ut-box">
        <div><strong>RECEIVED BY / ⁄©€å ÿ∑ÿ±ŸÅ ÿ≥€í ŸÖŸàÿµŸàŸÑ:</strong></div>
        <div style="height:30px;"></div>
        <div>SIGNATURE: _________________</div>
      </div>
      <div class="ut-box">
        <div><strong>RETURNED BY / ⁄©€å ÿ∑ÿ±ŸÅ ÿ≥€í ŸàÿßŸæÿ≥:</strong></div>
        <div style="font-size:14px; font-weight:bold; margin:5px 0;" id="ut_return_by"></div>

        <div>SIGNATURE: _________________</div>
        <div style="margin-top:5px;" id="ut_date_return">Date: </div>
      </div>
    </div>

    <div style="margin-top:40px; border-top:1px solid #000; display:flex; justify-content:space-between; padding-top:5px; font-size:11px;">
      <span>TRANSPORT CO-ORDINATOR</span>
      <span>PLANT MANAGER</span>
    </div>
    <div style="text-align:right; font-size:10px; margin-top:10px;">FORM: NPC/QHSE/FRM/253 R2</div>

  </div>
</section>

<!-- Change Password Modal -->
<div id="pwModal" class="modal">
  <div class="dialog">
    <h3>Change Password</h3>
    <input id="pwUser" type="hidden" />
    <input id="pwNew" placeholder="New Password" type="password" />
    <input id="pwConfirm" placeholder="Confirm Password" type="password" />
    <div class="actions">
      <button class="btn warn" onclick="closePw()">Cancel</button>
      <button class="btn" onclick="savePw()">Save</button>
    </div>
  </div>
</div>

<!-- Driver Logs Modal -->
<div id="logsModal" class="modal"> <div class="dialog">
    <h3>Driver Logs</h3>
    <div id="logsTimeline">
      </div>
    <div class="actions">
      <button class="btn secondary" onclick="exportLogsToPDF()">üìë Export PDF</button>
      <button class="btn warn" onclick="document.getElementById('logsModal').style.display='none'">Close</button>
    </div>
  </div>
</div>


<div id="importModal" class="modal">
  <div class="dialog" style="max-width: 500px; text-align: center;">
    <h3 id="importModalTitle">Import Data</h3>
    <p style="color:#64748b; margin-bottom: 20px;">
      Please download the sample template, fill it with your data, and upload it below.
    </p>

    <div class="grid grid-2" style="gap: 15px;">
      <div class="card" style="cursor: pointer; border: 1px dashed #2563eb;" onclick="downloadSampleTemplate()">
        <div style="font-size: 30px;">üì•</div>
        <div style="font-weight: 600; color: #2563eb; margin-top: 5px;">Download Template</div>
        <small style="color: #64748b;">.xlsx format</small>
      </div>

      <div class="card" style="cursor: pointer; border: 1px dashed #16a34a;" onclick="triggerFileSelect()">
        <div style="font-size: 30px;">üì§</div>
        <div style="font-weight: 600; color: #16a34a; margin-top: 5px;">Upload File</div>
        <small style="color: #64748b;" id="fileNameDisplay">Click to browse...</small>
      </div>
    </div>

    <input type="file" id="universalFileInput" accept=".xlsx,.xls" style="display:none" onchange="handleFileSelection(this)">

    <div class="actions" style="margin-top: 20px; justify-content: center;">
      <button class="btn warn" onclick="closeImportModal()">Cancel</button>
      <button class="btn" id="confirmImportBtn" onclick="processUniversalImport()" disabled style="opacity: 0.5;">Start Import</button>
    </div>
  </div>
</div>


<section id="reportActivity" class="section" style="display:none">
  <h2>Activity & Custom Reports</h2>
  
  <div class="grid grid-2" style="align-items: flex-start;">
    
    <div class="card">
      <h3>üì• Detailed History Export</h3>
      <p style="font-size:12px; color:#64748b; margin-bottom:15px;">
        Search entire database for a specific Asset or Driver to download Profile + Full History Logs.
      </p>
      
      <div style="margin-bottom:15px;">
        <label>Select Type</label>
        <select id="act_type" onchange="resetActSearch()">
          <option value="asset">Asset (Vehicle/Machine)</option>
          <option value="driver">Driver/Operator</option>
        </select>
      </div>

      <div style="margin-bottom:15px;">
        <label>Search Entity (Server-Wide)</label>
        <div class="search-dd" id="act_dd">
          <div class="selected">Type to search...</div>
          <div class="panel">
            <input class="search-input" placeholder="Type ID, Name, Plate No..." 
                   oninput="handleServerSearch(this)">
            <div class="list"></div>
          </div>
        </div>
      </div>

      <button class="btn" onclick="exportDetailedHistory()">
        üìÑ Download Profile & Logs
      </button>
    </div>

    <div class="card">
      <h3>üìä Bulk Snapshot Export</h3>
      <p style="font-size:12px; color:#64748b; margin-bottom:15px;">
        Select multiple filters to download a current status list.
      </p>

      <div class="grid grid-2">
        <div>
           <label>Projects</label>
           <div class="multi-select" id="ms_projects">
             <div class="select-box" onclick="toggleMulti('ms_projects')">
               <span class="text">Select Projects</span>
               <span class="arrow">‚ñº</span>
             </div>
             <div class="options-container" id="cont_projects"></div>
           </div>
        </div>

        <div>
           <label>Status</label>
           <div class="multi-select" id="ms_status">
             <div class="select-box" onclick="toggleMulti('ms_status')">
               <span class="text">Select Status</span>
               <span class="arrow">‚ñº</span>
             </div>
             <div class="options-container">
               <label class="option"><input type="checkbox" value="In operation"> In operation / Active</label>
               <label class="option"><input type="checkbox" value="IDLE"> IDLE</label>
               <label class="option"><input type="checkbox" value="Maintenance"> Maintenance</label>
               <label class="option"><input type="checkbox" value="On Leave"> On Leave</label>
               <label class="option"><input type="checkbox" value="Resigned"> Resigned</label>
               <label class="option"><input type="checkbox" value="Scrap"> Scrap</label>
               <label class="option"><input type="checkbox" value="Passing Work"> Passing Work</label>
               <label class="option"><input type="checkbox" value="To be Sold"> To be Sold</label>
               <label class="option"><input type="checkbox" value="Sold"> Sold</label>
             </div>
           </div>
        </div>

        <div>
          <label>Data To Export</label>
          <select id="ms_target">
            <option value="assets">Assets List</option>
            <option value="drivers">Drivers List</option>
          </select>
        </div>
      </div>

      <div style="margin-top:20px; text-align:right;">
        <button class="btn secondary" onclick="exportBulkSnapshot()">
          üì§ Export Filtered Data
        </button>
      </div>
    </div>
  </div>
</section>



<script type="module">



/* -------------------------- Firebase (ESM) -------------------------- */
// Use 10.13.0 for EVERYTHING
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
 getAuth, 
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
setPersistence,           
  browserSessionPersistence 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import {
  initializeFirestore,
  persistentLocalCache,
  persistentMultipleTabManager,
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  where,
  serverTimestamp,
  onSnapshot,
  orderBy,
  writeBatch,       // <--- NEW: For deleting logs + parent together
  limit,            // <--- NEW: For optimization
  startAfter,       // <--- NEW: For pagination
  getCountFromServer // <--- NEW: For cheap dashboard counts
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

/* ===== YOUR FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCmd5cSLKMJkiotQopikaOGRUZPvjYbmx4",
  authDomain: "asset-management-system-755a6.firebaseapp.com",
  projectId: "asset-management-system-755a6",
  storageBucket: "asset-management-system-755a6.firebasestorage.app",
  messagingSenderId: "889243221633",
  appId: "1:889243221633:web:e8767dc3d1d42c14fb9780",
  measurementId: "G-TT5CSSLCNR"
};

// Initialize App
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
setPersistence(auth, browserSessionPersistence)
  .then(() => {
    console.log("Session persistence enabled");
  })
  .catch((error) => {
    console.error("Persistence error:", error);
  });
// Initialize Firestore with consistent 10.13.0 cache settings
const db = initializeFirestore(app, {
  localCache: persistentLocalCache({
    tabManager: persistentMultipleTabManager()
  })
});

let charts = {}; // Store chart instances globally to destroy them later
let needsRefresh = false;
/* ------------------------ Minimal helper styles ------------------------ */
(function injectMinorStyles(){
  const s=document.createElement('style');
  s.textContent = `
    .cell-bad{ background:#fee2e2 !important; }
    .badge-danger{ background:rgba(239,68,68,.12); color:#ef4444; padding:4px 10px; border-radius:999px; font-size:12px }
    .hidden{ display:none !important; }
  `;
  document.head.appendChild(s);
})();
function applyRoleUI() {
  const role = (state.me?.role || 'Viewer'); // Default to Viewer if unknown

  // 1. Handle "User Management" Tab visibility
  const usersNav = document.getElementById('nav-users');
  if(usersNav) {
      // Only SuperAdmin sees User Management
      usersNav.style.display = (role === 'SuperAdmin') ? 'flex' : 'none';
  }

  // 2. Hide Elements based on role-sensitive tags
  // This looks for any element with data-hide-for="Admin,Viewer"
  const sensitiveElements = document.querySelectorAll('.role-sensitive, [data-hide-for]');
  
  sensitiveElements.forEach(el => {
    const hiddenFor = el.dataset.hideFor || ""; // e.g., "Admin,Viewer"
    if (hiddenFor.includes(role)) {
      el.style.display = 'none'; // Hide it
    } else {
      // Restore default (flex for navs/buttons usually, block for cards)
      el.style.display = el.tagName === 'BUTTON' || el.tagName === 'A' ? 'inline-block' : 'block'; 
    }
  });

  // 3. Special Case: Viewers cannot see Add Forms
  const addCards = ['addCard', 'addProjCard']; // IDs of your Add Forms
  addCards.forEach(id => {
      const el = document.getElementById(id);
      if(el) el.style.display = (role === 'Viewer') ? 'none' : 'block';
  });
  
  // 4. Special Case: Asset "Add Asset" button in toolbar
  const addAssetBtn = document.querySelector('button[onclick="openAssetModal()"]');
  if(addAssetBtn) addAssetBtn.style.display = (role === 'Viewer') ? 'none' : 'inline-block';
}

/* ------------------------------ Globals ------------------------------ */
const COLL_DRIVERS = "drivers";
const COLL_USERS   = "users";
const COLL_PROJECTS = "projects"; // New Firestore collection name
const COLL_ASSETS = "assets";
const COLL_ASSET_LOGS = "asset_logs"; // Same as driver logs
let unsubscribeProjects = null;
let unsubscribeDrivers = null;
let unsubscribeUsers = null;
let currentEditAssetId = null;

const state = {
  me: null,
  
  // --- ASSETS STATE ---
  assets: [],             // Holds the current chunk of 50 from server
  assetTotalCount: 0,     // Total in DB (for dashboard & pagination text)
  assetLocalPage: 1,      // Local page (1, 2, 3...) within the chunk
  assetPageSize: 10,      // Local rows per page (10, 20, 50)
  assetChunkSize: 50,     // How many to fetch from server
  lastAssetDoc: null,     // Firestore Cursor
  assetPageStack: [],     // Stack for server history
  
  // --- DRIVERS STATE ---
  drivers: [],            // Holds current chunk of 50
  driverTotalCount: 0,
  driverLocalPage: 1,
  driverPageSize: 10,
  driverChunkSize: 50,
  lastDriverDoc: null,
  driverPageStack: [],
  
  // --- OTHERS ---
  users: [],
  projects: [],
  
  // --- HELPERS ---
  filteredAssets: [],     // For local filtering of assets
  filtered: [],           // For local filtering of drivers
  annualLeaveOver6M: [],  
  
  // --- EDIT TRACKING ---
  editIndex: null,
  editDocId: null,
  editProjDocId: null,
  
  // --- PROJECT PAGINATION ---
  projFiltered: [],
  projPage: 1,
  projPageSize: 10,
  projTotalPages: 1
};
// Make globally available
window.state = state;

// make state visible to inline onclick handlers
window.state = state;

/* ------------------------ Utility / Formatting ------------------------ */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel)=> Array.from(document.querySelectorAll(sel));
function toast(msg){ alert(msg); }
function isDriver(rec){ return /driver/i.test(rec.designation||'') && !/operator/i.test(rec.designation||''); }
function isOperator(rec){ return /operator/i.test(rec.designation||''); }
function statusIndexToText(i){ return ['Active','on Leave','Resigned','Transfer','IDLE','Others...'][i] || ''; }
function validContact(c){ return /^\+9715\d{8}$/.test(c||''); }
function validassetCode(s){ return (s||'').length===16; }
function parseDate(d){ return d ? new Date(d) : null; }
function monthsDiff(fromDate, toDate=new Date()){
  if(!fromDate) return 0;
  const f = new Date(fromDate);
  return (toDate.getFullYear()-f.getFullYear())*12 + (toDate.getMonth()-f.getMonth());
}

/* -------------------------- First-time seeding ------------------------- */
async function ensureDefaultSuperAdmin(){
  // Create SuperAdmin "Trojan Plant" / "1234" only if not exists
  const qSnap = await getDocs(query(collection(db, COLL_USERS), where("username","==","Trojan Plant")));
  if(qSnap.empty){
    await addDoc(collection(db, COLL_USERS), {
      username: "Trojan Plant",
      password: "1234",
      role: "SuperAdmin",
      createdAt: serverTimestamp()
    });
  }
}

/* -------------------------------- Login -------------------------------- */
async function doLogin() {
  const email = $('#u').value.trim(); // Change placeholder to "Email" in HTML
  const password = $('#p').value.trim();
  
  if (!email || !password) { toast("Enter email and password"); return; }

  showLoader();
  try {
    // This securely checks credentials with Google's servers
    const userCredential = await signInWithEmailAndPassword(auth, email, password);
    // Login successful - onAuthStateChanged will handle the UI switch
  } catch (error) {
    console.error("Login Failed", error);
    toast("‚ùå Invalid Email or Password");
    hideLoader();
  }
}


onAuthStateChanged(auth, async (user) => {
  if (user) {
    console.log("‚úÖ Auth Login Success:", user.email, "| UID:", user.uid);
    
    // Default fallback
    let myRole = 'Viewer';
    let myName = user.email;

    // Fetch Role from DB
    const userDocRef = doc(db, COLL_USERS, user.uid);
    try {
      const userSnap = await getDoc(userDocRef);
      if (userSnap.exists()) {
        const data = userSnap.data();
        console.log("‚úÖ Database Profile Found:", data);
        myRole = data.role || 'Viewer';
        myName = data.username || user.email;
      } else {
        console.warn("‚ö†Ô∏è No Profile Found in DB for this UID. Defaulting to Viewer.");
        console.warn("Make sure Document ID in 'users' collection matches:", user.uid);
      }
    } catch (error) {
      console.error("‚ùå Error reading user profile:", error);
    }

    // Set State
    state.me = { id: user.uid, email: user.email, username: myName, role: myRole };

    // Update UI
    $('#loginWrap').style.display = 'none';
    $('#app').style.display = 'flex';
    $('#userLabel').textContent = `${state.me.username} (${state.me.role})`;

    // Show/Hide "Manage Users" tab
    if (state.me.role === 'SuperAdmin') {
      $('#nav-users').style.display = 'flex';
    } else {
      $('#nav-users').style.display = 'none';
    }

    applyRoleUI();
    
try {
        await Promise.all([
            // Load KPI counts immediately for Dashboard
initCounters(),
            // Load initial lists
            loadProjects(),

fetchAssets(null), 
  fetchDrivers(null)
        ]);
            
        if(state.me.role === 'SuperAdmin') loadUsers(); 
        
    } catch (e) {
        console.error("Initial load error:", e);
    } finally {
        // ALWAYS hide loader, even if errors occur
        hideLoader();
        nav('dashboard');

await loadAlertSettings();
runAlertCheck(); 
    }

  } else {
    doLogoutUI();
    hideLoader(); // Ensure loader hides on logout too
  }
});

function doLogoutUI() {
  $('#app').style.display = 'none';
  $('#loginWrap').style.display = 'flex';
  $('#u').value = ''; 
  $('#p').value = '';
}



let canvas, ctx, drawing = false;

// Initialize Canvas on Load
window.addEventListener('load', () => {
  canvas = document.getElementById('sigCanvas');
  ctx = canvas.getContext('2d');
  ctx.strokeStyle = "#000";
  ctx.lineWidth = 2;

  // Mouse Events
  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mousemove', draw);
  
  // Touch Events (Mobile)
  canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startDraw(e.touches[0]); });
  canvas.addEventListener('touchend', (e) => { e.preventDefault(); stopDraw(); });
  canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e.touches[0]); });
});

function startDraw(e) {
  drawing = true;
  document.getElementById('sig-placeholder').style.display = 'none';
  ctx.beginPath();
  const rect = canvas.getBoundingClientRect();
  ctx.moveTo((e.clientX - rect.left), (e.clientY - rect.top));
}

function stopDraw() {
  drawing = false;
  ctx.beginPath();
}

function draw(e) {
  if (!drawing) return;
  const rect = canvas.getBoundingClientRect();
  ctx.lineTo((e.clientX - rect.left), (e.clientY - rect.top));
  ctx.stroke();
}

window.clearSignature = function() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  document.getElementById('sig-placeholder').style.display = 'block';
};

// Function to Save Undertaking with Signature
window.saveUndertakingDigital = async function() {
  if(!confirm("Save this signed undertaking to system?")) return;
  
  const sigData = canvas.toDataURL(); // Base64 string
  
  const payload = {
    type: "UNDERTAKING",
    assetNo: document.getElementById('ut_asset').textContent,
    empId: document.getElementById('ut_empId').textContent,
    receiverName: document.getElementById('ut_name').textContent,
    signatureBase64: sigData,
    date: new Date(),
    remarks: document.getElementById('ut_remarks').value
  };

  try {
    showLoader();
    await addDoc(collection(db, "undertakings"), payload); // New Collection
    toast("‚úÖ Undertaking Saved Digitally!");
  } catch(e) {
    console.error(e);
    toast("Error saving digital copy");
  } finally {
    hideLoader();
  }
};










// Add this block anywhere in your <script> section
document.addEventListener('keydown', function(event) {
  // Check if the Enter key was pressed
  if (event.key === 'Enter') {
    // Only trigger if the user is currently looking at the login screen
    const loginWrap = document.querySelector('.login-wrap');
    if (loginWrap && loginWrap.style.display !== 'none') {
      doLogin(); // Calls your existing login function
    }
  }
});

window.togglePass = function() {
  const p = document.getElementById('p');
  const icon = document.getElementById('togglePassword');
  if (p.type === 'password') {
    p.type = 'text';
    icon.textContent = 'üîí'; // Icon changes to indicate "Hide"
  } else {
    p.type = 'password';
    icon.textContent = 'üëÅÔ∏è'; // Icon changes to indicate "Show"
  }
};

// Ensure Enter Key works (This replaces your existing event listener)
document.addEventListener('keydown', function(event) {
  if (event.key === 'Enter') {
    const loginWrap = document.getElementById('loginWrap');
    // Check if login is visible
    if (loginWrap && loginWrap.style.display !== 'none') {
      event.preventDefault(); // Stop default form submission if any
      doLogin();
    }
  }
});

function doLogout() {
  signOut(auth).then(() => {
    toast("Logged out");
    // onAuthStateChanged will handle the UI
  }).catch((error) => {
    console.error(error);
  });
}

/* ------------------------------ Button Bindings ------------------------------ */
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("loginBtn").addEventListener("click", doLogin);
  document.getElementById("logoutBtn").addEventListener("click", doLogout);
});


/* --------------------------------- NAV --------------------------------- */
/* -------------------------------- Undertaking -------------------------------- */
function fillUndertakingFromData(data) {
  // 1. Clear previous
  const fields = ['ut_name', 'ut_empId', 'ut_desig', 'ut_proj', 'ut_license', 'ut_contact', 
                  'ut_model', 'ut_plate', 'ut_asset', 'ut_reg', 'ut_ins', 'ut_km', 
                  'ut_return_by', 'ut_date_receive', 'ut_date_return'];
  fields.forEach(f => {
    const el = document.getElementById(f);
    if(el) el.textContent = '';
  });
  document.querySelectorAll('#undertaking input[type="checkbox"]').forEach(cb => cb.checked = false);

  // 2. Fill Vehicle Details
  document.getElementById('ut_model').textContent = data.category || 'Vehicle'; 
  document.getElementById('ut_plate').textContent = data.vmNo;
  document.getElementById('ut_asset').textContent = data.assetNo;
  document.getElementById('ut_reg').textContent = data.regExp || '';

if (data.regExp) {
    const regDate = new Date(data.regExp);
    if (!isNaN(regDate)) {
      regDate.setMonth(regDate.getMonth() + 1); // Add 1 month
      // Format as YYYY-MM-DD
      const insDateStr = regDate.toISOString().split('T')[0];
      document.getElementById('ut_ins').textContent = insDateStr;
    }
  }

  document.getElementById('ut_km').textContent = '________'; 



let projectDisplay = data.project || ''; // Default to name
  
  // Try to find the full project object
  if (state.projects && data.project) {
      // Check matching Name OR matching ID
      const projObj = state.projects.find(p => 
          p.p_name === data.project || p.p_id === data.project
      ); 
      if (projObj && projObj.p_id) {
          // Format: "[ID] Name"
          projectDisplay = `[${projObj.p_id}] ${projObj.p_name}`;
      }
  }
document.getElementById('ut_proj').textContent = projectDisplay;

  // 3. Logic based on Status
  const isOperation = (data.status === 'In operation');
  const now = new Date();
  const dateStr = now.toLocaleDateString();
  const timeStr = now.toLocaleTimeString();
  if (isOperation) {
    // FILL RECEIVING (Assigned)
    document.getElementById('ut_name').textContent = data.userName || '';
    document.getElementById('ut_empId').textContent = data.empId || '';
    document.getElementById('ut_desig').textContent = data.designation || '';
    document.getElementById('ut_proj').textContent = projectDisplay;
    document.getElementById('ut_contact').textContent = data.contact || '';
    document.getElementById('ut_date_receive').textContent = `Date: ${dateStr} Time: ${timeStr}`;
    document.getElementById('ut_name').textContent = data.userName; // Top right box
  } else {
    // FILL RETURN (Returned)
    // For return, we put the person returning it in the "Returned By" slot
 const contactInfo = data.contact ? ` | Contact: ${data.contact}` : "";
    const returnText = `${data.empId || ''} - ${data.userName || ''}${contactInfo}`;
    
    document.getElementById('ut_return_by').textContent = returnText;
    document.getElementById('ut_date_return').textContent = `Date: ${dateStr} Time: ${timeStr}`;
    
    // Clear receiving section
    document.getElementById('ut_name').textContent = "---";
  }
}
/* -------------------------------- Export PDF Undertaking -------------------------------- */



/* -------------------------------- Users -------------------------------- */
async function loadUsers(){
  if (state.me?.role !== 'SuperAdmin') {
   if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
   state.users = [];
   return;
 }
 if (unsubscribeUsers) unsubscribeUsers();
  unsubscribeUsers = onSnapshot(
    collection(db, COLL_USERS),
   (snap) => {
      state.users = snap.docs.map(d=>({ id:d.id, ...d.data() }));
     renderUsers();
applyAssetFilters();
   },
   (err)=> console.error("Users onSnapshot error:", err)
  );
}


function renderUsers(){
  // Hide or show Users page actions based on role
  if(state.me?.role!=='SuperAdmin'){ return; }
  const tbody = $('#userTbody'); tbody.innerHTML='';
  state.users.forEach(u=>{
    const tr=document.createElement('tr');
tr.innerHTML = `
  <td>${u.username||''}</td>
  <td>${u.role||''}</td>
  <td>
    <button class="page-btn" onclick="openPw('${u.id}','${u.username||''}')">Change Password</button>
    ${
      u.role === 'SuperAdmin'
        ? ''   // üîí No delete button for SuperAdmin
        : `<button class="page-btn" onclick="deleteUser('${u.id}')">Delete</button>`
    }
  </td>`;

    tbody.appendChild(tr);
  });
}


async function addUser(){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can add users'); return; }
  const username = $('#newU').value.trim();
  const password = $('#newP').value.trim();
  const role     = $('#newRole').value;
  if(!username||!password){ toast('Username & Password required'); return; }

  // prevent dup username
  const qSnap = await getDocs(query(collection(db, COLL_USERS), where("username","==",username)));
  if(!qSnap.empty){ toast('Username already exists'); return; }

  await addDoc(collection(db, COLL_USERS), { username, password, role, createdAt: serverTimestamp() });
  $('#newU').value=''; $('#newP').value=''; $('#newRole').value='Viewer';
  await loadUsers();
  toast('User added');
}
window.addUser = addUser;

async function deleteUser(id){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can delete users'); return; }
  if(!confirm('Delete this user?')) return;
  await deleteDoc(doc(db, COLL_USERS, id));
  await loadUsers();
  toast('User deleted');
}
window.deleteUser = deleteUser;
function renderAL6M(){
  const tbody = $('#al6mBody'); 
  tbody.innerHTML = '';

  state.annualLeaveOver6M.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${d.empId||''}</td>
      <td>${d.name||''}</td>
      <td>${d.designation||''}</td>
      <td>${d.project||''}</td>
      <td>${d.vehicleNo||''}</td>
      <td>${d.assetCode||''}</td>
      <td>${d.contact||''}</td>
      <td>${d.joiningDate||''}</td>
      <td>${d.leaveSince||''}</td>
      <td>${d.leaveTill||''}</td>
      <td>${d.status||''}</td>
      <td>${d.remarks||''}</td>
      <td>${d.category||''}</td>
      <td>${d.overstayDays||''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function openPw(id, username){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can change passwords'); return; }
  $('#pwUser').value = id;
  $('#pwNew').value = '';
  $('#pwConfirm').value = '';
  $('#pwModal').style.display='flex';
}
window.openPw = openPw;

function closePw(){ $('#pwModal').style.display='none'; }
window.closePw = closePw;

async function savePw(){
  const id = $('#pwUser').value;
  const np = $('#pwNew').value.trim();
  const cp = $('#pwConfirm').value.trim();
  if(!np){ toast('Enter new password'); return; }
  if(np!==cp){ toast('Passwords do not match'); return; }
  await updateDoc(doc(db, COLL_USERS, id), { password: np });
  closePw();
  await loadUsers();
  toast('Password updated');
}
window.savePw = savePw;


/* ------------------------------- Drivers -------------------------------- 
4. UPGRADED FETCH DRIVERS (Supports ID OR Name)
   ----------------------------------------------------------- */
window.fetchDrivers = async function(direction = null) {
  showLoader();
  try {
    const term = document.getElementById('search').value.trim();

    // A. SEARCH MODE
    if (term.length > 0) {
       // Query 1: Employee ID
       const qId = query(collection(db, COLL_DRIVERS),
         where('empId', '>=', term), where('empId', '<=', term + '\uf8ff'), limit(50));

       // Query 2: Name (Convert input to Title Case first to match DB format)
       const nameTerm = term.replace(/\b\w/g, c => c.toUpperCase());
       const qName = query(collection(db, COLL_DRIVERS),
         where('name', '>=', nameTerm), where('name', '<=', nameTerm + '\uf8ff'), limit(50));

       const [snapId, snapName] = await Promise.all([getDocs(qId), getDocs(qName)]);

       // Merge results
       const results = new Map();
       snapId.forEach(d => results.set(d.id, {id: d.id, ...d.data()}));
       snapName.forEach(d => results.set(d.id, {id: d.id, ...d.data()}));

       state.drivers = Array.from(results.values());
       state.lastDriverDoc = null; 
    } 
    // B. STANDARD PAGINATION MODE
    else {
       let q = query(collection(db, COLL_DRIVERS), orderBy("createdAt", "desc"));
       if (direction === 'next' && state.lastDriverDoc) {
         state.driverPageStack.push(state.lastDriverDoc);
         q = query(q, startAfter(state.lastDriverDoc), limit(state.driverChunkSize));
       } else {
         q = query(q, limit(state.driverChunkSize));
         state.driverPageStack = [];
       }
       const snapshot = await getDocs(q);
       state.drivers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
       if(!snapshot.empty) state.lastDriverDoc = snapshot.docs[snapshot.docs.length - 1];
    }

    state.driverLocalPage = 1;
    applyFilters(); 

  } catch(e) { 
    console.error(e); 
  } finally { 
    hideLoader(); 
  }
};

// 1. Navigation update
// ... existing nav function code ...
window.nav = function(id) {
  // 1. Hide all sections
  $$('.section').forEach(s => s.style.display = 'none');
  
  // 2. Clear actives
  $$('.nav a').forEach(a => a.classList.remove('active'));

  // 3. Show target
  const target = $(`#${id}`);
  if(target) target.style.display = 'block';

  // 4. Highlight Nav (Handle dropdown parent)
  const link = $(`#nav-${id}`);
  if(link) link.classList.add('active');
  // Keep parent active if submenu clicked
  if(id.startsWith('report')) $('#nav-reports').classList.add('active');

  // 5. Loaders
  if(id === 'dashboard') renderDashboard().catch(console.error);
  if(id === 'list') { applyRoleUI(); applyFilters(); }
  if(id === 'projectsSection') { loadProjects(); applyProjFilters(); }
  if(id === 'users') renderUsers();
  if(id === 'al6m') fetchOverstayReport();
  if(id === 'reportRegExp') fetchRegExpiryServer();
  if(id === 'undertaking') { /* ... */ }
  if(id === 'reportActivity') {initReportsUI();}
  // NEW REPORT LOADER

if(id === 'reportRegRenewal') {
     // Don't load data immediately. Just set default dates (e.g., this month)
     setRepDate('month');
  }
};

// Registartion Expiry Function

window.fetchRegExpiryServer = async function() {
  showLoader();
  const tbody = document.getElementById('regReportBody');
  tbody.innerHTML = '<tr><td colspan="7">Scanning database...</td></tr>';

  try {
    // Calculate date 15 days from now
    const today = new Date();
    const threshold = new Date();
    threshold.setDate(today.getDate() + 15);
    const thresholdStr = threshold.toISOString().slice(0, 10); // YYYY-MM-DD

    // Query: Get assets where regExp is populated and less than threshold
    // Note: Firestore string comparison works for ISO dates (YYYY-MM-DD)
    const q = query(
      collection(db, COLL_ASSETS), 
      where("regExp", "<=", thresholdStr),
      where("regExp", "!=", "") // Ensure not empty
    );

    const snap = await getDocs(q);
    const reportData = [];

    snap.forEach(doc => {
      const a = doc.data();
      const expDate = new Date(a.regExp);
      const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
      reportData.push({ ...a, diffDays });
    });

    // Render
    tbody.innerHTML = '';
    reportData.sort((a,b) => a.diffDays - b.diffDays);

    reportData.forEach(a => {
        let statusBadge = a.diffDays < 0 
          ? `<span class="badge b-bad">Expired</span>` 
          : `<span class="badge b-warn">${a.diffDays} Days Left</span>`;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.vmNo || ''}</td>
          <td>${a.assetNo || ''}</td>
          <td>${a.project || ''}</td>
          <td>${a.regNo || ''}</td>
          <td style="font-weight:bold">${a.regExp || ''}</td>
          <td>${a.diffDays}</td>
          <td>${statusBadge}</td>
        `;
        tbody.appendChild(tr);
    });

  } catch (err) {
    console.error(err);
    alert("Error: Ensure you have created the Firestore Index for 'regExp'. Check console for link.");
  } finally {
    hideLoader();
  }
};


window.exportRegReport = function() {
  // Simple Excel Export for the report
  const today = new Date();
  const data = state.assets
    .filter(a => a.regExp && Math.ceil((new Date(a.regExp) - today) / (86400000)) <= 15)
    .map(a => ({
       "VM No": a.vmNo,
       "Asset No": a.assetNo,
       "Project": a.project,
       "Reg Expiry": a.regExp,
       "Days Remaining": Math.ceil((new Date(a.regExp) - today) / (86400000))
    }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Expiry_Report");
  XLSX.writeFile(wb, "Reg_Expiry_Report.xlsx");
};


state.assets = [];
state.assetFiltered = [];
// Function to populate User Dropdown and Auto-fill
window.autoFillUserDetail = function() {
  const selectedEmpId = document.getElementById('a_userSelect').value;
  const user = state.drivers.find(d => d.empId === selectedEmpId);
  if (user) {
    document.getElementById('a_designation').value = user.designation;
    document.getElementById('a_contact').value = user.contact;
  }
};

// Function to populate the User Dropdown when opening the modal
window.openAssetModal = function() {
  // Show the modal first
  const modal = document.getElementById('assetModal');
  if (modal) modal.style.display = 'flex';

  // 1. Populate User Searchable Dropdown List
  // We target the '.list' div inside your new 'a_userDD' container
  const userListDiv = document.querySelector('#a_userDD .list');
  if (userListDiv) {
    // We use state.drivers (or state.data) to fill the searchable list
    userListDiv.innerHTML = state.drivers.map(u => `
      <div class="item" onclick="setDD('a_userDD', '${u.empId}', '${u.empId} - ${u.name}')">
        ${u.empId} - ${u.name}
      </div>
    `).join('');
  }

  // 2. Populate Project Searchable Dropdown List
  // We target the '.list' div inside your new 'a_projectDD' container
const projListDiv = document.querySelector('#a_projectDD .list');
  if (projListDiv) {
    projListDiv.innerHTML = state.projects.map(p => `
      <div class="item" onclick="setDD('a_projectDD', '${p.p_id}', '${p.p_name} (${p.p_id})')">
        ${p.p_name} (${p.p_id})
      </div>
    `).join('');
  }
  
// Add this line where you populate the edit fields:
handleAssetStatusChange();
};


window.editAsset = function (assetId) {
  const asset = state.assets.find(a => a.id === assetId);
  if (!asset) { alert("Asset not found"); return; }

  currentEditAssetId = assetId;
  document.querySelector('#assetModal h3').textContent = "Edit Asset";
  document.getElementById('assetModal').style.display = 'flex';

  // Standard Fields
  document.getElementById('a_vmNo').value = asset.vmNo || '';
  document.getElementById('a_assetNo').value = asset.assetNo || '';
  document.getElementById('a_brand').value = asset.brand || '';
  document.getElementById('a_category').value = asset.category || '';
  document.getElementById('a_regNo').value = asset.regNo || '';
  document.getElementById('a_regExp').value = asset.regExp || '';
  document.getElementById('a_from').value = asset.from || '';
  document.getElementById('a_till').value = asset.till || '';
  document.getElementById('a_status').value = asset.status || 'IDLE';
  document.getElementById('a_shift').value = asset.shift || 'Day';
  document.getElementById('a_remarks').value = asset.remarks || '';

  // Handle User Dropdown
  const userDD = document.getElementById('a_userDD');
  let userDisplay = "Select User (ID - Name)";
  
  if (asset.empId) {
    const driver = state.drivers.find(d => d.empId === asset.empId);
    userDisplay = driver ? `${driver.empId} - ${driver.name}` : `${asset.empId} - ${asset.userName || 'Unknown'}`;
    userDD.dataset.value = asset.empId;
    
    // Auto-fill disabled fields
    document.getElementById('a_designation').value = asset.designation || (driver?.designation || '');
    document.getElementById('a_contact').value = asset.contact || (driver?.contact || '');
    
    // Driver Leave Date
    if (driver && driver.leaveTill) document.getElementById('a_driverLeaveTill').value = driver.leaveTill;
  } else {
    userDD.dataset.value = '';
    document.getElementById('a_designation').value = '';
    document.getElementById('a_contact').value = '';
  }
  userDD.querySelector('.selected').textContent = userDisplay;

  // --- FIX: PROJECT SELECTION BY ID ---
  const projDD = document.getElementById('a_projectDD');
  // Prefer projectId, fall back to project name if old data
  const pId = asset.projectId || ''; 
  const pName = asset.project || '';
  
  // Try to find the project object to get the perfect display string
  // If we have an ID, find by ID. If not, find by Name.
  const projObj = state.projects.find(p => pId ? p.p_id === pId : p.p_name === pName);

  if (projObj) {
    projDD.dataset.value = projObj.p_id; // STORE THE ID
    projDD.querySelector('.selected').textContent = `${projObj.p_name} (${projObj.p_id})`;
  } else if (pName) {
    // Old data without ID
    projDD.dataset.value = ''; // No ID known
    projDD.querySelector('.selected').textContent = pName; 
  } else {
    projDD.dataset.value = '';
    projDD.querySelector('.selected').textContent = 'Select Project';
  }
  
  // Re-populate lists so they are clickable
  openAssetModal(); // This just refreshes the list HTML
};



// Example usage inside your edit function:
// prepareDateInput('joiningDate', driver.joiningDate);

/* ===== Search Dropdown Core (GLOBAL) ===== */

// This makes the function globally accessible to the 'oninput' in your HTML
/* ===== Search Dropdown Core (GLOBAL) - FIXED ===== */
window.filterDD = function(id, type) {
  const dd = document.getElementById(id);
  if (!dd) return; // Safety check

  // 1. Find the input and the list container using CLASSES, not IDs
  const input = dd.querySelector('input') || dd.querySelector('.search-input');
  const panel = dd.querySelector('.list'); // This fixes the "null" error

  if (!panel || !input) return;

  const term = input.value.toLowerCase();
  
  // 2. Select the Data Source
  let list = [];
  if (type === 'user') list = state.users;
  else if (type === 'project') list = state.projects;
  else if (type === 'asset') list = state.assets;
  // New: Handle driver search for reports
  else if (type === 'driver') list = state.drivers; 

  // 3. Filter Data
  const filtered = list.filter(item => {
    // Handle different naming conventions (e.g. Asset uses 'vmNo', Driver uses 'name')
    let val = "";
    if(type === 'project') val = item.p_name || "";
    else if(type === 'asset') val = (item.assetNo || "") + " " + (item.vmNo || ""); 
    else if(type === 'driver') val = (item.name || "") + " " + (item.empId || "");
    else val = item.name || item.username || ""; // Default

    return val.toLowerCase().includes(term);
  });

  // 4. Render Results
  panel.innerHTML = '';
  if(filtered.length === 0) {
      panel.innerHTML = '<div class="item" style="color:#999; cursor:default;">No results found</div>';
  }

  filtered.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    
    // Determine display text and value based on type
    let display = "";
    let value = "";

    if(type === 'asset') {
        display = `[${item.assetNo}] ${item.vmNo}`;
        value = item.id;
    } else if (type === 'driver') {
        display = `[${item.empId}] ${item.name}`;
        value = item.id;
    } else if (type === 'project') {
        display = item.p_name;
        value = item.p_name; // Or p_id if preferred
    } else {
        display = item.name || item.username;
        value = item.id;
    }

    div.textContent = display;

    div.onclick = () => {
      // Set the input text and the hidden data-value
      input.value = display;
      dd.dataset.value = value;
      
      // Hide the panel
      dd.querySelector('.panel').style.display = 'none';
      dd.querySelector('.selected').textContent = display;

      // Handle Auto-Fill for Add Driver Modal (if applicable)
      if (id === 'uUserDD') performAutoFill(item);
    };
    panel.appendChild(div);
  });
  
  // Ensure the panel is visible while typing
  dd.querySelector('.panel').style.display = 'block';
};

// New Helper Function for Auto-fill
function performAutoFill(userItem) {
  // Fill Project
  if (userItem.project) {
    const pDD = document.getElementById('uProjectDD');
    if (pDD) {
      pDD.querySelector('.search-input').value = userItem.project;
      pDD.dataset.value = userItem.project;
    }
  }
// Helper: Converts "farrukh ishfaq" -> "Farrukh Ishfaq"

  // Fill Asset Details (Vehicle No and T-Code)
  const targetAssetId = userItem.assignedAsset || userItem.assetId;
  if (targetAssetId) {
    const asset = state.assets.find(a => a.id === targetAssetId);
    if (asset) {
      // Set Vehicle No Dropdown
      const aDD = document.getElementById('uAssetDD');
      if (aDD) {
        aDD.querySelector('.search-input').value = asset.assetName || asset.name;
        aDD.dataset.value = asset.id;
      }
      // Set T-Code Input
      const tInput = document.getElementById('uTCode');
      if (tInput) {
        tInput.value = asset.assetTCode || asset.tCode || "";
      }
    }
  }
}

// 1. Toggle panel visibility
document.addEventListener('click', (e) => {
  const dd = e.target.closest('.search-dd');
  // Close all other panels
  document.querySelectorAll('.search-dd .panel').forEach(p => {
    if (!dd || p !== dd.querySelector('.panel')) p.style.display = 'none';
  });
  // Toggle current panel
  if (dd && e.target.classList.contains('selected')) {
    const panel = dd.querySelector('.panel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    if (panel.style.display === 'block') panel.querySelector('input').focus();
  }
});

/**
 * Global Utility: Converts "john doe" -> "John Doe"
 */
function toTitleCase(str) {
  if (!str) return "";
  return str.trim().toLowerCase().replace(/\b\w/g, s => s.toUpperCase());
}
window.toTitleCase = toTitleCase; // Explicitly attach to window for safety



window.setDD = function(ddId, value, text) {
  const dd = document.getElementById(ddId);
  if (!dd) return;
  
  // Update the visible text and store the value
  dd.querySelector('.selected').textContent = text;
  dd.dataset.value = value;
  dd.querySelector('.panel').style.display = 'none';

  // --- NEW AUTOFILL LOGIC FOR ASSETS ---
  if (ddId === 'a_userDD') {
    // Find the driver in the global state using the Employee ID (value)
    const driver = state.drivers.find(d => d.empId === value);
    
    if (driver) {
      // Fill the designation and contact fields automatically
      document.getElementById('a_designation').value = driver.designation || '';
      document.getElementById('a_contact').value = driver.contact || '';
    } else {
      // Clear them if no driver is found
      document.getElementById('a_designation').value = '';
      document.getElementById('a_contact').value = '';
    }
  }
if (ddId === 'a_projectDD') {
    // value here should be p.p_name passed from the onclick
    console.log("Project selected:", value); 
  }
};

// 2. Auto-fill Designation and Contact on Selection
window.onAssetUserChange = function() {
  const empId = document.getElementById('a_userSelect').value;
  const driver = state.drivers.find(d => d.empId === empId);
  if (driver) {
    document.getElementById('a_designation').value = driver.designation;
    document.getElementById('a_contact').value = driver.contact;
  } else {
    document.getElementById('a_designation').value = "";
    document.getElementById('a_contact').value = "";
  }
}



window.saveOrUpdateAsset = async function () {
  // 1. Grab values from the Form
  const vmNo = document.getElementById('a_vmNo').value;
  const assetNo = document.getElementById('a_assetNo').value;
const brand = document.getElementById('a_brand').value;
  const category = document.getElementById('a_category').value;
  
  // User Details (Raw input)
  const empId = document.getElementById('a_userDD').dataset.value || "";
  const userText = document.getElementById('a_userDD').querySelector('.selected').textContent;
  const userName = userText.includes("Select User") ? "" : userText.split('-')[1]?.trim(); // Extract name
  const designation = document.getElementById('a_designation').value;
  const contact = document.getElementById('a_contact').value;
  
  const selectedProjId = document.getElementById('a_projectDD').dataset.value || "";
  let projectName = "";
  let projectID = "";


  const regNo = document.getElementById('a_regNo').value;
  const regExp = document.getElementById('a_regExp').value;
  const from = document.getElementById('a_from').value;
  const till = document.getElementById('a_till').value;
  const status = document.getElementById('a_status').value || "IDLE";
  const shift = document.getElementById('a_shift').value || "Day";
  const remarks = document.getElementById('a_remarks').value;


const projectObj = state.projects.find(p => p.p_id === selectedProjId);
  
  if (projectObj) {
    projectName = projectObj.p_name;
    projectID = projectObj.p_id;
  } else {
    // Fallback: If no ID (maybe they didn't touch the dropdown and it was old data), use the text
    const textVal = document.getElementById('a_projectDD').querySelector('.selected').textContent;
    if (textVal !== "Select Project") {
      // Clean up "Name (ID)" format if present
      projectName = textVal.split('(')[0].trim();
    }
  }

  // Validation
  if (!vmNo || !assetNo) {
    alert("Please fill required fields (V/M No and Asset No)");
    return;
  }

let isNew = !currentEditAssetId;
  if (isNew || (state.assets.find(a => a.id === currentEditAssetId)?.assetNo !== assetNo)) {
      showLoader();
      const qCheck = query(collection(db, COLL_ASSETS), where("assetNo", "==", assetNo), limit(1));
      const snapCheck = await getDocs(qCheck);
      hideLoader();
      if (!snapCheck.empty) {
          alert(`‚õî DUPLICATE ERROR: Asset No "${assetNo}" already exists in the system.`);
          return;
      }
  }

const existingAsset = currentEditAssetId ? state.assets.find(a => a.id === currentEditAssetId) : null;
  const hasStatusChanged = !existingAsset || existingAsset.status !== status;  
  // Create a temporary object of the CURRENT form state to fill the undertaking
const formState = {
    category, vmNo, assetNo, regExp, empId, userName, 
    designation, contact, project: projectName, status
  };
  // Helper to fill undertaking UI directly
  fillUndertakingFromData(formState);
const cleanPlate = vmNo.replace(/[^a-zA-Z0-9]/g, "").toLowerCase(); // ad161224
  const numericPlate = vmNo.replace(/\D/g, ""); // 161224
  const searchKeywords = [assetNo.toLowerCase(), vmNo.toLowerCase(), cleanPlate, numericPlate].filter(k => k.length > 2);
  // ---------------------------------------------------------
  // 3. PREPARE DATA FOR FIRESTORE
  // ---------------------------------------------------------

const data = {
    vmNo, assetNo, brand, category, 
    project: projectName, // Save the name to the asset
    projectId: projectID, // NEW: Save the ID to the asset for accuracy
    regNo, regExp, from, till, status, shift, remarks,
    updatedAt: serverTimestamp()
  };


if (status !== 'In operation' && !till) {
    toast("Error: 'Till Date/Time' is required for " + status + " status.", "error");
    document.getElementById('a_till').focus();
    return; // Stop saving
}

  // LOGIC: If Status is "In operation", SAVE user details.
  // If Status is anything else (returned), CLEAR user details.
  if (status === 'In operation') {
    data.empId = empId;
    data.userName = userName; // Save name too for easier logging
    data.designation = designation;
    data.contact = contact;
  } else {
    // CLEAR USER DETAILS IN DB
    data.empId = "";
    data.userName = "";
    data.designation = "";
    data.contact = "";
    
    // Note: We leave 'project' as it might stay on site, but cleared user.
    // If you want to clear project too, uncomment next line:
    // data.project = ""; 
  }

  showLoader();
  try {
    let assetRefId = currentEditAssetId;

    // 4. SAVE TO DB (Assets Collection)
    if (currentEditAssetId) {
      await updateDoc(doc(db, COLL_ASSETS, currentEditAssetId), data);
    } else {
      const ref = await addDoc(collection(db, COLL_ASSETS), data);
      assetRefId = ref.id;
    }

    // 5. SAVE LOG (Full Snapshot in Table Format)
 if (hasStatusChanged|| !currentEditAssetId) {
await addDoc(collection(db, COLL_ASSET_LOGS), {
        parentId: assetRefId,
        type: currentEditAssetId ? "UPDATE" : "CREATE",
        vmNo, assetNo, brand, category,
        empId: formState.empId, userName: formState.userName,
        designation: formState.designation, contact: formState.contact,
        project: projectName, // FIXED: was 'project', now 'projectName'
        regNo, regExp, from, till, status, shift, remarks,
        user: state.me.username,
        timestamp: serverTimestamp()
      });
}

// B. NEW: Check for Registration Renewal
    // We compare form value (regExp) with existing data (existingAsset.regExp)
    if (currentEditAssetId && existingAsset) {
        const oldExp = existingAsset.regExp;
        const newExp = regExp; // from form input

        // If new date is provided AND it is different from old date
        if (newExp && newExp !== oldExp) {
            await addDoc(collection(db, COLL_ASSET_LOGS), {
                parentId: assetRefId,
                type: "REG_RENEWAL", // Specific type for the report
                vmNo, 
                assetNo,
                project: projectName,
                oldRegExp: oldExp,
                newRegExp: newExp, // The expiry date
                remarks: remarks, // Optional: capture remarks made during renewal
                user: state.me.username,
                timestamp: serverTimestamp() // The actual date/time the work was done
            });
        }
    }


    // 6. UPDATE DRIVER STATUS (If applicable)
    // ... (Keep your existing driver update logic here) ...
    const drvStatus = document.getElementById('a_driverStatus').value;
    const drvLeaveTill = document.getElementById('a_driverLeaveTill').value;
    
    if (empId) { // Use the empId we grabbed at the start
      const tech = state.drivers.find(d => d.empId === empId);
      if (tech) {
         // ... (Your existing logic for updating driver goes here) ...
         // Simplified for brevity, ensure you keep the logic from your previous code
        // const projectObj = state.projects.find(p => p.p_name === project);
         const projectWithId = projectObj ? `${projectName} (${projectID})` : projectName;
         
         let driverUpdates = { status: drvStatus };
         
         if (status === 'In operation') {
           driverUpdates.project = projectWithId;
           driverUpdates.vehicleNo = vmNo;
           driverUpdates.assetCode = assetNo;
         } else {
           driverUpdates.project = "";
           driverUpdates.vehicleNo = "";
           driverUpdates.assetCode = "";
         }
         
         // Driver Dates Logic
         if (drvStatus !== 'Active') {
            driverUpdates.leaveSince = till ? till.split('T')[0] : new Date().toISOString().split('T')[0];
            driverUpdates.leaveTill = drvLeaveTill || null;
         } else {
            driverUpdates.leaveSince = null;
            driverUpdates.leaveTill = null;
         }

         await updateDoc(doc(db, COLL_DRIVERS, tech.id), driverUpdates);
         // Only log driver status change if it actually changed
          if (tech.status !== drvStatus) {
            await logStatusChange(tech.id, drvStatus, `Updated via Asset ${assetNo} (${status})`);
          }
      }
    }
fetchDrivers();
fetchAssets();  
    // 7. CLEAN UP & REDIRECT
    resetAssetForm();
    closeAssetModal();
    toast("‚úÖ Saved & Form Generated");
    
    // Redirect to Undertaking Section automatically
    nav('undertaking');

  } catch (err) {
    console.error(err);
    alert("Error saving: " + err.message);
  } finally {
    hideLoader();
  }
};



function prepareDateInput(id, value) {
  const el = document.getElementById(id);
  if (value) {
    el.type = el.id.includes('Time') || el.id.includes('from') || el.id.includes('till') ? 'datetime-local' : 'date';
    el.value = value;
  } else {
    el.type = 'text';
    el.value = '';
  }
}
// 2. Load from Firebase
async function loadProjects() {
// FIND THIS SECTION IN YOUR CODE:
unsubscribeProjects = onSnapshot(collection(db, COLL_PROJECTS), (snap) => {
  state.projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  // FIX: Populate the "Add Asset" Dropdown
  const aProjSelect = document.getElementById('a_project');
  if (aProjSelect) {
    aProjSelect.innerHTML = '<option value="">Select Project</option>'; // Reset
    state.projects.forEach(proj => {
      const opt = document.createElement('option');
      // Use the exact field names from your Projects collection
      const pName = proj.p_name || "Unknown";
      const pId = proj.p_id || "";
      
      opt.value = pName; 
      opt.textContent = pId ? `${pId} - ${pName}` : pName;
      aProjSelect.appendChild(opt);
    });
  }

  renderProjTable();
  updateProjectDropdowns();
fillProjectDD("a_projectDD");
fillProjectDD("driverProjectDD");
updateAssetProjectFilter();
});
}

function fillProjectDD(id) {
  const list = document.querySelector(`#${id} .list`);
  if (!list) return;

  list.innerHTML = "";

  state.projects.forEach(p => {
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = `${p.p_id} - ${p.p_name}`;
    div.onclick = () => setDD(id, p.p_name, div.textContent);
    list.appendChild(div);
  });
}


function updateProjectDropdowns() {
  const filterDropdown = $('#fProject');    // The search filter
  const addFormDropdown = $('#fProjectVal'); // The add driver form
  const editFormDropdown = $('#e_project');  // The edit driver modal

  const optionsHtml = state.projects
    .map(p => {
      const displayString = `${p.p_id}-${p.p_name} `; // Format: Project A (PRJ001)
      return `<option value="${p.p_id}">${displayString}</option>`;
    })
    .join('');

  if (filterDropdown) filterDropdown.innerHTML = '<option value="">All Projects</option>' + optionsHtml;
  if (addFormDropdown) addFormDropdown.innerHTML = '<option value="">Select Project</option>' + optionsHtml;
  if (editFormDropdown) editFormDropdown.innerHTML = '<option value="">Select Project</option>' + optionsHtml;
}
// 3. Filters and Rendering
window.applyProjFilters = function() {
  const term = $('#projSearch').value.toLowerCase();
  const stat = $('#fProjStatus').value;
  state.projPageSize = parseInt($('#projPageSize').value);

  state.projFiltered = state.projects.filter(p => {
    const matchSearch = (p.p_name||'').toLowerCase().includes(term) || (p.p_id||'').toLowerCase().includes(term);
    const matchStatus = !stat || p.status === stat;
    return matchSearch && matchStatus;
  });

  state.projTotalPages = Math.max(1, Math.ceil(state.projFiltered.length / state.projPageSize));
  renderProjTable();
};

function renderProjTable() {
  const tbody = $('#projTbody');
  tbody.innerHTML = '';

  const start = (state.projPage - 1) * state.projPageSize;
  const end = start + state.projPageSize;
  const paged = state.projFiltered.slice(start, end);

  paged.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:bold; color:var(--brand);">${p.p_id || ''}</td>
      <td>${p.p_name || ''}</td>
      <td>${p.p_loc || ''}</td>
      <td>${p.p_div || ''}</td>
      <td>${p.p_date || ''}</td>
      <td>
  <span class="badge ${(p.status || p.p_status) === 'Active' ? 'b-ok' : 'b-warn'}">
    ${p.status || p.p_status || 'N/A'}
  </span>
</td>

      <td>
        ${
          state.me?.role === 'Viewer'
            ? `<button class="btn" onclick="editProject('${p.id}')">Edit</button>`
            : `
              <button class="btn" onclick="editProject('${p.id}')">Edit</button>
              <button class="btn warn" style="margin-left:5px" onclick="deleteProject('${p.id}')">Delete</button>

            `
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Update pagination info
  const info = $('#projPageInfo');
  if(info) info.textContent = `Page ${state.projPage} of ${Math.ceil(state.projFiltered.length / state.projPageSize) || 1}`;
}

// 4. CRUD Operations
window.addProject = async function() {
  const data = {
    p_id: $('#p_id').value,
    p_name: $('#p_name').value,
    p_loc: $('#p_loc').value,
    p_div: $('#p_div').value,
    p_date: $('#p_date').value,
    status: $('#p_status').value,
    createdAt: serverTimestamp()
  };
  await addDoc(collection(db, COLL_PROJECTS), data);
  toast("Project Added!");
  // Clear inputs
  ['p_id','p_name','p_loc','p_div','p_date'].forEach(id => $(`#${id}`).value = '');
};

// 1. Function to open the Edit Card and fill it with data

window.editProject = function(id) {
  const p = state.projects.find(proj => proj.id === id);
  if (!p) return;

  state.editProjDocId = id;

  // Fill the pop-up inputs
  $('#ep_id').value = p.p_id || '';
  $('#ep_name').value = p.p_name || '';
  $('#ep_loc').value = p.p_loc || '';
  $('#ep_div').value = p.p_div || '';
  $('#ep_date').value = p.p_date || '';
  $('#ep_status').value = p.status || 'Active';

  // Show the Modal as a Pop-up
  const modal = $('#projectEditModal');
  modal.style.display = 'flex'; 
};

window.closeProjEdit = function() {
  $('#projectEditModal').style.display = 'none';
  state.editProjDocId = null;
};

window.saveProjUpdate = async function() {
  if (!state.editProjDocId) return;

  const data = {
    p_id: $('#ep_id').value,
    p_name: $('#ep_name').value,
    p_loc: $('#ep_loc').value,
    p_div: $('#ep_div').value,
    p_date: $('#ep_date').value,
    status: $('#ep_status').value
  };

  try {
    showLoader();
    await updateDoc(doc(db, COLL_PROJECTS, state.editProjDocId), data);
    toast("‚úÖ Project updated successfully!");
    closeProjEdit(); // Close the pop-up
  } catch (err) {
    console.error("Update Error:", err);
    toast("‚ùå Update Failed");
  } finally {
    hideLoader();
  }
};


window.deleteProject = async function(id) {
  if (!confirm("Are you sure you want to delete this project?")) return;
  try {
    showLoader();
    await deleteDoc(doc(db, COLL_PROJECTS, id));
    toast("üóëÔ∏è Project deleted");
  } catch (err) {
    toast("‚ùå Delete failed");
  } finally {
    hideLoader();
  }
};

window.gotoProjPage = (p) => {
  if(p < 1 || p > state.projTotalPages) return;
  state.projPage = p;
  renderProjTable();
};

window.exportProjExcel = function() {
  const data = state.projFiltered.map(p => ({
    "Project ID": p.p_id,
    "Project Name": p.p_name,
    "Location": p.p_loc,
    "Division": p.p_div,
    "Creation Date": p.p_date,
    "Status": p.status
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Projects");
  XLSX.writeFile(wb, "Projects_List.xlsx");
};
function updateDriverProjectDropdown() {
  const select = $('#fProjectVal');
  if (!select) return;

  const currentVal = select.value;
  select.innerHTML = '<option value="">Select Project</option>';

  state.projects
    .filter(p => p.p_status === 'Active') // Use p_status
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.p_name;
      // UPDATED: Show Name (ID)
      opt.textContent = `${p.p_name} (${p.p_id})`; 
      select.appendChild(opt);
    });
    
  if(currentVal) select.value = currentVal;
}
function updateDriverFilterDropdown() {
  const filterSelect = document.getElementById('fProject');
  if (!filterSelect) return;

  const currentVal = filterSelect.value;
  filterSelect.innerHTML = '<option value="">All Projects</option>';

  state.projects
    .sort((a, b) => (a.p_name || "").localeCompare(b.p_name || ""))
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.p_name; // Value is Name to match table filtering logic
      opt.textContent = p.p_id ? `${p.p_id} - ${p.p_name}` : p.p_name;
      filterSelect.appendChild(opt);
    });

  if (currentVal) filterSelect.value = currentVal;
}
// --- LISTEN FOR ASSETS ---

async function initCounters() {
  try {
    const assetColl = collection(db, COLL_ASSETS);
    const driverColl = collection(db, COLL_DRIVERS);
    
    const [aSnap, dSnap] = await Promise.all([
      getCountFromServer(assetColl),
      getCountFromServer(driverColl)
    ]);
    
    state.assetTotalCount = aSnap.data().count;
    state.driverTotalCount = dSnap.data().count;
    
    // Update Dashboard KPIs immediately
const kpiAsset = document.getElementById('kpi_asset_total');
    const kpiDriver = document.getElementById('kpi_driver_total');
    if(kpiAsset) kpiAsset.textContent = state.assetTotalCount;
    if(kpiDriver) kpiDriver.textContent = state.driverTotalCount;
    
  } catch(e) { console.error("Counter Init Error", e); }
}


window.applyAssetFilters = function() {
  // We filter state.assets (the current server chunk)
  const fCat = document.getElementById('fAssetCat').value;
  const fProj = document.getElementById('fAssetProject').value;
  const fStatus = document.getElementById('fAssetStatus').value;

  state.filteredAssets = state.assets.filter(a => {
    const mCat = !fCat || a.category === fCat;
    const mProj = !fProj || a.projectId === fProj || a.project === fProj;
    const mStat = !fStatus || a.status === fStatus;
    return mCat && mProj && mStat;
  });

  state.assetLocalPage = 1; 
  renderAssetTable();
};

/* --- ADD: Pagination Control for Assets --- */
// Add these functions to handle Next/Prev for Assets
window.changeAssetPage = function(delta) {
  const newPage = state.assetPage + delta;
  if (newPage >= 1 && newPage <= state.assetTotalPages) {
    state.assetPage = newPage;
    renderAssetTable();
  }
};

function updateAssetProjectFilter() {
  const sel = document.getElementById('fAssetProject');
  if(!sel) return;
  
  const currentVal = sel.value;
  sel.innerHTML = '<option value="">All Projects</option>';
  
  state.projects.forEach(p => {
    const opt = document.createElement('option');
    // Assuming Asset filter checks ID (based on your applyAssetFilters logic)
    opt.value = p.p_id; 
    
    // Display format: "ID - Name"
    const dispId = p.p_id ? `${p.p_id} - ` : '';
    opt.textContent = `${dispId}${p.p_name}`;
    
    sel.appendChild(opt);
  });
   if (currentVal) sel.value = currentVal;
}

// Add this to update the page numbers at the bottom
function updateAssetPagination() {
  const info = document.getElementById('assetPageInfo'); // Ensure this ID exists in your HTML pagination
  if(info) info.textContent = `Page ${state.assetPage} of ${state.assetTotalPages}`;
}


/* --- Inside your deleteAsset function --- */

window.deleteAsset = async function(id) {
  if(!confirm("‚ö†Ô∏è Are you sure? This will delete the Asset AND all its History Logs permanently.")) return;
  
  showLoader();
  try {
    const batch = writeBatch(db);

    // 1. Delete the Asset Document
    const assetRef = doc(db, COLL_ASSETS, id);
    batch.delete(assetRef);

    // 2. Find and Delete all related logs
    // Note: We limit to 450 because batch limit is 500. 
    // If you have >500 logs per asset, you need a recursive delete (rare for this use case).
    const qLogs = query(collection(db, COLL_ASSET_LOGS), where("parentId", "==", id), limit(450));
    const logSnap = await getDocs(qLogs);
    
    logSnap.forEach((logDoc) => {
      batch.delete(logDoc.ref);
    });

    // 3. Commit the Batch (Atomic operation)
    await batch.commit();

    toast("‚úÖ Asset and History Logs deleted successfully.");
  } catch(err) {
    console.error(err);
    alert("Error deleting: " + err.message);
  } finally {
    hideLoader();
  }
};
window.deleteAsset = deleteAsset; 

// Helper function to reset the form for "Best Results" and clean UI
function resetAssetForm() {
  document.querySelector('#assetModal h3').textContent = "Add New Asset";
  currentEditAssetId = null;
  document.querySelectorAll('#assetModal input, #assetModal textarea').forEach(i => i.value = '');
  document.getElementById('a_userDD').dataset.value = '';
  document.getElementById('a_projectDD').dataset.value = '';
  document.querySelector('#a_userDD .selected').textContent = 'Select User (ID - Name)';
  document.querySelector('#a_projectDD .selected').textContent = 'Select Project';
}


window.closeAssetModal = function() {
  document.getElementById('assetModal').style.display = 'none';
resetAssetForm();
}


async function updateAssetDashboardCounts() {
  try {
    // 1. Total Assets
    const coll = collection(db, COLL_ASSETS);
    const snapTotal = await getCountFromServer(coll);
    
    // 2. Status: In Operation
    const qOp = query(coll, where("status", "==", "In operation"));
    const snapOp = await getCountFromServer(qOp);

    // 3. Status: IDLE
    const qIdle = query(coll, where("status", "==", "IDLE"));
    const snapIdle = await getCountFromServer(qIdle);

    // Update UI
    const total = snapTotal.data().count;
    const op = snapOp.data().count;
    const idle = snapIdle.data().count;

    document.getElementById('kpi_asset_total').textContent = total;
    document.getElementById('kpi_asset_sub').textContent = `Op: ${op} | Idle: ${idle}`;
    
  } catch(e) { console.error("Asset Count Error", e); }
}

// 1. GLOBAL TIMERS (The Debouncers)
let assetSearchTimer = null;
let driverSearchTimer = null;

// 2. DEBOUNCE WRAPPERS (Paste these anywhere in your script)
window.debouncedAssetSearch = function() {
  clearTimeout(assetSearchTimer);
  // Wait 800ms after user stops typing before calling server
  assetSearchTimer = setTimeout(() => {
    fetchAssets(null);
  }, 800);
};

window.debouncedDriverSearch = function() {
  clearTimeout(driverSearchTimer);
  driverSearchTimer = setTimeout(() => {
    fetchDrivers(null);
  }, 800);
};

// fetch Assets
window.fetchAssets = async function(direction = null) {
  showLoader();
  try {
    const term = document.getElementById('assetSearch').value.trim();
    
    // A. SEARCH MODE (If text exists)
    if (term.length > 0) {
      // Run two queries in parallel: One for Asset No, One for VM No (Plate)
      const q1 = query(collection(db, COLL_ASSETS), 
         where('assetNo', '>=', term), where('assetNo', '<=', term + '\uf8ff'), limit(50));
      
      const q2 = query(collection(db, COLL_ASSETS), 
         where('vmNo', '>=', term), where('vmNo', '<=', term + '\uf8ff'), limit(50));

      const [snap1, snap2] = await Promise.all([getDocs(q1), getDocs(q2)]);

      // Merge results and remove duplicates (using Map)
      const results = new Map();
      snap1.forEach(d => results.set(d.id, { id: d.id, ...d.data() }));
      snap2.forEach(d => results.set(d.id, { id: d.id, ...d.data() }));

      state.assets = Array.from(results.values());
      state.lastAssetDoc = null; // Disable pagination cursor during search
    } 
    // B. STANDARD PAGINATION MODE (No text)
    else {
      let q = query(collection(db, COLL_ASSETS), orderBy("updatedAt", "desc"));
      if (direction === 'next' && state.lastAssetDoc) {
        state.assetPageStack.push(state.lastAssetDoc);
        q = query(q, startAfter(state.lastAssetDoc), limit(state.assetChunkSize));
      } else {
        q = query(q, limit(state.assetChunkSize));
        state.assetPageStack = [];
      }
      const snapshot = await getDocs(q);
      state.assets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      if (!snapshot.empty) state.lastAssetDoc = snapshot.docs[snapshot.docs.length - 1];
    }

    state.assetLocalPage = 1;
    applyAssetFilters(); // Re-render table

  } catch (err) {
    console.error("Asset Fetch Error:", err);
    alert("Error fetching assets");
  } finally {
    hideLoader();
  }
};


async function updateDriverDashboardCounts() {
  try {
    const coll = collection(db, COLL_DRIVERS);
    
    // Total
    const snapTotal = await getCountFromServer(coll);
    
    // Active
    const qActive = query(coll, where("status", "==", "Active"));
    const snapActive = await getCountFromServer(qActive);

    // Leave
    const qLeave = query(coll, where("status", "==", "On Leave"));
    const snapLeave = await getCountFromServer(qLeave);

    document.getElementById('kpi_driver_total').textContent = snapTotal.data().count;
    document.getElementById('kpi_driver_sub').textContent = `Active: ${snapActive.data().count} | Leave: ${snapLeave.data().count}`;

  } catch(e) { console.error("Driver Count Error", e); }
}







function updateDriverCache(){
  localStorage.setItem("driversCache", JSON.stringify({
    timestamp: Date.now(),
    data: state.drivers
  }));
}





// Disable/enable leaveSince based on status
$('#status').addEventListener('change', function () {
  const status = this.value;
  const returned = $('#leaveSince');

  if (status === 'Active') {
    returned.disabled = true;
    returned.value = '';
  } 
  else if (status === 'Resigned') {
    returned.disabled = false;   // only leaveSince

  } 
  else {
    returned.disabled = false;
  }
});
// Disable/enable leaveSince & leaveTill in EDIT modal
$('#e_status').addEventListener('change', function () {
  const status = this.value;
  const returned = $('#e_leaveSince');
  const leaveTill = $('#e_leaveTill');

  if (status === 'Active') {
    returned.disabled = true;
    leaveTill.disabled = true;
    returned.value = '';
    leaveTill.value = '';
  } else if (status === 'Resigned') {
    returned.disabled = false;   // only leaveSince allowed
    leaveTill.disabled = true;
    leaveTill.value = '';
  } else {
    returned.disabled = false;
    leaveTill.disabled = false;
  }
});

// run once on page load so defaults apply
window.addEventListener('load', () => {
  $('#status').dispatchEvent(new Event('change'));
});


function showLoader() {
  const el = document.getElementById('loaderOverlay');
  el.style.display = 'flex';
  // auto-hide after 20s in case something hangs
  setTimeout(() => hideLoader(), 20000);
}

function hideLoader() {
  const loader = document.getElementById("loaderOverlay");
  if (loader) loader.style.display = "none";
}


/* ------------- Add / Edit / Delete (respect role permissions) ----------- */

async function addEntry() {
  /*if ((state.me?.role || '').toLowerCase() === 'viewer'){ toast('Viewers cannot add'); return; }*/

  try {
    showLoader();

    // 1. Safely grab values using Optional Chaining (?.) to prevent "null" errors
    const empId = $('#empId')?.value.trim();
    const name = toTitleCase($('#name')?.value.trim());
    const designation = $('#designation')?.value;
    const project = document.getElementById('driverProjectDD').dataset.value || "";
    const vehicleNo = $('#vehicleNo')?.value.trim();
    const assetCode = $('#assetCode')?.value.trim();
    const contact = $('#contact')?.value.trim();
    const joiningDate = $('#joiningDate')?.value;
    const leaveSince = $('#leaveSince')?.value;
    const leaveTill = $('#leaveTill')?.value; // Matches the new field
    const status = $('#status')?.value;
    const remarks = $('#remarks')?.value.trim();

    // 2. Validation
    if (leaveSince && joiningDate && new Date(leaveSince) <= new Date(joiningDate)) {
      toast("‚ùå Returned Date must be later than Provided Date");
      return;
    }

    if (!empId || !name || !designation || !joiningDate) {
      toast('Please fill all required fields (ID, Name, Desig, jOINING Date)');
      return;
    }
const isDuplicate = state.drivers.some(d => d.empId.toLowerCase() === empId.toLowerCase());
  if (isDuplicate) {
    alert(`‚ùå Duplicate Error: Employee ID "${empId}" is already registered.`);
    return;
  }
    // 3. Prepare Payload
    let payload = {
      empId, name, designation, project, vehicleNo,
      assetCode, contact,
      joiningDate, leaveSince, status, remarks,
      createdAt: serverTimestamp(),
      invalids: {
        contact: typeof validContact === 'function' ? !validContact(contact) : false,
        assetCode: typeof validassetCode === 'function' ? !validassetCode(assetCode) : false
      },
      leaveSince: leaveSince || null,
      leaveTill: leaveTill || null,
      returnedOnTime: false
    };

    // Auto-cleaning logic based on status
    if (status === "Active") {
      payload.leaveSince = null;
      payload.leaveTill = null;
    } else if (status === "Resigned") {
      payload.leaveTill = null;
    }
const shift = document.getElementById('shift').value;
    // 4. Add to Firestore
    const docRef = await addDoc(collection(db, COLL_DRIVERS), payload);
    
    // Log change
if (typeof logStatusChange === 'function') {
      await logStatusChange(docRef.id, status, remarks, payload);
    }

 

    // 6. üõ†Ô∏è FIXED: Safe Clear Form Logic
    // This list includes all text/date inputs
    const fieldsToClear = [
      'empId', 'name', 'vehicleNo', 'assetCode', 'contact', 
      'joiningDate', 'leaveSince', 'leaveTill', 'remarks'
    ];

    fieldsToClear.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = ''; // Only sets value if element exists
    });

    // Reset dropdowns specifically by ID
    if ($('#designation')) $('#designation').value = '';
    if ($('#fProjectVal')) $('#fProjectVal').value = '';
    if ($('#status')) $('#status').value = 'Active';

    toast('‚úÖ Driver added successfully');

  } catch (err) {
    console.error("Add error:", err);
    toast("‚ùå Failed to add driver. Check console for details.");
  } finally {
    hideLoader();
  }
}

window.addEntry = addEntry;

function openEdit(ix){
  const d = state.filtered[ix]; if(!d) return;
  state.editIndex = ix;
  state.editDocId = d.id;
  $('#e_empId').value = d.empId||'';
  $('#e_name').value = d.name||'';
  $('#e_designation').value = d.designation||'Heavy Duty Driver';
  $('#e_project').value = d.project||'Creation';
$('#e_vehicleNo').value = d.vehicleNo;
$('#e_assetCode').value = d.assetCode;
  $('#e_contact').value = d.contact||'';
$('#e_joiningDate').value = d.joiningDate;
$('#e_leaveSince').value = d.leaveSince;
$('#e_leaveTill').value = d.leaveTill || '';
  $('#e_status').value = d.status||'Active';
  $('#e_remarks').value = d.remarks||'';
  $('#editModal').style.display='flex';
$('#e_status').dispatchEvent(new Event('change'));

}
window.openEdit = openEdit;

function closeEdit(){ $('#editModal').style.display='none'; state.editIndex=null; state.editDocId=null; }
window.closeEdit = closeEdit;

function normalizeDate(v){
  if (!v) return '';
  if (v instanceof Date) return v.toISOString().slice(0,10); // Excel date
  if (typeof v === 'number') return XLSX.SSF.format("yyyy-mm-dd", v); // numeric Excel date
  return String(v).slice(0,10); // already string
}


async function saveEdit(){
 /* if(state.me?.role==='Viewer'){ toast('Viewers cannot edit'); return; }*/


try {
    showLoader();
  const id = state.editDocId;
  if (!id) { toast('No record selected'); return; }

  const joiningDate = $('#e_joiningDate').value;
  const leaveSince = $('#e_leaveSince').value;
  const leaveTill    = $('#e_leaveTill').value;

  let status = $('#e_status').value;

  const prev = state.drivers.find(d => d.id === id);  // ‚¨ÖÔ∏è get previous doc

  const rec = {
    empId: $('#e_empId').value.trim(),
    name: $('#e_name').value.trim(),
    designation: $('#e_designation').value,
    project: $('#e_project').value,
 vehicleNo: $('#e_vehicleNo').value,
  assetCode: $('#e_assetCode').value,
    contact: $('#e_contact').value.trim(),
    joiningDate: $('#e_joiningDate').value,
  leaveSince: $('#e_leaveSince').value,
    leaveTill: $('#e_leaveTill').value || null,
    status,
    remarks: $('#e_remarks').value.trim(),
    invalids: {
      contact: !validContact($('#e_contact').value.trim()),
      assetCode:  !validassetCode($('#e_assetCode').value.trim())
    },
    returnedOnTime: prev?.returnedOnTime || false   // ‚¨Ö keep previous unless updated
  };

if (leaveSince && joiningDate && new Date(leaveSince) <= new Date(joiningDate)) {
    toast("‚ùå Returned Date must be later than Provided Date");
    return;
  }
  if (leaveTill) {
    if (joiningDate && new Date(leaveTill) <= new Date(joiningDate)) {
      toast("‚ùå Leave Till must be later than Provided Date");
      return;
    }
    if (leaveSince && new Date(leaveTill) <= new Date(leaveSince)) {
      toast("‚ùå Leave Till must be later than Returned Date");
      return;
    }
  }

  // üîë Reset fields based on status
  if (status === "Active") {
    // check if returning from On Leave and leaveTill still valid
    if (prev?.status === "On Leave" && prev.leaveTill) {
      const leaveTillDate = new Date(prev.leaveTill);
const grace = 10 * 24 * 60 * 60 * 1000; // 10 days in ms
if (new Date() <= new Date(leaveTillDate.getTime() + grace)) {
  rec.returnedOnTime = true;  // within grace period = on time
}

    }
    rec.leaveSince = null;
    rec.leaveTill = null;
  }
  else if (status === "Resigned") {
    rec.leaveTill = null; // keep only leaveSince
  }

  await logStatusChange(id, status, rec.remarks, rec);
if (prev?.status !== status) {
  await logStatusChange(id, status, rec.remarks);
}


  const idx = state.drivers.findIndex(d => d.id === id);
  if (idx !== -1) state.drivers[idx] = { ...state.drivers[idx], ...rec };

  
  updateDriverCache();
  renderAL6M();
  

  closeEdit();
  toast('Driver updated');
}catch (err) {
    console.error("Edit error:", err);
    toast("‚ùå Failed to update driver");
  } finally {
    hideLoader();
  }
}

window.saveEdit = saveEdit;

/* -----------------------  Log Status Function -------------------- */


async function logStatusChange(driverId, newStatus, remarks="", fullRecord = null) {
  // If fullRecord is not provided, try to find it in state
  let snapshot = fullRecord;
  if (!snapshot) {
    snapshot = state.drivers.find(d => d.id === driverId) || {};
  }

  // Create a clean snapshot object
  const logData = {
    empId: snapshot.empId || '',
    name: snapshot.name || '',
    designation: snapshot.designation || '',
    project: snapshot.project || '',
    vehicleNo: snapshot.vehicleNo || '',
    assetCode: snapshot.assetCode || '',
    contact: snapshot.contact || '',
    joiningDate: snapshot.joiningDate || '',
    leaveSince: snapshot.leaveSince || '',
    leaveTill: snapshot.leaveTill || '',
    status: newStatus, // Ensure we log the status triggering this
    remarks: remarks,
    changedAt: serverTimestamp(),
    changedBy: state.me?.username || "system"
  };

  await addDoc(collection(db, COLL_DRIVERS, driverId, "logs"), logData);
}

/* -----------------------  open log Function -------------------- */



async function openLogs(driverId, driverName) {
  const container = document.getElementById("logsTimeline");
  container.innerHTML = `<div style="text-align:center;padding:20px;">
    <span style="font-size:14px;color:#475569;">‚è≥ Loading Driver Logs...</span>
  </div>`;
  document.getElementById("logsModal").style.display = "flex";
  state.currentLogDriver = { id: driverId, name: driverName };

  const qSnap = await getDocs(
    query(collection(db, COLL_DRIVERS, driverId, "logs"), orderBy("changedAt", "desc"))
  );

  if (qSnap.empty) {
    container.innerHTML = `<div style="padding:20px;text-align:center">No logs found.</div>`;
    return;
  }

  // Build Table HTML
  let html = `<h4>History: ${driverName}</h4>
  <table>
    <thead>
      <tr>
        <th>Date/Time</th>
        <th>Status</th>
        <th>Project</th>
        <th>Vehicle</th>
        <th>Asset Code</th>
        <th>Contact</th>
        <th>Dates (Join/Leave/Till)</th>
        <th>Remarks</th>
        <th>By</th>
      </tr>
    </thead>
    <tbody>`;

  qSnap.forEach(doc => {
    const d = doc.data();
    const date = d.changedAt?.toDate().toLocaleString() || "";
    
    // Combine dates for compactness
    const dates = `Join: ${d.joiningDate||''}<br>Since: ${d.leaveSince||''}<br>Till: ${d.leaveTill||''}`;

    html += `
      <tr>
        <td>${date}</td>
        <td style="font-weight:bold; color:${d.status === 'Active' ? 'green' : 'red'}">${d.status}</td>
        <td>${d.project || '-'}</td>
        <td>${d.vehicleNo || '-'}</td>
        <td>${d.assetCode || '-'}</td>
        <td>${d.contact || '-'}</td>
        <td style="font-size:11px">${dates}</td>
        <td>${d.remarks || ''}</td>
        <td>${d.changedBy || ''}</td>
      </tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}


/* -----------------------  Close log Function -------------------- */

function closeLogs() {
  const modal = document.getElementById("logsModal");
  modal.style.display = "none";
}
window.closeLogs = closeLogs;


/* ----------------------- Remove Row Function -------------------- */

async function removeRow(ix) {
  const d = state.filtered[ix];
  if (!d) return;
  if (!confirm("‚ö†Ô∏è Are you sure? This will delete the Driver AND all their History Logs.")) return;

  try {
    showLoader();
    const batch = writeBatch(db);

    // 1. Delete Driver Document
    const driverRef = doc(db, COLL_DRIVERS, d.id);
    batch.delete(driverRef);

    // 2. Delete Subcollection Logs
    const qLogs = await getDocs(collection(db, COLL_DRIVERS, d.id, "logs"));
    qLogs.forEach((logDoc) => {
      batch.delete(logDoc.ref);
    });

    // 3. Commit
    await batch.commit();

    // Update Local State
    state.drivers = state.drivers.filter(item => item.id !== d.id);
    
    updateDriverCache();
   

    toast("‚úÖ Driver and Logs deleted.");
  } catch (err) {
    console.error("Delete failed", err);
    toast("‚ùå Failed: " + err.message);
  } finally {
    hideLoader();
  }
}
window.removeRow = removeRow;

function handleAssetStatusChange() {
  const status = document.getElementById('a_status').value;
  const tillEl = document.getElementById('a_till');
  
  // Driver elements
  const driverStatusEl = document.getElementById('a_driverStatus');
  const driverLeaveTillEl = document.getElementById('a_driverLeaveTill');

  // --- 1. ASSET LOGIC: Handle "In Operation" vs Others ---
  if (status === 'In operation') {
    tillEl.value = '';
    tillEl.disabled = true;
    tillEl.style.background = '#f1f5f9';
    tillEl.placeholder = "N/A (In Operation)";

    // Force Driver to Active if Asset is in operation
    if (driverStatusEl) driverStatusEl.value = 'Active';
  } else {
    // Re-enable Till Date if status is IDLE, Maintenance, Breakdown, etc.
    tillEl.disabled = false;
    tillEl.style.background = '#fff'; 
    tillEl.placeholder = "üìÖ Till Date/Time";
  }

  // --- 2. DRIVER LOGIC: Toggle Leave Till Date (New Requirement) ---
  if (driverStatusEl && driverLeaveTillEl) {
    const drvStatus = driverStatusEl.value;

    if (drvStatus === 'On Leave') {
      // Enable only for "On Leave"
      driverLeaveTillEl.disabled = false;
      driverLeaveTillEl.style.background = '#fff';
      driverLeaveTillEl.placeholder = "üìÖ Select Date";
    } else {
      // Disable for IDLE, Resign, Transfer, or Active
      driverLeaveTillEl.value = '';
      driverLeaveTillEl.disabled = true;
      driverLeaveTillEl.style.background = '#f1f5f9';
      driverLeaveTillEl.placeholder = "N/A (Only for Leave End Date)";
    }
  }
}

window.handleAssetStatusChange= handleAssetStatusChange;

/* ----------------------- hard refresh -------------------- */



/* ----------------------- Filters, Table & Pagination -------------------- */
window.applyFilters = function() {
  // Filter state.drivers locally
  const term = (document.getElementById('search').value || '').toLowerCase();
  const fDesig = document.getElementById('fDesignation').value;
  const fProj = document.getElementById('fProject').value;
  const fStat = document.getElementById('fStatus').value;

  state.filtered = state.drivers.filter(d => {
    const mSearch = !term || (d.name||'').toLowerCase().includes(term) || (d.empId||'').toLowerCase().includes(term);
    const mDesig = !fDesig || d.designation === fDesig;
    const mProj = !fProj || d.project === fProj;
    const mStat = !fStat || d.status === fStat;
    return mSearch && mDesig && mProj && mStat;
  });

  state.driverLocalPage = 1;
  renderTablePage();
};




window.renderTablePage = function() {
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  
  const start = (state.driverLocalPage - 1) * state.driverPageSize;
  const end = start + state.driverPageSize;
  const pageData = state.filtered.slice(start, end);

  pageData.forEach((d, idx) => {
    // ... [KEEP YOUR EXISTING DRIVER ROW CODE] ...
 const projectObj = state.projects.find(proj => proj.p_name === d.project);
    const projectDisplay = projectObj ? `${d.project} (${projectObj.p_id})` : (d.project || 'N/A');

    const gi = idx; // simple index for edit
    const tr = document.createElement('tr');
    tr.oncontextmenu = (e) => { e.preventDefault(); openLogs(d.id, d.name); };
let actionButtons = `<button class="page-btn" onclick="openEdit(${gi})">Edit</button>`;
    
    if (state.me && state.me.role === 'SuperAdmin') {
       // Passes 'gi' (index) to removeRow, similar to your existing logic
       actionButtons += ` <button class="page-btn warn" onclick="removeRow(${gi})">Delete</button>`;
    }

    tr.innerHTML = `
      <td>${d.empId||''}</td>
      <td>${d.name||''}</td>
      <td>${d.designation||''}</td>
      <td>${projectDisplay}</td> 
      <td>${d.vehicleNo||''}</td>
      <td>${d.assetCode||''}</td>
      <td>${d.contact||''}</td>
      <td>${d.joiningDate||''}</td>
      <td>${d.leaveSince||''}</td>
      <td>${d.leaveTill||''}</td>
      <td>${d.status||''}</td>
      <td>${d.remarks||''}</td>
     <td>${actionButtons}</td>`;
    tbody.appendChild(tr);
  });
  
  // Update Info
  const serverOffset = (state.driverPageStack.length) * state.driverChunkSize;
  const localStart = serverOffset + ((state.driverLocalPage - 1) * state.driverPageSize) + 1;
  const localEnd = Math.min(localStart + state.driverPageSize - 1, serverOffset + state.filtered.length);
  document.getElementById('pageInfo').textContent = `Showing ${localStart}-${localEnd} (Total: ${state.driverTotalCount})`;
}
window.nextDriverPage = function() {
  const maxLocal = Math.ceil(state.filtered.length / state.driverPageSize);
  if (state.driverLocalPage < maxLocal) {
    state.driverLocalPage++;
    renderTablePage();
  } else {
    fetchDrivers('next');
  }
};
window.prevDriverPage = function() {
    if (state.driverLocalPage > 1) { state.driverLocalPage--; renderTablePage(); }
};
/* ------------------------------ Render Asset Page --------------------------- */

window.renderAssetTable = function() {
  const tbody = document.getElementById('assetTbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  // --- LOCAL PAGINATION SLICING ---
  const start = (state.assetLocalPage - 1) * state.assetPageSize;
  const end = start + state.assetPageSize;
  const pageData = state.filteredAssets.slice(start, end);

  pageData.forEach(asset => {
 
     const projectObj = state.projects.find(p => p.p_id === asset.projectId);
    const projectDisplay = projectObj 
      ? `${projectObj.p_name} (${projectObj.p_id})` 
      : (asset.project || '-');

    const empId = asset.empId || '';
    const userName = asset.userName || '';
    const userDisplay = (empId || userName) ? `${empId} - ${userName}` : '‚Äî';

    const tr = document.createElement('tr');
    tr.oncontextmenu = (e) => { e.preventDefault(); openAssetLogs(asset.id, asset.assetNo); };

    tr.innerHTML = `
      <td>${asset.vmNo || ''}</td>
      <td>${asset.assetNo || ''}</td>
      <td>${asset.brand || '-'}</td>
      <td>${asset.category || ''}</td>
      <td style="font-weight:500;">${userDisplay}</td> 
      <td>${asset.designation || ''}</td>
      <td>${asset.contact || ''}</td>
      <td style="font-weight:600; color:var(--brand);">${projectDisplay}</td>
      <td>${asset.regNo || ''}</td>
      <td>${asset.regExp || ''}</td>
      <td>${asset.from || ''}</td>
      <td>${asset.till || ''}</td>
     <td><span class="badge">${asset.status || 'N/A'}</span></td>

      <td>${asset.shift || '-'}</td>
      <td>${asset.remarks || ''}</td>
      <td>
         ${state.me?.role === 'Viewer' 
           ? `<button class="btn info" onclick="editAsset('${asset.id}')" style="padding:4px 8px; font-size:12px;">View</button>` 
           : `<button class="btn info" onclick="editAsset('${asset.id}')" style="padding:4px 8px; font-size:12px;">Edit</button>
              <button class="btn warn" onclick="deleteAsset('${asset.id}')" style="padding:4px 8px; font-size:12px;">Del</button>`}
      </td>`;
    tbody.appendChild(tr);
  });
  
  updateAssetPaginationUI();
};
window.nextAssetPage = function() {
  const totalInChunk = state.filteredAssets.length;
  const maxLocalPage = Math.ceil(totalInChunk / state.assetPageSize);

  if (state.assetLocalPage < maxLocalPage) {
    // 1. Move to next local page
    state.assetLocalPage++;
    renderAssetTable();
  } else {
    // 2. If at end of chunk, Fetch NEXT CHUNK from Server
    // Only if we haven't reached the absolute total
    fetchAssets('next');
  }
};

window.prevAssetPage = function() {
  if (state.assetLocalPage > 1) {
    state.assetLocalPage--;
    renderAssetTable();
  } else {
    // Optional: Logic to go back to previous server chunk (Requires keeping stack history)
    // For now, "First" is the reset.
    toast("At start of current loaded data. Click 'First' to reset.");
  }
};

function updateAssetPaginationUI() {
  const el = document.getElementById('assetPageInfo');
  if(!el) return;
  
  // Calculate "Global" approximate numbers for display
  const serverOffset = (state.assetPageStack.length) * state.assetChunkSize;
  const localStart = serverOffset + ((state.assetLocalPage - 1) * state.assetPageSize) + 1;
  const localEnd = Math.min(localStart + state.assetPageSize - 1, serverOffset + state.filteredAssets.length);
  
  el.innerHTML = `Showing <b>${localStart}-${localEnd}</b> (Total: ${state.assetTotalCount})`;
}

/* ------------------------------ Open Asset Logs --------------------------- */

window.openAssetLogs = async function(assetId, assetNo) {
  const container = document.getElementById("logsTimeline");
  container.innerHTML = `<div style="text-align:center;padding:20px;">‚è≥ Loading Asset Logs...</div>`;
  document.getElementById("logsModal").style.display = "flex";
  
  const qSnap = await getDocs(query(
    collection(db, COLL_ASSET_LOGS), 
    where("parentId", "==", assetId),
    orderBy("timestamp", "desc")
  ));

  let html = `<h4>Asset History: ${assetNo}</h4>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Status</th>
        <th>User</th>
        <th>Project</th>
        <th>Designation</th>
        <th>Contact</th>
        <th>From/Till</th>
        <th>Remarks</th>
        <th>By</th>
      </tr>
    </thead>
    <tbody>`;

  if(qSnap.empty){
     container.innerHTML = `<div style="padding:20px;">No history found.</div>`;
     return;
  }

  qSnap.forEach(doc => {
    const d = doc.data();
    const date = d.timestamp?.toDate().toLocaleString() || "";
    
    html += `
      <tr>
        <td>${date}</td>
        <td><b>${d.status || d.type}</b></td>
        <td>${d.empId ? d.empId + ' - ' : ''}${d.userName || ''}</td>
        <td>${d.project || ''}</td>
        <td>${d.designation || ''}</td>
        <td>${d.contact || ''}</td>
        <td style="font-size:11px">F: ${d.from||''}<br>T: ${d.till||''}</td>
        <td>${d.remarks || ''}</td>
        <td>${d.user || ''}</td>
      </tr>`;
  });
  
  html += `</tbody></table>`;
  container.innerHTML = html;
};
/* ------------------------------ Import/Export --------------------------- */
// Import: allow invalids, mark bad cells (contact/assetCode), include project

window.importExcel = function(){
  const file = $('#excelFile').files[0];
  if(!file){ toast('Choose an Excel file first'); return; }
  const reader = new FileReader();
  reader.onload = async (e)=>{
    try{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);
      let added = 0;

      // Header mapping (expects same names as earlier build; project added)
      // "Employee ID","Proper Name","Designation","Project","Plate No","Asset No","Contact Number","Joining Date","Driver Status","Remarks"
      for(const r of rows){
        const empId  = r['Employee ID'] || '';
        const name   = toTitleCase(r['Proper Name'] || '');
        const designation = r['Designation'] || '';
        const project = r['Project'] || '';
        const vehicleNo= r['Vehicle No'] || '';
        const assetCode = r['Asset No'] || '';
        const contact= r['Contact Number'] || '';
const joiningDate = normalizeDate(r['Joining Date']);
const leaveSince = normalizeDate(r['Leave Since/ Resigned Date']);
const leaveTill    = normalizeDate(r['Leave Till']);
        const status = r['Driver Status'] || '';
        const remarks= r['Remarks'] || '';

        const invalids = { contact: !validContact(contact), assetCode: !validassetCode(assetCode) };
        const payload = {
          empId,name,designation,project,vehicleNo,assetCode,contact,joiningDate,status,remarks,
          invalids,
          createdAt: serverTimestamp(),
          leaveSince: status==='On Leave' ? (new Date()).toISOString().slice(0,10) : null,
	leaveSince: leaveSince || null,

        };
if (status === "Active") {
  payload.leaveSince = null;
  payload.leaveTill = null;
}
else if (status === "Resigned") {
  payload.leaveTill = null; // keep only leaveSince
}


await addDoc(collection(db, COLL_DRIVERS), payload);
        added++;
      }
//Realtime Listener will bring the latest in; cashe will be updated there

      toast(`Import finished: ${added} rows added`);
    }catch(err){ toast('Failed to read Excel: '+err.message); }

  };
  reader.readAsArrayBuffer(file);
};

// Export current filtered to Excel
window.exportExcel = function(){
  const ws = XLSX.utils.json_to_sheet(state.filtered.map(d=>({
    "Employee ID": d.empId,
    "Proper Name": d.name,
    "Designation": d.designation,
    "Project": d.project,
    "Plate No": d.vehicleNo,
    "Asset No": d.assetCode,
    "Contact Number": d.contact,
    "Joining Date": d.joiningDate,
"Leave Since/ Resigned Date": d.leaveSince || "",
"Leave Till": d.leaveTill || "",
    "Driver Status": d.status,
    "Remarks": d.remarks
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "TouchKeys");
  XLSX.writeFile(wb, "touchkeys.xlsx");
};

// Export filtered to PDF
window.exportPDF = function(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'l', unit:'pt', format:'a4'});
  doc.setFontSize(14);
  doc.text("TouchKey - Driver/Operator List", 40, 34);
  const body = state.filtered.map(d=>[
    d.empId,d.name,d.designation,d.project,d.vehicleNo,d.assetCode,d.contact,d.joiningDate,d.leaveSince || "",d.leaveTill || "",d.status,d.remarks
  ]);
  doc.autoTable({
    startY: 50,
    head:[["Emp ID","Name","Designation","Project","TouchKey","assetCode","Contact","Joining Date","Leave Since/ Resigned Date/ Resigned Date","Leave Till","Status","Remarks"]],
    body,
    styles:{fontSize:9,cellPadding:4}
  });
  doc.save("touchkeys.pdf");
};
/* -------------------------------- Leave Overstay Function ----------------------------- */

window.fetchOverstayReport = async function() {
  showLoader();
  try {
    const tbody = document.getElementById('al6mBody');
    tbody.innerHTML = '<tr><td colspan="14">Loading full data from server...</td></tr>';

    // 1. Fetch ALL drivers who are currently 'On Leave'
    const q = query(collection(db, COLL_DRIVERS), where("status", "==", "On Leave"));
    const snap = await getDocs(q);

    state.annualLeaveOver6M = []; // Reset global list
    const today = new Date();

    snap.forEach(doc => {
      const d = { id: doc.id, ...doc.data() };
      
      const leaveSince = d.leaveSince ? new Date(d.leaveSince) : null;
      const leaveTill = d.leaveTill ? new Date(d.leaveTill) : null;
      let category = "";
      let overstayDays = 0;

      // Logic: Check if > 6 months
      if (leaveSince && (today - leaveSince) > (180 * 24 * 60 * 60 * 1000)) {
        category = "Leave > 6 Months";
      }
      // Logic: Check if Overstayed (past Leave Till date)
      else if (leaveTill && today > leaveTill) {
        category = "Overstayed";
        overstayDays = Math.floor((today - leaveTill) / (1000 * 60 * 60 * 24));
      }

      if (category) {
        d.category = category;
        d.overstayDays = overstayDays;
        state.annualLeaveOver6M.push(d);
      }
    });

    renderAL6M(); // Call your existing render function
    toast(`Report Generated: ${state.annualLeaveOver6M.length} drivers found.`);
    
  } catch (err) {
    console.error(err);
    toast("Error generating report");
  } finally {
    hideLoader();
  }
};


// Export On Leave > 6 months to Excel
window.exportAL6mExcel = function(){
  const ws = XLSX.utils.json_to_sheet(state.annualLeaveOver6M.map(d=>({
    "Employee ID": d.empId,
    "Name": d.name,
    "Designation": d.designation,
    "Project": d.project,
    "TouchKey": d.vehicleNo,
    "assetCode": d.assetCode,
    "Contact": d.contact,
    "Joining Date": d.joiningDate,
    "Leave Since/ Resigned Date": d.leaveSince,
    "Leave Till": d.leaveTill,
    "Status": d.status,
    "Remarks": d.remarks,
    "Category": d.category,
    "Overstay Days": d.overstayDays
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "AnnualLeave>6m");
  XLSX.writeFile(wb, "annual_leave_over_6m.xlsx");
};

/* -------------------------------- exportLogsPDF ----------------------------- */

window.exportLogsPDF = function() {
  const { jsPDF } = window.jspdf;
  const container = document.getElementById("logsTimeline");
  if (!container || !container.innerHTML.trim()) {
    alert("‚ö†Ô∏è No logs to export");
    return;
  }

  // Driver details
  const drv = state.currentLogDriver || { id: "Unknown", name: "Unknown" };
  const driverName = drv.name || "Unknown";
  const driverId = drv.id || "Unknown";

  // Create PDF
  const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
  doc.setFontSize(14);
  doc.text(`Driver Logs Report`, 40, 40);
  doc.setFontSize(12);
  doc.text(`Name: ${driverName}`, 40, 60);
  doc.text(`Employee ID: ${driverId}`, 40, 80);

  // Collect logs into rows
  const rows = [];
  container.querySelectorAll("li").forEach(li => {
    const status = li.querySelector("b")?.textContent || "";
    const details = li.querySelector("small")?.textContent || "";
    const remarks = li.querySelector("i")?.textContent || "";
    rows.push([status, details, remarks]);
  });

  // AutoTable
  doc.autoTable({
    startY: 100,
    head: [["Status", "Details", "Remarks"]],
    body: rows,
    styles: { fontSize: 10, cellPadding: 4 },
    headStyles: { fillColor: [30, 58, 138] }
  });

  // Save with driver name & ID in filename
  const safeName = driverName.replace(/\s+/g, "_");
  doc.save(`logs_${safeName}_${driverId}.pdf`);
};

/* ------------------------------ Import/Export ASSET EXCEL --------------------------- */

/* --- HELPER: Date Only (No Time) --- */
function formatDateOnly(v) {
  if (!v) return '';
  
  let dateObj = null;
  // Handle Excel Serial Numbers
  if (typeof v === 'number') {
    dateObj = new Date(Math.round((v - 25569) * 86400 * 1000));
  } 
  // Handle JS Date Objects
  else if (v instanceof Date) {
    dateObj = v;
  }
  // Handle Strings
  else {
    const timestamp = Date.parse(v);
    if (!isNaN(timestamp)) dateObj = new Date(timestamp);
  }

  if (!dateObj) return v;

  // Return YYYY-MM-DD only
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const d = String(dateObj.getDate()).padStart(2, '0');
  
  return `${y}-${m}-${d}`;
}

/* --- HELPER: Robust Date+Time Parser --- */
function formatDateTime(v) {
  if (!v) return '';
  
  let dateObj = null;

  // 1. Handle Excel Serial Numbers (e.g. 45305.54)
  if (typeof v === 'number') {
    // Excel base date is Dec 30, 1899
    dateObj = new Date(Math.round((v - 25569) * 86400 * 1000));
  } 
  // 2. Handle JS Date Objects (if XLSX parsed them)
  else if (v instanceof Date) {
    dateObj = v;
  }
  // 3. Handle Strings
  else {
    const timestamp = Date.parse(v);
    if (!isNaN(timestamp)) dateObj = new Date(timestamp);
  }

  if (!dateObj) return v; // Return raw if parsing failed

  // Return ISO format YYYY-MM-DD HH:mm
  // We manually build it to avoid timezone shifts if possible, or use ISOString
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const d = String(dateObj.getDate()).padStart(2, '0');
  const h = String(dateObj.getHours()).padStart(2, '0');
  const min = String(dateObj.getMinutes()).padStart(2, '0');
  
  return `${y}-${m}-${d} ${h}:${min}`;
}


/* --- PROCESS LOGIC --- */
async function processAssetImport(rows) {
  const groups = {};
  rows.forEach(r => {
    const assetNo = String(r['Asset No'] || r['AssetNo'] || r['asset_no'] || '').trim();
    if (!assetNo) return;

    const vm = r['Vehicle/Machine No'] || r['VM No'] || '';
    const cleanPlate = vm.replace(/[^a-zA-Z0-9]/g, "").toLowerCase();
    const numericPlate = vm.replace(/\D/g, "");

    const entry = {
      vmNo: vm, assetNo: assetNo, category: r['Category'] || 'Machine',
      brand: r['Brand'] || '', project: r['Project'] || '',
      empId: r['User ID'] || r['Employee ID'] || '', userName: r['User Name'] || '',
      designation: r['Designation'] || '', contact: r['Contact'] || '',
      regNo: r['Reg No'] || '', status: r['Status'] || 'IDLE',
      shift: r['Shift'] || 'Day', remarks: r['Remarks'] || '',
      regExp: formatDateOnly(r['Reg Expiry']), from: formatDateTime(r['From']), till: formatDateTime(r['Till']),
      searchKeywords: [assetNo.toLowerCase(), vm.toLowerCase(), cleanPlate, numericPlate].filter(k => k.length > 2)
    };
    if (!groups[assetNo]) groups[assetNo] = [];
    groups[assetNo].push(entry);
  });

  const batchSize = 450; 
  let batch = writeBatch(db);
  let opCount = 0, updatedCount = 0, createdCount = 0;

  for (const assetKey in groups) {
    const list = groups[assetKey];
    // Sort Excel: Newest 'From' date first
    list.sort((a, b) => (new Date(b.from || 0)) - (new Date(a.from || 0)));
    const excelWinner = list[0];
    const excelHistory = list.slice(1);

    const q = query(collection(db, COLL_ASSETS), where("assetNo", "==", assetKey), limit(1));
    const querySnapshot = await getDocs(q);

    let docRef;
    let mainPayload = excelWinner;
    let oldDataToLog = [];

    if (!querySnapshot.empty) {
      const dbDoc = querySnapshot.docs[0];
      const dbData = dbDoc.data();
      docRef = dbDoc.ref;
      
      const excelDate = new Date(excelWinner.from || 0);
      const dbDate = new Date(dbData.from || 0);

      if (excelDate >= dbDate) {
          oldDataToLog.push({ ...dbData, type: "HISTORY_LOG" });
          updatedCount++;
      } else {
          mainPayload = null; // Keep DB as is
          oldDataToLog.push({ ...excelWinner, type: "IMPORT_OLDER_THAN_DB" });
      }
    } else {
      docRef = doc(collection(db, COLL_ASSETS));
      createdCount++;
    }

    if (mainPayload) {
      batch.set(docRef, { ...mainPayload, updatedAt: serverTimestamp() }, { merge: true });
      opCount++;
    }

    // Move everything else to logs
    const logs = [...oldDataToLog, ...excelHistory];
    for (const logItem of logs) {
      const lRef = doc(collection(db, COLL_ASSET_LOGS));
      batch.set(lRef, { parentId: docRef.id, type: logItem.type || "IMPORT_HISTORY", ...logItem, timestamp: serverTimestamp() });
      opCount++;
    }

    if (mainPayload && mainPayload.status === 'In operation' && mainPayload.empId) {
      await updateDriverFromImport(mainPayload);
    }

    if (opCount >= batchSize) { await batch.commit(); batch = writeBatch(db); opCount = 0; }
  }
  if (opCount > 0) await batch.commit();
  hideLoader();
  alert(`‚úÖ Import Complete!\nUpdated: ${updatedCount}\nCreated: ${createdCount}`);
  fetchAssets();
}

async function updateDriverFromImport(assetData) {
  try {
    const q = query(collection(db, COLL_DRIVERS), where("empId", "==", assetData.empId));
    const snap = await getDocs(q);
    
    if (!snap.empty) {
      const driverDoc = snap.docs[0];
      await updateDoc(driverDoc.ref, {
        vehicleNo: assetData.vmNo,
        assetCode: assetData.assetNo,
        project: assetData.project,
        // Reset leave status since they are operating
        leaveSince: null, 
        leaveTill: null,
        status: 'Active' 
      });
      console.log(`Updated Driver ${assetData.empId} with Asset ${assetData.assetNo}`);
    }
  } catch (err) {
    console.error("Failed to update driver from import:", err);
  }
}


// --- IMPORT MODAL STATE ---
let currentImportType = null; // 'asset' or 'driver'
let selectedImportFile = null;

window.openImportModal = function(type) {
  currentImportType = type;
  selectedImportFile = null;
  
  // Update UI
  document.getElementById('importModalTitle').textContent = type === 'asset' ? "Import Assets" : "Import Drivers/Operators";
  document.getElementById('fileNameDisplay').textContent = "Click to browse...";
  document.getElementById('confirmImportBtn').disabled = true;
  document.getElementById('confirmImportBtn').style.opacity = "0.5";
  document.getElementById('universalFileInput').value = ""; // Clear previous
  
  document.getElementById('importModal').style.display = 'flex';
};

window.closeImportModal = function() {
  document.getElementById('importModal').style.display = 'none';
};

// 1. Download Sample Template Logic
window.downloadSampleTemplate = function() {
  let headers = [];
  let filename = "";

  if(currentImportType === 'asset') {
    headers = [
      { "Vehicle/Machine No": "B-101", "Asset No": "AST-001", "Category": "Vehicle", "Brand": "Toyota", "Project": "Gatex", "User Name": "John Doe", "User ID": "EMP123", "Designation": "Driver", "Contact": "0501234567", "Reg No": "DXB-123", "Reg Expiry": "2026-12-31", "Status": "In operation", "From": "2026-01-01 08:00", "Till": "2026-01-01 18:00", "Remarks": "" }
    ];
    filename = "Asset_Import_Template.xlsx";
  } else {
    headers = [
      { "Employee ID": "EMP001", "Proper Name": "Ali Khan", "Designation": "Heavy Duty Driver", "Project": "Gatex", "Vehicle No": "B-101", "Asset No": "AST-001", "Contact Number": "+971500000000", "Joining Date": "2024-01-01", "Leave Since/ Resigned Date": "", "Leave Till": "", "Driver Status": "Active", "Remarks": "Notes here" }
    ];
    filename = "Driver_Import_Template.xlsx";
  }

  const ws = XLSX.utils.json_to_sheet(headers);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Template");
  XLSX.writeFile(wb, filename);
};

// 2. Handle File Selection
window.triggerFileSelect = function() {
  document.getElementById('universalFileInput').click();
};

window.handleFileSelection = function(input) {
  if (input.files && input.files[0]) {
    selectedImportFile = input.files[0];
    document.getElementById('fileNameDisplay').textContent = selectedImportFile.name;
    document.getElementById('confirmImportBtn').disabled = false;
    document.getElementById('confirmImportBtn').style.opacity = "1";
  }
};

// 3. Process the Import
window.processUniversalImport = function() {
  if(!selectedImportFile) return;

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      showLoader();
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      
      // 'cellDates: true' helps parsing dates correctly
      const jsonData = XLSX.utils.sheet_to_json(ws, { cellDates: true });

      if (jsonData.length === 0) throw new Error("File is empty");

      if (currentImportType === 'asset') {
        await processAssetImport(jsonData); // Calls your existing Asset logic
      } else {
        await processDriverImportWrapper(jsonData); // Wrapper for Driver logic
      }
      
      closeImportModal();
      toast("‚úÖ Import Processed Successfully");
    } catch (err) {
      console.error(err);
      alert("Import Failed: " + err.message);
    } finally {
      hideLoader();
    }
  };
  reader.readAsArrayBuffer(selectedImportFile);
};

// Wrapper to make your existing driver import logic work with the new modal
async function processDriverImportWrapper(rows) {
  showLoader();
  let added = 0; let updated = 0;
  
  for(const r of rows){
      const empId = String(r['Employee ID'] || r['User ID'] || '').trim();
      if(!empId) continue;

      const payload = {
        empId, name: toTitleCase(r['Proper Name'] || r['Name'] || ''),
        designation: r['Designation'] || '', project: r['Project'] || '',
        vehicleNo: r['Vehicle No'] || '', assetCode: r['Asset No'] || r['assetCode'] || '',
        contact: r['Contact Number'] || r['Contact'] || '',
        joiningDate: normalizeDate(r['Joining Date']),
        status: r['Driver Status'] || r['Status'] || 'Active',
        remarks: r['Remarks'] || '',
        leaveSince: normalizeDate(r['Leave Since/ Resigned Date']) || null,
        leaveTill: normalizeDate(r['Leave Till']) || null,
        updatedAt: serverTimestamp()
      };

      if (payload.status === "Active") { payload.leaveSince = null; payload.leaveTill = null; }

      // SERVER-SIDE UNIQUE CHECK
      const q = query(collection(db, COLL_DRIVERS), where("empId", "==", empId), limit(1));
      const snap = await getDocs(q);

      if (snap.empty) {
          await addDoc(collection(db, COLL_DRIVERS), { ...payload, createdAt: serverTimestamp() });
          added++;
      } else {
          await updateDoc(snap.docs[0].ref, payload);
          updated++;
      }
  }
  hideLoader();
  alert(`Drivers Processed:\nNew: ${added}\nUpdated Existing: ${updated}`);
  await fetchDrivers(); 
}


window.exportAssetExcel = async function() {
  if (state.filteredAssets.length === 0) {
    toast("No data to export");
    return;
  }

  showLoader(); // Show loader because fetching logs might take a second

  try {
    // 1. Prepare Main Assets Data (Sheet 1)
    const assetData = state.filteredAssets.map(a => ({
      "Vehicle/Machine No": a.vmNo,
      "Asset No": a.assetNo,
      "Brand": a.brand,
      "Category": a.category,
      "Project": a.project,
      "User ID": a.empId || '',
      "User Name": a.userName || '',
      "Designation": a.designation || '',
      "Reg No": a.regNo,
      "Reg Expiry": a.regExp,
      "Status": a.status,
      "Shift": a.shift || 'Day',
      "From": a.from,
      "Till": a.till,
      "Remarks": a.remarks
    }));

    // 2. Fetch Logs for these specific assets (Sheet 2)
    // We get the IDs of all assets currently in the filtered list
    const assetIds = state.filteredAssets.map(a => a.id).filter(id => !!id);
    let logData = [];

    if (assetIds.length > 0) {
      // Fetch logs where parentId is in our current asset list
      // Note: Firestore 'in' query supports max 30 IDs. 
      // If you have hundreds, we fetch all logs and filter locally for better performance.
      const logSnap = await getDocs(collection(db, COLL_ASSET_LOGS));
      
      logData = logSnap.docs
        .map(doc => {
          const d = doc.data();
          return {
            "Asset No": d.assetNo || '',
            "Type": d.type || 'LOG',
            "Project": d.project || '',
            "Status": d.status || '',
            "Shift": d.shift || '',
            "User Name": d.userName || '',
            "From": d.from || '',
            "Till": d.till || '',
            "Log Date": d.timestamp ? d.timestamp.toDate().toLocaleString() : '',
            "Remarks": d.remarks || '',
            "Updated By": d.user || ''
          };
        })
        // Only include logs belonging to the assets currently displayed
        .filter(log => state.filteredAssets.some(a => a.assetNo === log["Asset No"]));
        
      // Sort logs by Date (Newest first)
      logData.sort((a, b) => new Date(b["Log Date"]) - new Date(a["Log Date"]));
    }

    // 3. Create Workbook and add both sheets
    const wb = XLSX.utils.book_new();

    // Sheet 1: Current Assets
    const wsAssets = XLSX.utils.json_to_sheet(assetData);
    XLSX.utils.book_append_sheet(wb, wsAssets, "Current Assets");

    // Sheet 2: Logs
    if (logData.length > 0) {
      const wsLogs = XLSX.utils.json_to_sheet(logData);
      XLSX.utils.book_append_sheet(wb, wsLogs, "Asset History Logs");
    }

    // 4. Download file
    const dateStr = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `Assets_and_Logs_${dateStr}.xlsx`);
    
    toast("‚úÖ Exported with History Logs");

  } catch (error) {
    console.error("Export Error:", error);
    toast("‚ùå Export failed");
  } finally {
    hideLoader();
  }
};

// --- REGISTRATION RENEWAL REPORT LOGIC ---

// 1. Helper to set dates
window.setRepDate = function(mode) {
    const startEl = document.getElementById('rep_start');
    const endEl = document.getElementById('rep_end');
    const today = new Date();
    
    if (mode === 'today') {
        startEl.valueAsDate = today;
        endEl.valueAsDate = today;
    } else if (mode === 'month') {
        // First day of current month
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        startEl.valueAsDate = firstDay;
        endEl.valueAsDate = today;
    }
}

// 2. Fetch Data (On Demand Only)
window.fetchRenewalData = async function() {
    const startVal = document.getElementById('rep_start').value;
    const endVal = document.getElementById('rep_end').value;
    
    if (!startVal || !endVal) {
        alert("Please select a valid date range.");
        return;
    }

    // Convert strings to Date objects for Firestore
    // Start of day
    const startDate = new Date(startVal); 
    startDate.setHours(0,0,0,0);
    
    // End of day
    const endDate = new Date(endVal); 
    endDate.setHours(23,59,59,999);

    showLoader();
    const tbody = document.getElementById('renewalBody');
    tbody.innerHTML = '';
    state.renewalData = []; // Store for export

    try {
        // QUERY: Get logs where type is 'REG_RENEWAL' within range
        // NOTE: This might require a Composite Index in Firestore Console.
        // If it fails, check console for the link to create index.
        const q = query(
            collection(db, COLL_ASSET_LOGS),
            where("type", "==", "REG_RENEWAL"),
            where("timestamp", ">=", startDate),
            where("timestamp", "<=", endDate),
            orderBy("timestamp", "desc")
        );

        const snap = await getDocs(q);
        
        if (snap.empty) {
            tbody.innerHTML = '<tr><td colspan="7">No renewals found in this period.</td></tr>';
        } else {
            snap.forEach(doc => {
                const d = doc.data();
                state.renewalData.push(d); // Save for excel
                
                const doneDate = d.timestamp ? d.timestamp.toDate().toLocaleString() : '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${doneDate}</td>
                    <td>${d.vmNo || ''}</td>
                    <td>${d.assetNo || ''}</td>
                    <td>${d.project || ''}</td>
                    <td style="font-weight:bold; color:green;">${d.newRegExp || ''}</td>
                    <td>${d.remarks || ''}</td>
                    <td>${d.user || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    } catch (err) {
        console.error("Report Error:", err);
        // Fallback for Index error
        if (err.message.includes("index")) {
            alert("‚ö†Ô∏è Index missing. Please check console to create Firestore Index.");
        } else {
            alert("Error fetching report.");
        }
    } finally {
        hideLoader();
    }
};

// 3. Export to Excel
window.exportRenewalExcel = function() {
    if (!state.renewalData || state.renewalData.length === 0) {
        alert("No data to export. Generate the report first.");
        return;
    }
    
    const data = state.renewalData.map(d => ({
        "Renewal Date/Time": d.timestamp ? d.timestamp.toDate().toLocaleString() : '',
        "Vehicle/Machine No": d.vmNo,
        "Asset No": d.assetNo,
        "Project": d.project,
        "Previous Expiry": d.oldRegExp,
        "New Expiry": d.newRegExp,
        "Remarks": d.remarks,
        "Done By": d.user
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Renewal_Report");
    XLSX.writeFile(wb, "Reg_Renewal_History.xlsx");
};


/* -------------------------------- Dashboard ----------------------------- */
let driverChart, operatorChart, projectChart,leaveChart;

function countByStatus(arr){
  const map = {
    "Active":0, "On Leave":0, "Resigned":0, "Transfer":0,
    "IDLE":0, "Others...":0
  };
  arr.forEach(d=>{ if(map[d.status]!=null) map[d.status]++; });
  return map;
}
function countByProject(arr){
  const map = {"Creation":0,"Gatex":0,"Samtech":0,"":0};
  arr.forEach(d=>{
    const v = (d.project||'').trim();
    if(map[v]==null) map[v]=0;
    map[v]++;
  });
  return map;
}
/*--------------------Render Dashboard------------------*/


window.renderDashboard = async function() {
  showLoader(); // Dashboard now fetches counts, so we show the loader

  try {
    const assetColl = collection(db, COLL_ASSETS);
    const drvColl = collection(db, COLL_DRIVERS);
    
    // We will store all our query promises here to run them concurrently
    const promises = [];
    const counts = {};

    // Helper function to queue a count query
    const queueCount = (key, q) => {
      promises.push(
        getCountFromServer(q).then(snap => { counts[key] = snap.data().count; })
      );
    };

    // 1. QUEUE ASSET QUERIES
    queueCount('asset_total', query(assetColl));
    const assetStatuses = ['In operation', 'IDLE', 'Maintenance', 'Scrap', 'Passing Work', 'To be Sold', 'Sold'];
    assetStatuses.forEach(s => queueCount(`ast_stat_${s}`, query(assetColl, where("status", "==", s))));
    
    const assetCats = ['Vehicle', 'Machine', 'Gensets', 'Minor'];
    assetCats.forEach(c => queueCount(`ast_cat_${c}`, query(assetColl, where("category", "==", c))));

    // 2. QUEUE DRIVER QUERIES
    queueCount('drv_total', query(drvColl));
    const drvStatuses = ['Active', 'On Leave', 'Resigned', 'Transfer', 'IDLE'];
    drvStatuses.forEach(s => queueCount(`drv_stat_${s}`, query(drvColl, where("status", "==", s))));

    // 3. QUEUE PROJECT QUERIES (Dynamic based on your active projects)
    state.projects.forEach(p => {
      const pName = p.p_name;
      // Asset count per project
      queueCount(`proj_ast_${pName}`, query(assetColl, where("project", "==", pName)));
    });

    // 4. REGISTRATION EXPIRY QUERIES
    const today = new Date();
    const todayStr = today.toISOString().slice(0, 10);
    const nearDate = new Date();
    nearDate.setDate(today.getDate() + 15);
    const nearStr = nearDate.toISOString().slice(0, 10);

    // Expired: RegExp < Today
    queueCount('reg_expired', query(assetColl, where("regExp", "<", todayStr), where("regExp", "!=", "")));
    // Valid: RegExp > 15 days from now
    queueCount('reg_valid', query(assetColl, where("regExp", ">", nearStr)));

    // EXECUTE ALL QUERIES AT ONCE
    await Promise.all(promises);

    // --- UPDATE KPIs ---
    document.getElementById('kpi_asset_total').textContent = counts['asset_total'] || 0;
    document.getElementById('kpi_asset_sub').textContent = `Op: ${counts['ast_stat_In operation'] || 0} | Idle: ${counts['ast_stat_IDLE'] || 0} | Maint: ${counts['ast_stat_Maintenance'] || 0}`;

    document.getElementById('kpi_driver_total').textContent = counts['drv_total'] || 0;
    document.getElementById('kpi_driver_sub').textContent = `Active: ${counts['drv_stat_Active'] || 0} | On Leave: ${counts['drv_stat_On Leave'] || 0}`;

    // Note: "Near Expiry" requires JS calculation or a specific compound index. 
    // We approximate Total Reg by subtracting Valid and Expired from Total.
    const totalRegAssumed = counts['asset_total'] || 0;
    const expReg = counts['reg_expired'] || 0;
    const validReg = counts['reg_valid'] || 0;
    const nearReg = Math.max(0, totalRegAssumed - expReg - validReg);

    document.getElementById('kpi_reg_total').textContent = totalRegAssumed;
    document.getElementById('kpi_reg_sub').textContent = `Valid: ${validReg} | Expired/Near: ${expReg + nearReg}`;

    // --- PREPARE CHART DATA ---
    const projAssetData = {};
    state.projects.forEach(p => { 
        if(counts[`proj_ast_${p.p_name}`]) projAssetData[p.p_name] = counts[`proj_ast_${p.p_name}`]; 
    });

    const astStatData = {};
    assetStatuses.forEach(s => { if(counts[`ast_stat_${s}`]) astStatData[s] = counts[`ast_stat_${s}`]; });

    const astCatData = {};
    assetCats.forEach(c => { if(counts[`ast_cat_${c}`]) astCatData[c] = counts[`ast_cat_${c}`]; });

    const drvStatData = {};
    drvStatuses.forEach(s => { if(counts[`drv_stat_${s}`]) drvStatData[s] = counts[`drv_stat_${s}`]; });

    // Project Status & Division (These are fast to calculate locally since state.projects is fully loaded)
    const projStatusCount = {};
    const divCount = {};
    state.projects.forEach(p => {
      const s = p.status || 'Unknown';
      const d = p.p_div || 'Unknown';
      projStatusCount[s] = (projStatusCount[s] || 0) + 1;
      divCount[d] = (divCount[d] || 0) + 1;
    });

    // --- RENDER CHARTS ---
    const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 11} } } } };
    
    ['projectAssetChart', 'assetStatusChart', 'opStatusChart', 'assetCatChart', 'projStatusChart', 'projDivChart'].forEach(id => {
      if(charts[id]) charts[id].destroy();
    });

    charts['projectAssetChart'] = new Chart(document.getElementById('projectAssetChart'), {
      type: 'bar',
      data: {
        labels: Object.keys(projAssetData).map(key => `${key} (${projAssetData[key]})`),
        datasets: [{ label: 'Count', data: Object.values(projAssetData), backgroundColor: '#3b82f6' }]
      },
      options: { ...commonOptions, plugins: { legend: { display: false } } }
    });

    charts['assetStatusChart'] = new Chart(document.getElementById('assetStatusChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(astStatData).map(key => `${key} (${astStatData[key]})`),
        datasets: [{ data: Object.values(astStatData), backgroundColor: ['#22c55e','#f59e0b','#ef4444','#64748b','#3b82f6','#a855f7'] }]
      },
      options: commonOptions
    });


// Changed from 'pie' to 'polarArea' with transparent colors for a modern look
    charts['opStatusChart'] = new Chart(document.getElementById('opStatusChart'), {
      type: 'polarArea',
      data: {
        labels: Object.keys(drvStatData).map(key => `${key} (${drvStatData[key]})`),
        datasets: [{ 
          data: Object.values(drvStatData), 
          // Adding transparency (0.7) makes the polar grid lines visible behind the colors
          backgroundColor: [
            'rgba(249, 115, 22, 0.7)', 
            'rgba(139, 92, 246, 0.7)', 
            'rgba(6, 182, 212, 0.7)', 
            'rgba(236, 72, 153, 0.7)'
          ],
          borderColor: ['#f97316','#8b5cf6','#06b6d4','#ec4899'],
          borderWidth: 1
        }]
      },
      options: { 
        ...commonOptions,
        scales: {
          r: { 
            ticks: { display: false } // Hides the background numbers for a cleaner design
          }
        }
      }
    });


 

    charts['assetCatChart'] = new Chart(document.getElementById('assetCatChart'), {
      type: 'pie',
      data: {
        labels: Object.keys(astCatData).map(key => `${key} (${astCatData[key]})`),
        datasets: [{ data: Object.values(astCatData), backgroundColor: ['#f97316','#8b5cf6','#06b6d4','#ec4899'] }]
      },
      options: commonOptions
    });

 // Changed from standard 'pie' to a 180-degree Half-Doughnut
    charts['projStatusChart'] = new Chart(document.getElementById('projStatusChart'), {
      type: 'doughnut',
      data: {
        labels: Object.keys(projStatusCount).map(key => `${key} (${projStatusCount[key]})`),
        datasets: [{ 
          data: Object.values(projStatusCount), 
          backgroundColor: ['#22c55e','#94a3b8','#f59e0b'],
          borderWidth: 2
        }]
      },
      options: { 
        ...commonOptions,
        rotation: -90,        // Starts the chart at the far left
        circumference: 180,   // Cuts the chart exactly in half
        cutout: '65%'         // Makes the ring slightly thinner for elegance
      }
    });

    charts['projDivChart'] = new Chart(document.getElementById('projDivChart'), {
      type: 'bar',
      data: {
        labels: Object.keys(divCount).map(key => `${key} (${divCount[key]})`),
        datasets: [{ label:'Count', data: Object.values(divCount), backgroundColor: '#6366f1' }]
      },
      options: { ...commonOptions, indexAxis: 'y', plugins: { legend: { display: false } } }
    });

  } catch (err) {
    console.error("Dashboard Render Error:", err);
  } finally {
    hideLoader();
  }
}
// Global function to expand chart
window.expandChart = function(chartId) {
  const modal = document.getElementById('chartModal');
  const modalCanvas = document.getElementById('expandedCanvas');
  const sourceChart = charts[chartId];
  
  if(!sourceChart) return;

  modal.style.display = 'flex';
  
  // Destroy previous modal chart if exists
  if(charts['expanded']) charts['expanded'].destroy();

  // Create new chart in modal with same config but bigger
  charts['expanded'] = new Chart(modalCanvas, {
    type: sourceChart.config.type,
    data: sourceChart.config.data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Detailed View', font: { size: 18 } }
      }
    }
  });
 updateAssetDashboardCounts();
};

/*--------------------Activity & Custom Reports------------------*/

// --- 1. Multi-Select Logic ---

// Populate Projects Multi-Select on Load
function initReportsUI() {
  const container = document.getElementById('cont_projects');
  if(!container) return;
  
  container.innerHTML = '';
  // Sort projects for easy finding
  const sorted = [...state.projects].sort((a,b) => (a.p_name||'').localeCompare(b.p_name||''));
  
  sorted.forEach(p => {
    const lbl = document.createElement('label');
    lbl.className = 'option';
    lbl.innerHTML = `<input type="checkbox" value="${p.p_name}"> ${p.p_name} <small style="color:#aaa">(${p.p_id})</small>`;
    container.appendChild(lbl);
  });
}

// Global toggle function for multi-selects
window.toggleMulti = function(id) {
  const el = document.querySelector(`#${id} .options-container`);
  // Close others
  document.querySelectorAll('.options-container').forEach(d => {
    if(d !== el) d.classList.remove('active');
  });
  el.classList.toggle('active');
};

// Close dropdowns when clicking outside
document.addEventListener('click', (e) => {
  if(!e.target.closest('.multi-select')) {
    document.querySelectorAll('.options-container').forEach(d => d.classList.remove('active'));
  }
});

// Helper to get checked values
function getMultiValues(id) {
  const checkboxes = document.querySelectorAll(`#${id} input[type="checkbox"]:checked`);
  return Array.from(checkboxes).map(cb => cb.value);
}

// --- 2. Activity Report Logic (Detailed) ---

window.toggleActSearch = function() {
  // Clear the search dropdown when switching type
  const dd = document.getElementById('act_dd');
  dd.dataset.value = '';
  dd.querySelector('.selected').textContent = 'Type to search...';
}

window.exportDetailedHistory = async function() {
  const type = document.getElementById('act_type').value;
  const id = document.getElementById('act_dd').dataset.value;
  
  if(!id) { alert("Please search and select an entity first."); return; }

  showLoader();
  try {
    const wb = XLSX.utils.book_new();
    let profileData = [];
    let logsData = [];
    let fileName = "";

    if (type === 'asset') {
      // 1. ASSET EXPORT
      const docRef = doc(db, "assets", id);
      const docSnap = await getDoc(docRef);
      if(!docSnap.exists()) throw new Error("Asset not found");
      const a = docSnap.data();
      
      // Profile Sheet
      profileData.push({
        "Asset No": a.assetNo, 
        "VM No": a.vmNo, 
        "Category": a.category,
        "Current Project": a.project, 
        "Current Status": a.status,
        "User": a.userName, 
        "Contact": a.contact,
        "Reg Expiry": a.regExp
      });

      // Logs Sheet
      const qLogs = query(collection(db, "asset_logs"), where("parentId", "==", id), orderBy("timestamp", "desc"));
      const snapLogs = await getDocs(qLogs);
      
      snapLogs.forEach(l => {
        const d = l.data();
        
        // Combine From/Till into one column
        const fromStr = d.from ? d.from : '';
        const tillStr = d.till ? d.till : '';
        const rangeStr = (fromStr || tillStr) ? `From: ${fromStr}\nTill: ${tillStr}` : '-';

        logsData.push({
          "Date": d.timestamp?.toDate().toLocaleString(),
          "Status/Type": d.status || d.type,
          "Project": d.project,
          "User": d.userName,
          "From/Till": rangeStr, // <--- NEW COLUMN
          "Remarks": d.remarks,
          "Updated By": d.user
        });
      });
      fileName = `History_Asset_${a.assetNo}.xlsx`;

    } else {
      // 2. DRIVER EXPORT
      const docRef = doc(db, "drivers", id);
      const docSnap = await getDoc(docRef);
      if(!docSnap.exists()) throw new Error("Driver not found");
      const d = docSnap.data();

      profileData.push({
        "Emp ID": d.empId, 
        "Name": d.name, 
        "Designation": d.designation,
        "Project": d.project, 
        "Vehicle": d.vehicleNo, 
        "Status": d.status
      });

      const qLogs = query(collection(db, "drivers", id, "logs"), orderBy("changedAt", "desc"));
      const snapLogs = await getDocs(qLogs);

      snapLogs.forEach(l => {
        const d = l.data();
        
        // Combine Dates into one column
        const join = d.joiningDate ? `Join: ${d.joiningDate}` : '';
        const since = d.leaveSince ? `Since: ${d.leaveSince}` : '';
        const till = d.leaveTill ? `Till: ${d.leaveTill}` : '';
        // Filter out empty strings and join with newlines
        const dateStr = [join, since, till].filter(Boolean).join('\n');

        logsData.push({
          "Date": d.changedAt?.toDate().toLocaleString(),
          "Status": d.status,
          "Project": d.project,
          "Vehicle": d.vehicleNo,
          "Asset Code": d.assetCode,
          "Dates (Join/Leave/Till)": dateStr, // <--- NEW COLUMN
          "Remarks": d.remarks,
          "Updated By": d.changedBy
        });
      });
      fileName = `History_Driver_${d.empId}.xlsx`;
    }

    // Write Sheets
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(profileData), "Profile");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(logsData), "Activity Logs");
    XLSX.writeFile(wb, fileName);

    toast("‚úÖ Report Downloaded");

  } catch(e) {
    console.error(e);
    alert("Export Failed: " + e.message);
  } finally {
    hideLoader();
  }
};
/* --- SERVER SIDE SEARCH UTILS --- */

// 1. Debounce to prevent too many reads while typing
let searchTimeout;
window.handleServerSearch = function(input) {
  const type = document.getElementById('act_type').value;
  const listContainer = input.parentElement.querySelector('.list');
  const term = input.value.trim();

  // Show panel immediately
  input.closest('.search-dd').querySelector('.panel').style.display = 'block';

  if (!term) {
    listContainer.innerHTML = '<div class="item" style="color:#999">Type to search server...</div>';
    return;
  }

  listContainer.innerHTML = '<div class="item" style="color:#666">üîç Searching...</div>';

  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => {
    executeGlobalSearch(type, term, listContainer, input.closest('.search-dd'));
  }, 600); // Wait 600ms after typing stops
};

// 2. Execute the Search
async function executeGlobalSearch(type, term, listContainer, ddElement) {
  try {
    const collName = type === 'asset' ? 'assets' : 'drivers';
    const results = new Map(); // Use Map to deduplicate by ID

    // SEARCH STRATEGY: Run 2 parallel queries to find matches in different fields
    const promises = [];

    if (type === 'asset') {
      // Query 1: Match Asset No
      promises.push(getDocs(query(collection(db, collName), 
        where('assetNo', '>=', term), where('assetNo', '<=', term + '\uf8ff'), limit(5))));
      
      // Query 2: Match VM No (Plate)
      promises.push(getDocs(query(collection(db, collName), 
        where('vmNo', '>=', term), where('vmNo', '<=', term + '\uf8ff'), limit(5))));
    
    } else {
      // Query 1: Match Emp ID
      promises.push(getDocs(query(collection(db, collName), 
        where('empId', '>=', term), where('empId', '<=', term + '\uf8ff'), limit(5))));

      // Query 2: Match Name (Try Title Case automatically since names are usually stored that way)
      const nameTerm = term.replace(/\b\w/g, c => c.toUpperCase());
      promises.push(getDocs(query(collection(db, collName), 
        where('name', '>=', nameTerm), where('name', '<=', nameTerm + '\uf8ff'), limit(5))));
    }

    // Wait for all queries
    const snapshots = await Promise.all(promises);

    // Merge Results
    snapshots.forEach(snap => {
      snap.forEach(doc => {
        results.set(doc.id, { id: doc.id, ...doc.data() });
      });
    });

    // Render
    listContainer.innerHTML = '';
    if (results.size === 0) {
      listContainer.innerHTML = '<div class="item" style="color:#999">No results found.</div>';
      return;
    }

    results.forEach(item => {
      const div = document.createElement('div');
      div.className = 'item';
      
      if (type === 'asset') {
        div.textContent = `[${item.assetNo}] ${item.vmNo} (${item.status})`;
      } else {
        div.textContent = `[${item.empId}] ${item.name} (${item.designation})`;
      }

      div.onclick = () => {
        ddElement.querySelector('.selected').textContent = div.textContent;
        ddElement.dataset.value = item.id; // Store ID for export
        ddElement.querySelector('.panel').style.display = 'none';
      };
      
      listContainer.appendChild(div);
    });

  } catch (e) {
    console.error(e);
    listContainer.innerHTML = '<div class="item" style="color:red">Error searching.</div>';
  }
}

window.resetActSearch = function() {
  const dd = document.getElementById('act_dd');
  dd.dataset.value = '';
  dd.querySelector('.selected').textContent = 'Type to search...';
  dd.querySelector('input').value = '';
  dd.querySelector('.list').innerHTML = '';
}


// --- 3. Bulk Snapshot Logic (Filtered) ---

window.exportBulkSnapshot = async function() {
  const target = document.getElementById('ms_target').value;
  const projects = getMultiValues('ms_projects');
  const statuses = getMultiValues('ms_status');

  // Warning for empty filters (Potential big read)
  if(projects.length === 0 && statuses.length === 0) {
    if(!confirm("‚ö†Ô∏è No filters selected. This will download ALL data. Continue?")) return;
  }

  showLoader();
  try {
    const collectionName = target === 'assets' ? COLL_ASSETS : COLL_DRIVERS;
    
    // STRATEGY: 
    // Firestore 'in' query supports max 10 items.
    // Also, we cannot chain multiple 'in' arrays on different fields easily.
    // SOLUTION: Fetch based on Project (if < 10 selected) OR fetch all and filter in JS (Memory).
    // Given the request "Cost too much reads", we try to limit reads.
    
    let q = query(collection(db, collectionName));
    let rawDocs = [];

    // Optimization: If projects selected and < 10, use database filter
    if (projects.length > 0 && projects.length <= 10) {
       // Note: Your asset 'project' field stores Name, but in some places ID. 
       // Ensure consistency. Here we filter by the stored string.
       q = query(q, where(target === 'assets' ? 'project' : 'project', 'in', projects));
    }

    const snap = await getDocs(q);
    
    // JS Filtering for remaining conditions
    snap.forEach(doc => {
      const d = doc.data();
      const pName = d.project || ''; // Project Name
      const sName = d.status || '';  // Status

      // Filter Projects (If > 10 were selected, or if we didn't filter in DB)
      if (projects.length > 0 && !projects.includes(pName)) return;

      // Filter Status
      // Handle "In operation" mapping for drivers who might be "Active"
      let passStatus = false;
      if (statuses.length === 0) passStatus = true;
      else {
        if (statuses.includes(sName)) passStatus = true;
        // Map Active/In operation
        if (statuses.includes('In operation') && sName === 'Active') passStatus = true;
      }
      
      if (!passStatus) return;

      rawDocs.push(d);
    });

    if (rawDocs.length === 0) {
      alert("No records matched your filters.");
      hideLoader(); return;
    }

    // Generate Excel
    const data = rawDocs.map(item => {
      if (target === 'assets') {
         return {
           "Asset No": item.assetNo, "VM No": item.vmNo, "Category": item.category,
           "Project": item.project, "Status": item.status, "Reg Exp": item.regExp,
           "User": item.userName, "Designation": item.designation
         };
      } else {
         return {
           "Emp ID": item.empId, "Name": item.name, "Designation": item.designation,
           "Project": item.project, "Status": item.status, "Mobile": item.contact,
           "Vehicle": item.vehicleNo, "Asset": item.assetCode
         };
      }
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), "Filtered Data");
    XLSX.writeFile(wb, `Filtered_${target}_${new Date().toISOString().slice(0,10)}.xlsx`);
    
    toast(`‚úÖ Exported ${data.length} records.`);

  } catch(e) {
    console.error(e);
    alert("Export Error: " + e.message);
  } finally {
    hideLoader();
  }
};

/*--------------------FIletr from status------------------*/
function filterFromStatus(role, status){
  nav('list');
  $('#fStatus').value = status;
  $('#fDesignation').value = '';
  $('#fProject').value = '';
  applyFilters();
  // Then further filter by role:
  state.filtered = state.filtered.filter(role==='driver' ? isDriver : isOperator);
  state.page=1;
  state.totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
  renderTablePage();
}

/*--------------------data Status------------------*/

function setDataStatus(text, color="#475569") {
  const el = document.getElementById("dataStatus");
  if (el) {
    el.textContent = text;
    el.style.color = color;
  }
}


/*--------------------ALERT SYSTEM STATE------------------*/

let alertConfig = {
  emails: [],
  idle_ops: false,
  idle_assets: false,
  reg_exp: false,
  weekly_ops: false,
  weekly_assets: false,
  lastDailySent: "",
  lastWeeklySent: ""
};

const EMAILJS_SERVICE_ID = "service_42kt8rp";
const EMAILJS_TEMPLATE_ID = "template_e0bax7b";

// 1. Load Settings
async function loadAlertSettings() {
  try {
    const docRef = doc(db, "settings", "alertsConfig");
    const snap = await getDoc(docRef);
    if (snap.exists()) {
      alertConfig = { ...alertConfig, ...snap.data() };
      
      // Update UI
      document.getElementById('cfg_idle_ops').checked = alertConfig.idle_ops;
      document.getElementById('cfg_idle_assets').checked = alertConfig.idle_assets;
      document.getElementById('cfg_reg_exp').checked = alertConfig.reg_exp;
      document.getElementById('cfg_weekly_ops').checked = alertConfig.weekly_ops;
      document.getElementById('cfg_weekly_assets').checked = alertConfig.weekly_assets;
      renderEmailList();
    }
  } catch (e) {
    console.error("Failed to load alert settings", e);
  }
}
window.loadAlertSettings = loadAlertSettings;

// 2. Manage Emails
window.addEmailRecipient = function() {
  const email = document.getElementById('newAlertEmail').value.trim();
  if(email && !alertConfig.emails.includes(email)) {
    alertConfig.emails.push(email);
    document.getElementById('newAlertEmail').value = '';
    renderEmailList();
  }
}

window.removeEmail = function(index) {
  alertConfig.emails.splice(index, 1);
  renderEmailList();
}

function renderEmailList() {
  const container = document.getElementById('emailRecipientList');
  container.innerHTML = alertConfig.emails.map((email, idx) => `
    <div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #e2e8f0; font-size:14px;">
      <span>${email}</span>
      <span style="color:var(--bad); cursor:pointer; font-weight:bold;" onclick="removeEmail(${idx})">‚úñ</span>
    </div>
  `).join('');
}

window.saveAlertConfig = async function() {
  alertConfig.idle_ops = document.getElementById('cfg_idle_ops').checked;
  alertConfig.idle_assets = document.getElementById('cfg_idle_assets').checked;
  alertConfig.reg_exp = document.getElementById('cfg_reg_exp').checked;
  alertConfig.weekly_ops = document.getElementById('cfg_weekly_ops').checked;
  alertConfig.weekly_assets = document.getElementById('cfg_weekly_assets').checked;

  try {
    await setDoc(doc(db, "settings", "alertsConfig"), alertConfig);
    toast("‚úÖ Alert Configuration Saved!");
  } catch(e) {
    toast("‚ùå Error saving config");
  }
}

// 3. CORE LOGIC: Evaluate & Send
window.runAlertCheck = async function(force = false) {
  const statusTxt = document.getElementById('alertStatusText');
  if(statusTxt) statusTxt.textContent = "Checking criteria...";

  if (!alertConfig.emails || alertConfig.emails.length === 0) {
    if(statusTxt) statusTxt.textContent = "No recipient emails configured.";
    return;
  }

  const now = new Date();
  const todayStr = now.toISOString().slice(0, 10);
  const isAfter8AM = now.getHours() >= 8;
  const isMonday = now.getDay() === 1;

  // --- A. DAILY 8 AM (IDLE REPORT) ---
  if ((isAfter8AM && alertConfig.lastDailySent !== todayStr) || force) {
    let dailyHtml = `<h2>Daily IDLE Report - ${todayStr}</h2>`;
    let sendDaily = false;

    // IDLE Operators
    if (alertConfig.idle_ops) {
      const idleOps = state.drivers.filter(d => (d.status || "").toLowerCase() === "idle");
      if (idleOps.length > 0) {
        sendDaily = true;
        dailyHtml += `<h3>IDLE Operators</h3>
          <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; text-align: left;">
          <tr style="background:#eff6ff;"><th>SN.</th><th>Employee ID</th><th>Name</th><th>IDLE Since (Days)</th></tr>`;
        
        idleOps.forEach((op, idx) => {
          const days = op.leaveSince ? Math.floor((now - new Date(op.leaveSince)) / 86400000) : "N/A";
          dailyHtml += `<tr><td>${idx+1}</td><td>${op.empId}</td><td>${op.name}</td><td>${days}</td></tr>`;
        });
        dailyHtml += `</table><br>`;
      }
    }

    // IDLE Assets
    if (alertConfig.idle_assets) {
      const idleAssets = state.assets.filter(a => (a.status || "").toLowerCase() === "idle");
      if (idleAssets.length > 0) {
        sendDaily = true;
        dailyHtml += `<h3>IDLE Assets</h3>
          <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; text-align: left;">
          <tr style="background:#fef3c7;"><th>SN.</th><th>Asset Code</th><th>Plate No</th><th>IDLE Since (Days)</th></tr>`;
        
        idleAssets.forEach((ast, idx) => {
          // Fallback to 'till' date or 'updatedAt' to calculate idle days
          const refDate = ast.till ? new Date(ast.till) : (ast.updatedAt ? ast.updatedAt.toDate() : now);
          const days = Math.floor((now - refDate) / 86400000);
          dailyHtml += `<tr><td>${idx+1}</td><td>${ast.assetNo}</td><td>${ast.vmNo}</td><td>${days >= 0 ? days : 0}</td></tr>`;
        });
        dailyHtml += `</table><br>`;
      }
    }

    if (sendDaily) {
      await sendEmail("Daily IDLE Report", dailyHtml);
      alertConfig.lastDailySent = todayStr;
      await setDoc(doc(db, "settings", "alertsConfig"), { lastDailySent: todayStr }, { merge: true });
    }
  }

  // --- B. WEEKLY (MONDAY) ---
  if ((isMonday && alertConfig.lastWeeklySent !== todayStr) || force) {
    let weeklyHtml = `<h2>Weekly Summary Report - ${todayStr}</h2>`;
    let sendWeekly = false;

    if (alertConfig.weekly_assets) {
      sendWeekly = true;
      const counts = { "In operation": 0, "IDLE": 0, "Maintenance": 0, "Passing Work": 0 };
      state.assets.forEach(a => { if(counts[a.status] !== undefined) counts[a.status]++; });

      weeklyHtml += `<h3>Asset Count</h3>
        <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; text-align: center;">
        <tr style="background:#eff6ff;"><th>In Operation</th><th>IDLE</th><th>Maintenance</th><th>Passing Work</th></tr>
        <tr><td>${counts["In operation"]}</td><td>${counts["IDLE"]}</td><td>${counts["Maintenance"]}</td><td>${counts["Passing Work"]}</td></tr>
        </table><br>`;
    }

    if (alertConfig.weekly_ops) {
      sendWeekly = true;
      const counts = { "Active": 0, "On Leave": 0, "IDLE": 0, "Resigned": 0 };
      state.drivers.forEach(d => { if(counts[d.status] !== undefined) counts[d.status]++; });

      weeklyHtml += `<h3>Operator/Driver Count</h3>
        <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%; text-align: center;">
        <tr style="background:#dcfce7;"><th>Active</th><th>On Leave</th><th>IDLE</th><th>Resigned</th></tr>
        <tr><td>${counts["Active"]}</td><td>${counts["On Leave"]}</td><td>${counts["IDLE"]}</td><td>${counts["Resigned"]}</td></tr>
        </table><br>`;
    }

    if (sendWeekly) {
      await sendEmail("Weekly Summary Report", weeklyHtml);
      alertConfig.lastWeeklySent = todayStr;
      await setDoc(doc(db, "settings", "alertsConfig"), { lastWeeklySent: todayStr }, { merge: true });
    }
  }

  // --- C. REGISTRATION ONE-TIME ALERTS ---
  if (alertConfig.reg_exp) {
    const threshold = new Date();
    threshold.setDate(now.getDate() + 15);
    
    for (const a of state.assets) {
      if (!a.regExp) continue;
      
      const expDate = new Date(a.regExp);
      const diffDays = Math.ceil((expDate - now) / 86400000);
      let newAlertStatus = null;

      if (diffDays <= 0) newAlertStatus = "expired";
      else if (diffDays <= 15) newAlertStatus = "near_expiry";

      // If status changed to a critical state and we haven't alerted yet
      if (newAlertStatus && a.lastAlertStatus !== newAlertStatus) {
        const msg = `<h3>Registration Alert</h3>
          <p>Asset <b>${a.assetNo}</b> (${a.vmNo}) registration is currently <b>${newAlertStatus.toUpperCase()}</b>.</p>
          <p>Expiry Date: ${a.regExp}</p>`;
        
        await sendEmail(`Asset ${newAlertStatus}: ${a.assetNo}`, msg);
        
        // Update document to prevent repeating
        await updateDoc(doc(db, "assets", a.id), { lastAlertStatus: newAlertStatus });
      } 
      // Reset if renewed
      else if (diffDays > 15 && a.lastAlertStatus) {
        await updateDoc(doc(db, "assets", a.id), { lastAlertStatus: null });
      }
    }
  }

  if(statusTxt) statusTxt.textContent = "Check complete! Emails sent if criteria were met.";
}

// 4. Send Email Wrapper
async function sendEmail(subject, htmlContent) {
  const emails = alertConfig.emails.join(", ");
  const params = {
    to_email: emails,
    subject: subject,
    message: htmlContent // Make sure your EmailJS template interprets {{message}} as HTML (use {{{message}}} in EmailJS if needed)
  };

  try {
    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
    console.log(`Sent: ${subject}`);
  } catch (e) {
    console.error(`Failed to send ${subject}`, e);
  }
}

/* --------------------------------- Init --------------------------------- */
function onLoad(){
  // restore page size
  const psSel = $('#pageSize');
  const savedPS = localStorage.getItem('pageSize_v2');
  if(savedPS){ psSel.value = savedPS; state.pageSize = parseInt(savedPS,10); }
  psSel.addEventListener('change', ()=>{ localStorage.setItem('pageSize_v2', psSel.value); });

$('#pageSize').addEventListener('change', (e) => {
  state.ASSET_PAGE_SIZE = parseInt(e.target.value);
  fetchAssets(null); // Reload page 1 with new size
});

  // If you want to keep a "logout" function ‚Äî optional
  // window.doLogout = function(){ location.reload(); };

}

window.addEventListener('load', onLoad);

/* Ensure SuperAdmin account exists once at startup */
//await ensureDefaultSuperAdmin();


// Exporting functions to global scope so HTML onclick can find them
window.deleteAsset = deleteAsset;
window.openAssetModal = openAssetModal;
window.saveOrUpdateAsset = saveOrUpdateAsset;
window.closeAssetModal = closeAssetModal;
window.applyAssetFilters = applyAssetFilters;
</script> 
