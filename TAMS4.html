<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TAMS</title>
<link rel="icon" type="image/x-icon" href="logo.ico">

<!-- projects -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase -->
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
  :root{
    --brand:#1e3a8a; --brand-2:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --info:#0ea5e9;
    --bg:#f4f6f9; --card:#ffffff; --text:#0f172a; --muted:#64748b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  
  /* Light blue gradient transition from top to bottom */
  background: linear-gradient(180deg, #e0f2fe 0%, #f1f5f9 100%);
  
  /* This ensures the background stays smooth even when scrolling */
  background-attachment: fixed;
  
  color: var(--text);
}
.dashboard-cards {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.dashboard-cards .card {
  background: #f8fafc;
  border: 1px solid #cbd5e1;
  border-radius: 10px;
  flex: 1 1 200px;
  padding: 16px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}
.dashboard-cards .card h3 {
  font-size: 16px;
  margin-bottom: 8px;
  color: #334155;
}
.dashboard-cards .card p {
  font-size: 20px;
  font-weight: bold;
  color: #1e293b;
}
/* Base card hover effect */
.dashboard-cards .card {
  transition: transform 0.3s, box-shadow 0.3s;
}
/* Pulse animation keyframes */
@keyframes pulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.03); }
  100% { transform: scale(1); }
}

/* Apply on hover */
.dashboard-cards .card:hover {
  animation: pulse 1.2s ease-in-out infinite;
  box-shadow: 0 12px 28px rgba(0,0,0,0.18);
}

/* Light gradient backgrounds */
.card.drivers {
  background: linear-gradient(135deg, #93c5fd, #60a5fa); /* light blue */
  color: #0f172a;
}
.card.operators {
  background: linear-gradient(135deg, #86efac, #34d399); /* light green */
  color: #064e3b;
}
.card.leave {
  background: linear-gradient(135deg, #fde68a, #fbbf24); /* light orange */
  color: #78350f;
}
.card.resigned {
  background: linear-gradient(135deg, #fecaca, #f87171); /* light red */
  color: #7f1d1d;
}

/* Modal Overlay Background */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none; /* Hidden by default */
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

/* Modal Content Box */
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 800px;
  position: relative;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

  /* Login */
  .login-wrap {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: url('background2.jpg') no-repeat center center;
  background-size: cover;
  overflow: hidden;
}

/* Overlay */
.login-wrap::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.5); /* dark overlay */
  z-index: 0;
}

/* Make sure login card stays above overlay */
.login-card {
  position: relative;
  z-index: 1;
}

/* Login Card with Glassmorphism */
.login-card {
  width: 360px;
  padding: 22px;
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.15);   /* semi-transparent white */
  backdrop-filter: blur(12px);             /* glass blur effect */
  -webkit-backdrop-filter: blur(12px);     /* Safari support */
  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  color: #f1f5f9;                          /* light text */
  text-align: center;
}

  .login-card h1{margin:0 0 6px;font-size:20px}
.login-card input {
  width: 100%;
  padding: 12px 14px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
}

.login-btn {
  margin-top: 14px;
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 10px;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
.login-btn:hover {
  transform: scale(1.05);
}
  .login-hint{font-size:12px;color:#94a3b8;margin-top:10px}
.login-logo {
  width: 80px;          /* size of logo */
  height: auto;
  margin-bottom: 15px;
  border-radius: 12px;  /* optional rounded corners */
}

  /* Layout */
  .app {
  display: flex; 
  flex-direction: column; /* Stack top bar above content */
  min-height: 20vh;
}
/* Sidebar (Top Bar) Update */
/* --- SIDEBAR (TOP BAR) --- */
.sidebar {
  width: 100%;
  height: 60px; 
  background: #0A2A6A;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  position: sticky;
  top: 0;
  display: flex;
  flex-direction: row;
  align-items: center; /* Vertically center the brand and nav */
  justify-content:  flex-start;
  z-index: 1000;
  padding: 0 40px; /* Reduced padding for more link space */
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}


.sidebar-footer {
  margin-left: auto; /* THIS IS KEY */
  margin-top: 0;
  padding-top: 0;
  border-top: none;
  display: flex;
  flex-direction: row; /* Align items side by side */
  align-items: center;
  padding-right: 20px;
}

.user-bar {
  flex-direction: row; /* Name and Logout side by side */
  gap: 15px;
  margin-bottom: 0;
}

#userLabel {
  color: #ffffff !important;
  font-size: 0.9rem;
  font-weight: 500;
  opacity: 1;	
margin-bottom: 5px;
}

/* Professional Signature */
.owner-claim {
  margin-top: 15px;
  font-size: 10px;
  color: rgba(255, 255, 255, 0.4);
  line-height: 1.3;
}

/* Adjust button sizes for sidebar fit */
.sidebar .btn {
  padding: 6px 15px;
  font-size: 12px;
  width: fit-content; /* Prevents buttons from taking full width */
}
/* --- NAVIGATION MENU --- */
.nav {
  display: flex;           
  flex-direction: row;
  margin-left: 50px; /* Space between logo and first link */
  height: 70px;      /* Explicit height to match sidebar */
  align-items: center;
}

.nav a {
  text-decoration: none !important;
  color: rgba(255, 255, 255, 1);
  display: flex !important;   /* Force flex */
  align-items: center !important;
  justify-content: center;
  height: 100%;             
  padding: 0 10px;
  font-size: 16px;            /* Slightly smaller to fit many links */
  font-weight: 400;
 // transition: all 0.3s ease;
  position: relative;
  white-space: nowrap;        /* Prevent text from breaking into 2 lines */
}
.nav a.active {
  color: #ffffff !important;
  /* CHANGE 2: Make it BOLD only when active */
  font-weight: 800; 
  background: rgba(255, 255, 255, 0.1);
}
/* --- ACTIVE LINK INDICATOR --- */
.nav a.active::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 10%;
  width: 80%;
  height: 2px;
  background: #60a5fa;
  border-radius: 4px 4px 0 0;
  box-shadow: 0 -2px 10px rgba(96, 165, 250, 0.5);
}
/* --- MAIN CONTENT TRANSITION --- */
.content {
  padding: 40px 60px;
  animation: slideUp 0.6s ease-out;
  margin-left: 0;
  flex: 1;
  color: #1e293b;
  font-weight: 400; /* Change from 600 to 400 (Normal) */
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Specifically target table data to make it stand out */
td {
  color: #0f172a;
  font-weight: 400; /* Change from 700 to 400 (Normal) */
}
/* Target Labels to make them look professional */
label {
  display: block;
  margin-bottom: 5px;
  color: var(--brand); /* Uses your blue brand color */
  font-weight: 800; /* Extra bold for headers/labels */
  font-size: 13px;
  text-transform: uppercase;
}
input, select, textarea {
  color: #1e293b !important;
  font-weight: 400 !important;
  border: 1.5px solid #cbd5e1; /* Thicker border to match the bold text */
}

/* Makes placeholder text slightly lighter but still visible */
input::placeholder {
  font-weight: 400;
  color: #94a3b8;
}
  .footer{position:fixed;right:12px;bottom:8px;font-size:12px;color:#475569}
  /*.user-info{position:absolute;top:10px;right:20px;font-size:14px;font-weight:600;color:#1e293b}*/
.user-bar {
  display: flex;
  align-items: center;
  gap: 15px;           /* space between username & button */
  margin-bottom: 10px; /* space below, before Dashboard */
}
.user-bar #userLabel {
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
}

  /* Cards / Grid */
  .grid{display:grid;gap:16px}
  .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:1100px){.grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:700px){.grid-4,.grid-2{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,.06);padding:16px}
  .kpi{display:flex;justify-content:space-between;align-items:center}
  .kpi .big{font-size:30px;font-weight:800}
  .kpi small{color:var(--muted)}
  .kpi .badge{padding:6px 10px;border-radius:999px;font-size:12px}
  .b-ok{background:rgba(22,163,74,.12);color:var(--ok)}
  .b-warn{background:rgba(245,158,11,.12);color:var(--warn)}
  .b-bad{background:rgba(239,68,68,.12);color:var(--bad)}
  .b-info{background:rgba(14,165,233,.12);color:var(--info)}

  /* Toolbar */
  .toolbar {
  display: flex;
  justify-content: space-between; /* Pushes groups apart */
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}
.toolbar-left, .toolbar-right {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

.date-range-group {
    display: flex;
    align-items: center;
    gap: 5px;
    background: #fff;
    padding: 5px;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
}
.spacer {
  margin-right: auto;
}
  .toolbar input,.toolbar select{padding:10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:var(--brand-2);color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#0ea5e9}
  .btn.warn{background:#ef4444}

  /* Table */
  .table-wrap{overflow:auto;background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,.06)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:center}
  thead th{position:sticky;top:0;background:#eff6ff;font-weight:700}

  /* Pagination */
  .pagination{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:10px}
  .page-btn{padding:8px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
  .page-btn[disabled]{opacity:.5;cursor:not-allowed}
  .page-size{margin-left:auto}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
  .modal .dialog{background:#fff;border-radius:14px;max-width:720px;width:95%;padding:16px}
  .dialog h3{margin-top:0}
  .dialog .grid-2{gap:10px}
  .dialog input,.dialog select{width:100%;padding:10px;border-radius:10px;border:1px solid #cbd5e1}
  .dialog .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

 
@media print {
  body * {
    visibility: hidden; /* hide everything */
  }
}
 .search-dd {
  position: relative;
  width: 100%;
}

.search-dd .selected {
  padding: 10px;
  border: 1.5px solid #cbd5e1;
  border-radius: 10px;
  background: #fff;
  cursor: pointer;
}

.search-dd .panel {
  position: absolute;
  top: 110%;
  width: 100%;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  z-index: 5000;
  display: none;
}

.search-dd input {
  width: 100%;
  padding: 8px 10px;
  border: none;
  border-bottom: 1px solid #e2e8f0;
  outline: none;
}

.search-dd .list {
  max-height: 220px;
  overflow-y: auto;
}

.search-dd .item {
  padding: 8px 10px;
  cursor: pointer;
}

.search-dd .item:hover {
  background: #eff6ff;
}
/* Styling the Date/Time inputs to look like your text inputs */
input[type="text"], 
input[type="date"], 
input[type="datetime-local"] {
  height: 42px;
  padding: 8px 12px;
  border: 1.5px solid #cbd5e1;
  border-radius: 10px;
  font-size: 14px;
  width: 100%;
  box-sizing: border-box;
}

/* Ensures the calendar icon inside the native picker stays on the right */
input::-webkit-calendar-picker-indicator {
  cursor: pointer;
  filter: invert(0.5); /* Makes the icon subtle */
}

input:focus {
    border-color: #3b82f6 !important;
    outline: none;
    background-color: #f0f7ff;
}
/* Increase width of the Asset Modal Card */
#assetModal .modal-content {
    max-width: 1000px; /* Increased from default (usually 500px-600px) */
    width: 95%;      /* Responsive for smaller screens */
    padding: 10px;   /* Added padding for a cleaner look */
}

/* Optional: Adjust grid gap for better spacing with the new width */
#assetModal .grid-4 {
    gap: 10px;
    grid-template-columns: repeat(4, 1fr);
}

/* --- UNDERTAKING FORM STYLES --- */
.undertaking-paper {
  background: white;
  width: 210mm; /* A4 Width */
  min-height: 297mm;
  padding: 10mm;
  margin: 0 auto;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
  color: #000;
  font-family: 'Times New Roman', serif;
}
.ut-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
.ut-header h2, .ut-header h3 { margin: 2px 0; text-transform: uppercase; }
.ut-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.ut-box { border: 1px solid #000; padding: 5px; }
.ut-row { display: flex; justify-content: space-between; margin-bottom: 4px; border-bottom: 1px dotted #ccc; }
.ut-label { font-weight: bold; font-size: 12px; }
.ut-val { font-weight: normal; font-size: 13px; }
.checklist-grid { display: grid; grid-template-columns: 1fr 1fr; border: 1px solid #000; margin-top: 10px; }
.cl-header { font-weight: bold; border-bottom: 1px solid #000; padding: 5px; background: #eee; text-align: center; }
.cl-item { border-bottom: 1px solid #ccc; padding: 2px 5px; font-size: 11px; display: flex; justify-content: space-between; }
.ut-section-title { background: #000; color: #fff; padding: 2px 5px; font-weight: bold; margin-top: 10px; font-size: 12px; }
.ut-footer-row { display: flex; justify-content: space-between; margin-top: 30px; }
.ut-sig-box { width: 45%; border-top: 1px solid #000; padding-top: 5px; text-align: center; }

@media print {
  @page { size: A4; margin: 0; }
  body * { visibility: hidden; }
  #undertaking, #undertaking * { visibility: visible; }
  #undertaking { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
  .undertaking-paper { box-shadow: none;-webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important; width: 100%; margin: 0; padding: 10mm; }
  .no-print { display: none !important; }
}
/* --- Editable Text Areas for Print --- */
.writable-input {
  width: 100%;
  border: 1px dashed #ccc; /* Dashed border on screen to show where to type */
  background: rgba(255, 255, 255, 0.5);
  font-family: 'Times New Roman', serif; /* Match form font */
  font-size: 12px;
  resize: none; /* Disable resizing */
  outline: none;
  padding: 5px;
  box-sizing: border-box;
  overflow: hidden;
}

@media print {
  .writable-input {
    border: none; /* Hide the dashed border when printing */
    background: transparent;
    padding: 0;
  }
  /* Ensure placeholders don't print (browsers usually hide them, but just in case) */
  .writable-input::placeholder {
    color: transparent;
  }
}
/* Apply uniform sizing ONLY to the Asset Modal fields */
#assetModal input, 
#assetModal select, 
#assetModal textarea, 
#assetModal .search-dd .selected {
  width: 100% !important;
  height: 40px !important; /* Forces all boxes to the same height */
  padding: 8px 12px !important;
  font-size: 14px !important;
  border: 1px solid #cbd5e1 !important;
  border-radius: 6px !important;
  box-sizing: border-box !important;
  display: flex !important;
  align-items: center !important;
  background-color: white;
}

/* Specific handling for the remarks box so it starts at the same height */
#assetModal textarea {
  min-height: 40px;
  max-height: 120px; /* Allows it to grow if they type a lot */
  resize: vertical;
  line-height: 1.4;
}

/* Ensures labels don't push the boxes out of alignment */
#assetModal label {
  display: block;
  margin-bottom: 4px;
  font-size: 11px;
  font-weight: 700;
  color: #475569;
  text-transform: uppercase;
}

/* Special alignment for the search dropdown text to match standard inputs */
#assetModal .search-dd .selected {
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* Update the Log Modal to be wider for tables */
#logsModal .dialog {
  max-width: 1100px; /* Increased from default */
  width: 95%;
}

/* Scrollable table within logs */
#logsTimeline {
  max-height: 60vh;
  overflow: auto;
}

#logsTimeline table {
  width: 100%;
  border-collapse: collapse;
  font-size: 12px;
}

#logsTimeline th, #logsTimeline td {
  border: 1px solid #e2e8f0;
  padding: 8px;
  text-align: left;
}

#logsTimeline th {
  background: #eff6ff;
  position: sticky;
  top: 0;
}
/* Watermark Styling */
.undertaking-paper {
  position: relative;
  background-color: #white;
}

.undertaking-paper::before {
  content: "";
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  /* Replace 'NPClogo.png' with your watermark file */
  background-image: url('NPClogo.png'); 
  background-repeat: no-repeat;
  background-position: center center;
  background-size: 500px; /* Adjust size of watermark here */
  opacity: 0.12; /* Controls how faint the watermark is (0.1 is 10%) */
  pointer-events: none; /* Ensures you can still click/select text */
  z-index: 0;
}

/* Ensure the content stays above the watermark */
.ut-header, .ut-body, .ut-footer, table {
  position: relative;
  z-index: 1;
}
/* --- NEW: Dropdown Menu in Sidebar --- */
.nav-item { position: relative; display: flex; align-items: center; height: 100%; }
.dropdown-content {
  display: none;
  position: absolute;
  top: 60px; /* Below the navbar */
  left: 0;
  background-color: #0A2A6A; /* Match Sidebar */
  min-width: 220px;
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  z-index: 2000;
  border-radius: 0 0 8px 8px;
}
.dropdown-content a {
  color: white;
  padding: 12px 16px;
  text-decoration: none;
  display: block;
  font-size: 14px;
  text-align: left;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
.dropdown-content a:hover { background-color: rgba(255,255,255,0.1); }
.nav-item:hover .dropdown-content { display: block; }

/* --- NEW: Compact Dashboard Layout (Fit Screen) --- */
.dash-container {
  height: calc(100vh - 140px); /* Adjust based on header/padding */
  display: flex;
  flex-direction: column;
  gap: 10px;
  overflow: hidden; /* Prevent scrolling */
}

/* Summary Cards Row (Top) */
.summary-row {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
  height: 15%; /* Takes top 15% of screen */
  min-height: 90px;
}
.kpi-card {
  background: white; border-radius: 8px; padding: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  display: flex; flex-direction: column; justify-content: center;
  position: relative; overflow: hidden;
}
.kpi-title { font-size: 14px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; }
.kpi-value { font-size: 24px; font-weight: 800; color: #0f172a; }
.kpi-sub   { font-size: 14px; color: #0f172a; margin-top: 4px; }

/* status colors bars on left of card */
.kpi-card.c-blue { border-left: 4px solid #3b82f6; }
.kpi-card.c-green { border-left: 4px solid #22c55e; }
.kpi-card.c-orange { border-left: 4px solid #f59e0b; }
.kpi-card.c-red { border-left: 4px solid #ef4444; }

/* Charts Grid (Bottom) */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  grid-template-rows: repeat(2, 1fr);
  gap: 10px;
  height: 85%; /* Takes remaining height */
}
.chart-box {
  background: white; border-radius: 8px; padding: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  position: relative;
  display: flex; flex-direction: column;
}
.chart-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
.chart-title { font-size: 13px; font-weight: 700; color: #334155; }
.expand-btn { background: none; border: none; cursor: pointer; font-size: 14px; }

.chart-container { flex: 1; position: relative; width: 100%; height: 100%; }

/* Modal for Expanded Chart */
#chartModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; align-items: center; justify-content: center; }
#chartModalContent { background: white; width: 90%; height: 80%; padding: 20px; border-radius: 12px; display: flex; flex-direction: column; }



</style>
</head>


<!-- Loader Overlay -->
<div id="loaderOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  z-index:9999;
   align-items:center;
  justify-content:center;
">
  <div style="text-align:center;color:#fff;font-size:18px;">
    <div class="spinner"></div>
    <p>Please wait...</p>
  </div>
</div>



<body>

<!-- LOGIN -->
<div id="loginWrap" class="login-wrap">
<div class="login-card">
  <img src="Trojan.png" alt="Trojan Contracting" class="login-logo" />
  <h1>TAMS</h1>
  <input id="u" placeholder="Username" />
  <input id="p" placeholder="Password" type="password" />
  <button id="loginBtn" class="login-btn">Login</button>
  <div class="login-hint"></div>
</div>
</div>


<div class="app" id="app" style="display:none">
  <!-- SIDEBAR -->
<aside class="sidebar">
  <div class="brand">
    <img src="TAMS_logo1.png" style="height:65px; vertical-align:middle; margin-right:15px;">
  </div>

  <nav class="nav">
    <a href="#" id="nav-dashboard" class="active" onclick="nav('dashboard')">Dashboard</a>
    <a href="#" id="nav-assets" onclick="nav('assets')">Asset Management</a>
    <a href="#" id="nav-list" onclick="nav('list')">Drivers/Operators List</a>
<a href="#" id="nav-al6m" onclick="nav('al6m')">Drivers/Operators Overstay</a>
    <div class="nav-item">
      <a href="#" id="nav-reports" onclick="void(0)">Reports ‚ñæ</a>
      <div class="dropdown-content">
        <a href="#" onclick="nav('reportRegExp')">1. Registration Expiry</a>
        <a href="#" onclick="nav('reportRegRenewal')">2. Registration Renewal</a> 
</div>
    </div>
  <a href="#" id="nav-undertaking" onclick="nav('undertaking')">Undertaking</a>
  <a href="#" id="nav-projectsSection" onclick="nav('projectsSection')">Projects</a>
  <a href="#" id="nav-users" onclick="nav('users')">Manage Users</a>
    </nav>

  <div class="sidebar-footer">
    <div id="userBar" class="user-bar">
      <span id="userLabel"></span>
      <button id="logoutBtn" class="btn warn" onclick="doLogout()">Logout</button>
    </div>
  </div>
</aside>

  <!-- MAIN -->
  <main class="content">
  

<button class="btn secondary" onclick="hardRefresh()">üîÑ Refresh Now</button>


<!-- DASHBOARD -->
<section id="dashboard" class="section">
  <div class="dash-container">
    
    <div class="summary-row">
      <div class="kpi-card c-blue">
        <div class="kpi-title">Assets Status</div>
        <div class="kpi-value" id="kpi_asset_total">0</div>
        <div class="kpi-sub" id="kpi_asset_sub">Op: 0 | Idle: 0</div>
      </div>
      <div class="kpi-card c-green">
        <div class="kpi-title">Operator/Driver Status</div>
        <div class="kpi-value" id="kpi_driver_total">0</div>
        <div class="kpi-sub" id="kpi_driver_sub">Active: 0 | Leave: 0</div>
      </div>
      <div class="kpi-card c-orange">
        <div class="kpi-title">Registration Status</div>
        <div class="kpi-value" id="kpi_reg_total">0</div>
        <div class="kpi-sub" id="kpi_reg_sub">Valid: 0 | Exp: 0</div>
      </div>
      <div class="kpi-card c-red">
        <div class="kpi-title">License Status (Drivers)</div>
        <div class="kpi-value" id="kpi_lic_total">N/A</div>
        <div class="kpi-sub" id="kpi_lic_sub">Feature coming soon</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Project-wise Assets</span> <button class="expand-btn" onclick="expandChart('projectAssetChart')">‚§¢</button></div>
        <div class="chart-container"><canvas id="projectAssetChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Asset Status</span></div>
        <div class="chart-container"><canvas id="assetStatusChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Operator/Driver Status</span></div>
        <div class="chart-container"><canvas id="opStatusChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Asset Category</span></div>
        <div class="chart-container"><canvas id="assetCatChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Projects Status</span></div>
        <div class="chart-container"><canvas id="projStatusChart"></canvas></div>
      </div>
      <div class="chart-box">
        <div class="chart-header"><span class="chart-title">Project Division</span></div>
        <div class="chart-container"><canvas id="projDivChart"></canvas></div>
      </div>
    </div>
  </div>
</section>

<div id="chartModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:5000; align-items:center; justify-content:center;">
  <div style="background:white; width:90%; height:80%; padding:20px; border-radius:12px; display:flex; flex-direction:column;">
    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
      <h3 id="expandedChartTitle">Detailed View</h3>
      <button class="btn warn" onclick="document.getElementById('chartModal').style.display='none'">Close</button>
    </div>
    <div style="flex:1; position:relative;">
      <canvas id="expandedCanvas"></canvas>
    </div>
  </div>
</div>

    <!-- Asset Management -->

<section id="assets" class="section" style="display:none">
  <h2>Asset Management</h2>
  
  <div class="toolbar card">
<div class="toolbar-left">
    <input id="assetSearch" placeholder="Search Assets..." oninput="applyAssetFilters()" />
    <select id="fAssetCat" onchange="applyAssetFilters()">
      <option value="">All Categories</option>
      <option>Vehicle</option>
      <option>Machine</option>
      <option>Gensets</option>
      <option>Minor</option>
    </select>
    <select id="fAssetProject" onchange="applyAssetFilters()"><option value="">All Projects</option></select>
    <select id="fAssetStatus" onchange="applyAssetFilters()">
      <option value="">All Status</option>
      <option>In operation</option><option>IDLE</option><option>maintenance</option>
      <option>service</option><option>passing work</option><option>Scrap</option>
      <option>cancelled</option><option>to be sold</option><option>sold</option>
    </select>
    <div class="toolbar-right">
    <button class="btn" onclick="openAssetModal()">+ Add Asset</button>
    <button class="btn secondary" onclick="importAssetExcel()">Import Excel</button>
    <button class="btn" onclick="exportAssetExcel()">Export Excel</button>
  </div>
</div>
  </div>


  <div class="table-wrap">
    <table id="assetTable">
      <thead>
        <tr>
          <th>Vehicle/Machine No</th>
          <th>Asset No</th>        
	<th>Brand/Model</th>
	<th>Category</th>
          <th>User Name</th>
          <th>Designation</th>
          <th>Contact</th>
          <th>Project</th>
          <th>Reg No</th>
          <th>Reg Expiry</th>
          <th>From</th>
          <th>Till</th>
<th>Status</th> <th>Shift</th>
          <th>Remarks</th>

          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="assetTbody"></tbody>
    </table>
  </div>


<div class="pagination">
  <button class="page-btn" onclick="changeAssetPage(-1)">‚óÄ Prev</button>
  <span id="assetPageInfo">Page 1 of 1</span>
  <button class="page-btn" onclick="changeAssetPage(1)">Next ‚ñ∂</button>
</div>
</section>



<div id="assetModal" class="modal-overlay">
  <div class="modal-content card">
    <h3>Asset Details</h3>
    <div class="grid grid-4">
      <div>
        <label>Vehicle/Machine No</label>
        <input id="a_vmNo" />
      </div>
      <div>
        <label>Asset No</label>
        <input id="a_assetNo" />
      </div>
<div>
  <label>Brand/Model</label>
  <input id="a_brand" placeholder="e.g. Toyota/CAT" />
</div>
      <div>
        <label>Category</label>
        <select id="a_category">
          <option value="">Select Category</option>
          <option>Vehicle</option><option>Machine</option><option>Gensets</option><option>Minor</option>
        </select>
      </div>
      <div>
        <label>Assign User</label>
        <div class="search-dd" id="a_userDD">
          <div class="selected">Select User (ID - Name)</div>
          <div class="panel">
            <input placeholder="Search user..." oninput="filterDD(this)">
            <div class="list"></div>
          </div>
        </div>
      </div>

      <div>
        <label>Designation</label>
        <input id="a_designation" readonly />
      </div>
      <div>
        <label>Contact</label>
        <input id="a_contact" readonly />
      </div>
      <div>
        <label>Project</label>
        <div class="search-dd" id="a_projectDD">
          <div class="selected">Select Project</div>
          <div class="panel">
            <input placeholder="Search project..." oninput="filterDD(this)">
            <div class="list"></div>
          </div>
        </div>
      </div>
      <div>
        <label>Registration No</label>
        <input id="a_regNo" />
      </div>

      <div>
        <label>Reg Expiry</label>
        <input id="a_regExp" type="text" placeholder="üìÖ Select Date" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
      </div>
      <div>
        <label>From Date/Time</label>
        <input id="a_from" type="text" placeholder="üìÖ Select Date/Time" onfocus="(this.type='datetime-local')" oninput="this.blur()" onblur="if(!this.value) this.type='text'" />
      </div>
      <div>
        <label>Till Date/Time</label>
        <input id="a_till" type="text" placeholder="üìÖ Select Date/Time" onfocus="(this.type='datetime-local')" oninput="this.blur()" onblur="if(!this.value) this.type='text'" />
      </div>
      <div>
        <label>Status</label>
<select id="a_status" onchange="handleAssetStatusChange()">
          <option value="">Select Status</option>
          <option>In operation</option><option>IDLE</option><option>Maintenance</option>
          <option>Scrap</option><option>Passing Work</option><option>To be Sold</option><option>Sold</option>
        </select>
      </div>
      <div>
        <label>Shift</label>
        <select id="a_shift">
          <option value="">Select Shift</option>
          <option>Day</option><option>Night</option>
        </select>
      </div>
      <div style="grid-column: span 3;">
        <label>Remarks</label>
        <textarea id="a_remarks" style="height: 42px;"></textarea>
      </div>

      <div style="grid-column: span 4; background: #eff6ff; padding: 15px; border-radius: 8px; margin-top: 10px; border: 1px solid #bfdbfe;">
        <label style="font-size:12px;">Update Driver Status (If User Assigned)</label>
        <div class="grid grid-2" style="gap:10px;">
          <div>
            <label style="font-size:11px; color:#64748b;">Action</label>
            <select id="a_driverStatus">
              <option value="Active">Keep Driver Active</option>
<option value="IDLE">Set Driver: IDLE</option>
              <option value="On Leave">Set Driver: On Leave</option>
              <option value="Resigned">Set Driver: Resigned</option>
              <option value="Transfer">Set Driver: Transfer</option>
            </select>
          </div>
          <div>
            <label style="font-size:11px; color:#64748b;">Leave Till Date</label>
            <input id="a_driverLeaveTill" type="text" placeholder="üìÖ Manual: Leave Till" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
          </div>
        </div>
        <small style="color:#64748b; display:block; margin-top:8px;">
          * Selecting "On Leave" or "Resigned" uses the Asset "Till Date" as the event start date.
        </small>
      </div>
    </div>
    <div style="margin-top:20px; text-align:right;">
      <button class="btn warn" onclick="closeAssetModal()">Cancel</button>
      <button class="btn" onclick="saveOrUpdateAsset()">Save Asset</button>
    </div>
  </div>
</div>


    <!-- DRIVER/OPERATOR LIST -->
    <section id="list" class="section" style="display:none">
      <h2>Driver/Operator List</h2>
      <div class="toolbar card">
        <input id="search" placeholder="Search" oninput="applyFilters()" />
        <select id="fDesignation" onchange="applyFilters()">
          <option value="">All Designations</option>
          <option>Heavy Duty Driver</option>
          <option>Bus Driver</option>
          <option>Operator - Heavy Equipment</option>
          <option>Light Vehicle Driver</option>
	<option>Workshop</option>
        </select>

  <select id="fProject" onchange="applyFilters()">
  <option value="">All Projects</option>
</select>

        <select id="fStatus" onchange="applyFilters()">
          <option value="">All Status</option>
          <option>Active</option>
          <option>On Leave</option>
          <option>Resigned</option>
          <option>Transfer</option>
          <option>IDLE</option>
          <option>Others...</option>
        </select>
        <span class="page-size">Rows/page:
          <select id="pageSize" onchange="applyFilters()">
            <option>10</option><option>20</option><option>50</option><option>100</option>
          </select>
        </span>
       <input type="file" id="excelFile" accept=".xlsx,.xls" />
<button id="btnImport" class="btn secondary" onclick="importExcel()">Import Excel</button>

        <button class="btn" onclick="exportExcel()">Export Excel</button>
        <button class="btn" onclick="exportPDF()">Export PDF</button>
      </div>
      <div class="card" id="addCard">
        <h3>Add Driver/Operator</h3>
        <div class="grid grid-4">
          <input id="empId" placeholder="Employee ID" />
          <input id="name" placeholder="Proper Name"autocomplete="name" />

          <select id="designation">
            <option value="">Designation</option>
            <option>Heavy Duty Driver</option>
            <option>Bus Driver</option>
            <option>Operator - Heavy Equipment</option>
            <option>Light Vehicle Driver</option>
		<option>Workshop</option>
          </select>
<div class="search-dd" id="driverProjectDD">
  <div class="selected">Select Project</div>
  <div class="panel">
    <input placeholder="Search project..." oninput="filterDD(this)">
    <div class="list"></div>
  </div>
</div>


          <input id="vehicleNo" placeholder="Vehicle / Machine No" />
          <input id="assetCode" placeholder="Asset T Code" />

          <input id="contact" placeholder="+9715XXXXXXXX" />
<input id="joiningDate" type="text" placeholder="üìÖ Joining Date" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
<input id="leaveSince" type="text" placeholder="üìÖ Leave Since/Resigned Date" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />

          <select id="status">
            <option>Active</option>
            <option>On Leave</option>
            <option>Resigned</option>
            <option>Transfer</option>
            <option>IDLE</option>
            <option>Others...</option>
          </select>
          <input id="remarks" placeholder="Remarks" />
          <button class="btn" onclick="addEntry()">Add</button>
        </div>
      </div>

<p style="color:#2563eb; font-weight:600; margin:8px 0;">
  üí° Tip: Right-click a row to open Driver/Operator Logs
</p>

      <div class="table-wrap">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Employee ID</th>
              <th>Name</th>
              <th>Designation</th>
              <th>Project</th>
              <th>Vehicle / Machine No</th>
              <th>Asset T Code</th>
              <th>Contact</th>
              <th>Joining Date</th>
	      <th>Leave Since/ Resigned Date</th>
	      <th>Leave Till</th>
              <th>Status</th>
              <th>Remarks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="pagination">
        <button class="page-btn" onclick="gotoPage(1)">‚èÆ First</button>
        <button id="prevBtn" class="page-btn" onclick="gotoPage(state.page-1)">‚óÄ Prev</button>
        <span id="pageInfo"></span>
        <button id="nextBtn" class="page-btn" onclick="gotoPage(state.page+1)">Next ‚ñ∂</button>
        <button class="page-btn" onclick="gotoPage(state.totalPages)">Last ‚è≠</button>
      </div>
    </section>

<!-- Project Section -->

<section id="projectsSection" class="section" style="display:none">
  <h2>Projects List</h2>
  <div class="toolbar card">
    <input id="projSearch" placeholder="Search Projects..." oninput="applyProjFilters()" />
    <select id="fProjStatus" onchange="applyProjFilters()">
      <option value="">All Status</option>
      <option>Active</option>
      <option>Inactive</option>
      <option>On Hold</option>
    </select>
    <span class="page-size">Rows/page:
      <select id="projPageSize" onchange="applyProjFilters()">
        <option>10</option><option>20</option><option>50</option>
      </select>
    </span>
    <input type="file" id="projExcelFile" accept=".xlsx,.xls" style="display:none" />
    <button class="btn secondary" onclick="document.getElementById('projExcelFile').click()">Import Excel</button>
    <button class="btn" onclick="exportProjExcel()">Export Excel</button>
  </div>

  <div class="card" id="addProjCard">
    <h3>Add Project</h3>
    <div class="grid grid-4">
      <input id="p_id" placeholder="Project ID" />
      <input id="p_name" placeholder="Project Name" />
      <input id="p_loc" placeholder="Location" />
      <input id="p_div" placeholder="Division" />
      <input id="p_date" type="date" title="Creation Date" />
      <select id="p_status">
        <option>Active</option>
        <option>Inactive</option>
        <option>On Hold</option>
      </select>
      <button class="btn" onclick="addProject()">Add Project</button>
    </div>
  </div>
<div id="projectEditModal" class="modal-overlay">
  <div class="modal-content card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0;">Edit Project Details</h3>
      <button class="btn warn" onclick="closeProjEdit()">‚úï</button>
    </div>
    
    <div class="grid grid-2">
      <div>
        
        <input id="ep_id" placeholder="Project ID" />
      </div>
      <div>
       
        <input id="ep_name" placeholder="Project Name" />
      </div>
      <div>
       
        <input id="ep_loc" placeholder="Location" />
      </div>
      <div>
        
        <input id="ep_div" placeholder="Division" />
      </div>
      <div>
        
        <input id="ep_date" type="date" />
      </div>
      <div>
        
        <select id="ep_status">
          <option>Active</option>
          <option>Inactive</option>
          <option>On Hold</option>
        </select>
      </div>
    </div>

    <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn secondary" onclick="closeProjEdit()">Cancel</button>
      <button class="btn" onclick="saveProjUpdate()">Update Project</button>
    </div>
  </div>
</div>

  <div class="table-wrap">
    <table id="projTable">
      <thead>
        <tr>
          <th>Project ID</th>
          <th>Project Name</th>
          <th>Location</th>
          <th>Division</th>
          <th>Creation Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="projTbody"></tbody>
    </table>
  </div>
  
  <div class="pagination">
    <button class="page-btn" onclick="gotoProjPage(1)">‚èÆ First</button>
    <button id="prevProjBtn" class="page-btn" onclick="gotoProjPage(state.projPage-1)">‚óÄ Prev</button>
    <span id="projPageInfo"></span>
    <button id="nextProjBtn" class="page-btn" onclick="gotoProjPage(state.projPage+1)">Next ‚ñ∂</button>
  </div>
</section>



<!--  LEAVE > 6 MONTHS -->
<section id="al6m" class="section" style="display:none">
  <h2>On Leave > 6 Months</h2>
  <div class="card">
    <button class="btn" onclick="exportAL6mExcel()">Export Excel</button>
  </div>
  <div class="table-wrap">
    <table id="al6mTable">
<thead>
  <tr>
    <th>Employee ID</th>
    <th>Name</th>
    <th>Designation</th>
    <th>Project</th>
    <th>Plate Noth>
    <th>assetCode</th>
    <th>Contact</th>
    <th>Joining Date</th>
    <th>Leave Since/ Resigned Date</th>
    <th>Leave Till</th>
    <th>Status</th>
    <th>Remarks</th>
    <th>Category</th>
    <th>Overstay Days</th>
  </tr>
</thead>

      <tbody id="al6mBody"></tbody>
    </table>
  </div>
</section>

<!-- Report -->
<section id="reportRegExp" class="section" style="display:none">
  <h2>Registration Expiry Report</h2>
  <div class="toolbar card" style="background:#fee2e2; border-color:#fca5a5;">
    <p style="margin:0; font-weight:bold; color:#b91c1c;">
      ‚ö†Ô∏è Displaying Assets with Expired Registration or Expiring within 15 Days.
    </p>
    <button class="btn" style="margin-left:auto;" onclick="exportRegReport()">Export Excel</button>
  </div>
  <div class="table-wrap">
    <table id="regReportTable">
      <thead>
        <tr>
          <th>Vehicle/Machine No</th>
          <th>Asset No</th>
          <th>Project</th>
          <th>Reg No</th>
          <th>Reg Expiry</th>
          <th>Days Remaining</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="regReportBody"></tbody>
    </table>
  </div>
</section>



<section id="reportRegRenewal" class="section" style="display:none">
  <h2>Asset Registration Renewal</h2>
  
  <div class="toolbar card">
    <div class="toolbar-left">
        <div class="date-range-group">
            <label style="margin:0; font-size:12px;">From:</label>
            <input type="date" id="rep_start" />
        </div>
        <div class="date-range-group">
            <label style="margin:0; font-size:12px;">To:</label>
            <input type="date" id="rep_end" />
        </div>
        <button class="btn secondary" onclick="setRepDate('today')">Today</button>
        <button class="btn secondary" onclick="setRepDate('month')">This Month</button>
        <button class="btn" onclick="fetchRenewalData()">üîç Generate Report</button>
    </div>
    
    <div class="toolbar-right">
        <button class="btn" onclick="exportRenewalExcel()">Export Excel</button>
    </div>
  </div>

  <div class="table-wrap">
    <table id="renewalTable">
      <thead>
        <tr>
          <th>Date of Renewal</th> <th>Vehicle/Machine No</th>
          <th>Asset No</th>
          <th>Project</th>
          <th>New Expiry Date</th>
          <th>Remarks</th>
          <th>Done By</th>
        </tr>
      </thead>
      <tbody id="renewalBody"></tbody>
    </table>
  </div>
</section>


<section id="reportLicExp" class="section" style="display:none">
    <h2>License Expiry Report</h2>
    <div class="card"><p>Feature coming soon...</p></div>
</section>

    <!-- USERS -->
    <section id="users" class="section" style="display:none">
      <h2>Users</h2>
      <div class="card">
        <h3>Add User</h3>
        <div class="grid grid-4">
          <input id="newU" placeholder="Username" />
          <input id="newP" placeholder="Password" type="password" />
          <select id="newRole">
            <option>Viewer</option>
            <option>Admin</option>
            <option>SuperAdmin</option>
          </select>
          <button class="btn" onclick="addUser()">Add User</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="userTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTbody"></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<div class="footer">
  ¬© 2026 Engr. Farrukh. All Rights Reserved.
  <span id="dataStatus" style="margin-left:12px; font-weight:600;"></span>
</div>


<!-- Edit Driver Modal -->
<div id="editModal" class="modal">
  <div class="dialog">
    <h3>Edit Entry</h3>
    <div class="grid grid-2">
      <input id="e_empId" placeholder="Employee ID" />
      <input id="e_name" placeholder="Name" />
      <select id="e_designation">
        <option>Heavy Duty Driver</option>
        <option>Bus Driver</option>
        <option>Operator - Heavy Equipment</option>
        <option>Light Vehicle Driver</option>
<option>Workshop</option>
      </select>
      <select id="e_project">
        <option>Creation</option>
        <option>Gatex</option>
        <option>Samtech</option>
      </select>
      <input id="e_vehicleNo" placeholder="Vehicle / Machine No" />
      <input id="e_assetCode" placeholder="Asset T Code" />
      <input id="e_contact" placeholder="Contact" />
      <input id="e_joiningDate" type="date" />
<input id="e_leaveSince" type="date" placeholder="Tochkey Returned Date (optional)" />
<input id="e_leaveTill" type="date" placeholder="Leave Till (optional)" />
      <select id="e_status">
        <option>Active</option>
        <option>On Leave</option>
        <option>Resigned</option>
        <option>Transfer</option>
        <option>IDLE</option>
        <option>Others...</option>
      </select>
      <input id="e_remarks" placeholder="Remarks" />
    </div>
    <div class="actions">
      <button class="btn warn" onclick="closeEdit()">Cancel</button>
      <button class="btn" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>



<section id="undertaking" class="section" style="display:none">
  <div class="no-print" style="padding: 20px; text-align:right;">
    <button class="btn" onclick="window.print()">üñ®Ô∏è Print Undertaking</button>
  </div>

  <div class="undertaking-paper">
<div class="ut-header">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <img src="NPClogo.png" style="height: 60px; width: auto; object-fit: contain;" alt="Logo Left">
    
    <img src="UndertakingMiddle.jpg" style="height: 60px; width: auto; object-fit: contain;" alt="Logo Middle">
    
    <img src="UndertakingRight.png" style="height: 60px; width: auto; object-fit: contain;" alt="Logo Right">
  </div>

  <div style="text-align: center; border-top: 1px solid #eee; padding-top: 15px;">
    <h2 style="margin: 0; font-size: 22px; letter-spacing: 1px;">PLANT DEPARTMENT</h2>
    <h3 style="margin: 5px 0 0 0; font-size: 18px; font-weight: bold;">UNDERTAKING (RECEIVING) OF NPC OWNED VEHICLES</h3>
  </div>
</div>

    <div class="ut-grid">
      <div class="ut-box">
        <div class="ut-section-title">RECEIVING PERSON DETAILS / ŸàÿµŸàŸÑ ⁄©ÿ±ŸÜ€í ŸàÿßŸÑ€í ÿ¥ÿÆÿµ ⁄©€å ÿ™ŸÅÿµ€åŸÑÿßÿ™</div>
        <div class="ut-row"><span class="ut-label">NAME / ŸÜÿßŸÖ:</span> <span class="ut-val" id="ut_name"></span></div>
        <div class="ut-row"><span class="ut-label">EMP. NO / ŸÖŸÑÿßÿ≤ŸÖ ⁄©ÿß ŸÜŸÖÿ®ÿ±:</span> <span class="ut-val" id="ut_empId"></span></div>
        <div class="ut-row"><span class="ut-label">DESIGNATION / ÿπ€ÅÿØ€Å:</span> <span class="ut-val" id="ut_desig"></span></div>
        <div class="ut-row"><span class="ut-label">PROJECT / Ÿæÿ±Ÿàÿ¨€å⁄©Ÿπ:</span> <span class="ut-val" id="ut_proj"></span></div>
        <div class="ut-row"><span class="ut-label">LICENSE / ŸÑÿßÿ¶ÿ≥ŸÜÿ≥:</span> <span class="ut-val" id="ut_license"></span></div>
        <div class="ut-row"><span class="ut-label">CONTACT / ŸÜŸÖÿ®ÿ±:</span> <span class="ut-val" id="ut_contact"></span></div>
      </div>

      <div class="ut-box">
        <div class="ut-section-title">VEHICLE DETAILS / ⁄Øÿß⁄ë€å ⁄©€å ÿ™ŸÅÿµ€åŸÑÿßÿ™</div>
        <div class="ut-row"><span class="ut-label">MAKE & MODEL / ŸÖÿß⁄àŸÑ:</span> <span class="ut-val" id="ut_model"></span></div>
        <div class="ut-row"><span class="ut-label">PLATE NO / ŸæŸÑ€åŸπ ŸÜŸÖÿ®ÿ±:</span> <span class="ut-val" id="ut_plate"></span></div>
        <div class="ut-row"><span class="ut-label">ASSET NO / ÿßÿ´ÿßÿ´€Å ŸÜŸÖÿ®ÿ±:</span> <span class="ut-val" id="ut_asset"></span></div>
        <div class="ut-row"><span class="ut-label">REG. VALIDITY / ÿ±ÿ¨ÿ≥Ÿπÿ±€åÿ¥ŸÜ:</span> <span class="ut-val" id="ut_reg"></span></div>
        <div class="ut-row"><span class="ut-label">INSURANCE / ÿßŸÜÿ¥Ÿàÿ±ŸÜÿ≥:</span> <span class="ut-val" id="ut_ins"></span></div>
        <div class="ut-row"><span class="ut-label">K.M. READING / ⁄©ŸÑŸàŸÖ€åŸπÿ±:</span> <span class="ut-val" id="ut_km"></span></div>
      </div>
    </div>

    <div class="checklist-grid">
      <div>
        <div class="cl-header">CHECKLIST (RECEIVE / RETURN)</div>
        <div class="cl-item"><span>FIRST AID BOX / ÿ∑ÿ®€å ÿßŸÖÿØÿßÿØ ⁄©ÿß ⁄àÿ®€Å</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>WIPER / WASHER / Ÿàÿßÿ¶Ÿæÿ±</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>RADIO / CD / ÿ±€å⁄à€åŸà</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>TOOL KIT / ŸπŸàŸÑ ⁄©Ÿπ</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>JACK / ÿ¨€å⁄©</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>SPARE WHEEL / ÿßÿ≥Ÿæ€åÿ¶ÿ± Ÿà€Å€åŸÑ</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>MIRRORS / ÿ¢ÿ¶€åŸÜ€Å</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>A/C CONTROL / ÿß€åÿ¶ÿ± ⁄©ŸÜ⁄à€åÿ¥ŸÜ⁄Ø</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>PETROL CARD NO. /Ÿæ€åŸπÿ±ŸàŸÑ</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>SALIK TAG / ÿ≥ÿßŸÑ⁄© </span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>FLOOR MATS / ŸÅÿ±ÿ¥</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>WHEEL CAPS / Ÿà€Å€åŸÑ ⁄©€åŸæ	</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>FIRE EXTINGUISHER /ÿß⁄Ø ÿ®ÿ¨⁄æÿßŸÜ€í ⁄©ÿß ÿßŸÑ€Å</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
        <div class="cl-item"><span>LIGHTS / INDICATORS  /ÿ±Ÿàÿ¥ŸÜ€å / ÿßÿ¥ÿßÿ±€í</span> <span><input type="checkbox"> OK / <input type="checkbox"> NO</span></div>
      </div>
      <div>
  <div class="cl-header">TRAFFIC FINE DETAILS & NOTES</div>
  <div style="padding:10px; font-size:11px; height:100%; box-sizing:border-box;">
    <p style="margin:0 0 5px 0;"><strong>OFFENCE DATE / FINE REF:</strong></p>
    
    <textarea id="ut_fines" class="writable-input" rows="6" 
      placeholder="Type fine details here..."></textarea>
      
    <p style="margin-top:10px; font-style:italic; font-size:10px;">
      "Note: All Traffic fines has to be paid by the individual user, if not equal amount shall be deducted from their salary."
    </p>
  </div>
</div>
    </div>

    <div style="margin-top:15px; font-size:12px; font-weight:bold;">
      RECEIVED THE ABOVE VEHICLE IN GOOD CONDITION. I UNDERTAKE RESPONSIBILITY OF THE VEHICLE.
    </div>

    <div class="ut-footer-row">
      <div class="ut-sig-box">
        <div>SIGNATURE / ÿØÿ≥ÿ™ÿÆÿ∑</div>
        <br><br>
        <div>_______________________</div>
        <div style="margin-top:5px;" id="ut_date_receive">Date: </div>
      </div>
<div class="ut-sig-box" style="border:none; text-align:left; width: 45%;">
  <div><strong>REMARKS:</strong></div>
  
  <textarea id="ut_remarks" class="writable-input" rows="3" 
    style="border-bottom: 1px solid #000; margin-top: 5px;" 
    placeholder="Type remarks here..."></textarea>
</div>
    </div>

    <div class="ut-section-title" style="margin-top:30px;">VEHICLE RETURN DETAILS / ⁄Øÿß⁄ë€å ⁄©€å ŸàÿßŸæÿ≥€å ⁄©€å ÿ™ŸÅÿµ€åŸÑÿßÿ™</div>
    <div class="ut-grid" style="margin-top:10px;">
      <div class="ut-box">
        <div><strong>RECEIVED BY / ⁄©€å ÿ∑ÿ±ŸÅ ÿ≥€í ŸÖŸàÿµŸàŸÑ:</strong></div>
        <div style="height:30px;"></div>
        <div>SIGNATURE: _________________</div>
      </div>
      <div class="ut-box">
        <div><strong>RETURNED BY / ⁄©€å ÿ∑ÿ±ŸÅ ÿ≥€í ŸàÿßŸæÿ≥:</strong></div>
        <div style="font-size:14px; font-weight:bold; margin:5px 0;" id="ut_return_by"></div>

        <div>SIGNATURE: _________________</div>
        <div style="margin-top:5px;" id="ut_date_return">Date: </div>
      </div>
    </div>

    <div style="margin-top:40px; border-top:1px solid #000; display:flex; justify-content:space-between; padding-top:5px; font-size:11px;">
      <span>TRANSPORT CO-ORDINATOR</span>
      <span>PLANT MANAGER</span>
    </div>
    <div style="text-align:right; font-size:10px; margin-top:10px;">FORM: NPC/QHSE/FRM/253 R2</div>

  </div>
</section>

<!-- Change Password Modal -->
<div id="pwModal" class="modal">
  <div class="dialog">
    <h3>Change Password</h3>
    <input id="pwUser" type="hidden" />
    <input id="pwNew" placeholder="New Password" type="password" />
    <input id="pwConfirm" placeholder="Confirm Password" type="password" />
    <div class="actions">
      <button class="btn warn" onclick="closePw()">Cancel</button>
      <button class="btn" onclick="savePw()">Save</button>
    </div>
  </div>
</div>

<!-- Driver Logs Modal -->
<div id="logsModal" class="modal"> <div class="dialog">
    <h3>Driver Logs</h3>
    <div id="logsTimeline">
      </div>
    <div class="actions">
      <button class="btn secondary" onclick="exportLogsToPDF()">üìë Export PDF</button>
      <button class="btn warn" onclick="document.getElementById('logsModal').style.display='none'">Close</button>
    </div>
  </div>
</div>

<script type="module">



/* -------------------------- Firebase (ESM) -------------------------- */
// Use 10.13.0 for EVERYTHING
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import {
  initializeFirestore,
  persistentLocalCache,
  persistentMultipleTabManager,
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  where,
  serverTimestamp,
  onSnapshot,
  orderBy,
  writeBatch,       // <--- NEW: For deleting logs + parent together
  limit,            // <--- NEW: For optimization
  startAfter,       // <--- NEW: For pagination
  getCountFromServer // <--- NEW: For cheap dashboard counts
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

/* ===== YOUR FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCmd5cSLKMJkiotQopikaOGRUZPvjYbmx4",
  authDomain: "asset-management-system-755a6.firebaseapp.com",
  projectId: "asset-management-system-755a6",
  storageBucket: "asset-management-system-755a6.firebasestorage.app",
  messagingSenderId: "889243221633",
  appId: "1:889243221633:web:e8767dc3d1d42c14fb9780",
  measurementId: "G-TT5CSSLCNR"
};

// Initialize App
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Initialize Firestore with consistent 10.13.0 cache settings
const db = initializeFirestore(app, {
  localCache: persistentLocalCache({
    tabManager: persistentMultipleTabManager()
  })
});

let charts = {}; // Store chart instances globally to destroy them later
let needsRefresh = false;
/* ------------------------ Minimal helper styles ------------------------ */
(function injectMinorStyles(){
  const s=document.createElement('style');
  s.textContent = `
    .cell-bad{ background:#fee2e2 !important; }
    .badge-danger{ background:rgba(239,68,68,.12); color:#ef4444; padding:4px 10px; border-radius:999px; font-size:12px }
    .hidden{ display:none !important; }
  `;
  document.head.appendChild(s);
})();
function applyRoleUI(){
  const role = (state.me?.role || '').toLowerCase();
  const isViewer = role === 'viewer';

  // Hide manual add form & import controls for viewers
 // $('#addCard')?.classList.toggle('hidden', isViewer);
  $('#excelFile')?.classList.toggle('hidden', isViewer);
  $('#btnImport')?.classList.toggle('hidden', isViewer);
}

/* ------------------------------ Globals ------------------------------ */
const COLL_DRIVERS = "drivers";
const COLL_USERS   = "users";
const COLL_PROJECTS = "projects"; // New Firestore collection name
const COLL_ASSETS = "assets";
const COLL_ASSET_LOGS = "asset_logs"; // Same as driver logs
let unsubscribeProjects = null;
let unsubscribeDrivers = null;
let unsubscribeUsers = null;
let currentEditAssetId = null;


const state = {
  me: null,                           // {id, username, role}
  drivers: [],                        // all drivers from DB
  users: [],                          // all users from DB
  filtered: [],                       // filtered drivers for table
  page: 1,
  pageSize: 10,
  totalPages: 1,
  editIndex: null,                    // index in drivers[]
  editDocId: null,                    // firestore doc id being edited
  annualLeaveOver6M: [],               // derived list for alerts/export
projects: [],
editProjDocId: null,
  projFiltered: [],
  projPage: 1,
  projPageSize: 10,
  projTotalPages: 1,
assets: [],
  filteredAssets: [],
  assetPage: 1,
  assetTotalPages: 1,
lastDriverDoc: null, // For pagination
  lastAssetDoc: null,  // For pagination
  isSearching: false   // To toggle between realtime list and search results
};

// make state visible to inline onclick handlers
window.state = state;

/* ------------------------ Utility / Formatting ------------------------ */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel)=> Array.from(document.querySelectorAll(sel));
function toast(msg){ alert(msg); }
function isDriver(rec){ return /driver/i.test(rec.designation||'') && !/operator/i.test(rec.designation||''); }
function isOperator(rec){ return /operator/i.test(rec.designation||''); }
function statusIndexToText(i){ return ['Active','on Leave','Resigned','Transfer','IDLE','Others...'][i] || ''; }
function validContact(c){ return /^\+9715\d{8}$/.test(c||''); }
function validassetCode(s){ return (s||'').length===16; }
function parseDate(d){ return d ? new Date(d) : null; }
function monthsDiff(fromDate, toDate=new Date()){
  if(!fromDate) return 0;
  const f = new Date(fromDate);
  return (toDate.getFullYear()-f.getFullYear())*12 + (toDate.getMonth()-f.getMonth());
}

/* -------------------------- First-time seeding ------------------------- */
async function ensureDefaultSuperAdmin(){
  // Create SuperAdmin "Trojan Plant" / "1234" only if not exists
  const qSnap = await getDocs(query(collection(db, COLL_USERS), where("username","==","Trojan Plant")));
  if(qSnap.empty){
    await addDoc(collection(db, COLL_USERS), {
      username: "Trojan Plant",
      password: "1234",
      role: "SuperAdmin",
      createdAt: serverTimestamp()
    });
  }
}

/* -------------------------------- Login -------------------------------- */
async function doLogin(){
  const u = $('#u').value.trim();
  const p = $('#p').value.trim();
  if(!u || !p){ toast("Enter username and password"); return; }

try {
    showLoader();  // show overlay while checking credentials

  // authenticate against Firestore (no hashing as requested)
  const qSnap = await getDocs(query(collection(db, COLL_USERS), where("username","==",u), where("password","==",p)));
  if(qSnap.empty){ toast("Invalid credentials"); return; }

  const docRef = qSnap.docs[0];
  state.me = { id: docRef.id, ...docRef.data() };
  $('#loginWrap').style.display='none';
  $('#app').style.display='flex';
  $('#userLabel').textContent = `${state.me.username} (${state.me.role})`;
  // Access control: show/hide Users tab
  const usersNav = $('#nav-users');
  if(state.me.role === 'SuperAdmin'){ usersNav.style.display = 'block'; }
  else { usersNav.style.display = 'none'; }
applyRoleUI();

  await loadDrivers();  // attaches realtime listener + paints from cache
await loadProjects();
 await loadUsers();    // attaches realtime listener if SuperAdmin
  nav('dashboard');
}  catch(err){
    console.error("Login error:", err);
    toast("‚ùå Login failed");
  }
  finally {
    hideLoader();   // <--- always hide overlay, success or fail
  }
}
// Add this block anywhere in your <script> section
document.addEventListener('keydown', function(event) {
  // Check if the Enter key was pressed
  if (event.key === 'Enter') {
    // Only trigger if the user is currently looking at the login screen
    const loginWrap = document.querySelector('.login-wrap');
    if (loginWrap && loginWrap.style.display !== 'none') {
      doLogin(); // Calls your existing login function
    }
  }
});



function doLogout() {
  if (unsubscribeDrivers) { unsubscribeDrivers(); unsubscribeDrivers = null; }
  if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
  state.me = null;

  $('#userLabel').textContent = '';
  $('#app').style.display = 'none';
  $('#loginWrap').style.display = 'flex';
  $('#u').value = '';
  $('#p').value = '';
}

/* ------------------------------ Button Bindings ------------------------------ */
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("loginBtn").addEventListener("click", doLogin);
  document.getElementById("logoutBtn").addEventListener("click", doLogout);
});


/* --------------------------------- NAV --------------------------------- */
function nav(id){
  // 1. Hide all sections first
  $$('.section').forEach(s => s.style.display = 'none');
  
  // 2. Remove 'active' class from all nav links
  $$('.nav a').forEach(a => a.classList.remove('active'));

  // 3. Show the requested section
  const targetSection = $(`#${id}`);
  if (targetSection) {
    targetSection.style.display = 'block';
  }

  // 4. Highlight the nav link
  const navLink = $(`#nav-${id}`);
  if (navLink) {
    navLink.classList.add('active');
  }

  // 5. Run section-specific loaders
  if(id === 'dashboard') renderDashboard();
  if(id === 'list'){
    applyRoleUI();
    applyFilters();
  }
  if(id === 'projectsSection'){
    loadProjects(); 
    applyProjFilters(); 
  }
  if(id === 'users') renderUsers();
  if(id === 'al6m') renderAL6M();
  
  // FIXED: Check if element exists before setting textContent to avoid crash
  if(id === 'undertaking') {
    const dateEl = document.getElementById("undertakingDate");
    if(dateEl) {
        dateEl.textContent = new Date().toLocaleDateString();
    }
  }
}
window.nav = nav;
/* -------------------------------- Undertaking -------------------------------- */
function fillUndertakingFromData(data) {
  // 1. Clear previous
  const fields = ['ut_name', 'ut_empId', 'ut_desig', 'ut_proj', 'ut_license', 'ut_contact', 
                  'ut_model', 'ut_plate', 'ut_asset', 'ut_reg', 'ut_ins', 'ut_km', 
                  'ut_return_by', 'ut_date_receive', 'ut_date_return'];
  fields.forEach(f => {
    const el = document.getElementById(f);
    if(el) el.textContent = '';
  });
  document.querySelectorAll('#undertaking input[type="checkbox"]').forEach(cb => cb.checked = false);

  // 2. Fill Vehicle Details
  document.getElementById('ut_model').textContent = data.category || 'Vehicle'; 
  document.getElementById('ut_plate').textContent = data.vmNo;
  document.getElementById('ut_asset').textContent = data.assetNo;
  document.getElementById('ut_reg').textContent = data.regExp || '';

if (data.regExp) {
    const regDate = new Date(data.regExp);
    if (!isNaN(regDate)) {
      regDate.setMonth(regDate.getMonth() + 1); // Add 1 month
      // Format as YYYY-MM-DD
      const insDateStr = regDate.toISOString().split('T')[0];
      document.getElementById('ut_ins').textContent = insDateStr;
    }
  }

  document.getElementById('ut_km').textContent = '________'; 

  // 3. Logic based on Status
  const isOperation = (data.status === 'In operation');
  const now = new Date();
  const dateStr = now.toLocaleDateString();
  const timeStr = now.toLocaleTimeString();

  if (isOperation) {
    // FILL RECEIVING (Assigned)
    document.getElementById('ut_name').textContent = data.userName || '';
    document.getElementById('ut_empId').textContent = data.empId || '';
    document.getElementById('ut_desig').textContent = data.designation || '';
    document.getElementById('ut_proj').textContent = data.project || '';
    document.getElementById('ut_contact').textContent = data.contact || '';
    document.getElementById('ut_date_receive').textContent = `Date: ${dateStr} Time: ${timeStr}`;
    document.getElementById('ut_name').textContent = data.userName; // Top right box
  } else {
    // FILL RETURN (Returned)
    // For return, we put the person returning it in the "Returned By" slot
 const contactInfo = data.contact ? ` | Contact: ${data.contact}` : "";
    const returnText = `${data.empId || ''} - ${data.userName || ''}${contactInfo}`;
    
    document.getElementById('ut_return_by').textContent = returnText;
    document.getElementById('ut_date_return').textContent = `Date: ${dateStr} Time: ${timeStr}`;
    
    // Clear receiving section
    document.getElementById('ut_name').textContent = "---";
  }
}
/* -------------------------------- Export PDF Undertaking -------------------------------- */



/* -------------------------------- Users -------------------------------- */
async function loadUsers(){
  if (state.me?.role !== 'SuperAdmin') {
   if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
   state.users = [];
   return;
 }
 if (unsubscribeUsers) unsubscribeUsers();
  unsubscribeUsers = onSnapshot(
    collection(db, COLL_USERS),
   (snap) => {
      state.users = snap.docs.map(d=>({ id:d.id, ...d.data() }));
     renderUsers();
applyAssetFilters();
   },
   (err)=> console.error("Users onSnapshot error:", err)
  );
}


function renderUsers(){
  // Hide or show Users page actions based on role
  if(state.me?.role!=='SuperAdmin'){ return; }
  const tbody = $('#userTbody'); tbody.innerHTML='';
  state.users.forEach(u=>{
    const tr=document.createElement('tr');
tr.innerHTML = `
  <td>${u.username||''}</td>
  <td>${u.role||''}</td>
  <td>
    <button class="page-btn" onclick="openPw('${u.id}','${u.username||''}')">Change Password</button>
    ${
      u.role === 'SuperAdmin'
        ? ''   // üîí No delete button for SuperAdmin
        : `<button class="page-btn" onclick="deleteUser('${u.id}')">Delete</button>`
    }
  </td>`;

    tbody.appendChild(tr);
  });
}


async function addUser(){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can add users'); return; }
  const username = $('#newU').value.trim();
  const password = $('#newP').value.trim();
  const role     = $('#newRole').value;
  if(!username||!password){ toast('Username & Password required'); return; }

  // prevent dup username
  const qSnap = await getDocs(query(collection(db, COLL_USERS), where("username","==",username)));
  if(!qSnap.empty){ toast('Username already exists'); return; }

  await addDoc(collection(db, COLL_USERS), { username, password, role, createdAt: serverTimestamp() });
  $('#newU').value=''; $('#newP').value=''; $('#newRole').value='Viewer';
  await loadUsers();
  toast('User added');
}
window.addUser = addUser;

async function deleteUser(id){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can delete users'); return; }
  if(!confirm('Delete this user?')) return;
  await deleteDoc(doc(db, COLL_USERS, id));
  await loadUsers();
  toast('User deleted');
}
window.deleteUser = deleteUser;
function renderAL6M(){
  const tbody = $('#al6mBody'); 
  tbody.innerHTML = '';

  state.annualLeaveOver6M.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${d.empId||''}</td>
      <td>${d.name||''}</td>
      <td>${d.designation||''}</td>
      <td>${d.project||''}</td>
      <td>${d.vehicleNo||''}</td>
      <td>${d.assetCode||''}</td>
      <td>${d.contact||''}</td>
      <td>${d.joiningDate||''}</td>
      <td>${d.leaveSince||''}</td>
      <td>${d.leaveTill||''}</td>
      <td>${d.status||''}</td>
      <td>${d.remarks||''}</td>
      <td>${d.category||''}</td>
      <td>${d.overstayDays||''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function openPw(id, username){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can change passwords'); return; }
  $('#pwUser').value = id;
  $('#pwNew').value = '';
  $('#pwConfirm').value = '';
  $('#pwModal').style.display='flex';
}
window.openPw = openPw;

function closePw(){ $('#pwModal').style.display='none'; }
window.closePw = closePw;

async function savePw(){
  const id = $('#pwUser').value;
  const np = $('#pwNew').value.trim();
  const cp = $('#pwConfirm').value.trim();
  if(!np){ toast('Enter new password'); return; }
  if(np!==cp){ toast('Passwords do not match'); return; }
  await updateDoc(doc(db, COLL_USERS, id), { password: np });
  closePw();
  await loadUsers();
  toast('Password updated');
}
window.savePw = savePw;


/* ------------------------------- Drivers -------------------------------- */
async function loadDrivers() {
  // ... existing cache logic (keep it if you want) ...

  if (unsubscribeDrivers) unsubscribeDrivers();

  // Listen to the most recent 100 drivers/operators
  const q = query(
    collection(db, COLL_DRIVERS),
    orderBy("createdAt", "desc"),
    limit(100)
  );

  unsubscribeDrivers = onSnapshot(q, (snap) => {
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      state.drivers = arr;
      
      deriveAnnualLeaveList();
      updateDriverCache();
      refreshAll();
      
      // Update Dashboard KPIs separately
      updateDriverDashboardCounts();
      
      if (!snap.metadata.fromCache) {
         setDataStatus("üîÑ Live (Recent 100)", "#16a34a");
      }
    },
    (err) => console.error("onSnapshot error:", err)
  );
}

  //Lazy refresh: only if cache expired
  if (needsRefresh) {
    const snap = await getDocs(collection(db, COLL_DRIVERS));
    const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    arr.sort((a, b) => {
      const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
      const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
      return tb - ta;
    });
    state.drivers = arr;
    deriveAnnualLeaveList();
    updateDriverCache();
    refreshAll();
	setDataStatus("‚úÖ Fresh data", "#2563eb");  // blue
    console.log("‚úÖ Cache refreshed after 24h");
  }



// 1. Navigation update
// ... existing nav function code ...
window.nav = function(id) {
  // 1. Hide all sections
  $$('.section').forEach(s => s.style.display = 'none');
  
  // 2. Clear actives
  $$('.nav a').forEach(a => a.classList.remove('active'));

  // 3. Show target
  const target = $(`#${id}`);
  if(target) target.style.display = 'block';

  // 4. Highlight Nav (Handle dropdown parent)
  const link = $(`#nav-${id}`);
  if(link) link.classList.add('active');
  // Keep parent active if submenu clicked
  if(id.startsWith('report')) $('#nav-reports').classList.add('active');

  // 5. Loaders
  if(id === 'dashboard') renderDashboard();
  if(id === 'list') { applyRoleUI(); applyFilters(); }
  if(id === 'projectsSection') { loadProjects(); applyProjFilters(); }
  if(id === 'users') renderUsers();
  if(id === 'al6m') renderAL6M();
  if(id === 'undertaking') { /* ... */ }
  
  // NEW REPORT LOADER
  if(id === 'reportRegExp') renderRegExpiryReport();
if(id === 'reportRegRenewal') {
     // Don't load data immediately. Just set default dates (e.g., this month)
     setRepDate('month');
  }
};

// Registartion Expiry Function

window.renderRegExpiryReport = function() {
  const tbody = document.getElementById('regReportBody');
  tbody.innerHTML = '';
  
  const today = new Date();
  const warningLimit = 15; // Days

  const reportData = state.assets.filter(a => {
    if(!a.regExp) return false; // Ignore if no date
    const expDate = new Date(a.regExp);
    const diffTime = expDate - today;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    // Filter: Expired OR Expiring within 15 days
    return diffDays <= warningLimit;
  });

  reportData.sort((a,b) => new Date(a.regExp) - new Date(b.regExp)); // Sort by date ascending

  reportData.forEach(a => {
    const expDate = new Date(a.regExp);
    const diffDays = Math.ceil((expDate - today) / (1000 * 60 * 60 * 24));
    
    let statusBadge = '';
    if(diffDays < 0) statusBadge = `<span class="badge b-bad">Expired (${Math.abs(diffDays)} days ago)</span>`;
    else statusBadge = `<span class="badge b-warn">Expiring in ${diffDays} days</span>`;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${a.vmNo || ''}</td>
      <td>${a.assetNo || ''}</td>
      <td>${a.project || ''}</td>
      <td>${a.regNo || ''}</td>
      <td style="font-weight:bold">${a.regExp || ''}</td>
      <td>${diffDays}</td>
      <td>${statusBadge}</td>
    `;
    tbody.appendChild(tr);
  });
};

window.exportRegReport = function() {
  // Simple Excel Export for the report
  const today = new Date();
  const data = state.assets
    .filter(a => a.regExp && Math.ceil((new Date(a.regExp) - today) / (86400000)) <= 15)
    .map(a => ({
       "VM No": a.vmNo,
       "Asset No": a.assetNo,
       "Project": a.project,
       "Reg Expiry": a.regExp,
       "Days Remaining": Math.ceil((new Date(a.regExp) - today) / (86400000))
    }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Expiry_Report");
  XLSX.writeFile(wb, "Reg_Expiry_Report.xlsx");
};


state.assets = [];
state.assetFiltered = [];
// Function to populate User Dropdown and Auto-fill
window.autoFillUserDetail = function() {
  const selectedEmpId = document.getElementById('a_userSelect').value;
  const user = state.drivers.find(d => d.empId === selectedEmpId);
  if (user) {
    document.getElementById('a_designation').value = user.designation;
    document.getElementById('a_contact').value = user.contact;
  }
};

// Function to populate the User Dropdown when opening the modal
window.openAssetModal = function() {
  // Show the modal first
  const modal = document.getElementById('assetModal');
  if (modal) modal.style.display = 'flex';

  // 1. Populate User Searchable Dropdown List
  // We target the '.list' div inside your new 'a_userDD' container
  const userListDiv = document.querySelector('#a_userDD .list');
  if (userListDiv) {
    // We use state.drivers (or state.data) to fill the searchable list
    userListDiv.innerHTML = state.drivers.map(u => `
      <div class="item" onclick="setDD('a_userDD', '${u.empId}', '${u.empId} - ${u.name}')">
        ${u.empId} - ${u.name}
      </div>
    `).join('');
  }

  // 2. Populate Project Searchable Dropdown List
  // We target the '.list' div inside your new 'a_projectDD' container
const projListDiv = document.querySelector('#a_projectDD .list');
  if (projListDiv) {
    projListDiv.innerHTML = state.projects.map(p => `
      <div class="item" onclick="setDD('a_projectDD', '${p.p_id}', '${p.p_name} (${p.p_id})')">
        ${p.p_name} (${p.p_id})
      </div>
    `).join('');
  }
  
// Add this line where you populate the edit fields:
handleAssetStatusChange();
};


window.editAsset = function (assetId) {
  const asset = state.assets.find(a => a.id === assetId);
  if (!asset) { alert("Asset not found"); return; }

  currentEditAssetId = assetId;
  document.querySelector('#assetModal h3').textContent = "Edit Asset";
  document.getElementById('assetModal').style.display = 'flex';

  // Standard Fields
  document.getElementById('a_vmNo').value = asset.vmNo || '';
  document.getElementById('a_assetNo').value = asset.assetNo || '';
  document.getElementById('a_brand').value = asset.brand || '';
  document.getElementById('a_category').value = asset.category || '';
  document.getElementById('a_regNo').value = asset.regNo || '';
  document.getElementById('a_regExp').value = asset.regExp || '';
  document.getElementById('a_from').value = asset.from || '';
  document.getElementById('a_till').value = asset.till || '';
  document.getElementById('a_status').value = asset.status || 'IDLE';
  document.getElementById('a_shift').value = asset.shift || 'Day';
  document.getElementById('a_remarks').value = asset.remarks || '';

  // Handle User Dropdown
  const userDD = document.getElementById('a_userDD');
  let userDisplay = "Select User (ID - Name)";
  
  if (asset.empId) {
    const driver = state.drivers.find(d => d.empId === asset.empId);
    userDisplay = driver ? `${driver.empId} - ${driver.name}` : `${asset.empId} - ${asset.userName || 'Unknown'}`;
    userDD.dataset.value = asset.empId;
    
    // Auto-fill disabled fields
    document.getElementById('a_designation').value = asset.designation || (driver?.designation || '');
    document.getElementById('a_contact').value = asset.contact || (driver?.contact || '');
    
    // Driver Leave Date
    if (driver && driver.leaveTill) document.getElementById('a_driverLeaveTill').value = driver.leaveTill;
  } else {
    userDD.dataset.value = '';
    document.getElementById('a_designation').value = '';
    document.getElementById('a_contact').value = '';
  }
  userDD.querySelector('.selected').textContent = userDisplay;

  // --- FIX: PROJECT SELECTION BY ID ---
  const projDD = document.getElementById('a_projectDD');
  // Prefer projectId, fall back to project name if old data
  const pId = asset.projectId || ''; 
  const pName = asset.project || '';
  
  // Try to find the project object to get the perfect display string
  // If we have an ID, find by ID. If not, find by Name.
  const projObj = state.projects.find(p => pId ? p.p_id === pId : p.p_name === pName);

  if (projObj) {
    projDD.dataset.value = projObj.p_id; // STORE THE ID
    projDD.querySelector('.selected').textContent = `${projObj.p_name} (${projObj.p_id})`;
  } else if (pName) {
    // Old data without ID
    projDD.dataset.value = ''; // No ID known
    projDD.querySelector('.selected').textContent = pName; 
  } else {
    projDD.dataset.value = '';
    projDD.querySelector('.selected').textContent = 'Select Project';
  }
  
  // Re-populate lists so they are clickable
  openAssetModal(); // This just refreshes the list HTML
};



// Example usage inside your edit function:
// prepareDateInput('joiningDate', driver.joiningDate);

/* ===== Search Dropdown Core (GLOBAL) ===== */

// This makes the function globally accessible to the 'oninput' in your HTML
window.filterDD = function(id, type) {
  const dd = document.getElementById(id);
  const input = dd.querySelector('.search-input');
  const panel = document.getElementById(id + 'List');
  const term = input.value.toLowerCase();
  
  let list = [];
  if (type === 'user') list = state.users;
  else if (type === 'project') list = state.projects;
  else if (type === 'asset') list = state.assets;

  const filtered = list.filter(item => {
    const val = (type === 'project') ? item.name : (item.name || item.assetName || item.displayName || "");
    return val.toLowerCase().includes(term);
  });

  panel.innerHTML = '';
  filtered.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    
    // Determine display name based on type
    let displayName = item.name || item.assetName || item.displayName || "";
    div.textContent = displayName;

    div.onclick = () => {
      // 1. Set the selected value
      input.value = displayName;
      dd.dataset.value = (type === 'project') ? item.name : item.id;
      dd.classList.remove('open');

      // 2. AUTO-FILL LOGIC: If we are selecting a user in the Driver/Operator modal
      if (id === 'uUserDD') {
        performAutoFill(item);
      }
    };
    panel.appendChild(div);
  });
  
  dd.classList.add('open');
};

// New Helper Function for Auto-fill
function performAutoFill(userItem) {
  // Fill Project
  if (userItem.project) {
    const pDD = document.getElementById('uProjectDD');
    if (pDD) {
      pDD.querySelector('.search-input').value = userItem.project;
      pDD.dataset.value = userItem.project;
    }
  }

  // Fill Asset Details (Vehicle No and T-Code)
  const targetAssetId = userItem.assignedAsset || userItem.assetId;
  if (targetAssetId) {
    const asset = state.assets.find(a => a.id === targetAssetId);
    if (asset) {
      // Set Vehicle No Dropdown
      const aDD = document.getElementById('uAssetDD');
      if (aDD) {
        aDD.querySelector('.search-input').value = asset.assetName || asset.name;
        aDD.dataset.value = asset.id;
      }
      // Set T-Code Input
      const tInput = document.getElementById('uTCode');
      if (tInput) {
        tInput.value = asset.assetTCode || asset.tCode || "";
      }
    }
  }
}

// 1. Toggle panel visibility
document.addEventListener('click', (e) => {
  const dd = e.target.closest('.search-dd');
  // Close all other panels
  document.querySelectorAll('.search-dd .panel').forEach(p => {
    if (!dd || p !== dd.querySelector('.panel')) p.style.display = 'none';
  });
  // Toggle current panel
  if (dd && e.target.classList.contains('selected')) {
    const panel = dd.querySelector('.panel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    if (panel.style.display === 'block') panel.querySelector('input').focus();
  }
});


window.setDD = function(ddId, value, text) {
  const dd = document.getElementById(ddId);
  if (!dd) return;
  
  // Update the visible text and store the value
  dd.querySelector('.selected').textContent = text;
  dd.dataset.value = value;
  dd.querySelector('.panel').style.display = 'none';

  // --- NEW AUTOFILL LOGIC FOR ASSETS ---
  if (ddId === 'a_userDD') {
    // Find the driver in the global state using the Employee ID (value)
    const driver = state.drivers.find(d => d.empId === value);
    
    if (driver) {
      // Fill the designation and contact fields automatically
      document.getElementById('a_designation').value = driver.designation || '';
      document.getElementById('a_contact').value = driver.contact || '';
    } else {
      // Clear them if no driver is found
      document.getElementById('a_designation').value = '';
      document.getElementById('a_contact').value = '';
    }
  }
if (ddId === 'a_projectDD') {
    // value here should be p.p_name passed from the onclick
    console.log("Project selected:", value); 
  }
};

// 2. Auto-fill Designation and Contact on Selection
window.onAssetUserChange = function() {
  const empId = document.getElementById('a_userSelect').value;
  const driver = state.drivers.find(d => d.empId === empId);
  if (driver) {
    document.getElementById('a_designation').value = driver.designation;
    document.getElementById('a_contact').value = driver.contact;
  } else {
    document.getElementById('a_designation').value = "";
    document.getElementById('a_contact').value = "";
  }
}



window.saveOrUpdateAsset = async function () {
  // 1. Grab values from the Form
  const vmNo = document.getElementById('a_vmNo').value;
  const assetNo = document.getElementById('a_assetNo').value;
const brand = document.getElementById('a_brand').value;
  const category = document.getElementById('a_category').value;
  
  // User Details (Raw input)
  const empId = document.getElementById('a_userDD').dataset.value || "";
  const userText = document.getElementById('a_userDD').querySelector('.selected').textContent;
  const userName = userText.includes("Select User") ? "" : userText.split('-')[1]?.trim(); // Extract name
  const designation = document.getElementById('a_designation').value;
  const contact = document.getElementById('a_contact').value;
  
  const selectedProjId = document.getElementById('a_projectDD').dataset.value || "";
  let projectName = "";
  let projectID = "";


  const regNo = document.getElementById('a_regNo').value;
  const regExp = document.getElementById('a_regExp').value;
  const from = document.getElementById('a_from').value;
  const till = document.getElementById('a_till').value;
  const status = document.getElementById('a_status').value || "IDLE";
  const shift = document.getElementById('a_shift').value || "Day";
  const remarks = document.getElementById('a_remarks').value;


const projectObj = state.projects.find(p => p.p_id === selectedProjId);
  
  if (projectObj) {
    projectName = projectObj.p_name;
    projectID = projectObj.p_id;
  } else {
    // Fallback: If no ID (maybe they didn't touch the dropdown and it was old data), use the text
    const textVal = document.getElementById('a_projectDD').querySelector('.selected').textContent;
    if (textVal !== "Select Project") {
      // Clean up "Name (ID)" format if present
      projectName = textVal.split('(')[0].trim();
    }
  }

  // Validation
  if (!vmNo || !assetNo) {
    alert("Please fill required fields (V/M No and Asset No)");
    return;
  }


const existingAsset = currentEditAssetId ? state.assets.find(a => a.id === currentEditAssetId) : null;
  const hasStatusChanged = !existingAsset || existingAsset.status !== status;  
  // Create a temporary object of the CURRENT form state to fill the undertaking
const formState = {
    category, vmNo, assetNo, regExp, empId, userName, 
    designation, contact, project: projectName, status
  };
  // Helper to fill undertaking UI directly
  fillUndertakingFromData(formState);

  // ---------------------------------------------------------
  // 3. PREPARE DATA FOR FIRESTORE
  // ---------------------------------------------------------

const data = {
    vmNo, assetNo, brand, category, 
    project: projectName, // Save the name to the asset
    projectId: projectID, // NEW: Save the ID to the asset for accuracy
    regNo, regExp, from, till, status, shift, remarks,
    updatedAt: serverTimestamp()
  };

  // LOGIC: If Status is "In operation", SAVE user details.
  // If Status is anything else (returned), CLEAR user details.
  if (status === 'In operation') {
    data.empId = empId;
    data.userName = userName; // Save name too for easier logging
    data.designation = designation;
    data.contact = contact;
  } else {
    // CLEAR USER DETAILS IN DB
    data.empId = "";
    data.userName = "";
    data.designation = "";
    data.contact = "";
    
    // Note: We leave 'project' as it might stay on site, but cleared user.
    // If you want to clear project too, uncomment next line:
    // data.project = ""; 
  }

  showLoader();
  try {
    let assetRefId = currentEditAssetId;

    // 4. SAVE TO DB (Assets Collection)
    if (currentEditAssetId) {
      await updateDoc(doc(db, COLL_ASSETS, currentEditAssetId), data);
    } else {
      const ref = await addDoc(collection(db, COLL_ASSETS), data);
      assetRefId = ref.id;
    }

    // 5. SAVE LOG (Full Snapshot in Table Format)
 if (hasStatusChanged|| !currentEditAssetId) {
await addDoc(collection(db, COLL_ASSET_LOGS), {
        parentId: assetRefId,
        type: currentEditAssetId ? "UPDATE" : "CREATE",
        vmNo, assetNo, brand, category,
        empId: formState.empId, userName: formState.userName,
        designation: formState.designation, contact: formState.contact,
        project: projectName, // FIXED: was 'project', now 'projectName'
        regNo, regExp, from, till, status, shift, remarks,
        user: state.me.username,
        timestamp: serverTimestamp()
      });
}

// B. NEW: Check for Registration Renewal
    // We compare form value (regExp) with existing data (existingAsset.regExp)
    if (currentEditAssetId && existingAsset) {
        const oldExp = existingAsset.regExp;
        const newExp = regExp; // from form input

        // If new date is provided AND it is different from old date
        if (newExp && newExp !== oldExp) {
            await addDoc(collection(db, COLL_ASSET_LOGS), {
                parentId: assetRefId,
                type: "REG_RENEWAL", // Specific type for the report
                vmNo, 
                assetNo,
                project: projectName,
                oldRegExp: oldExp,
                newRegExp: newExp, // The expiry date
                remarks: remarks, // Optional: capture remarks made during renewal
                user: state.me.username,
                timestamp: serverTimestamp() // The actual date/time the work was done
            });
        }
    }


    // 6. UPDATE DRIVER STATUS (If applicable)
    // ... (Keep your existing driver update logic here) ...
    const drvStatus = document.getElementById('a_driverStatus').value;
    const drvLeaveTill = document.getElementById('a_driverLeaveTill').value;
    
    if (empId) { // Use the empId we grabbed at the start
      const tech = state.drivers.find(d => d.empId === empId);
      if (tech) {
         // ... (Your existing logic for updating driver goes here) ...
         // Simplified for brevity, ensure you keep the logic from your previous code
        // const projectObj = state.projects.find(p => p.p_name === project);
         const projectWithId = projectObj ? `${projectName} (${projectID})` : projectName;
         
         let driverUpdates = { status: drvStatus };
         
         if (status === 'In operation') {
           driverUpdates.project = projectWithId;
           driverUpdates.vehicleNo = vmNo;
           driverUpdates.assetCode = assetNo;
         } else {
           driverUpdates.project = "";
           driverUpdates.vehicleNo = "";
           driverUpdates.assetCode = "";
         }
         
         // Driver Dates Logic
         if (drvStatus !== 'Active') {
            driverUpdates.leaveSince = till ? till.split('T')[0] : new Date().toISOString().split('T')[0];
            driverUpdates.leaveTill = drvLeaveTill || null;
         } else {
            driverUpdates.leaveSince = null;
            driverUpdates.leaveTill = null;
         }

         await updateDoc(doc(db, COLL_DRIVERS, tech.id), driverUpdates);
         // Only log driver status change if it actually changed
          if (tech.status !== drvStatus) {
            await logStatusChange(tech.id, drvStatus, `Updated via Asset ${assetNo} (${status})`);
          }
      }
    }

    // 7. CLEAN UP & REDIRECT
    resetAssetForm();
    closeAssetModal();
    toast("‚úÖ Saved & Form Generated");
    
    // Redirect to Undertaking Section automatically
    nav('undertaking');

  } catch (err) {
    console.error(err);
    alert("Error saving: " + err.message);
  } finally {
    hideLoader();
  }
};



function prepareDateInput(id, value) {
  const el = document.getElementById(id);
  if (value) {
    el.type = el.id.includes('Time') || el.id.includes('from') || el.id.includes('till') ? 'datetime-local' : 'date';
    el.value = value;
  } else {
    el.type = 'text';
    el.value = '';
  }
}
// 2. Load from Firebase
async function loadProjects() {
// FIND THIS SECTION IN YOUR CODE:
unsubscribeProjects = onSnapshot(collection(db, COLL_PROJECTS), (snap) => {
  state.projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  // FIX: Populate the "Add Asset" Dropdown
  const aProjSelect = document.getElementById('a_project');
  if (aProjSelect) {
    aProjSelect.innerHTML = '<option value="">Select Project</option>'; // Reset
    state.projects.forEach(proj => {
      const opt = document.createElement('option');
      // Use the exact field names from your Projects collection
      const pName = proj.p_name || "Unknown";
      const pId = proj.p_id || "";
      
      opt.value = pName; 
      opt.textContent = pId ? `${pId} - ${pName}` : pName;
      aProjSelect.appendChild(opt);
    });
  }

  renderProjTable();
  updateProjectDropdowns();
fillProjectDD("a_projectDD");
fillProjectDD("driverProjectDD");
updateAssetProjectFilter();
});
}

function fillProjectDD(id) {
  const list = document.querySelector(`#${id} .list`);
  if (!list) return;

  list.innerHTML = "";

  state.projects.forEach(p => {
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = `${p.p_id} - ${p.p_name}`;
    div.onclick = () => setDD(id, p.p_name, div.textContent);
    list.appendChild(div);
  });
}


function updateProjectDropdowns() {
  const filterDropdown = $('#fProject');    // The search filter
  const addFormDropdown = $('#fProjectVal'); // The add driver form
  const editFormDropdown = $('#e_project');  // The edit driver modal

  const optionsHtml = state.projects
    .map(p => {
      const displayString = `${p.p_id}-${p.p_name} `; // Format: Project A (PRJ001)
      return `<option value="${p.p_id}">${displayString}</option>`;
    })
    .join('');

  if (filterDropdown) filterDropdown.innerHTML = '<option value="">All Projects</option>' + optionsHtml;
  if (addFormDropdown) addFormDropdown.innerHTML = '<option value="">Select Project</option>' + optionsHtml;
  if (editFormDropdown) editFormDropdown.innerHTML = '<option value="">Select Project</option>' + optionsHtml;
}
// 3. Filters and Rendering
window.applyProjFilters = function() {
  const term = $('#projSearch').value.toLowerCase();
  const stat = $('#fProjStatus').value;
  state.projPageSize = parseInt($('#projPageSize').value);

  state.projFiltered = state.projects.filter(p => {
    const matchSearch = (p.p_name||'').toLowerCase().includes(term) || (p.p_id||'').toLowerCase().includes(term);
    const matchStatus = !stat || p.status === stat;
    return matchSearch && matchStatus;
  });

  state.projTotalPages = Math.max(1, Math.ceil(state.projFiltered.length / state.projPageSize));
  renderProjTable();
};

function renderProjTable() {
  const tbody = $('#projTbody');
  tbody.innerHTML = '';

  const start = (state.projPage - 1) * state.projPageSize;
  const end = start + state.projPageSize;
  const paged = state.projFiltered.slice(start, end);

  paged.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:bold; color:var(--brand);">${p.p_id || ''}</td>
      <td>${p.p_name || ''}</td>
      <td>${p.p_loc || ''}</td>
      <td>${p.p_div || ''}</td>
      <td>${p.p_date || ''}</td>
      <td>
  <span class="badge ${(p.status || p.p_status) === 'Active' ? 'b-ok' : 'b-warn'}">
    ${p.status || p.p_status || 'N/A'}
  </span>
</td>
      <td>
        <button class="btn" onclick="editProject('${p.id}')">Edit</button>
        <button class="btn warn" style="margin-left:5px" onclick="deleteProject('${p.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Update pagination info
  const info = $('#projPageInfo');
  if(info) info.textContent = `Page ${state.projPage} of ${Math.ceil(state.projFiltered.length / state.projPageSize) || 1}`;
}

// 4. CRUD Operations
window.addProject = async function() {
  const data = {
    p_id: $('#p_id').value,
    p_name: $('#p_name').value,
    p_loc: $('#p_loc').value,
    p_div: $('#p_div').value,
    p_date: $('#p_date').value,
    status: $('#p_status').value,
    createdAt: serverTimestamp()
  };
  await addDoc(collection(db, COLL_PROJECTS), data);
  toast("Project Added!");
  // Clear inputs
  ['p_id','p_name','p_loc','p_div','p_date'].forEach(id => $(`#${id}`).value = '');
};

// 1. Function to open the Edit Card and fill it with data

window.editProject = function(id) {
  const p = state.projects.find(proj => proj.id === id);
  if (!p) return;

  state.editProjDocId = id;

  // Fill the pop-up inputs
  $('#ep_id').value = p.p_id || '';
  $('#ep_name').value = p.p_name || '';
  $('#ep_loc').value = p.p_loc || '';
  $('#ep_div').value = p.p_div || '';
  $('#ep_date').value = p.p_date || '';
  $('#ep_status').value = p.status || 'Active';

  // Show the Modal as a Pop-up
  const modal = $('#projectEditModal');
  modal.style.display = 'flex'; 
};

window.closeProjEdit = function() {
  $('#projectEditModal').style.display = 'none';
  state.editProjDocId = null;
};

window.saveProjUpdate = async function() {
  if (!state.editProjDocId) return;

  const data = {
    p_id: $('#ep_id').value,
    p_name: $('#ep_name').value,
    p_loc: $('#ep_loc').value,
    p_div: $('#ep_div').value,
    p_date: $('#ep_date').value,
    status: $('#ep_status').value
  };

  try {
    showLoader();
    await updateDoc(doc(db, COLL_PROJECTS, state.editProjDocId), data);
    toast("‚úÖ Project updated successfully!");
    closeProjEdit(); // Close the pop-up
  } catch (err) {
    console.error("Update Error:", err);
    toast("‚ùå Update Failed");
  } finally {
    hideLoader();
  }
};


window.deleteProject = async function(id) {
  if (!confirm("Are you sure you want to delete this project?")) return;
  try {
    showLoader();
    await deleteDoc(doc(db, COLL_PROJECTS, id));
    toast("üóëÔ∏è Project deleted");
  } catch (err) {
    toast("‚ùå Delete failed");
  } finally {
    hideLoader();
  }
};

window.gotoProjPage = (p) => {
  if(p < 1 || p > state.projTotalPages) return;
  state.projPage = p;
  renderProjTable();
};

window.exportProjExcel = function() {
  const data = state.projFiltered.map(p => ({
    "Project ID": p.p_id,
    "Project Name": p.p_name,
    "Location": p.p_loc,
    "Division": p.p_div,
    "Creation Date": p.p_date,
    "Status": p.status
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Projects");
  XLSX.writeFile(wb, "Projects_List.xlsx");
};
function updateDriverProjectDropdown() {
  const select = $('#fProjectVal');
  if (!select) return;

  const currentVal = select.value;
  select.innerHTML = '<option value="">Select Project</option>';

  state.projects
    .filter(p => p.p_status === 'Active') // Use p_status
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.p_name;
      // UPDATED: Show Name (ID)
      opt.textContent = `${p.p_name} (${p.p_id})`; 
      select.appendChild(opt);
    });
    
  if(currentVal) select.value = currentVal;
}
function updateDriverFilterDropdown() {
  const filterSelect = $('#fProject');
  if (!filterSelect) return;

  // Preserve the current selection if the user already picked a project
  const currentFilterVal = filterSelect.value;
  
  // Clear and add the default "All Projects"
  filterSelect.innerHTML = '<option value="">All Projects</option>';

  // Sort projects alphabetically and add them
  state.projects
    .filter(p => p.status === 'Active') // Optional: Only show Active projects in filter
    .sort((a, b) => (a.p_name || "").localeCompare(b.p_name || ""))
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.p_name;
      opt.textContent = p.p_name;
      filterSelect.appendChild(opt);
    });

  // Restore previous value
  filterSelect.value = currentFilterVal;
}
// --- LISTEN FOR ASSETS ---
function listenToAssets() {
    const q = query(
        collection(db, COLL_ASSETS),
        orderBy("updatedAt", "desc"),
        limit(100)
    );

    onSnapshot(q, (snapshot) => {
        state.assets = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
        }));
        
        // Ensure the search flag is off so it uses the loaded data
        state.isSearching = false; 
        
        // Force count update and filter application
        updateAssetDashboardCounts();
        applyAssetFilters(); // This will call renderAssetTable()
    }, (error) => {
        console.error("Asset listener error:", error);
    });
}

/* --- applyAssetFilters --- */
window.applyAssetFilters = async function() {
  const term = (document.getElementById('assetSearch').value || '').trim().toLowerCase();
  
  // Get Dropdown Values
  const fCat = document.getElementById('fAssetCat').value;
  const fProj = document.getElementById('fAssetProject').value; // Ensure this ID matches your HTML
  const fStatus = document.getElementById('fAssetStatus').value;
  
  // 1. Client-Side Filtering (Default or if search term is empty)
  // Note: If you want server-side search for ID/VM No, we can do that, 
  // but let's first filter what we have in memory (state.assets) for speed.
  
  let sourceData = state.assets; // The 100 recent items loaded by listener

  state.filteredAssets = sourceData.filter(a => {
    // Text Search (Partial match on common fields)
    const matchesTerm = !term || 
      (a.vmNo||'').toLowerCase().includes(term) ||
      (a.assetNo||'').toLowerCase().includes(term) ||
      (a.project||'').toLowerCase().includes(term);

    // Dropdown Filters
    const matchesCat = !fCat || a.category === fCat;
    
    // For Project Filter: Check both Name and ID
    // The dropdown usually returns p_id (if you updated it) or Name. 
    // Let's assume the dropdown value is the ID.
    const matchesProj = !fProj || a.projectId === fProj || a.project === fProj;
    
    const matchesStatus = !fStatus || a.status === fStatus;

    return matchesTerm && matchesCat && matchesProj && matchesStatus;
  });

  // Reset to Page 1
  state.assetPage = 1;
  state.assetTotalPages = Math.max(1, Math.ceil(state.filteredAssets.length / state.pageSize));
  
  renderAssetTable();
};
/* --- ADD: Pagination Control for Assets --- */
// Add these functions to handle Next/Prev for Assets
window.changeAssetPage = function(delta) {
  const newPage = state.assetPage + delta;
  if (newPage >= 1 && newPage <= state.assetTotalPages) {
    state.assetPage = newPage;
    renderAssetTable();
  }
};

function updateAssetProjectFilter() {
  const sel = document.getElementById('fAssetProject');
  if(!sel) return;
  
  sel.innerHTML = '<option value="">All Projects</option>';
  state.projects.forEach(p => {
    // Value is ID, Text is Name
    sel.innerHTML += `<option value="${p.p_id}">${p.p_name}</option>`;
  });
}

// Add this to update the page numbers at the bottom
function updateAssetPagination() {
  const info = document.getElementById('assetPageInfo'); // Ensure this ID exists in your HTML pagination
  if(info) info.textContent = `Page ${state.assetPage} of ${state.assetTotalPages}`;
}


/* --- Inside your deleteAsset function --- */

window.deleteAsset = async function(id) {
  if(!confirm("‚ö†Ô∏è Are you sure? This will delete the Asset AND all its History Logs permanently.")) return;
  
  showLoader();
  try {
    const batch = writeBatch(db);

    // 1. Delete the Asset Document
    const assetRef = doc(db, COLL_ASSETS, id);
    batch.delete(assetRef);

    // 2. Find and Delete all related logs
    // Note: We limit to 450 because batch limit is 500. 
    // If you have >500 logs per asset, you need a recursive delete (rare for this use case).
    const qLogs = query(collection(db, COLL_ASSET_LOGS), where("parentId", "==", id), limit(450));
    const logSnap = await getDocs(qLogs);
    
    logSnap.forEach((logDoc) => {
      batch.delete(logDoc.ref);
    });

    // 3. Commit the Batch (Atomic operation)
    await batch.commit();

    toast("‚úÖ Asset and History Logs deleted successfully.");
  } catch(err) {
    console.error(err);
    alert("Error deleting: " + err.message);
  } finally {
    hideLoader();
  }
};
window.deleteAsset = deleteAsset; 

// Helper function to reset the form for "Best Results" and clean UI
function resetAssetForm() {
  document.querySelector('#assetModal h3').textContent = "Add New Asset";
  currentEditAssetId = null;
  document.querySelectorAll('#assetModal input, #assetModal textarea').forEach(i => i.value = '');
  document.getElementById('a_userDD').dataset.value = '';
  document.getElementById('a_projectDD').dataset.value = '';
  document.querySelector('#a_userDD .selected').textContent = 'Select User (ID - Name)';
  document.querySelector('#a_projectDD .selected').textContent = 'Select Project';
}


window.closeAssetModal = function() {
  document.getElementById('assetModal').style.display = 'none';
resetAssetForm();
}


async function updateAssetDashboardCounts() {
  try {
    // This costs 1/1000th of a read per document. Very cheap.
    const coll = collection(db, COLL_ASSETS);
    const snap = await getCountFromServer(coll);
    const total = snap.data().count;
    
    // Update the HTML element
    document.getElementById('kpi_asset_total').textContent = total;
    
    // Note: For detailed breakdown (Active vs Idle) without reading data, 
    // you'd ideally need a "Stats" document. 
    // For now, we will show "Total" accurately, and subgroups based on loaded data 
    // or you can run specific count queries for them too:
    
    const qOp = query(coll, where("status", "==", "In operation"));
    const snapOp = await getCountFromServer(qOp);
    document.getElementById('kpi_asset_sub').textContent = `Op: ${snapOp.data().count} | (Est. others)`;
    
  } catch(e) { console.error("Count error", e); }
}

async function updateDriverDashboardCounts() {
    const coll = collection(db, COLL_DRIVERS);
    const snap = await getCountFromServer(coll);
    document.getElementById('kpi_driver_total').textContent = snap.data().count;
}





function deriveAnnualLeaveList(){
  state.annualLeaveOver6M = state.drivers.filter(d => {
    if(d.status !== "On Leave") return false;

    const leaveSince = d.leaveSince ? new Date(d.leaveSince) : null; // "Leave Since/ Resigned Date"
    const leaveTill  = d.leaveTill ? new Date(d.leaveTill) : null;
    const today = new Date();
const grace = 10 * 24 * 60 * 60 * 1000; // 10 days in ms

    let category = "";
    let overstayDays = 0;

    // 1) If > 6 months since leaveSince
    if (leaveSince && (today - leaveSince) > (180*24*60*60*1000)) {
      category = "Leave > 6 Months";
      if (leaveTill) {
        overstayDays = Math.max(0, Math.floor((today - leaveTill) / (1000*60*60*24)));
      }
    }
    // 2) Otherwise, if overstayed beyond leaveTill
 else if (leaveTill && today > new Date(leaveTill.getTime() + grace)) {
        category = "Overstay";
        overstayDays = Math.floor(
          (today - leaveTill.getTime()) / (1000 * 60 * 60 * 24)
        );
      }
    else {
      return false; // Not included
    }

    d.category = category;
    d.overstayDays = overstayDays;
    return true;
  });
}


function updateDriverCache(){
  localStorage.setItem("driversCache", JSON.stringify({
    timestamp: Date.now(),
    data: state.drivers
  }));
}

function refreshAll(){
  renderDashboard();
  applyFilters();
}



// Disable/enable leaveSince based on status
$('#status').addEventListener('change', function () {
  const status = this.value;
  const returned = $('#leaveSince');

  if (status === 'Active') {
    returned.disabled = true;
    returned.value = '';
  } 
  else if (status === 'Resigned') {
    returned.disabled = false;   // only leaveSince

  } 
  else {
    returned.disabled = false;
  }
});
// Disable/enable leaveSince & leaveTill in EDIT modal
$('#e_status').addEventListener('change', function () {
  const status = this.value;
  const returned = $('#e_leaveSince');
  const leaveTill = $('#e_leaveTill');

  if (status === 'Active') {
    returned.disabled = true;
    leaveTill.disabled = true;
    returned.value = '';
    leaveTill.value = '';
  } else if (status === 'Resigned') {
    returned.disabled = false;   // only leaveSince allowed
    leaveTill.disabled = true;
    leaveTill.value = '';
  } else {
    returned.disabled = false;
    leaveTill.disabled = false;
  }
});

// run once on page load so defaults apply
window.addEventListener('load', () => {
  $('#status').dispatchEvent(new Event('change'));
});


function showLoader() {
  const el = document.getElementById('loaderOverlay');
  el.style.display = 'flex';
  // auto-hide after 20s in case something hangs
  setTimeout(() => hideLoader(), 20000);
}

function hideLoader() {
  const loader = document.getElementById("loaderOverlay");
  if (loader) loader.style.display = "none";
}


/* ------------- Add / Edit / Delete (respect role permissions) ----------- */

async function addEntry() {
  /*if ((state.me?.role || '').toLowerCase() === 'viewer'){ toast('Viewers cannot add'); return; }*/

  try {
    showLoader();

    // 1. Safely grab values using Optional Chaining (?.) to prevent "null" errors
    const empId = $('#empId')?.value.trim();
    const name = $('#name')?.value.trim();
    const designation = $('#designation')?.value;
    const project = document.getElementById('driverProjectDD').dataset.value || "";
    const vehicleNo = $('#vehicleNo')?.value.trim();
    const assetCode = $('#assetCode')?.value.trim();
    const contact = $('#contact')?.value.trim();
    const joiningDate = $('#joiningDate')?.value;
    const leaveSince = $('#leaveSince')?.value;
    const leaveTill = $('#leaveTill')?.value; // Matches the new field
    const status = $('#status')?.value;
    const remarks = $('#remarks')?.value.trim();

    // 2. Validation
    if (leaveSince && joiningDate && new Date(leaveSince) <= new Date(joiningDate)) {
      toast("‚ùå Returned Date must be later than Provided Date");
      return;
    }

    if (!empId || !name || !designation || !joiningDate) {
      toast('Please fill all required fields (ID, Name, Desig, jOINING Date)');
      return;
    }
const isDuplicate = state.drivers.some(d => d.empId.toLowerCase() === empId.toLowerCase());
  if (isDuplicate) {
    alert(`‚ùå Duplicate Error: Employee ID "${empId}" is already registered.`);
    return;
  }
    // 3. Prepare Payload
    let payload = {
      empId, name, designation, project, vehicleNo,
      assetCode, contact,
      joiningDate, leaveSince, status, remarks,
      createdAt: serverTimestamp(),
      invalids: {
        contact: typeof validContact === 'function' ? !validContact(contact) : false,
        assetCode: typeof validassetCode === 'function' ? !validassetCode(assetCode) : false
      },
      leaveSince: leaveSince || null,
      leaveTill: leaveTill || null,
      returnedOnTime: false
    };

    // Auto-cleaning logic based on status
    if (status === "Active") {
      payload.leaveSince = null;
      payload.leaveTill = null;
    } else if (status === "Resigned") {
      payload.leaveTill = null;
    }
const shift = document.getElementById('shift').value;
    // 4. Add to Firestore
    const docRef = await addDoc(collection(db, COLL_DRIVERS), payload);
    
    // Log change
if (typeof logStatusChange === 'function') {
      await logStatusChange(docRef.id, status, remarks, payload);
    }

 

    // 6. üõ†Ô∏è FIXED: Safe Clear Form Logic
    // This list includes all text/date inputs
    const fieldsToClear = [
      'empId', 'name', 'vehicleNo', 'assetCode', 'contact', 
      'joiningDate', 'leaveSince', 'leaveTill', 'remarks'
    ];

    fieldsToClear.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = ''; // Only sets value if element exists
    });

    // Reset dropdowns specifically by ID
    if ($('#designation')) $('#designation').value = '';
    if ($('#fProjectVal')) $('#fProjectVal').value = '';
    if ($('#status')) $('#status').value = 'Active';

    toast('‚úÖ Driver added successfully');

  } catch (err) {
    console.error("Add error:", err);
    toast("‚ùå Failed to add driver. Check console for details.");
  } finally {
    hideLoader();
  }
}

window.addEntry = addEntry;

function openEdit(ix){
  const d = state.filtered[ix]; if(!d) return;
  state.editIndex = ix;
  state.editDocId = d.id;
  $('#e_empId').value = d.empId||'';
  $('#e_name').value = d.name||'';
  $('#e_designation').value = d.designation||'Heavy Duty Driver';
  $('#e_project').value = d.project||'Creation';
$('#e_vehicleNo').value = d.vehicleNo;
$('#e_assetCode').value = d.assetCode;
  $('#e_contact').value = d.contact||'';
$('#e_joiningDate').value = d.joiningDate;
$('#e_leaveSince').value = d.leaveSince;
$('#e_leaveTill').value = d.leaveTill || '';
  $('#e_status').value = d.status||'Active';
  $('#e_remarks').value = d.remarks||'';
  $('#editModal').style.display='flex';
$('#e_status').dispatchEvent(new Event('change'));

}
window.openEdit = openEdit;

function closeEdit(){ $('#editModal').style.display='none'; state.editIndex=null; state.editDocId=null; }
window.closeEdit = closeEdit;

function normalizeDate(v){
  if (!v) return '';
  if (v instanceof Date) return v.toISOString().slice(0,10); // Excel date
  if (typeof v === 'number') return XLSX.SSF.format("yyyy-mm-dd", v); // numeric Excel date
  return String(v).slice(0,10); // already string
}


async function saveEdit(){
 /* if(state.me?.role==='Viewer'){ toast('Viewers cannot edit'); return; }*/


try {
    showLoader();
  const id = state.editDocId;
  if (!id) { toast('No record selected'); return; }

  const joiningDate = $('#e_joiningDate').value;
  const leaveSince = $('#e_leaveSince').value;
  const leaveTill    = $('#e_leaveTill').value;

  let status = $('#e_status').value;

  const prev = state.drivers.find(d => d.id === id);  // ‚¨ÖÔ∏è get previous doc

  const rec = {
    empId: $('#e_empId').value.trim(),
    name: $('#e_name').value.trim(),
    designation: $('#e_designation').value,
    project: $('#e_project').value,
 vehicleNo: $('#e_vehicleNo').value,
  assetCode: $('#e_assetCode').value,
    contact: $('#e_contact').value.trim(),
    joiningDate: $('#e_joiningDate').value,
  leaveSince: $('#e_leaveSince').value,
    leaveTill: $('#e_leaveTill').value || null,
    status,
    remarks: $('#e_remarks').value.trim(),
    invalids: {
      contact: !validContact($('#e_contact').value.trim()),
      assetCode:  !validassetCode($('#e_assetCode').value.trim())
    },
    returnedOnTime: prev?.returnedOnTime || false   // ‚¨Ö keep previous unless updated
  };

if (leaveSince && joiningDate && new Date(leaveSince) <= new Date(joiningDate)) {
    toast("‚ùå Returned Date must be later than Provided Date");
    return;
  }
  if (leaveTill) {
    if (joiningDate && new Date(leaveTill) <= new Date(joiningDate)) {
      toast("‚ùå Leave Till must be later than Provided Date");
      return;
    }
    if (leaveSince && new Date(leaveTill) <= new Date(leaveSince)) {
      toast("‚ùå Leave Till must be later than Returned Date");
      return;
    }
  }

  // üîë Reset fields based on status
  if (status === "Active") {
    // check if returning from On Leave and leaveTill still valid
    if (prev?.status === "On Leave" && prev.leaveTill) {
      const leaveTillDate = new Date(prev.leaveTill);
const grace = 10 * 24 * 60 * 60 * 1000; // 10 days in ms
if (new Date() <= new Date(leaveTillDate.getTime() + grace)) {
  rec.returnedOnTime = true;  // within grace period = on time
}

    }
    rec.leaveSince = null;
    rec.leaveTill = null;
  }
  else if (status === "Resigned") {
    rec.leaveTill = null; // keep only leaveSince
  }

  await logStatusChange(id, status, rec.remarks, rec);
if (prev?.status !== status) {
  await logStatusChange(id, status, rec.remarks);
}


  const idx = state.drivers.findIndex(d => d.id === id);
  if (idx !== -1) state.drivers[idx] = { ...state.drivers[idx], ...rec };

  deriveAnnualLeaveList();
  updateDriverCache();
  renderAL6M();
  refreshAll();

  closeEdit();
  toast('Driver updated');
}catch (err) {
    console.error("Edit error:", err);
    toast("‚ùå Failed to update driver");
  } finally {
    hideLoader();
  }
}

window.saveEdit = saveEdit;

/* -----------------------  Log Status Function -------------------- */


async function logStatusChange(driverId, newStatus, remarks="", fullRecord = null) {
  // If fullRecord is not provided, try to find it in state
  let snapshot = fullRecord;
  if (!snapshot) {
    snapshot = state.drivers.find(d => d.id === driverId) || {};
  }

  // Create a clean snapshot object
  const logData = {
    empId: snapshot.empId || '',
    name: snapshot.name || '',
    designation: snapshot.designation || '',
    project: snapshot.project || '',
    vehicleNo: snapshot.vehicleNo || '',
    assetCode: snapshot.assetCode || '',
    contact: snapshot.contact || '',
    joiningDate: snapshot.joiningDate || '',
    leaveSince: snapshot.leaveSince || '',
    leaveTill: snapshot.leaveTill || '',
    status: newStatus, // Ensure we log the status triggering this
    remarks: remarks,
    changedAt: serverTimestamp(),
    changedBy: state.me?.username || "system"
  };

  await addDoc(collection(db, COLL_DRIVERS, driverId, "logs"), logData);
}

/* -----------------------  open log Function -------------------- */



async function openLogs(driverId, driverName) {
  const container = document.getElementById("logsTimeline");
  container.innerHTML = `<div style="text-align:center;padding:20px;">
    <span style="font-size:14px;color:#475569;">‚è≥ Loading Driver Logs...</span>
  </div>`;
  document.getElementById("logsModal").style.display = "flex";
  state.currentLogDriver = { id: driverId, name: driverName };

  const qSnap = await getDocs(
    query(collection(db, COLL_DRIVERS, driverId, "logs"), orderBy("changedAt", "desc"))
  );

  if (qSnap.empty) {
    container.innerHTML = `<div style="padding:20px;text-align:center">No logs found.</div>`;
    return;
  }

  // Build Table HTML
  let html = `<h4>History: ${driverName}</h4>
  <table>
    <thead>
      <tr>
        <th>Date/Time</th>
        <th>Status</th>
        <th>Project</th>
        <th>Vehicle</th>
        <th>Asset Code</th>
        <th>Contact</th>
        <th>Dates (Join/Leave/Till)</th>
        <th>Remarks</th>
        <th>By</th>
      </tr>
    </thead>
    <tbody>`;

  qSnap.forEach(doc => {
    const d = doc.data();
    const date = d.changedAt?.toDate().toLocaleString() || "";
    
    // Combine dates for compactness
    const dates = `Join: ${d.joiningDate||''}<br>Since: ${d.leaveSince||''}<br>Till: ${d.leaveTill||''}`;

    html += `
      <tr>
        <td>${date}</td>
        <td style="font-weight:bold; color:${d.status === 'Active' ? 'green' : 'red'}">${d.status}</td>
        <td>${d.project || '-'}</td>
        <td>${d.vehicleNo || '-'}</td>
        <td>${d.assetCode || '-'}</td>
        <td>${d.contact || '-'}</td>
        <td style="font-size:11px">${dates}</td>
        <td>${d.remarks || ''}</td>
        <td>${d.changedBy || ''}</td>
      </tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;
}


/* -----------------------  Close log Function -------------------- */

function closeLogs() {
  const modal = document.getElementById("logsModal");
  modal.style.display = "none";
}
window.closeLogs = closeLogs;


/* ----------------------- Remove Row Function -------------------- */

async function removeRow(ix) {
  const d = state.filtered[ix];
  if (!d) return;
  if (!confirm("‚ö†Ô∏è Are you sure? This will delete the Driver AND all their History Logs.")) return;

  try {
    showLoader();
    const batch = writeBatch(db);

    // 1. Delete Driver Document
    const driverRef = doc(db, COLL_DRIVERS, d.id);
    batch.delete(driverRef);

    // 2. Delete Subcollection Logs
    const qLogs = await getDocs(collection(db, COLL_DRIVERS, d.id, "logs"));
    qLogs.forEach((logDoc) => {
      batch.delete(logDoc.ref);
    });

    // 3. Commit
    await batch.commit();

    // Update Local State
    state.drivers = state.drivers.filter(item => item.id !== d.id);
    deriveAnnualLeaveList();
    updateDriverCache();
    refreshAll();

    toast("‚úÖ Driver and Logs deleted.");
  } catch (err) {
    console.error("Delete failed", err);
    toast("‚ùå Failed: " + err.message);
  } finally {
    hideLoader();
  }
}
window.removeRow = removeRow;

function handleAssetStatusChange() {
  const status = document.getElementById('a_status').value;
  //const fromEl = document.getElementById('a_from');
  const tillEl = document.getElementById('a_till');
  
  // New elements to reset
  const driverStatusEl = document.getElementById('a_driverStatus');
  const driverLeaveTillEl = document.getElementById('a_driverLeaveTill');

  if (status === 'In operation') {
    // 1. Handle Asset Dates
    tillEl.value = '';
    tillEl.disabled = true;
    tillEl.style.background = '#f1f5f9';
    tillEl.placeholder = "N/A (In Operation)";

    // 2. Reset Driver Status Section
    if (driverStatusEl) driverStatusEl.value = 'Active'; // Resets to "Keep Driver Active"
    if (driverLeaveTillEl) {
      driverLeaveTillEl.value = '';
      driverLeaveTillEl.type = 'text'; // Returns to text placeholder mode
      driverLeaveTillEl.placeholder = "üìÖ Manual: Leave Till";
    }
    
  } else {
    // Re-enable Till Date if status is anything else (IDLE, Maintenance, etc.)
    tillEl.disabled = false;
    tillEl.style.background = ''; 
    tillEl.placeholder = "üìÖ Till Date/Time";
  }
}

window.handleAssetStatusChange= handleAssetStatusChange;

/* ----------------------- hard refresh -------------------- */

window.hardRefresh = async function(){
  localStorage.removeItem("driversCache");
  // Force one-time server fetch (snapshot will also refresh anyway)
  const snap = await getDocs(collection(db, COLL_DRIVERS));
  const arr = snap.docs.map(d=>({ id: d.id, ...d.data() }));
  arr.sort((a,b)=>{
    const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
    const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
    return tb - ta;
  });
  state.drivers = arr;
  deriveAnnualLeaveList();
  updateDriverCache();
  refreshAll();
  toast('Data refreshed from server');
};

/* ----------------------- Filters, Table & Pagination -------------------- */
function applyFilters() {
  const term = ($('#search')?.value || '').toLowerCase();
  const desg = $('#fDesignation')?.value || '';
  const proj = $('#fProject')?.value || ''; // Get the project filter value
  const stat = $('#fStatus')?.value || '';

  state.filtered = state.drivers.filter(d => {
const pObj = state.projects.find(p => p.p_name === d.project);
    const pId = pObj ? pObj.p_id.toLowerCase() : '';
    const mSearch = (d.name||'').toLowerCase().includes(term) || (d.empId||'').toLowerCase().includes(term);
    const mDesg   = !desg || d.designation === desg;
    const mProj   = !proj || d.project === proj; // Match the project field
    const mStat   = !stat || d.status === stat;
    return mSearch && mDesg && mProj && mStat;
  });

  state.page = 1;
  state.totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
  renderTablePage();
}
window.applyFilters = applyFilters;

function gotoPage(p){
  state.page = Math.min(Math.max(1, p), state.totalPages);
  renderTablePage();
}

window.gotoPage = gotoPage;


function renderTablePage() {
  const start = (state.page - 1) * state.pageSize;
  const rows = state.filtered.slice(start, start + state.pageSize);
  const tbody = $('#tbody');
  tbody.innerHTML = '';

  rows.forEach((d, idx) => {
    // 1. Move the lookup INSIDE the loop so 'd' is defined
    const projectObj = state.projects.find(proj => proj.p_name === d.project);
    const projectDisplay = projectObj ? `${d.project} (${projectObj.p_id})` : (d.project || 'N/A');

    const gi = start + idx;
    const tr = document.createElement('tr');
    
    tr.oncontextmenu = (e) => {
      e.preventDefault(); 
      openLogs(d.id, d.name);
    };

    tr.innerHTML = `
      <td>${d.empId || ''}</td>
      <td>${d.name || ''}</td>
      <td>${d.designation || ''}</td>
      <td>${projectDisplay}</td> <td>${d.vehicleNo || ''}</td>
      <td>${d.assetCode || ''}</td>
      <td>${d.contact || ''}</td>
      <td>${d.joiningDate || ''}</td>
      <td>${d.leaveSince || ''}</td>
      <td>${d.leaveTill || ''}</td>
      <td>${d.status || ''}</td>
      <td>${d.remarks || ''}</td>
      <td>
        ${
          state.me?.role === 'Viewer'
            ? `<button class="page-btn" onclick="openEdit(${gi})">Edit</button>`
            : `
              <button class="page-btn" onclick="openEdit(${gi})">Edit</button>
              <button class="btn warn" style="padding: 2px 8px;" onclick="removeRow(${gi})">Delete</button>
            `
        }
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Update pagination info
  $('#pageInfo').textContent = `Page ${state.page} of ${state.totalPages} ‚Äî ${state.filtered.length} rows`;

  // Enable/disable buttons
  $('#prevBtn').disabled = state.page <= 1;
  $('#nextBtn').disabled = state.page >= state.totalPages;
}

window.renderAssetTable = function() {
  const tbody = document.getElementById('assetTbody');
  tbody.innerHTML = '';

  // Get current page slice from filtered assets
  const start = (state.assetPage - 1) * state.pageSize;
  const end = start + state.pageSize;
  const pageData = state.filteredAssets.slice(start, end);
console.log("Rendering assets:", pageData.length);
  pageData.forEach(asset => {
    // LOOKUP: Find the project details from the state.projects list
   const projectObj = state.projects.find(p => p.p_id === asset.projectId);
    
    // FORMAT: Show "Project Name (ID)" or just Name if ID isn't found
 const projectDisplay = projectObj 
    ? `${projectObj.p_name} (${projectObj.p_id})` 
    : (asset.project || '-');
let userDisplay = '‚Äî';
    if (asset.empId) {
      // Look up the full driver object to get the name
      const driver = state.drivers.find(d => d.empId === asset.empId);
      const driverName = driver ? driver.name : (asset.name || ''); 
      userDisplay = `${asset.empId} - ${driverName}`;
    }

    const tr = document.createElement('tr');
tr.oncontextmenu = (e) => {
      e.preventDefault(); 
      openAssetLogs(asset.id, asset.assetNo); // Call new function
    };
    tr.innerHTML = `
<td>${asset.vmNo || ''}</td>
      <td>${asset.assetNo || ''}</td>
<td>${asset.brand || '-'}</td>
      <td>${asset.category || ''}</td>
      <td style="font-weight:500;">${userDisplay}</td> 
	<td>${asset.designation || ''}</td>
      <td>${asset.contact || ''}</td>
      <td style="font-weight:600; color:var(--brand);">${projectDisplay}</td>
      <td>${asset.regNo || ''}</td>
      <td>${asset.regExp || ''}</td>
      <td>${asset.from || ''}</td>
      <td>${asset.till || ''}</td>
<td><span class="badge">${asset.status || 'N/A'}</span></td>
  <td>${asset.shift || '-'}</td>
      <td>${asset.remarks || ''}</td>
      <td>
        <button class="btn info" onclick="editAsset('${asset.id}')" style="padding:4px 8px; font-size:12px;">Edit</button>
        <button class="btn warn" onclick="deleteAsset('${asset.id}')" style="padding:4px 8px; font-size:12px;">Del</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Update Pagination Info for Assets
  updateAssetPagination();
};


/* ------------------------------ Open Asset Logs --------------------------- */

window.openAssetLogs = async function(assetId, assetNo) {
  const container = document.getElementById("logsTimeline");
  container.innerHTML = `<div style="text-align:center;padding:20px;">‚è≥ Loading Asset Logs...</div>`;
  document.getElementById("logsModal").style.display = "flex";
  
  const qSnap = await getDocs(query(
    collection(db, COLL_ASSET_LOGS), 
    where("parentId", "==", assetId),
    orderBy("timestamp", "desc")
  ));

  let html = `<h4>Asset History: ${assetNo}</h4>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Status</th>
        <th>User</th>
        <th>Project</th>
        <th>Designation</th>
        <th>Contact</th>
        <th>From/Till</th>
        <th>Remarks</th>
        <th>By</th>
      </tr>
    </thead>
    <tbody>`;

  if(qSnap.empty){
     container.innerHTML = `<div style="padding:20px;">No history found.</div>`;
     return;
  }

  qSnap.forEach(doc => {
    const d = doc.data();
    const date = d.timestamp?.toDate().toLocaleString() || "";
    
    html += `
      <tr>
        <td>${date}</td>
        <td><b>${d.status || d.type}</b></td>
        <td>${d.empId ? d.empId + ' - ' : ''}${d.userName || ''}</td>
        <td>${d.project || ''}</td>
        <td>${d.designation || ''}</td>
        <td>${d.contact || ''}</td>
        <td style="font-size:11px">F: ${d.from||''}<br>T: ${d.till||''}</td>
        <td>${d.remarks || ''}</td>
        <td>${d.user || ''}</td>
      </tr>`;
  });
  
  html += `</tbody></table>`;
  container.innerHTML = html;
};
/* ------------------------------ Import/Export --------------------------- */
// Import: allow invalids, mark bad cells (contact/assetCode), include project

window.importExcel = function(){
  const file = $('#excelFile').files[0];
  if(!file){ toast('Choose an Excel file first'); return; }
  const reader = new FileReader();
  reader.onload = async (e)=>{
    try{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);
      let added = 0;

      // Header mapping (expects same names as earlier build; project added)
      // "Employee ID","Proper Name","Designation","Project","Plate No","Asset No","Contact Number","Joining Date","Driver Status","Remarks"
      for(const r of rows){
        const empId  = r['Employee ID'] || '';
        const name   = r['Proper Name'] || '';
        const designation = r['Designation'] || '';
        const project = r['Project'] || '';
        const vehicleNo= r['Vehicle No'] || '';
        const assetCode = r['Asset No'] || '';
        const contact= r['Contact Number'] || '';
const joiningDate = normalizeDate(r['Joining Date']);
const leaveSince = normalizeDate(r['Leave Since/ Resigned Date']);
const leaveTill    = normalizeDate(r['Leave Till']);
        const status = r['Driver Status'] || '';
        const remarks= r['Remarks'] || '';

        const invalids = { contact: !validContact(contact), assetCode: !validassetCode(assetCode) };
        const payload = {
          empId,name,designation,project,vehicleNo,assetCode,contact,joiningDate,status,remarks,
          invalids,
          createdAt: serverTimestamp(),
          leaveSince: status==='On Leave' ? (new Date()).toISOString().slice(0,10) : null,
	leaveSince: leaveSince || null,

        };
if (status === "Active") {
  payload.leaveSince = null;
  payload.leaveTill = null;
}
else if (status === "Resigned") {
  payload.leaveTill = null; // keep only leaveSince
}


await addDoc(collection(db, COLL_DRIVERS), payload);
        added++;
      }
//Realtime Listener will bring the latest in; cashe will be updated there

      toast(`Import finished: ${added} rows added`);
    }catch(err){ toast('Failed to read Excel: '+err.message); }

  };
  reader.readAsArrayBuffer(file);
};

// Export current filtered to Excel
window.exportExcel = function(){
  const ws = XLSX.utils.json_to_sheet(state.filtered.map(d=>({
    "Employee ID": d.empId,
    "Proper Name": d.name,
    "Designation": d.designation,
    "Project": d.project,
    "Plate No": d.vehicleNo,
    "Asset No": d.assetCode,
    "Contact Number": d.contact,
    "Joining Date": d.joiningDate,
"Leave Since/ Resigned Date": d.leaveSince || "",
"Leave Till": d.leaveTill || "",
    "Driver Status": d.status,
    "Remarks": d.remarks
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "TouchKeys");
  XLSX.writeFile(wb, "touchkeys.xlsx");
};

// Export filtered to PDF
window.exportPDF = function(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'l', unit:'pt', format:'a4'});
  doc.setFontSize(14);
  doc.text("TouchKey - Driver/Operator List", 40, 34);
  const body = state.filtered.map(d=>[
    d.empId,d.name,d.designation,d.project,d.vehicleNo,d.assetCode,d.contact,d.joiningDate,d.leaveSince || "",d.leaveTill || "",d.status,d.remarks
  ]);
  doc.autoTable({
    startY: 50,
    head:[["Emp ID","Name","Designation","Project","TouchKey","assetCode","Contact","Joining Date","Leave Since/ Resigned Date/ Resigned Date","Leave Till","Status","Remarks"]],
    body,
    styles:{fontSize:9,cellPadding:4}
  });
  doc.save("touchkeys.pdf");
};

// Export On Leave > 6 months to Excel
window.exportAL6mExcel = function(){
  const ws = XLSX.utils.json_to_sheet(state.annualLeaveOver6M.map(d=>({
    "Employee ID": d.empId,
    "Name": d.name,
    "Designation": d.designation,
    "Project": d.project,
    "TouchKey": d.vehicleNo,
    "assetCode": d.assetCode,
    "Contact": d.contact,
    "Joining Date": d.joiningDate,
    "Leave Since/ Resigned Date": d.leaveSince,
    "Leave Till": d.leaveTill,
    "Status": d.status,
    "Remarks": d.remarks,
    "Category": d.category,
    "Overstay Days": d.overstayDays
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "AnnualLeave>6m");
  XLSX.writeFile(wb, "annual_leave_over_6m.xlsx");
};

/* -------------------------------- exportLogsPDF ----------------------------- */

window.exportLogsPDF = function() {
  const { jsPDF } = window.jspdf;
  const container = document.getElementById("logsTimeline");
  if (!container || !container.innerHTML.trim()) {
    alert("‚ö†Ô∏è No logs to export");
    return;
  }

  // Driver details
  const drv = state.currentLogDriver || { id: "Unknown", name: "Unknown" };
  const driverName = drv.name || "Unknown";
  const driverId = drv.id || "Unknown";

  // Create PDF
  const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
  doc.setFontSize(14);
  doc.text(`Driver Logs Report`, 40, 40);
  doc.setFontSize(12);
  doc.text(`Name: ${driverName}`, 40, 60);
  doc.text(`Employee ID: ${driverId}`, 40, 80);

  // Collect logs into rows
  const rows = [];
  container.querySelectorAll("li").forEach(li => {
    const status = li.querySelector("b")?.textContent || "";
    const details = li.querySelector("small")?.textContent || "";
    const remarks = li.querySelector("i")?.textContent || "";
    rows.push([status, details, remarks]);
  });

  // AutoTable
  doc.autoTable({
    startY: 100,
    head: [["Status", "Details", "Remarks"]],
    body: rows,
    styles: { fontSize: 10, cellPadding: 4 },
    headStyles: { fillColor: [30, 58, 138] }
  });

  // Save with driver name & ID in filename
  const safeName = driverName.replace(/\s+/g, "_");
  doc.save(`logs_${safeName}_${driverId}.pdf`);
};

/* ------------------------------ Import/Export ASSET EXCEL --------------------------- */

/* --- HELPER: Date Only (No Time) --- */
function formatDateOnly(v) {
  if (!v) return '';
  
  let dateObj = null;
  // Handle Excel Serial Numbers
  if (typeof v === 'number') {
    dateObj = new Date(Math.round((v - 25569) * 86400 * 1000));
  } 
  // Handle JS Date Objects
  else if (v instanceof Date) {
    dateObj = v;
  }
  // Handle Strings
  else {
    const timestamp = Date.parse(v);
    if (!isNaN(timestamp)) dateObj = new Date(timestamp);
  }

  if (!dateObj) return v;

  // Return YYYY-MM-DD only
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const d = String(dateObj.getDate()).padStart(2, '0');
  
  return `${y}-${m}-${d}`;
}

/* --- HELPER: Robust Date+Time Parser --- */
function formatDateTime(v) {
  if (!v) return '';
  
  let dateObj = null;

  // 1. Handle Excel Serial Numbers (e.g. 45305.54)
  if (typeof v === 'number') {
    // Excel base date is Dec 30, 1899
    dateObj = new Date(Math.round((v - 25569) * 86400 * 1000));
  } 
  // 2. Handle JS Date Objects (if XLSX parsed them)
  else if (v instanceof Date) {
    dateObj = v;
  }
  // 3. Handle Strings
  else {
    const timestamp = Date.parse(v);
    if (!isNaN(timestamp)) dateObj = new Date(timestamp);
  }

  if (!dateObj) return v; // Return raw if parsing failed

  // Return ISO format YYYY-MM-DD HH:mm
  // We manually build it to avoid timezone shifts if possible, or use ISOString
  const y = dateObj.getFullYear();
  const m = String(dateObj.getMonth() + 1).padStart(2, '0');
  const d = String(dateObj.getDate()).padStart(2, '0');
  const h = String(dateObj.getHours()).padStart(2, '0');
  const min = String(dateObj.getMinutes()).padStart(2, '0');
  
  return `${y}-${m}-${d} ${h}:${min}`;
}

/* --- IMPORT EXCEL FUNCTION --- */
window.importAssetExcel = function() {
  // Create hidden input if not exists
  let input = document.getElementById('assetExcelInput');
  if (!input) {
    input = document.createElement('input');
    input.type = 'file';
    input.id = 'assetExcelInput';
    input.accept = '.xlsx, .xls, .csv';
    input.style.display = 'none';
    document.body.appendChild(input);
    
    input.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Reset input so same file can be selected again if needed
      e.target.value = ''; 
      
      showLoader();
      
      const reader = new FileReader();
      reader.onload = async (evt) => {
        try {
          const data = new Uint8Array(evt.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          
          // cellDates: true forces XLSX to return JS Date objects instead of serial numbers
          const rawData = XLSX.utils.sheet_to_json(ws, { cellDates: true });
          
          if (rawData.length === 0) {
            throw new Error("Excel file appears empty.");
          }

          await processAssetImport(rawData);
          
        } catch (err) {
          console.error(err);
          alert("‚ùå Import Failed: " + err.message);
          hideLoader();
        }
      };
      reader.readAsArrayBuffer(file);
    });
  }
  input.click();
};


/* --- PROCESS LOGIC --- */
async function processAssetImport(rows) {
  // 1. Group Excel data by Asset No
  const groups = {};
  
  rows.forEach(r => {
    // Try different casing for Asset No
    const assetNo = r['Asset No'] || r['AssetNo'] || r['asset_no'] || r['Asset_No'];
    if (!assetNo) return; // Skip rows without Asset ID
const rawShift = r['Shift'] || r['shift'] || r['SHIFT'] || '';
    const entry = {
      vmNo: r['Vehicle/Machine No'] || r['VM No'] || r['Plate No'] || '',
      assetNo: String(assetNo).trim(),
      category: r['Category'] || 'Machine',
      brand: r['Brand'] || '',
      project: r['Project'] || '',
      regNo: r['Reg No'] || '',
      status: r['Status'] || 'IDLE',
	shift: (typeof rawShift === 'string' && rawShift.trim() !== '') ? rawShift.trim() : 'Day',
      remarks: r['Remarks'] || '',

      // USE NEW TIME FUNCTION
      regExp: formatDateOnly(r['Reg Expiry']),
      from: formatDateTime(r['From']),
      till: formatDateTime(r['Till'])
    };
    
    if (!groups[assetNo]) groups[assetNo] = [];
    groups[assetNo].push(entry);
  });

  const batchSize = 450; 
  let batch = writeBatch(db);
  let opCount = 0;
  let updatedCount = 0;
  let createdCount = 0;

  // 2. Iterate over each Asset Group
  for (const assetKey in groups) {
    const list = groups[assetKey];
    
    // Sort Excel entries by 'From' Date (Newest first)
    list.sort((a, b) => {
      const dA = a.from ? new Date(a.from) : new Date(0);
      const dB = b.from ? new Date(b.from) : new Date(0);
      return dB - dA; 
    });

    const excelWinner = list[0];       // The newest data from Excel
    const excelLosers = list.slice(1); // Older data from Excel (goes to logs)

    // 3. CHECK DATABASE: Does this asset already exist?
    // We query by assetNo to prevent duplicates in the table
    const q = query(collection(db, COLL_ASSETS), where("assetNo", "==", assetKey));
    const querySnapshot = await getDocs(q);

    let docRef;
    let oldDataToLog = null;
    let shouldUpdate = false;

    if (!querySnapshot.empty) {
      // CASE: Asset Exists
      const existingDoc = querySnapshot.docs[0]; // Take the first match
      const dbData = existingDoc.data();
      docRef = existingDoc.ref;

      // Compare Dates: Is Excel data newer than DB data?
      const excelDate = excelWinner.from ? new Date(excelWinner.from) : new Date(0);
      const dbDate = dbData.from ? new Date(dbData.from) : new Date(0);

      // If Excel is newer, OR if DB has no date, we update DB
      if (excelDate > dbDate || !dbData.from) {
        shouldUpdate = true;
        oldDataToLog = { ...dbData, source: "PREV_DB_DATA" }; // Save old DB state to log
      } else {
        // Excel is older or same. Do NOT update DB. 
        // Just add the "Excel Winner" to logs as history.
        oldDataToLog = { ...excelWinner, source: "EXCEL_OLDER_DATA" };
        shouldUpdate = false;
      }

    } else {
      // CASE: New Asset
      docRef = doc(collection(db, COLL_ASSETS)); // Generate new ID
      shouldUpdate = true;
      createdCount++;
    }

    // 4. PREPARE BATCH WRITES
    
    // A. Update/Create the Main Asset Document
    if (shouldUpdate) {
      const mainPayload = { 
        ...excelWinner, 
        updatedAt: serverTimestamp() 
      };
      // If creating new, add createdAt
      if (createdCount > 0 && !querySnapshot.empty === false) {
         mainPayload.createdAt = serverTimestamp();
      }
      batch.set(docRef, mainPayload, { merge: true });
      if (!querySnapshot.empty) updatedCount++;
      opCount++;
    }

    // B. Log the displaced data (either old DB data or the older Excel winner)
    if (oldDataToLog) {
      const logRef = doc(collection(db, COLL_ASSET_LOGS));
      batch.set(logRef, {
        parentId: docRef.id,
        type: "HISTORY_LOG",
        assetNo: assetKey,
        ...oldDataToLog,
        timestamp: serverTimestamp()
      });
      opCount++;
    }

    // C. Log the rest of the Excel rows (the "losers")
    for (const hist of excelLosers) {
      const logRef = doc(collection(db, COLL_ASSET_LOGS));
      batch.set(logRef, {
        parentId: docRef.id,
        type: "IMPORT_HISTORY",
        ...hist,
        timestamp: hist.from ? new Date(hist.from) : new Date()
      });
      opCount++;
    }

    // Commit if batch full
    if (opCount >= batchSize) {
      await batch.commit();
      batch = writeBatch(db);
      opCount = 0;
    }
  }

  // Final Commit
  if (opCount > 0) await batch.commit();

  hideLoader();
  alert(`‚úÖ Import Complete!\nUpdated: ${updatedCount}\nCreated: ${createdCount}\n(History logs generated automatically)`);
}

window.exportAssetExcel = async function() {
  if (state.filteredAssets.length === 0) {
    toast("No data to export");
    return;
  }

  showLoader(); // Show loader because fetching logs might take a second

  try {
    // 1. Prepare Main Assets Data (Sheet 1)
    const assetData = state.filteredAssets.map(a => ({
      "Vehicle/Machine No": a.vmNo,
      "Asset No": a.assetNo,
      "Brand": a.brand,
      "Category": a.category,
      "Project": a.project,
      "User ID": a.empId || '',
      "User Name": a.userName || '',
      "Designation": a.designation || '',
      "Reg No": a.regNo,
      "Reg Expiry": a.regExp,
      "Status": a.status,
      "Shift": a.shift || 'Day',
      "From": a.from,
      "Till": a.till,
      "Remarks": a.remarks
    }));

    // 2. Fetch Logs for these specific assets (Sheet 2)
    // We get the IDs of all assets currently in the filtered list
    const assetIds = state.filteredAssets.map(a => a.id).filter(id => !!id);
    let logData = [];

    if (assetIds.length > 0) {
      // Fetch logs where parentId is in our current asset list
      // Note: Firestore 'in' query supports max 30 IDs. 
      // If you have hundreds, we fetch all logs and filter locally for better performance.
      const logSnap = await getDocs(collection(db, COLL_ASSET_LOGS));
      
      logData = logSnap.docs
        .map(doc => {
          const d = doc.data();
          return {
            "Asset No": d.assetNo || '',
            "Type": d.type || 'LOG',
            "Project": d.project || '',
            "Status": d.status || '',
            "Shift": d.shift || '',
            "User Name": d.userName || '',
            "From": d.from || '',
            "Till": d.till || '',
            "Log Date": d.timestamp ? d.timestamp.toDate().toLocaleString() : '',
            "Remarks": d.remarks || '',
            "Updated By": d.user || ''
          };
        })
        // Only include logs belonging to the assets currently displayed
        .filter(log => state.filteredAssets.some(a => a.assetNo === log["Asset No"]));
        
      // Sort logs by Date (Newest first)
      logData.sort((a, b) => new Date(b["Log Date"]) - new Date(a["Log Date"]));
    }

    // 3. Create Workbook and add both sheets
    const wb = XLSX.utils.book_new();

    // Sheet 1: Current Assets
    const wsAssets = XLSX.utils.json_to_sheet(assetData);
    XLSX.utils.book_append_sheet(wb, wsAssets, "Current Assets");

    // Sheet 2: Logs
    if (logData.length > 0) {
      const wsLogs = XLSX.utils.json_to_sheet(logData);
      XLSX.utils.book_append_sheet(wb, wsLogs, "Asset History Logs");
    }

    // 4. Download file
    const dateStr = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `Assets_and_Logs_${dateStr}.xlsx`);
    
    toast("‚úÖ Exported with History Logs");

  } catch (error) {
    console.error("Export Error:", error);
    toast("‚ùå Export failed");
  } finally {
    hideLoader();
  }
};

// --- REGISTRATION RENEWAL REPORT LOGIC ---

// 1. Helper to set dates
window.setRepDate = function(mode) {
    const startEl = document.getElementById('rep_start');
    const endEl = document.getElementById('rep_end');
    const today = new Date();
    
    if (mode === 'today') {
        startEl.valueAsDate = today;
        endEl.valueAsDate = today;
    } else if (mode === 'month') {
        // First day of current month
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        startEl.valueAsDate = firstDay;
        endEl.valueAsDate = today;
    }
}

// 2. Fetch Data (On Demand Only)
window.fetchRenewalData = async function() {
    const startVal = document.getElementById('rep_start').value;
    const endVal = document.getElementById('rep_end').value;
    
    if (!startVal || !endVal) {
        alert("Please select a valid date range.");
        return;
    }

    // Convert strings to Date objects for Firestore
    // Start of day
    const startDate = new Date(startVal); 
    startDate.setHours(0,0,0,0);
    
    // End of day
    const endDate = new Date(endVal); 
    endDate.setHours(23,59,59,999);

    showLoader();
    const tbody = document.getElementById('renewalBody');
    tbody.innerHTML = '';
    state.renewalData = []; // Store for export

    try {
        // QUERY: Get logs where type is 'REG_RENEWAL' within range
        // NOTE: This might require a Composite Index in Firestore Console.
        // If it fails, check console for the link to create index.
        const q = query(
            collection(db, COLL_ASSET_LOGS),
            where("type", "==", "REG_RENEWAL"),
            where("timestamp", ">=", startDate),
            where("timestamp", "<=", endDate),
            orderBy("timestamp", "desc")
        );

        const snap = await getDocs(q);
        
        if (snap.empty) {
            tbody.innerHTML = '<tr><td colspan="7">No renewals found in this period.</td></tr>';
        } else {
            snap.forEach(doc => {
                const d = doc.data();
                state.renewalData.push(d); // Save for excel
                
                const doneDate = d.timestamp ? d.timestamp.toDate().toLocaleString() : '-';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${doneDate}</td>
                    <td>${d.vmNo || ''}</td>
                    <td>${d.assetNo || ''}</td>
                    <td>${d.project || ''}</td>
                    <td style="font-weight:bold; color:green;">${d.newRegExp || ''}</td>
                    <td>${d.remarks || ''}</td>
                    <td>${d.user || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    } catch (err) {
        console.error("Report Error:", err);
        // Fallback for Index error
        if (err.message.includes("index")) {
            alert("‚ö†Ô∏è Index missing. Please check console to create Firestore Index.");
        } else {
            alert("Error fetching report.");
        }
    } finally {
        hideLoader();
    }
};

// 3. Export to Excel
window.exportRenewalExcel = function() {
    if (!state.renewalData || state.renewalData.length === 0) {
        alert("No data to export. Generate the report first.");
        return;
    }
    
    const data = state.renewalData.map(d => ({
        "Renewal Date/Time": d.timestamp ? d.timestamp.toDate().toLocaleString() : '',
        "Vehicle/Machine No": d.vmNo,
        "Asset No": d.assetNo,
        "Project": d.project,
        "Previous Expiry": d.oldRegExp,
        "New Expiry": d.newRegExp,
        "Remarks": d.remarks,
        "Done By": d.user
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Renewal_Report");
    XLSX.writeFile(wb, "Reg_Renewal_History.xlsx");
};


/* -------------------------------- Dashboard ----------------------------- */
let driverChart, operatorChart, projectChart,leaveChart;

function countByStatus(arr){
  const map = {
    "Active":0, "On Leave":0, "Resigned":0, "Transfer":0,
    "IDLE":0, "Others...":0
  };
  arr.forEach(d=>{ if(map[d.status]!=null) map[d.status]++; });
  return map;
}
function countByProject(arr){
  const map = {"Creation":0,"Gatex":0,"Samtech":0,"":0};
  arr.forEach(d=>{
    const v = (d.project||'').trim();
    if(map[v]==null) map[v]=0;
    map[v]++;
  });
  return map;
}
/*--------------------Render Dashboard------------------*/


function renderDashboard(){
  // 1. DATA PREPARATION
  const assets = state.assets || [];
  const drivers = state.drivers || [];
  const projects = state.projects || [];
  
  // --- KPI 1: Asset Status ---
  const assetStats = { Total: assets.length, Operation: 0, IDLE: 0, Maintenance: 0, Others: 0 };
  const assetStatusCounts = {}; // For Chart
  
  assets.forEach(a => {
    const s = a.status || 'Unknown';
    assetStatusCounts[s] = (assetStatusCounts[s] || 0) + 1;
    
    if(s === 'In operation') assetStats.Operation++;
    else if(s === 'IDLE') assetStats.IDLE++;
    else if(s === 'Maintenance') assetStats.Maintenance++;
    else assetStats.Others++;
  });
  
  document.getElementById('kpi_asset_total').textContent = assetStats.Total;
  document.getElementById('kpi_asset_sub').textContent = `In Operation: ${assetStats.Operation} | IDLE: ${assetStats.IDLE} | Maintenance: ${assetStats.Maintenance}`;

  // --- KPI 2: Driver Status ---
  const drvStats = { Total: drivers.length, Active: 0, Leave: 0 };
  const drvStatusCounts = {}; // For Chart

  drivers.forEach(d => {
    const s = d.status || 'Unknown';
    drvStatusCounts[s] = (drvStatusCounts[s] || 0) + 1;
    if(s === 'Active') drvStats.Active++;
    if(s === 'On Leave') drvStats.Leave++;
  });

  document.getElementById('kpi_driver_total').textContent = drvStats.Total;
  document.getElementById('kpi_driver_sub').textContent = `Active: ${drvStats.Active} | On Leave: ${drvStats.Leave}`;

  // --- KPI 3: Registration Status ---
  let validReg = 0, expReg = 0, nearReg = 0;
  const today = new Date();
  
  assets.forEach(a => {
    if(a.regExp) {
      const d = new Date(a.regExp);
      const diff = (d - today) / (1000*60*60*24);
      if(diff < 0) expReg++;
      else if(diff <= 15) nearReg++;
      else validReg++;
    }
  });
  
  document.getElementById('kpi_reg_total').textContent = assets.filter(a=>a.regExp).length;
  document.getElementById('kpi_reg_sub').textContent = `Valid: ${validReg} | Expired/Near Expiry: ${expReg + nearReg}`;

  // --- CHARTS PREPARATION ---
  
  // 1. Project-wise Asset Count
  const projAssetCount = {};
  assets.forEach(a => {
    const p = a.project || 'Unassigned';
    projAssetCount[p] = (projAssetCount[p] || 0) + 1;
  });

  // 2. Asset Category
  const catCount = {};
  assets.forEach(a => {
    const c = a.category || 'Other';
    catCount[c] = (catCount[c] || 0) + 1;
  });

  // 3. Project Status
  const projStatusCount = {};
  projects.forEach(p => {
    const s = p.status || 'Unknown';
    projStatusCount[s] = (projStatusCount[s] || 0) + 1;
  });

  // 4. Project Division
  const divCount = {};
  projects.forEach(p => {
    const d = p.p_div || 'Unknown';
    divCount[d] = (divCount[d] || 0) + 1;
  });


  // --- RENDERING CHARTS ---
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: {size: 11} } } }
  };
  
  // Helper to destroy old charts
  ['projectAssetChart', 'assetStatusChart', 'opStatusChart', 'assetCatChart', 'projStatusChart', 'projDivChart'].forEach(id => {
    if(charts[id]) charts[id].destroy();
  });

  // 1. Project Assets (Bar)
  charts['projectAssetChart'] = new Chart(document.getElementById('projectAssetChart'), {
    type: 'bar',
    data: {
     labels: Object.keys(projAssetCount).map(key => `${key} (${projAssetCount[key]})`),
      datasets: [{ label: 'Count', data: Object.values(projAssetCount), backgroundColor: '#3b82f6' }]
    },
    options: { ...commonOptions, plugins: { legend: { display: false } } } // Hide legend for bar
  });

  // 2. Asset Status (Doughnut)
  charts['assetStatusChart'] = new Chart(document.getElementById('assetStatusChart'), {
    type: 'doughnut',
    data: {
     labels: Object.keys(assetStatusCounts).map(key => `${key} (${assetStatusCounts[key]})`),
      datasets: [{ data: Object.values(assetStatusCounts), backgroundColor: ['#22c55e','#f59e0b','#ef4444','#64748b','#3b82f6','#a855f7'] }]
    },
    options: commonOptions
  });

  // 3. Operator Status (Doughnut)
  charts['opStatusChart'] = new Chart(document.getElementById('opStatusChart'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(drvStatusCounts).map(key => `${key} (${drvStatusCounts[key]})`),
      datasets: [{ data: Object.values(drvStatusCounts), backgroundColor: ['#22c55e','#f59e0b','#ef4444','#0ea5e9','#64748b'] }]
    },
    options: commonOptions
  });

  // 4. Asset Category (Pie)
  charts['assetCatChart'] = new Chart(document.getElementById('assetCatChart'), {
    type: 'pie',
    data: {
      labels: Object.keys(catCount).map(key => `${key} (${catCount[key]})`),
      datasets: [{ data: Object.values(catCount), backgroundColor: ['#f97316','#8b5cf6','#06b6d4','#ec4899'] }]
    },
    options: commonOptions
  });

  // 5. Project Status (Pie)
  charts['projStatusChart'] = new Chart(document.getElementById('projStatusChart'), {
    type: 'pie',
    data: {
      labels: Object.keys(projStatusCount).map(key => `${key} (${projStatusCount[key]})`),
      datasets: [{ data: Object.values(projStatusCount), backgroundColor: ['#22c55e','#94a3b8','#f59e0b'] }]
    },
    options: commonOptions
  });

  // 6. Project Division (Bar - Horizontal is better for names)
  charts['projDivChart'] = new Chart(document.getElementById('projDivChart'), {
    type: 'bar',
    data: {
      labels: Object.keys(divCount).map(key => `${key} (${divCount[key]})`),
      datasets: [{ label:'Count', data: Object.values(divCount), backgroundColor: '#6366f1' }]
    },
    options: { ...commonOptions, indexAxis: 'y', plugins: { legend: { display: false } } }
  });
}

// Global function to expand chart
window.expandChart = function(chartId) {
  const modal = document.getElementById('chartModal');
  const modalCanvas = document.getElementById('expandedCanvas');
  const sourceChart = charts[chartId];
  
  if(!sourceChart) return;

  modal.style.display = 'flex';
  
  // Destroy previous modal chart if exists
  if(charts['expanded']) charts['expanded'].destroy();

  // Create new chart in modal with same config but bigger
  charts['expanded'] = new Chart(modalCanvas, {
    type: sourceChart.config.type,
    data: sourceChart.config.data,
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' },
        title: { display: true, text: 'Detailed View', font: { size: 18 } }
      }
    }
  });
 updateAssetDashboardCounts();
};


/*--------------------FIletr from status------------------*/
function filterFromStatus(role, status){
  nav('list');
  $('#fStatus').value = status;
  $('#fDesignation').value = '';
  $('#fProject').value = '';
  applyFilters();
  // Then further filter by role:
  state.filtered = state.filtered.filter(role==='driver' ? isDriver : isOperator);
  state.page=1;
  state.totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
  renderTablePage();
}

/*--------------------data Status------------------*/

function setDataStatus(text, color="#475569") {
  const el = document.getElementById("dataStatus");
  if (el) {
    el.textContent = text;
    el.style.color = color;
  }
}


/* --------------------------------- Init --------------------------------- */
function onLoad(){
  // restore page size
  const psSel = $('#pageSize');
  const savedPS = localStorage.getItem('pageSize_v2');
  if(savedPS){ psSel.value = savedPS; state.pageSize = parseInt(savedPS,10); }
  psSel.addEventListener('change', ()=>{ localStorage.setItem('pageSize_v2', psSel.value); });

  // If you want to keep a "logout" function ‚Äî optional
  // window.doLogout = function(){ location.reload(); };
listenToAssets();
}

window.addEventListener('load', onLoad);

/* Ensure SuperAdmin account exists once at startup */
await ensureDefaultSuperAdmin();


// Exporting functions to global scope so HTML onclick can find them
window.deleteAsset = deleteAsset;
window.openAssetModal = openAssetModal;
window.saveOrUpdateAsset = saveOrUpdateAsset;
window.closeAssetModal = closeAssetModal;
window.applyAssetFilters = applyAssetFilters;
</script> 
