<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TAMS</title>
<link rel="icon" type="image/x-icon" href="logo.ico">

<!-- projects -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<!-- Firebase -->
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>

<style>
  :root{
    --brand:#1e3a8a; --brand-2:#2563eb; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --info:#0ea5e9;
    --bg:#f4f6f9; --card:#ffffff; --text:#0f172a; --muted:#64748b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  body {
  margin: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  
  /* Light blue gradient transition from top to bottom */
  background: linear-gradient(180deg, #e0f2fe 0%, #f1f5f9 100%);
  
  /* This ensures the background stays smooth even when scrolling */
  background-attachment: fixed;
  
  color: var(--text);
}
.dashboard-cards {
  display: flex;
  gap: 20px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}
.dashboard-cards .card {
  background: #f8fafc;
  border: 1px solid #cbd5e1;
  border-radius: 10px;
  flex: 1 1 200px;
  padding: 16px;
  text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}
.dashboard-cards .card h3 {
  font-size: 16px;
  margin-bottom: 8px;
  color: #334155;
}
.dashboard-cards .card p {
  font-size: 20px;
  font-weight: bold;
  color: #1e293b;
}
/* Base card hover effect */
.dashboard-cards .card {
  transition: transform 0.3s, box-shadow 0.3s;
}
/* Pulse animation keyframes */
@keyframes pulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.03); }
  100% { transform: scale(1); }
}

/* Apply on hover */
.dashboard-cards .card:hover {
  animation: pulse 1.2s ease-in-out infinite;
  box-shadow: 0 12px 28px rgba(0,0,0,0.18);
}

/* Light gradient backgrounds */
.card.drivers {
  background: linear-gradient(135deg, #93c5fd, #60a5fa); /* light blue */
  color: #0f172a;
}
.card.operators {
  background: linear-gradient(135deg, #86efac, #34d399); /* light green */
  color: #064e3b;
}
.card.leave {
  background: linear-gradient(135deg, #fde68a, #fbbf24); /* light orange */
  color: #78350f;
}
.card.resigned {
  background: linear-gradient(135deg, #fecaca, #f87171); /* light red */
  color: #7f1d1d;
}

/* Modal Overlay Background */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.6);
  display: none; /* Hidden by default */
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

/* Modal Content Box */
.modal-content {
  background: white;
  padding: 20px;
  border-radius: 8px;
  width: 90%;
  max-width: 800px;
  position: relative;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

  /* Login */
  .login-wrap {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: url('background2.jpg') no-repeat center center;
  background-size: cover;
  overflow: hidden;
}

/* Overlay */
.login-wrap::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.5); /* dark overlay */
  z-index: 0;
}

/* Make sure login card stays above overlay */
.login-card {
  position: relative;
  z-index: 1;
}

/* Login Card with Glassmorphism */
.login-card {
  width: 360px;
  padding: 22px;
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.15);   /* semi-transparent white */
  backdrop-filter: blur(12px);             /* glass blur effect */
  -webkit-backdrop-filter: blur(12px);     /* Safari support */
  border: 1px solid rgba(255, 255, 255, 0.25);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
  color: #f1f5f9;                          /* light text */
  text-align: center;
}

  .login-card h1{margin:0 0 6px;font-size:20px}
.login-card input {
  width: 100%;
  padding: 12px 14px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
}

.login-btn {
  margin-top: 14px;
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 10px;
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}
.login-btn:hover {
  transform: scale(1.05);
}
  .login-hint{font-size:12px;color:#94a3b8;margin-top:10px}
.login-logo {
  width: 80px;          /* size of logo */
  height: auto;
  margin-bottom: 15px;
  border-radius: 12px;  /* optional rounded corners */
}

  /* Layout */
  .app {
  display: flex; 
  flex-direction: column; /* Stack top bar above content */
  min-height: 20vh;
}
/* Sidebar (Top Bar) Update */
/* --- SIDEBAR (TOP BAR) --- */
.sidebar {
  width: 100%;
  height: 60px; 
  background: #0A2A6A;
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  position: sticky;
  top: 0;
  display: flex;
  flex-direction: row;
  align-items: center; /* Vertically center the brand and nav */
  justify-content: flex-start;
  z-index: 1000;
  padding: 0 40px; /* Reduced padding for more link space */
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

/* --- NAVIGATION MENU --- */
.nav {
  display: flex;           
  flex-direction: row;
  margin-left: 50px; /* Space between logo and first link */
  height: 70px;      /* Explicit height to match sidebar */
  align-items: center;
}

.nav a {
  text-decoration: none !important;
  color: rgba(255, 255, 255, 1);
  display: flex !important;   /* Force flex */
  align-items: center !important;
  justify-content: center;
  height: 100%;             
  padding: 0 10px;
  font-size: 16px;            /* Slightly smaller to fit many links */
  font-weight: 400;
 // transition: all 0.3s ease;
  position: relative;
  white-space: nowrap;        /* Prevent text from breaking into 2 lines */
}
.nav a.active {
  color: #ffffff !important;
  /* CHANGE 2: Make it BOLD only when active */
  font-weight: 800; 
  background: rgba(255, 255, 255, 0.1);
}
/* --- ACTIVE LINK INDICATOR --- */
.nav a.active::after {
  content: "";
  position: absolute;
  bottom: 0;
  left: 10%;
  width: 80%;
  height: 2px;
  background: #60a5fa;
  border-radius: 4px 4px 0 0;
  box-shadow: 0 -2px 10px rgba(96, 165, 250, 0.5);
}
/* --- MAIN CONTENT TRANSITION --- */
.content {
  padding: 40px 60px;
  animation: slideUp 0.6s ease-out;
  margin-left: 0;
  flex: 1;
  color: #1e293b;
  font-weight: 400; /* Change from 600 to 400 (Normal) */
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
/* Specifically target table data to make it stand out */
td {
  color: #0f172a;
  font-weight: 400; /* Change from 700 to 400 (Normal) */
}
/* Target Labels to make them look professional */
label {
  display: block;
  margin-bottom: 5px;
  color: var(--brand); /* Uses your blue brand color */
  font-weight: 800; /* Extra bold for headers/labels */
  font-size: 13px;
  text-transform: uppercase;
}
input, select, textarea {
  color: #1e293b !important;
  font-weight: 400 !important;
  border: 1.5px solid #cbd5e1; /* Thicker border to match the bold text */
}

/* Makes placeholder text slightly lighter but still visible */
input::placeholder {
  font-weight: 400;
  color: #94a3b8;
}
  .footer{position:fixed;right:12px;bottom:8px;font-size:12px;color:#475569}
  /*.user-info{position:absolute;top:10px;right:20px;font-size:14px;font-weight:600;color:#1e293b}*/
.user-bar {
  display: flex;
  align-items: center;
  gap: 15px;           /* space between username & button */
  margin-bottom: 10px; /* space below, before Dashboard */
}
.user-bar #userLabel {
  font-size: 14px;
  font-weight: 600;
  color: #1e293b;
}

  /* Cards / Grid */
  .grid{display:grid;gap:16px}
  .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:1100px){.grid-4{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:700px){.grid-4,.grid-2{grid-template-columns:1fr}}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,.06);padding:16px}
  .kpi{display:flex;justify-content:space-between;align-items:center}
  .kpi .big{font-size:30px;font-weight:800}
  .kpi small{color:var(--muted)}
  .kpi .badge{padding:6px 10px;border-radius:999px;font-size:12px}
  .b-ok{background:rgba(22,163,74,.12);color:var(--ok)}
  .b-warn{background:rgba(245,158,11,.12);color:var(--warn)}
  .b-bad{background:rgba(239,68,68,.12);color:var(--bad)}
  .b-info{background:rgba(14,165,233,.12);color:var(--info)}

  /* Toolbar */
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom:10px}
  .toolbar input,.toolbar select{padding:10px;border-radius:10px;border:1px solid #cbd5e1;background:#fff}
  .btn{padding:10px 14px;border:none;border-radius:10px;background:var(--brand-2);color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#0ea5e9}
  .btn.warn{background:#ef4444}

  /* Table */
  .table-wrap{overflow:auto;background:var(--card);border-radius:var(--radius);box-shadow:0 10px 30px rgba(2,6,23,.06)}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:center}
  thead th{position:sticky;top:0;background:#eff6ff;font-weight:700}

  /* Pagination */
  .pagination{display:flex;gap:6px;align-items:center;justify-content:flex-end;margin-top:10px}
  .page-btn{padding:8px 12px;border-radius:8px;border:1px solid #cbd5e1;background:#fff;cursor:pointer}
  .page-btn[disabled]{opacity:.5;cursor:not-allowed}
  .page-size{margin-left:auto}

  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:100}
  .modal .dialog{background:#fff;border-radius:14px;max-width:720px;width:95%;padding:16px}
  .dialog h3{margin-top:0}
  .dialog .grid-2{gap:10px}
  .dialog input,.dialog select{width:100%;padding:10px;border-radius:10px;border:1px solid #cbd5e1}
  .dialog .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}

 
@media print {
  body * {
    visibility: hidden; /* hide everything */
  }
}
 .search-dd {
  position: relative;
  width: 100%;
}

.search-dd .selected {
  padding: 10px;
  border: 1.5px solid #cbd5e1;
  border-radius: 10px;
  background: #fff;
  cursor: pointer;
}

.search-dd .panel {
  position: absolute;
  top: 110%;
  width: 100%;
  background: #fff;
  border: 1px solid #cbd5e1;
  border-radius: 12px;
  z-index: 5000;
  display: none;
}

.search-dd input {
  width: 100%;
  padding: 8px 10px;
  border: none;
  border-bottom: 1px solid #e2e8f0;
  outline: none;
}

.search-dd .list {
  max-height: 220px;
  overflow-y: auto;
}

.search-dd .item {
  padding: 8px 10px;
  cursor: pointer;
}

.search-dd .item:hover {
  background: #eff6ff;
}
/* Styling the Date/Time inputs to look like your text inputs */
input[type="text"], 
input[type="date"], 
input[type="datetime-local"] {
  height: 42px;
  padding: 8px 12px;
  border: 1.5px solid #cbd5e1;
  border-radius: 10px;
  font-size: 14px;
  width: 100%;
  box-sizing: border-box;
}

/* Ensures the calendar icon inside the native picker stays on the right */
input::-webkit-calendar-picker-indicator {
  cursor: pointer;
  filter: invert(0.5); /* Makes the icon subtle */
}

input:focus {
    border-color: #3b82f6 !important;
    outline: none;
    background-color: #f0f7ff;
}
/* Increase width of the Asset Modal Card */
#assetModal .modal-content {
    max-width: 1000px; /* Increased from default (usually 500px-600px) */
    width: 95%;      /* Responsive for smaller screens */
    padding: 10px;   /* Added padding for a cleaner look */
}

/* Optional: Adjust grid gap for better spacing with the new width */
#assetModal .grid-4 {
    gap: 10px;
    grid-template-columns: repeat(4, 1fr);
}




</style>
</head>


<!-- Loader Overlay -->
<div id="loaderOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  z-index:9999;
   align-items:center;
  justify-content:center;
">
  <div style="text-align:center;color:#fff;font-size:18px;">
    <div class="spinner"></div>
    <p>Please wait...</p>
  </div>
</div>



<body>

<!-- LOGIN -->
<div id="loginWrap" class="login-wrap">
<div class="login-card">
  <img src="Trojan.png" alt="Trojan Contracting" class="login-logo" />
  <h1>TAMS</h1>
  <input id="u" placeholder="Username" />
  <input id="p" placeholder="Password" type="password" />
  <button id="loginBtn" class="login-btn">Login</button>
  <div class="login-hint"></div>
</div>
</div>


<div class="app" id="app" style="display:none">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
  <img src="TAMS_logo.png" style="height:70px; vertical-align:middle; margin-right:15px;">
</div>

    <nav class="nav">
      <a href="#" id="nav-dashboard" class="active" onclick="nav('dashboard')">Dashboard</a>
<a href="#" id="nav-assets" onclick="nav('assets')">Asset Management</a>
      <a href="#" id="nav-list" onclick="nav('list')">Drivers/Operators List</a>
<a href="#" id="nav-al6m" onclick="nav('al6m')">Drivers/Operators Overstay </a>
<a href="#" id="nav-undertaking" onclick="nav('undertaking')">Undertaking</a>
<a href="#" id="nav-projectsSection" onclick="nav('projectsSection')">Projects</a>
      <a href="#" id="nav-users" onclick="nav('users')">Manage Users</a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="content">
  
<div id="userBar" class="user-bar">
  <span id="userLabel"></span>
  <button id="logoutBtn" class="btn warn">Logout</button>
</div>
<button class="btn secondary" onclick="hardRefresh()">üîÑ Refresh Now</button>


<!-- DASHBOARD -->
<section id="dashboard" class="section">
  <h2>Dashboard</h2>

  <!-- Summary Cards -->
<div class="dashboard-cards">
  <div class="card drivers">
    <h3>üöó Total Drivers</h3>
    <p id="totalDrivers">0</p>
    <small id="activeDrivers"></small>
  </div>
  <div class="card operators">
    <h3>üõ†Ô∏è Total Operators</h3>
    <p id="totalOperators">0</p>
    <small id="activeOperators"></small>
  </div>
  <div class="card leave">
    <h3>üå¥ On Leave</h3>
    <p id="onLeave">0</p>
  </div>
  <div class="card resigned">
    <h3>‚ùå Resigned</h3>
    <p id="resigned">0</p>
  </div>
</div>


  <!-- Charts -->
  <div class="grid grid-2">
    <div class="card"><canvas id="driverChart" height="100"></canvas></div>
    <div class="card"><canvas id="operatorChart" height="100"></canvas></div>
  </div>
  <div class="grid" style="margin-top:16px">
    <div class="card"><canvas id="projectChart" height="140"></canvas></div>
  </div>
<div class="grid" style="margin-top:16px">
  <div class="card"><canvas id="leaveChart" height="140"></canvas></div>
</div>
</section>

    <!-- Asset Management -->

<section id="assets" class="section" style="display:none">
  <h2>Asset Management</h2>
  
  <div class="toolbar card">
    <input id="assetSearch" placeholder="Search Assets..." oninput="applyAssetFilters()" />
    <select id="fAssetCat" onchange="applyAssetFilters()">
      <option value="">All Categories</option>
      <option>Vehicle</option>
      <option>Machine</option>
      <option>Gensets</option>
      <option>Minor</option>
    </select>
    <select id="fAssetProject" onchange="applyAssetFilters()"><option value="">All Projects</option></select>
    <select id="fAssetStatus" onchange="applyAssetFilters()">
      <option value="">All Status</option>
      <option>In operation</option><option>IDLE</option><option>maintenance</option>
      <option>service</option><option>passing work</option><option>Scrap</option>
      <option>cancelled</option><option>to be sold</option><option>sold</option>
    </select>
    
    <button class="btn" onclick="openAssetModal()">+ Add Asset</button>
    <button class="btn secondary" onclick="importAssetExcel()">Import Excel</button>
    <button class="btn" onclick="exportAssetExcel()">Export Excel</button>
  </div>

  <div class="table-wrap">
    <table id="assetTable">
      <thead>
        <tr>
          <th>Vehicle/Machine No</th>
          <th>Asset No</th>
          <th>Category</th>
          <th>User Name</th>
          <th>Designation</th>
          <th>Contact</th>
          <th>Project</th>
          <th>Reg No</th>
          <th>Reg Expiry</th>
          <th>From</th>
          <th>Till</th>
<th>Status</th> <th>Shift</th>
          <th>Remarks</th>

          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="assetTbody"></tbody>
    </table>
  </div>
</section>
<div id="assetModal" class="modal-overlay">
  <div class="modal-content card">
    <h3>Add New Asset</h3>
    <div class="grid grid-4">
      <input id="a_vmNo" placeholder="Vehicle/Machine No" />
      <input id="a_assetNo" placeholder="Asset No" />
      <select id="a_category">
        <option value="">Category</option>
        <option>Vehicle</option><option>Machine</option><option>Gensets</option><option>Minor</option>
      </select>
<div class="search-dd" id="a_userDD">
  <div class="selected">Select User (ID - Name)</div>
  <div class="panel">
    <input placeholder="Search user..." oninput="filterDD(this)">
    <div class="list"></div>
  </div>
</div>

      <input id="a_designation" placeholder="Designation (Auto)" readonly />
      <input id="a_contact" placeholder="Contact (Auto)" readonly />
      <div class="search-dd" id="a_projectDD">
  <div class="selected">Select Project</div>
  <div class="panel">
    <input placeholder="Search project..." oninput="filterDD(this)">
    <div class="list"></div>
  </div>
</div>

      <input id="a_regNo" placeholder="Registration No" />
<input id="a_regExp" type="text" placeholder="üìÖ Reg Expiry" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
<input 
  id="a_from" 
  type="text" 
  placeholder="üìÖ From Date/Time" 
  onfocus="(this.type='datetime-local')" 
  oninput="this.blur()" 
  onblur="if(!this.value) this.type='text'" 
/>

<input 
  id="a_till" 
  type="text" 
  placeholder="üìÖ Till Date/Time" 
  onfocus="(this.type='datetime-local')" 
  oninput="this.blur()" 
  onblur="if(!this.value) this.type='text'" 
/>
<select id="a_status">
        <option value="">Select Status</option>
        <option>In operation</option>
        <option>IDLE</option>
        <option>Maintenance</option>
        <option>Scrap</option>
<option>Passing Work</option>
<option>To be Sold</option>
<option>Sold</option>
      </select>
<select id="a_shift">
        <option value="">Select Shift</option>
        <option>Day</option>
        <option>Night</option>
      </select>
      <textarea id="a_remarks" placeholder="Remarks"></textarea>
    </div>
    <div style="margin-top:20px; text-align:right;">
      <button class="btn warn" onclick="closeAssetModal()">Cancel</button>
      <button class="btn" onclick="saveOrUpdateAsset()">Save Asset</button>

    </div>
  </div>
</div>


    <!-- DRIVER/OPERATOR LIST -->
    <section id="list" class="section" style="display:none">
      <h2>Driver/Operator List</h2>
      <div class="toolbar card">
        <input id="search" placeholder="Search" oninput="applyFilters()" />
        <select id="fDesignation" onchange="applyFilters()">
          <option value="">All Designations</option>
          <option>Heavy Duty Driver</option>
          <option>Bus Driver</option>
          <option>Operator - Heavy Equipment</option>
          <option>Light Vehicle Driver</option>
	<option>Workshop</option>
        </select>

  <select id="fProject" onchange="applyFilters()">
  <option value="">All Projects</option>
</select>

        <select id="fStatus" onchange="applyFilters()">
          <option value="">All Status</option>
          <option>Active</option>
          <option>On Leave</option>
          <option>Resigned</option>
          <option>Transfer</option>
          <option>IDLE</option>
          <option>Others...</option>
        </select>
        <span class="page-size">Rows/page:
          <select id="pageSize" onchange="applyFilters()">
            <option>10</option><option>20</option><option>50</option><option>100</option>
          </select>
        </span>
       <input type="file" id="excelFile" accept=".xlsx,.xls" />
<button id="btnImport" class="btn secondary" onclick="importExcel()">Import Excel</button>

        <button class="btn" onclick="exportExcel()">Export Excel</button>
        <button class="btn" onclick="exportPDF()">Export PDF</button>
      </div>
      <div class="card" id="addCard">
        <h3>Add Driver/Operator</h3>
        <div class="grid grid-4">
          <input id="empId" placeholder="Employee ID" />
          <input id="name" placeholder="Proper Name"autocomplete="name" />

          <select id="designation">
            <option value="">Designation</option>
            <option>Heavy Duty Driver</option>
            <option>Bus Driver</option>
            <option>Operator - Heavy Equipment</option>
            <option>Light Vehicle Driver</option>
		<option>Workshop</option>
          </select>
<div class="search-dd" id="driverProjectDD">
  <div class="selected">Select Project</div>
  <div class="panel">
    <input placeholder="Search project..." oninput="filterDD(this)">
    <div class="list"></div>
  </div>
</div>


          <input id="vehicleNo" placeholder="Vehicle / Machine No" />
          <input id="assetCode" placeholder="Asset T Code" />

          <input id="contact" placeholder="+9715XXXXXXXX" />
<input id="joiningDate" type="text" placeholder="üìÖ Joining Date" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />
<input id="leaveSince" type="text" placeholder="üìÖ Leave Since/Resigned Date" onfocus="(this.type='date')" onblur="if(!this.value)this.type='text'" />

          <select id="status">
            <option>Active</option>
            <option>On Leave</option>
            <option>Resigned</option>
            <option>Transfer</option>
            <option>IDLE</option>
            <option>Others...</option>
          </select>
          <input id="remarks" placeholder="Remarks" />
          <button class="btn" onclick="addEntry()">Add</button>
        </div>
      </div>

<p style="color:#2563eb; font-weight:600; margin:8px 0;">
  üí° Tip: Right-click a row to open Driver/Operator Logs
</p>

      <div class="table-wrap">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Employee ID</th>
              <th>Name</th>
              <th>Designation</th>
              <th>Project</th>
              <th>Vehicle / Machine No</th>
              <th>Asset T Code</th>
              <th>Contact</th>
              <th>Joining Date</th>
	      <th>Leave Since/ Resigned Date</th>
	      <th>Leave Till</th>
              <th>Status</th>
              <th>Remarks</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="pagination">
        <button class="page-btn" onclick="gotoPage(1)">‚èÆ First</button>
        <button id="prevBtn" class="page-btn" onclick="gotoPage(state.page-1)">‚óÄ Prev</button>
        <span id="pageInfo"></span>
        <button id="nextBtn" class="page-btn" onclick="gotoPage(state.page+1)">Next ‚ñ∂</button>
        <button class="page-btn" onclick="gotoPage(state.totalPages)">Last ‚è≠</button>
      </div>
    </section>

<!-- Project Section -->

<section id="projectsSection" class="section" style="display:none">
  <h2>Projects List</h2>
  <div class="toolbar card">
    <input id="projSearch" placeholder="Search Projects..." oninput="applyProjFilters()" />
    <select id="fProjStatus" onchange="applyProjFilters()">
      <option value="">All Status</option>
      <option>Active</option>
      <option>Inactive</option>
      <option>On Hold</option>
    </select>
    <span class="page-size">Rows/page:
      <select id="projPageSize" onchange="applyProjFilters()">
        <option>10</option><option>20</option><option>50</option>
      </select>
    </span>
    <input type="file" id="projExcelFile" accept=".xlsx,.xls" style="display:none" />
    <button class="btn secondary" onclick="document.getElementById('projExcelFile').click()">Import Excel</button>
    <button class="btn" onclick="exportProjExcel()">Export Excel</button>
  </div>

  <div class="card" id="addProjCard">
    <h3>Add Project</h3>
    <div class="grid grid-4">
      <input id="p_id" placeholder="Project ID" />
      <input id="p_name" placeholder="Project Name" />
      <input id="p_loc" placeholder="Location" />
      <input id="p_div" placeholder="Division" />
      <input id="p_date" type="date" title="Creation Date" />
      <select id="p_status">
        <option>Active</option>
        <option>Inactive</option>
        <option>On Hold</option>
      </select>
      <button class="btn" onclick="addProject()">Add Project</button>
    </div>
  </div>
<div id="projectEditModal" class="modal-overlay">
  <div class="modal-content card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="margin:0;">Edit Project Details</h3>
      <button class="btn warn" onclick="closeProjEdit()">‚úï</button>
    </div>
    
    <div class="grid grid-2">
      <div>
        
        <input id="ep_id" placeholder="Project ID" />
      </div>
      <div>
       
        <input id="ep_name" placeholder="Project Name" />
      </div>
      <div>
       
        <input id="ep_loc" placeholder="Location" />
      </div>
      <div>
        
        <input id="ep_div" placeholder="Division" />
      </div>
      <div>
        
        <input id="ep_date" type="date" />
      </div>
      <div>
        
        <select id="ep_status">
          <option>Active</option>
          <option>Inactive</option>
          <option>On Hold</option>
        </select>
      </div>
    </div>

    <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px;">
      <button class="btn secondary" onclick="closeProjEdit()">Cancel</button>
      <button class="btn" onclick="saveProjUpdate()">Update Project</button>
    </div>
  </div>
</div>

  <div class="table-wrap">
    <table id="projTable">
      <thead>
        <tr>
          <th>Project ID</th>
          <th>Project Name</th>
          <th>Location</th>
          <th>Division</th>
          <th>Creation Date</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="projTbody"></tbody>
    </table>
  </div>
  
  <div class="pagination">
    <button class="page-btn" onclick="gotoProjPage(1)">‚èÆ First</button>
    <button id="prevProjBtn" class="page-btn" onclick="gotoProjPage(state.projPage-1)">‚óÄ Prev</button>
    <span id="projPageInfo"></span>
    <button id="nextProjBtn" class="page-btn" onclick="gotoProjPage(state.projPage+1)">Next ‚ñ∂</button>
  </div>
</section>



<!--  LEAVE > 6 MONTHS -->
<section id="al6m" class="section" style="display:none">
  <h2>On Leave > 6 Months</h2>
  <div class="card">
    <button class="btn" onclick="exportAL6mExcel()">Export Excel</button>
  </div>
  <div class="table-wrap">
    <table id="al6mTable">
<thead>
  <tr>
    <th>Employee ID</th>
    <th>Name</th>
    <th>Designation</th>
    <th>Project</th>
    <th>Plate Noth>
    <th>assetCode</th>
    <th>Contact</th>
    <th>Joining Date</th>
    <th>Leave Since/ Resigned Date</th>
    <th>Leave Till</th>
    <th>Status</th>
    <th>Remarks</th>
    <th>Category</th>
    <th>Overstay Days</th>
  </tr>
</thead>

      <tbody id="al6mBody"></tbody>
    </table>
  </div>
</section>



    <!-- USERS -->
    <section id="users" class="section" style="display:none">
      <h2>Users</h2>
      <div class="card">
        <h3>Add User</h3>
        <div class="grid grid-4">
          <input id="newU" placeholder="Username" />
          <input id="newP" placeholder="Password" type="password" />
          <select id="newRole">
            <option>Viewer</option>
            <option>Admin</option>
            <option>SuperAdmin</option>
          </select>
          <button class="btn" onclick="addUser()">Add User</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="userTable">
          <thead>
            <tr>
              <th>Username</th>
              <th>Role</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="userTbody"></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<div class="footer">
  Designed by Engr. Farrukh 
  <span id="dataStatus" style="margin-left:12px; font-weight:600;"></span>
</div>


<!-- Edit Driver Modal -->
<div id="editModal" class="modal">
  <div class="dialog">
    <h3>Edit Entry</h3>
    <div class="grid grid-2">
      <input id="e_empId" placeholder="Employee ID" />
      <input id="e_name" placeholder="Name" />
      <select id="e_designation">
        <option>Heavy Duty Driver</option>
        <option>Bus Driver</option>
        <option>Operator - Heavy Equipment</option>
        <option>Light Vehicle Driver</option>
<option>Workshop</option>
      </select>
      <select id="e_project">
        <option>Creation</option>
        <option>Gatex</option>
        <option>Samtech</option>
      </select>
      <input id="e_vehicleNo" placeholder="Vehicle / Machine No" />
      <input id="e_assetCode" placeholder="Asset T Code" />
      <input id="e_contact" placeholder="Contact" />
      <input id="e_joiningDate" type="date" />
<input id="e_leaveSince" type="date" placeholder="Tochkey Returned Date (optional)" />
<input id="e_leaveTill" type="date" placeholder="Leave Till (optional)" />
      <select id="e_status">
        <option>Active</option>
        <option>On Leave</option>
        <option>Resigned</option>
        <option>Transfer</option>
        <option>IDLE</option>
        <option>Others...</option>
      </select>
      <input id="e_remarks" placeholder="Remarks" />
    </div>
    <div class="actions">
      <button class="btn warn" onclick="closeEdit()">Cancel</button>
      <button class="btn" onclick="saveEdit()">Save</button>
    </div>
  </div>
</div>


<!-- Change Password Modal -->
<div id="pwModal" class="modal">
  <div class="dialog">
    <h3>Change Password</h3>
    <input id="pwUser" type="hidden" />
    <input id="pwNew" placeholder="New Password" type="password" />
    <input id="pwConfirm" placeholder="Confirm Password" type="password" />
    <div class="actions">
      <button class="btn warn" onclick="closePw()">Cancel</button>
      <button class="btn" onclick="savePw()">Save</button>
    </div>
  </div>
</div>

<!-- Driver Logs Modal -->
<div id="logsModal" class="modal">
  <div class="dialog">
    <h3>Driver Logs</h3>
    <div id="logsTimeline" style="max-height:400px;overflow:auto;"></div>
    <div class="actions">
	<button class="btn secondary" onclick="exportLogsPDF()">üìë Export PDF</button>
      <button class="btn warn" onclick="closeLogs()">Close</button>
    </div>
  </div>
</div>

<script type="module">



/* -------------------------- Firebase (ESM) -------------------------- */
// Use 10.13.0 for EVERYTHING
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import {
  initializeFirestore,
  persistentLocalCache,
  persistentMultipleTabManager,
  collection,
  doc,
  getDoc,
  getDocs,
  setDoc,
  addDoc,
  updateDoc,
  deleteDoc,
  query,
  where,
  serverTimestamp,
  onSnapshot,
  orderBy
} from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

/* ===== YOUR FIREBASE CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCmd5cSLKMJkiotQopikaOGRUZPvjYbmx4",
  authDomain: "asset-management-system-755a6.firebaseapp.com",
  projectId: "asset-management-system-755a6",
  storageBucket: "asset-management-system-755a6.firebasestorage.app",
  messagingSenderId: "889243221633",
  appId: "1:889243221633:web:e8767dc3d1d42c14fb9780",
  measurementId: "G-TT5CSSLCNR"
};

// Initialize App
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// Initialize Firestore with consistent 10.13.0 cache settings
const db = initializeFirestore(app, {
  localCache: persistentLocalCache({
    tabManager: persistentMultipleTabManager()
  })
});


/* ------------------------ Minimal helper styles ------------------------ */
(function injectMinorStyles(){
  const s=document.createElement('style');
  s.textContent = `
    .cell-bad{ background:#fee2e2 !important; }
    .badge-danger{ background:rgba(239,68,68,.12); color:#ef4444; padding:4px 10px; border-radius:999px; font-size:12px }
    .hidden{ display:none !important; }
  `;
  document.head.appendChild(s);
})();
function applyRoleUI(){
  const role = (state.me?.role || '').toLowerCase();
  const isViewer = role === 'viewer';

  // Hide manual add form & import controls for viewers
 // $('#addCard')?.classList.toggle('hidden', isViewer);
  $('#excelFile')?.classList.toggle('hidden', isViewer);
  $('#btnImport')?.classList.toggle('hidden', isViewer);
}

/* ------------------------------ Globals ------------------------------ */
const COLL_DRIVERS = "drivers";
const COLL_USERS   = "users";
const COLL_PROJECTS = "projects"; // New Firestore collection name
const COLL_ASSETS = "assets";
const COLL_ASSET_LOGS = "asset_logs"; // Same as driver logs
let unsubscribeProjects = null;
let unsubscribeDrivers = null;
let unsubscribeUsers = null;
let currentEditAssetId = null;


const state = {
  me: null,                           // {id, username, role}
  drivers: [],                        // all drivers from DB
  users: [],                          // all users from DB
  filtered: [],                       // filtered drivers for table
  page: 1,
  pageSize: 10,
  totalPages: 1,
  editIndex: null,                    // index in drivers[]
  editDocId: null,                    // firestore doc id being edited
  annualLeaveOver6M: [],               // derived list for alerts/export
projects: [],
editProjDocId: null,
  projFiltered: [],
  projPage: 1,
  projPageSize: 10,
  projTotalPages: 1,
assets: [],
  filteredAssets: [],
  assetPage: 1,
  assetTotalPages: 1,
};

// make state visible to inline onclick handlers
window.state = state;

/* ------------------------ Utility / Formatting ------------------------ */
const $ = (sel) => document.querySelector(sel);
const $$ = (sel)=> Array.from(document.querySelectorAll(sel));
function toast(msg){ alert(msg); }
function isDriver(rec){ return /driver/i.test(rec.designation||'') && !/operator/i.test(rec.designation||''); }
function isOperator(rec){ return /operator/i.test(rec.designation||''); }
function statusIndexToText(i){ return ['Active','on Leave','Resigned','Transfer','IDLE','Others...'][i] || ''; }
function validContact(c){ return /^\+9715\d{8}$/.test(c||''); }
function validassetCode(s){ return (s||'').length===16; }
function parseDate(d){ return d ? new Date(d) : null; }
function monthsDiff(fromDate, toDate=new Date()){
  if(!fromDate) return 0;
  const f = new Date(fromDate);
  return (toDate.getFullYear()-f.getFullYear())*12 + (toDate.getMonth()-f.getMonth());
}

/* -------------------------- First-time seeding ------------------------- */
async function ensureDefaultSuperAdmin(){
  // Create SuperAdmin "Trojan Plant" / "1234" only if not exists
  const qSnap = await getDocs(query(collection(db, COLL_USERS), where("username","==","Trojan Plant")));
  if(qSnap.empty){
    await addDoc(collection(db, COLL_USERS), {
      username: "Trojan Plant",
      password: "1234",
      role: "SuperAdmin",
      createdAt: serverTimestamp()
    });
  }
}

/* -------------------------------- Login -------------------------------- */
async function doLogin(){
  const u = $('#u').value.trim();
  const p = $('#p').value.trim();
  if(!u || !p){ toast("Enter username and password"); return; }

try {
    showLoader();  // show overlay while checking credentials

  // authenticate against Firestore (no hashing as requested)
  const qSnap = await getDocs(query(collection(db, COLL_USERS), where("username","==",u), where("password","==",p)));
  if(qSnap.empty){ toast("Invalid credentials"); return; }

  const docRef = qSnap.docs[0];
  state.me = { id: docRef.id, ...docRef.data() };
  $('#loginWrap').style.display='none';
  $('#app').style.display='flex';
  $('#userLabel').textContent = `${state.me.username} (${state.me.role})`;
  // Access control: show/hide Users tab
  const usersNav = $('#nav-users');
  if(state.me.role === 'SuperAdmin'){ usersNav.style.display = 'block'; }
  else { usersNav.style.display = 'none'; }
applyRoleUI();

  await loadDrivers();  // attaches realtime listener + paints from cache
await loadProjects();
 await loadUsers();    // attaches realtime listener if SuperAdmin
  nav('dashboard');
}  catch(err){
    console.error("Login error:", err);
    toast("‚ùå Login failed");
  }
  finally {
    hideLoader();   // <--- always hide overlay, success or fail
  }
}
// Add this block anywhere in your <script> section
document.addEventListener('keydown', function(event) {
  // Check if the Enter key was pressed
  if (event.key === 'Enter') {
    // Only trigger if the user is currently looking at the login screen
    const loginWrap = document.querySelector('.login-wrap');
    if (loginWrap && loginWrap.style.display !== 'none') {
      doLogin(); // Calls your existing login function
    }
  }
});



function doLogout() {
  if (unsubscribeDrivers) { unsubscribeDrivers(); unsubscribeDrivers = null; }
  if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
  state.me = null;

  $('#userLabel').textContent = '';
  $('#app').style.display = 'none';
  $('#loginWrap').style.display = 'flex';
  $('#u').value = '';
  $('#p').value = '';
}

/* ------------------------------ Button Bindings ------------------------------ */
window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("loginBtn").addEventListener("click", doLogin);
  document.getElementById("logoutBtn").addEventListener("click", doLogout);
});

/* --------------------------------- NAV --------------------------------- */
function nav(id){
  // 1. Hide all sections first
  $$('.section').forEach(s => s.style.display = 'none');
  
  // 2. Remove 'active' class from all nav links
  $$('.nav a').forEach(a => a.classList.remove('active'));

  // 3. Show the requested section
  const targetSection = $(`#${id}`);
  if (targetSection) {
    targetSection.style.display = 'block';
  }

  // 4. Highlight the nav link
  const navLink = $(`#nav-${id}`);
  if (navLink) {
    navLink.classList.add('active');
  }

  // 5. Run section-specific loaders
  if(id === 'dashboard') renderDashboard();
  if(id === 'list'){
    applyRoleUI();
    applyFilters();
  }
  if(id === 'projectsSection'){
    loadProjects(); // Ensure this function exists
    applyProjFilters(); // Ensure this function exists
  }
  if(id === 'users') renderUsers();
  if(id === 'al6m') renderAL6M();
  if(id === 'undertaking') {
    document.getElementById("undertakingDate").textContent = new Date().toLocaleDateString();
  }
}
window.nav = nav;
/* -------------------------------- Undertaking -------------------------------- */
function fillUndertakingForm(driver) {
  document.getElementById("undertakingDate").textContent = new Date().toLocaleDateString();
  document.getElementById("uName").textContent = driver.name || '';
  document.getElementById("uEmpId").textContent = driver.empId || '';
  document.getElementById("uvehicleNo").textContent = driver.vehicleNo || '';
  document.getElementById("uassetCode").textContent = driver.assetCode || '';
  document.getElementById("uContact").textContent = driver.contact || '';
  document.getElementById("uRemarks").textContent = driver.remarks || '';
}
function printUndertaking() {
  const content = document.getElementById("undertaking");
  if (!content) return;

  // Save old display state
  const sections = document.querySelectorAll(".section");
  sections.forEach(s => s.setAttribute("data-old-display", s.style.display));

  // Show undertaking only
  sections.forEach(s => s.style.display = "none");
  content.style.display = "block";

  // Trigger print
  window.print();

  // Restore old state after print
  sections.forEach(s => {
    s.style.display = s.getAttribute("data-old-display") || "none";
  });
}
window.printUndertaking = printUndertaking;

/* -------------------------------- Export PDF Undertaking -------------------------------- */
window.exportUndertakingPDF = function() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({
    orientation: 'p',
    unit: 'mm',
    format: 'a4'
  });

  const element = document.getElementById("undertakingContent");

  // Temporarily show undertaking if hidden
  const parent = document.getElementById("undertaking");
  const prev = parent.style.display;
  parent.style.display = "block";

  doc.html(element, {
    callback: function (doc) {
      doc.save("undertaking.pdf");
      parent.style.display = prev; // restore after save
    },
    margin: [10, 10, 10, 10],
    x: 0,
    y: 0,
    width: 190,
    windowWidth: element.scrollWidth
  });
};


/* -------------------------------- Users -------------------------------- */
async function loadUsers(){
  if (state.me?.role !== 'SuperAdmin') {
   if (unsubscribeUsers) { unsubscribeUsers(); unsubscribeUsers = null; }
   state.users = [];
   return;
 }
 if (unsubscribeUsers) unsubscribeUsers();
  unsubscribeUsers = onSnapshot(
    collection(db, COLL_USERS),
   (snap) => {
      state.users = snap.docs.map(d=>({ id:d.id, ...d.data() }));
     renderUsers();
applyAssetFilters();
   },
   (err)=> console.error("Users onSnapshot error:", err)
  );
}


function renderUsers(){
  // Hide or show Users page actions based on role
  if(state.me?.role!=='SuperAdmin'){ return; }
  const tbody = $('#userTbody'); tbody.innerHTML='';
  state.users.forEach(u=>{
    const tr=document.createElement('tr');
tr.innerHTML = `
  <td>${u.username||''}</td>
  <td>${u.role||''}</td>
  <td>
    <button class="page-btn" onclick="openPw('${u.id}','${u.username||''}')">Change Password</button>
    ${
      u.role === 'SuperAdmin'
        ? ''   // üîí No delete button for SuperAdmin
        : `<button class="page-btn" onclick="deleteUser('${u.id}')">Delete</button>`
    }
  </td>`;

    tbody.appendChild(tr);
  });
}


async function addUser(){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can add users'); return; }
  const username = $('#newU').value.trim();
  const password = $('#newP').value.trim();
  const role     = $('#newRole').value;
  if(!username||!password){ toast('Username & Password required'); return; }

  // prevent dup username
  const qSnap = await getDocs(query(collection(db, COLL_USERS), where("username","==",username)));
  if(!qSnap.empty){ toast('Username already exists'); return; }

  await addDoc(collection(db, COLL_USERS), { username, password, role, createdAt: serverTimestamp() });
  $('#newU').value=''; $('#newP').value=''; $('#newRole').value='Viewer';
  await loadUsers();
  toast('User added');
}
window.addUser = addUser;

async function deleteUser(id){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can delete users'); return; }
  if(!confirm('Delete this user?')) return;
  await deleteDoc(doc(db, COLL_USERS, id));
  await loadUsers();
  toast('User deleted');
}
window.deleteUser = deleteUser;
function renderAL6M(){
  const tbody = $('#al6mBody'); 
  tbody.innerHTML = '';

  state.annualLeaveOver6M.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${d.empId||''}</td>
      <td>${d.name||''}</td>
      <td>${d.designation||''}</td>
      <td>${d.project||''}</td>
      <td>${d.vehicleNo||''}</td>
      <td>${d.assetCode||''}</td>
      <td>${d.contact||''}</td>
      <td>${d.joiningDate||''}</td>
      <td>${d.leaveSince||''}</td>
      <td>${d.leaveTill||''}</td>
      <td>${d.status||''}</td>
      <td>${d.remarks||''}</td>
      <td>${d.category||''}</td>
      <td>${d.overstayDays||''}</td>
    `;
    tbody.appendChild(tr);
  });
}

function openPw(id, username){
  if(state.me?.role!=='SuperAdmin'){ toast('Only SuperAdmin can change passwords'); return; }
  $('#pwUser').value = id;
  $('#pwNew').value = '';
  $('#pwConfirm').value = '';
  $('#pwModal').style.display='flex';
}
window.openPw = openPw;

function closePw(){ $('#pwModal').style.display='none'; }
window.closePw = closePw;

async function savePw(){
  const id = $('#pwUser').value;
  const np = $('#pwNew').value.trim();
  const cp = $('#pwConfirm').value.trim();
  if(!np){ toast('Enter new password'); return; }
  if(np!==cp){ toast('Passwords do not match'); return; }
  await updateDoc(doc(db, COLL_USERS, id), { password: np });
  closePw();
  await loadUsers();
  toast('Password updated');
}
window.savePw = savePw;


/* ------------------------------- Drivers -------------------------------- */
async function loadDrivers() {
  const cacheKey = "driversCache";
  const cacheTTL = 1000 * 60 * 60 * 24; // 24h

  let needsRefresh = true;

  // 1) Check local cache
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    const { timestamp, data } = JSON.parse(cached);
    state.drivers = data || [];
    deriveAnnualLeaveList();
    refreshAll();

    // If cache still valid ‚Üí no refresh
    if (Date.now() - timestamp < cacheTTL) {
      needsRefresh = false;
	setDataStatus("‚ö° Cached", "#f59e0b");  // orange
      console.log("‚úÖ Using cache, still fresh");
    } else {
	setDataStatus("‚ö†Ô∏è Cache expired, refreshing‚Ä¶", "#ef4444");  // red
      console.log("‚ö†Ô∏è Cache expired, will refresh once");
    }
  }

  // 2) Always attach realtime listener (keeps cache updated on changes)
  if (unsubscribeDrivers) unsubscribeDrivers();
  unsubscribeDrivers = onSnapshot(
    collection(db, COLL_DRIVERS),
    { includeMetadataChanges: true },
    (snap) => {
      const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      arr.sort((a, b) => {
        const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
        const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
        return tb - ta;
      });
      state.drivers = arr;

      deriveAnnualLeaveList();
      updateDriverCache();
      refreshAll();

      if (!snap.metadata.fromCache) {
	setDataStatus("üîÑ Realtime update", "#16a34a");  // green
        console.log("üîÑ Realtime update from Firestore");
      }
    },
    (err) => console.error("onSnapshot error:", err)
  );

  //Lazy refresh: only if cache expired
  if (needsRefresh) {
    const snap = await getDocs(collection(db, COLL_DRIVERS));
    const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    arr.sort((a, b) => {
      const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
      const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
      return tb - ta;
    });
    state.drivers = arr;
    deriveAnnualLeaveList();
    updateDriverCache();
    refreshAll();
	setDataStatus("‚úÖ Fresh data", "#2563eb");  // blue
    console.log("‚úÖ Cache refreshed after 24h");
  }
}


// 1. Navigation update
const originalNav = window.nav;
window.nav = function(id) {
  originalNav(id);
  if(id === 'projectsSection') {
    loadProjects();
    applyProjFilters();
  }
};


state.assets = [];
state.assetFiltered = [];
// Function to populate User Dropdown and Auto-fill
window.autoFillUserDetail = function() {
  const selectedEmpId = document.getElementById('a_userSelect').value;
  const user = state.drivers.find(d => d.empId === selectedEmpId);
  if (user) {
    document.getElementById('a_designation').value = user.designation;
    document.getElementById('a_contact').value = user.contact;
  }
};

// Function to populate the User Dropdown when opening the modal
window.openAssetModal = function() {
  // Show the modal first
  const modal = document.getElementById('assetModal');
  if (modal) modal.style.display = 'flex';

  // 1. Populate User Searchable Dropdown List
  // We target the '.list' div inside your new 'a_userDD' container
  const userListDiv = document.querySelector('#a_userDD .list');
  if (userListDiv) {
    // We use state.drivers (or state.data) to fill the searchable list
    userListDiv.innerHTML = state.drivers.map(u => `
      <div class="item" onclick="setDD('a_userDD', '${u.empId}', '${u.empId} - ${u.name}')">
        ${u.empId} - ${u.name}
      </div>
    `).join('');
  }

  // 2. Populate Project Searchable Dropdown List
  // We target the '.list' div inside your new 'a_projectDD' container
  const projListDiv = document.querySelector('#a_projectDD .list');
  if (projListDiv) {
    projListDiv.innerHTML = state.projects.map(p => `
      <div class="item" onclick="setDD('a_projectDD', '${p.p_name}', '${p.p_name} (${p.p_id})')">
        ${p.p_name} (${p.p_id})
      </div>
    `).join('');
  }
};

window.editAsset = function (assetId) {
  const asset = state.assets.find(a => a.id === assetId);
  if (!asset) {
    alert("Asset not found");
    return;
  }

  currentEditAssetId = assetId;

  // Change modal title
  document.querySelector('#assetModal h3').textContent = "Edit Asset";

  // Open modal
  document.getElementById('assetModal').style.display = 'flex';

  // Populate normal inputs
  document.getElementById('a_vmNo').value = asset.vmNo || '';
  document.getElementById('a_assetNo').value = asset.assetNo || '';
  document.getElementById('a_category').value = asset.category || '';
  document.getElementById('a_designation').value = asset.designation || '';
  document.getElementById('a_contact').value = asset.contact || '';
  document.getElementById('a_regNo').value = asset.regNo || '';
  document.getElementById('a_regExp').value = asset.regExp || '';
  document.getElementById('a_from').value = asset.from || '';
  document.getElementById('a_till').value = asset.till || '';
  document.getElementById('a_status').value = asset.status || 'IDLE';
  document.getElementById('a_shift').value = asset.shift || 'Day';
  document.getElementById('a_remarks').value = asset.remarks || '';

  // Populate USER dropdown
  const userDD = document.getElementById('a_userDD');
  userDD.dataset.value = asset.empId || '';
  userDD.querySelector('.selected').textContent =
    asset.empId ? `${asset.empId} - ${asset.designation}` : 'Select User (ID - Name)';

  // Populate PROJECT dropdown
  const projDD = document.getElementById('a_projectDD');
  projDD.dataset.value = asset.project || '';
  projDD.querySelector('.selected').textContent =
    asset.project || 'Select Project';

  // Populate dropdown lists (same as add)
  document.querySelector('#a_userDD .list').innerHTML =
    state.drivers.map(u => `
      <div class="item" onclick="setDD('a_userDD','${u.empId}','${u.empId} - ${u.name}')">
        ${u.empId} - ${u.name}
      </div>
    `).join('');

  document.querySelector('#a_projectDD .list').innerHTML =
    state.projects.map(p => `
      <div class="item" onclick="setDD('a_projectDD','${p.p_name}','${p.p_name} (${p.p_id})')">
        ${p.p_name} (${p.p_id})
      </div>
    `).join('');
};


// Example usage inside your edit function:
// prepareDateInput('joiningDate', driver.joiningDate);

/* ===== Search Dropdown Core (GLOBAL) ===== */

// This makes the function globally accessible to the 'oninput' in your HTML
window.filterDD = function(id, type) {
  const dd = document.getElementById(id);
  const input = dd.querySelector('.search-input');
  const panel = document.getElementById(id + 'List');
  const term = input.value.toLowerCase();
  
  let list = [];
  if (type === 'user') list = state.users;
  else if (type === 'project') list = state.projects;
  else if (type === 'asset') list = state.assets;

  const filtered = list.filter(item => {
    const val = (type === 'project') ? item.name : (item.name || item.assetName || item.displayName || "");
    return val.toLowerCase().includes(term);
  });

  panel.innerHTML = '';
  filtered.forEach(item => {
    const div = document.createElement('div');
    div.className = 'item';
    
    // Determine display name based on type
    let displayName = item.name || item.assetName || item.displayName || "";
    div.textContent = displayName;

    div.onclick = () => {
      // 1. Set the selected value
      input.value = displayName;
      dd.dataset.value = (type === 'project') ? item.name : item.id;
      dd.classList.remove('open');

      // 2. AUTO-FILL LOGIC: If we are selecting a user in the Driver/Operator modal
      if (id === 'uUserDD') {
        performAutoFill(item);
      }
    };
    panel.appendChild(div);
  });
  
  dd.classList.add('open');
};

// New Helper Function for Auto-fill
function performAutoFill(userItem) {
  // Fill Project
  if (userItem.project) {
    const pDD = document.getElementById('uProjectDD');
    if (pDD) {
      pDD.querySelector('.search-input').value = userItem.project;
      pDD.dataset.value = userItem.project;
    }
  }

  // Fill Asset Details (Vehicle No and T-Code)
  const targetAssetId = userItem.assignedAsset || userItem.assetId;
  if (targetAssetId) {
    const asset = state.assets.find(a => a.id === targetAssetId);
    if (asset) {
      // Set Vehicle No Dropdown
      const aDD = document.getElementById('uAssetDD');
      if (aDD) {
        aDD.querySelector('.search-input').value = asset.assetName || asset.name;
        aDD.dataset.value = asset.id;
      }
      // Set T-Code Input
      const tInput = document.getElementById('uTCode');
      if (tInput) {
        tInput.value = asset.assetTCode || asset.tCode || "";
      }
    }
  }
}

// 1. Toggle panel visibility
document.addEventListener('click', (e) => {
  const dd = e.target.closest('.search-dd');
  // Close all other panels
  document.querySelectorAll('.search-dd .panel').forEach(p => {
    if (!dd || p !== dd.querySelector('.panel')) p.style.display = 'none';
  });
  // Toggle current panel
  if (dd && e.target.classList.contains('selected')) {
    const panel = dd.querySelector('.panel');
    panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
    if (panel.style.display === 'block') panel.querySelector('input').focus();
  }
});


window.setDD = function(ddId, value, text) {
  const dd = document.getElementById(ddId);
  if (!dd) return;
  
  // Update the visible text and store the value
  dd.querySelector('.selected').textContent = text;
  dd.dataset.value = value;
  dd.querySelector('.panel').style.display = 'none';

  // --- NEW AUTOFILL LOGIC FOR ASSETS ---
  if (ddId === 'a_userDD') {
    // Find the driver in the global state using the Employee ID (value)
    const driver = state.drivers.find(d => d.empId === value);
    
    if (driver) {
      // Fill the designation and contact fields automatically
      document.getElementById('a_designation').value = driver.designation || '';
      document.getElementById('a_contact').value = driver.contact || '';
    } else {
      // Clear them if no driver is found
      document.getElementById('a_designation').value = '';
      document.getElementById('a_contact').value = '';
    }
  }
};

// 2. Auto-fill Designation and Contact on Selection
window.onAssetUserChange = function() {
  const empId = document.getElementById('a_userSelect').value;
  const driver = state.drivers.find(d => d.empId === empId);
  if (driver) {
    document.getElementById('a_designation').value = driver.designation;
    document.getElementById('a_contact').value = driver.contact;
  } else {
    document.getElementById('a_designation').value = "";
    document.getElementById('a_contact').value = "";
  }
}




window.saveOrUpdateAsset = async function () {

  const data = {
    vmNo: document.getElementById('a_vmNo').value,
    assetNo: document.getElementById('a_assetNo').value,
    category: document.getElementById('a_category').value,
    empId: document.getElementById('a_userDD').dataset.value,
    designation: document.getElementById('a_designation').value,
    contact: document.getElementById('a_contact').value,
    project: document.getElementById('a_projectDD').dataset.value,
    regNo: document.getElementById('a_regNo').value,
    regExp: document.getElementById('a_regExp').value,
    from: document.getElementById('a_from').value,
    till: document.getElementById('a_till').value,
    status: document.getElementById('a_status').value || "IDLE",
    shift: document.getElementById('a_shift').value || "Day",
    remarks: document.getElementById('a_remarks').value,
    updatedAt: serverTimestamp()
  };
if (!data.vmNo || !data.assetNo) {
    alert("Please fill required fields (VM No and Asset No)");
    return;
  }
  showLoader();
  try {
// 1. Identify the PREVIOUS technician (if any) to clear their data
    if (currentEditAssetId) {
      const oldAssetDoc = state.assets.find(a => a.id === currentEditAssetId);
      if (oldAssetDoc && oldAssetDoc.empId && oldAssetDoc.empId !== data.empId) {
        const prevTech = state.drivers.find(d => d.empId === oldAssetDoc.empId);
        if (prevTech) {
          await updateDoc(doc(db, COLL_DRIVERS, prevTech.id), {
            project: "",
            vehicleNo: "",
            assetCode: "",
            status: "IDLE" // Or keep "Active" if preferred
          });
          console.log(`Cleaned up previous technician: ${oldAssetDoc.empId}`);
        }
      }
    }

    if (currentEditAssetId) {
      // üîÅ UPDATE
      await updateDoc(doc(db, COLL_ASSETS, currentEditAssetId), data);
      await addDoc(collection(db, COLL_ASSET_LOGS), {
        parentId: currentEditAssetId,
        type: "UPDATE",
        message: "Asset updated",
        user: `${state.me.username} (${state.me.role})`,
        timestamp: serverTimestamp()
      });

      alert("Asset updated successfully");
    } else {
      // ‚ûï ADD
      const ref = await addDoc(collection(db, COLL_ASSETS), data);
      await addDoc(collection(db, COLL_ASSET_LOGS), {
        parentId: ref.id,
        type: "CREATE",
        message: "Asset created",
        user: `${state.me.username} (${state.me.role})`,
        timestamp: serverTimestamp()
      });

      alert("Asset added successfully");
    }

// 2. REFLECT CHANGES IN DRIVER/OPERATOR TABLE [Your Requirement]
    if (data.empId) {
      // Find the technician in the local state by Employee ID
      const tech = state.drivers.find(d => d.empId === data.empId);
      
      if (tech) {
        // Find the Project ID to create the "Project Name (ID)" string
        const projectObj = state.projects.find(p => p.p_name === data.project);
        const projectWithId = projectObj ? `${data.project} (${projectObj.p_id})` : data.project;

        const techRef = doc(db, COLL_DRIVERS, tech.id);
        await updateDoc(techRef, {
          project: projectWithId,   // Project name with ID
          vehicleNo: data.vmNo,     // From Asset VM No
          assetCode: data.assetNo,  // From Asset No
          status: "Active",         // Set to Active automatically
          leaveSince: "",           // Clear Resigned/Leave date
          leaveTill: ""             // Clear Leave Till date
        });
        console.log(`Technician ${data.empId} updated automatically.`);
      }
    }

    resetAssetForm();
    closeAssetModal();
    currentEditAssetId = null;

  } catch (err) {
    console.error(err);
    alert("Error saving asset");
  }
finally {
    hideLoader();
  }
};



function prepareDateInput(id, value) {
  const el = document.getElementById(id);
  if (value) {
    el.type = el.id.includes('Time') || el.id.includes('from') || el.id.includes('till') ? 'datetime-local' : 'date';
    el.value = value;
  } else {
    el.type = 'text';
    el.value = '';
  }
}
// 2. Load from Firebase
async function loadProjects() {
// FIND THIS SECTION IN YOUR CODE:
unsubscribeProjects = onSnapshot(collection(db, COLL_PROJECTS), (snap) => {
  state.projects = snap.docs.map(d => ({ id: d.id, ...d.data() }));

  // FIX: Populate the "Add Asset" Dropdown
  const aProjSelect = document.getElementById('a_project');
  if (aProjSelect) {
    aProjSelect.innerHTML = '<option value="">Select Project</option>'; // Reset
    state.projects.forEach(proj => {
      const opt = document.createElement('option');
      // Use the exact field names from your Projects collection
      const pName = proj.p_name || "Unknown";
      const pId = proj.p_id || "";
      
      opt.value = pName; 
      opt.textContent = pId ? `${pId} - ${pName}` : pName;
      aProjSelect.appendChild(opt);
    });
  }

  renderProjTable();
  updateProjectDropdowns();
fillProjectDD("a_projectDD");
fillProjectDD("driverProjectDD");

});
}

function fillProjectDD(id) {
  const list = document.querySelector(`#${id} .list`);
  if (!list) return;

  list.innerHTML = "";

  state.projects.forEach(p => {
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = `${p.p_id} - ${p.p_name}`;
    div.onclick = () => setDD(id, p.p_name, div.textContent);
    list.appendChild(div);
  });
}


function updateProjectDropdowns() {
  const filterDropdown = $('#fProject');    // The search filter
  const addFormDropdown = $('#fProjectVal'); // The add driver form
  const editFormDropdown = $('#e_project');  // The edit driver modal

  const optionsHtml = state.projects
    .map(p => {
      const displayString = `${p.p_name} (${p.p_id})`; // Format: Project A (PRJ001)
      return `<option value="${p.p_name}">${displayString}</option>`;
    })
    .join('');

  if (filterDropdown) filterDropdown.innerHTML = '<option value="">All Projects</option>' + optionsHtml;
  if (addFormDropdown) addFormDropdown.innerHTML = '<option value="">Select Project</option>' + optionsHtml;
  if (editFormDropdown) editFormDropdown.innerHTML = '<option value="">Select Project</option>' + optionsHtml;
}
// 3. Filters and Rendering
window.applyProjFilters = function() {
  const term = $('#projSearch').value.toLowerCase();
  const stat = $('#fProjStatus').value;
  state.projPageSize = parseInt($('#projPageSize').value);

  state.projFiltered = state.projects.filter(p => {
    const matchSearch = (p.p_name||'').toLowerCase().includes(term) || (p.p_id||'').toLowerCase().includes(term);
    const matchStatus = !stat || p.status === stat;
    return matchSearch && matchStatus;
  });

  state.projTotalPages = Math.max(1, Math.ceil(state.projFiltered.length / state.projPageSize));
  renderProjTable();
};

function renderProjTable() {
  const tbody = $('#projTbody');
  tbody.innerHTML = '';

  const start = (state.projPage - 1) * state.projPageSize;
  const end = start + state.projPageSize;
  const paged = state.projFiltered.slice(start, end);

  paged.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="font-weight:bold; color:var(--brand);">${p.p_id || ''}</td>
      <td>${p.p_name || ''}</td>
      <td>${p.p_loc || ''}</td>
      <td>${p.p_div || ''}</td>
      <td>${p.p_date || ''}</td>
      <td>
  <span class="badge ${(p.status || p.p_status) === 'Active' ? 'b-ok' : 'b-warn'}">
    ${p.status || p.p_status || 'N/A'}
  </span>
</td>
      <td>
        <button class="btn" onclick="editProject('${p.id}')">Edit</button>
        <button class="btn warn" style="margin-left:5px" onclick="deleteProject('${p.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  
  // Update pagination info
  const info = $('#projPageInfo');
  if(info) info.textContent = `Page ${state.projPage} of ${Math.ceil(state.projFiltered.length / state.projPageSize) || 1}`;
}

// 4. CRUD Operations
window.addProject = async function() {
  const data = {
    p_id: $('#p_id').value,
    p_name: $('#p_name').value,
    p_loc: $('#p_loc').value,
    p_div: $('#p_div').value,
    p_date: $('#p_date').value,
    status: $('#p_status').value,
    createdAt: serverTimestamp()
  };
  await addDoc(collection(db, COLL_PROJECTS), data);
  toast("Project Added!");
  // Clear inputs
  ['p_id','p_name','p_loc','p_div','p_date'].forEach(id => $(`#${id}`).value = '');
};

// 1. Function to open the Edit Card and fill it with data

window.editProject = function(id) {
  const p = state.projects.find(proj => proj.id === id);
  if (!p) return;

  state.editProjDocId = id;

  // Fill the pop-up inputs
  $('#ep_id').value = p.p_id || '';
  $('#ep_name').value = p.p_name || '';
  $('#ep_loc').value = p.p_loc || '';
  $('#ep_div').value = p.p_div || '';
  $('#ep_date').value = p.p_date || '';
  $('#ep_status').value = p.status || 'Active';

  // Show the Modal as a Pop-up
  const modal = $('#projectEditModal');
  modal.style.display = 'flex'; 
};

window.closeProjEdit = function() {
  $('#projectEditModal').style.display = 'none';
  state.editProjDocId = null;
};

window.saveProjUpdate = async function() {
  if (!state.editProjDocId) return;

  const data = {
    p_id: $('#ep_id').value,
    p_name: $('#ep_name').value,
    p_loc: $('#ep_loc').value,
    p_div: $('#ep_div').value,
    p_date: $('#ep_date').value,
    status: $('#ep_status').value
  };

  try {
    showLoader();
    await updateDoc(doc(db, COLL_PROJECTS, state.editProjDocId), data);
    toast("‚úÖ Project updated successfully!");
    closeProjEdit(); // Close the pop-up
  } catch (err) {
    console.error("Update Error:", err);
    toast("‚ùå Update Failed");
  } finally {
    hideLoader();
  }
};


window.deleteProject = async function(id) {
  if (!confirm("Are you sure you want to delete this project?")) return;
  try {
    showLoader();
    await deleteDoc(doc(db, COLL_PROJECTS, id));
    toast("üóëÔ∏è Project deleted");
  } catch (err) {
    toast("‚ùå Delete failed");
  } finally {
    hideLoader();
  }
};

window.gotoProjPage = (p) => {
  if(p < 1 || p > state.projTotalPages) return;
  state.projPage = p;
  renderProjTable();
};

window.exportProjExcel = function() {
  const data = state.projFiltered.map(p => ({
    "Project ID": p.p_id,
    "Project Name": p.p_name,
    "Location": p.p_loc,
    "Division": p.p_div,
    "Creation Date": p.p_date,
    "Status": p.status
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Projects");
  XLSX.writeFile(wb, "Projects_List.xlsx");
};
function updateDriverProjectDropdown() {
  const select = $('#fProjectVal');
  if (!select) return;

  const currentVal = select.value;
  select.innerHTML = '<option value="">Select Project</option>';

  state.projects
    .filter(p => p.p_status === 'Active') // Use p_status
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.p_name;
      // UPDATED: Show Name (ID)
      opt.textContent = `${p.p_name} (${p.p_id})`; 
      select.appendChild(opt);
    });
    
  if(currentVal) select.value = currentVal;
}
function updateDriverFilterDropdown() {
  const filterSelect = $('#fProject');
  if (!filterSelect) return;

  // Preserve the current selection if the user already picked a project
  const currentFilterVal = filterSelect.value;
  
  // Clear and add the default "All Projects"
  filterSelect.innerHTML = '<option value="">All Projects</option>';

  // Sort projects alphabetically and add them
  state.projects
    .filter(p => p.status === 'Active') // Optional: Only show Active projects in filter
    .sort((a, b) => (a.p_name || "").localeCompare(b.p_name || ""))
    .forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.p_name;
      opt.textContent = p.p_name;
      filterSelect.appendChild(opt);
    });

  // Restore previous value
  filterSelect.value = currentFilterVal;
}
// --- LISTEN FOR ASSETS ---
function listenToAssets() {
  // Reference the 'assets' collection
  const q = query(collection(db, "assets"), orderBy("updatedAt", "desc"));
  
  onSnapshot(q, (snapshot) => {
    // 1. Update the state.assets array with real data from Firebase
    state.assets = snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data()
    }));
    
    // 2. Refresh the project dropdowns inside the Asset Modal
    //updateAssetProjectOptions(); 
    
    // 3. Re-run filters and redraw the table
    if (typeof applyAssetFilters === 'function') {
      applyAssetFilters(); 
    } else {
      renderTablePage();
    }
  }, (error) => {
    console.error("Asset listener error:", error);
  });
}
window.applyAssetFilters = function() {
  const search = document.getElementById('assetSearch').value.toLowerCase();
  const cat = document.getElementById('fAssetCat').value;
  const proj = document.getElementById('fAssetProject').value;

  state.filteredAssets = state.assets.filter(a => {
    const matchesSearch = (a.vmNo?.toLowerCase().includes(search) || a.assetNo?.toLowerCase().includes(search));
    const matchesCat = !cat || a.category === cat;
    const matchesProj = !proj || a.project === proj;
    return matchesSearch && matchesCat && matchesProj;
  });

  state.assetPage = 1;
  state.assetTotalPages = Math.max(1, Math.ceil(state.filteredAssets.length / state.pageSize));
  renderAssetTable();
};

// Add this to update the page numbers at the bottom
function updateAssetPagination() {
  const info = document.getElementById('assetPageInfo'); // Ensure this ID exists in your HTML pagination
  if(info) info.textContent = `Page ${state.assetPage} of ${state.assetTotalPages}`;
}


/* --- Inside your deleteAsset function --- */

async function deleteAsset(docId) {
  if (!confirm("Are you sure?")) return;
  
  showLoader(); 
  try {
    const docRef = doc(db, COLL_ASSETS, docId);
    await deleteDoc(docRef);
    
    hideLoader(); // Hide loader before the alert
    alert("Asset deleted successfully");
  } catch (err) {
    hideLoader();
    alert("Error: " + err.message);
  }
}
window.deleteAsset = deleteAsset; // This fixes the 'not defined' error

// Helper function to reset the form for "Best Results" and clean UI
function resetAssetForm() {
  document.querySelector('#assetModal h3').textContent = "Add New Asset";
  currentEditAssetId = null;
  document.querySelectorAll('#assetModal input, #assetModal textarea').forEach(i => i.value = '');
  document.getElementById('a_userDD').dataset.value = '';
  document.getElementById('a_projectDD').dataset.value = '';
  document.querySelector('#a_userDD .selected').textContent = 'Select User (ID - Name)';
  document.querySelector('#a_projectDD .selected').textContent = 'Select Project';
}


window.closeAssetModal = function() {
  document.getElementById('assetModal').style.display = 'none';
resetAssetForm();
}






function deriveAnnualLeaveList(){
  state.annualLeaveOver6M = state.drivers.filter(d => {
    if(d.status !== "On Leave") return false;

    const leaveSince = d.leaveSince ? new Date(d.leaveSince) : null; // "Leave Since/ Resigned Date"
    const leaveTill  = d.leaveTill ? new Date(d.leaveTill) : null;
    const today = new Date();
const grace = 10 * 24 * 60 * 60 * 1000; // 10 days in ms

    let category = "";
    let overstayDays = 0;

    // 1) If > 6 months since leaveSince
    if (leaveSince && (today - leaveSince) > (180*24*60*60*1000)) {
      category = "Leave > 6 Months";
      if (leaveTill) {
        overstayDays = Math.max(0, Math.floor((today - leaveTill) / (1000*60*60*24)));
      }
    }
    // 2) Otherwise, if overstayed beyond leaveTill
 else if (leaveTill && today > new Date(leaveTill.getTime() + grace)) {
        category = "Overstay";
        overstayDays = Math.floor(
          (today - leaveTill.getTime()) / (1000 * 60 * 60 * 24)
        );
      }
    else {
      return false; // Not included
    }

    d.category = category;
    d.overstayDays = overstayDays;
    return true;
  });
}


function updateDriverCache(){
  localStorage.setItem("driversCache", JSON.stringify({
    timestamp: Date.now(),
    data: state.drivers
  }));
}

function refreshAll(){
  renderDashboard();
  updateDashboardCounts();   // ‚¨ÖÔ∏è add here
  applyFilters();
}

function updateDashboardCounts() {
  const all = state.drivers || [];

  const drivers = all.filter(isDriver);
  const operators = all.filter(isOperator);

  const totalDrivers = drivers.length;
  const activeDrivers = drivers.filter(d => d.status === "Active").length;

  const totalOperators = operators.length;
  const activeOperators = operators.filter(d => d.status === "Active").length;

  const onLeave = all.filter(d => d.status === "On Leave").length;
  const resigned = all.filter(d => d.status === "Resigned").length;

  $('#totalDrivers').textContent = totalDrivers;
  $('#activeDrivers').textContent = `Active: ${activeDrivers}`;
  $('#totalOperators').textContent = totalOperators;
  $('#activeOperators').textContent = `Active: ${activeOperators}`;
  $('#onLeave').textContent = onLeave;
  $('#resigned').textContent = resigned;
}


// Disable/enable leaveSince based on status
$('#status').addEventListener('change', function () {
  const status = this.value;
  const returned = $('#leaveSince');

  if (status === 'Active') {
    returned.disabled = true;
    returned.value = '';
  } 
  else if (status === 'Resigned') {
    returned.disabled = false;   // only leaveSince

  } 
  else {
    returned.disabled = false;
  }
});
// Disable/enable leaveSince & leaveTill in EDIT modal
$('#e_status').addEventListener('change', function () {
  const status = this.value;
  const returned = $('#e_leaveSince');
  const leaveTill = $('#e_leaveTill');

  if (status === 'Active') {
    returned.disabled = true;
    leaveTill.disabled = true;
    returned.value = '';
    leaveTill.value = '';
  } else if (status === 'Resigned') {
    returned.disabled = false;   // only leaveSince allowed
    leaveTill.disabled = true;
    leaveTill.value = '';
  } else {
    returned.disabled = false;
    leaveTill.disabled = false;
  }
});

// run once on page load so defaults apply
window.addEventListener('load', () => {
  $('#status').dispatchEvent(new Event('change'));
});


function showLoader() {
  const el = document.getElementById('loaderOverlay');
  el.style.display = 'flex';
  // auto-hide after 20s in case something hangs
  setTimeout(() => hideLoader(), 20000);
}

function hideLoader() {
  const loader = document.getElementById("loaderOverlay");
  if (loader) loader.style.display = "none";
}


/* ------------- Add / Edit / Delete (respect role permissions) ----------- */

async function addEntry() {
  /*if ((state.me?.role || '').toLowerCase() === 'viewer'){ toast('Viewers cannot add'); return; }*/

  try {
    showLoader();

    // 1. Safely grab values using Optional Chaining (?.) to prevent "null" errors
    const empId = $('#empId')?.value.trim();
    const name = $('#name')?.value.trim();
    const designation = $('#designation')?.value;
    project: document.getElementById("driverProjectDD").dataset.value;
    const vehicleNo = $('#vehicleNo')?.value.trim();
    const assetCode = $('#assetCode')?.value.trim();
    const contact = $('#contact')?.value.trim();
    const joiningDate = $('#joiningDate')?.value;
    const leaveSince = $('#leaveSince')?.value;
    const leaveTill = $('#leaveTill')?.value; // Matches the new field
    const status = $('#status')?.value;
    const remarks = $('#remarks')?.value.trim();

    // 2. Validation
    if (leaveSince && joiningDate && new Date(leaveSince) <= new Date(joiningDate)) {
      toast("‚ùå Returned Date must be later than Provided Date");
      return;
    }

    if (!empId || !name || !designation || !project || !vehicleNo || !joiningDate) {
      toast('Please fill all required fields (ID, Name, Desig, Project, Vehicle, Date)');
      return;
    }

    // 3. Prepare Payload
    let payload = {
      empId, name, designation, project, vehicleNo,
      assetCode, contact,
      joiningDate, leaveSince, status, remarks,
      createdAt: serverTimestamp(),
      invalids: {
        contact: typeof validContact === 'function' ? !validContact(contact) : false,
        assetCode: typeof validassetCode === 'function' ? !validassetCode(assetCode) : false
      },
      leaveSince: leaveSince || null,
      leaveTill: leaveTill || null,
      returnedOnTime: false
    };

    // Auto-cleaning logic based on status
    if (status === "Active") {
      payload.leaveSince = null;
      payload.leaveTill = null;
    } else if (status === "Resigned") {
      payload.leaveTill = null;
    }
const shift = document.getElementById('shift').value;
    // 4. Add to Firestore
    const docRef = await addDoc(collection(db, COLL_DRIVERS), payload);
    
    // Log change
    if (typeof logStatusChange === 'function') {
      await logStatusChange(docRef.id, status, remarks);
    }

 

    // 6. üõ†Ô∏è FIXED: Safe Clear Form Logic
    // This list includes all text/date inputs
    const fieldsToClear = [
      'empId', 'name', 'vehicleNo', 'assetCode', 'contact', 
      'joiningDate', 'leaveSince', 'leaveTill', 'remarks'
    ];

    fieldsToClear.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.value = ''; // Only sets value if element exists
    });

    // Reset dropdowns specifically by ID
    if ($('#designation')) $('#designation').value = '';
    if ($('#fProjectVal')) $('#fProjectVal').value = '';
    if ($('#status')) $('#status').value = 'Active';

    toast('‚úÖ Driver added successfully');

  } catch (err) {
    console.error("Add error:", err);
    toast("‚ùå Failed to add driver. Check console for details.");
  } finally {
    hideLoader();
  }
}

window.addEntry = addEntry;

function openEdit(ix){
  const d = state.filtered[ix]; if(!d) return;
  state.editIndex = ix;
  state.editDocId = d.id;
  $('#e_empId').value = d.empId||'';
  $('#e_name').value = d.name||'';
  $('#e_designation').value = d.designation||'Heavy Duty Driver';
  $('#e_project').value = d.project||'Creation';
$('#e_vehicleNo').value = d.vehicleNo;
$('#e_assetCode').value = d.assetCode;
  $('#e_contact').value = d.contact||'';
$('#e_joiningDate').value = d.joiningDate;
$('#e_leaveSince').value = d.leaveSince;
$('#e_leaveTill').value = d.leaveTill || '';
  $('#e_status').value = d.status||'Active';
  $('#e_remarks').value = d.remarks||'';
  $('#editModal').style.display='flex';
$('#e_status').dispatchEvent(new Event('change'));

}
window.openEdit = openEdit;

function closeEdit(){ $('#editModal').style.display='none'; state.editIndex=null; state.editDocId=null; }
window.closeEdit = closeEdit;

function normalizeDate(v){
  if (!v) return '';
  if (v instanceof Date) return v.toISOString().slice(0,10); // Excel date
  if (typeof v === 'number') return XLSX.SSF.format("yyyy-mm-dd", v); // numeric Excel date
  return String(v).slice(0,10); // already string
}


async function saveEdit(){
 /* if(state.me?.role==='Viewer'){ toast('Viewers cannot edit'); return; }*/


try {
    showLoader();
  const id = state.editDocId;
  if (!id) { toast('No record selected'); return; }

  const joiningDate = $('#e_joiningDate').value;
  const leaveSince = $('#e_leaveSince').value;
  const leaveTill    = $('#e_leaveTill').value;

  let status = $('#e_status').value;

  const prev = state.drivers.find(d => d.id === id);  // ‚¨ÖÔ∏è get previous doc

  const rec = {
    empId: $('#e_empId').value.trim(),
    name: $('#e_name').value.trim(),
    designation: $('#e_designation').value,
    project: $('#e_project').value,
 vehicleNo: $('#e_vehicleNo').value,
  assetCode: $('#e_assetCode').value,
    contact: $('#e_contact').value.trim(),
    joiningDate: $('#e_joiningDate').value,
  leaveSince: $('#e_leaveSince').value,
    leaveTill: $('#e_leaveTill').value || null,
    status,
    remarks: $('#e_remarks').value.trim(),
    invalids: {
      contact: !validContact($('#e_contact').value.trim()),
      assetCode:  !validassetCode($('#e_assetCode').value.trim())
    },
    returnedOnTime: prev?.returnedOnTime || false   // ‚¨Ö keep previous unless updated
  };

if (leaveSince && joiningDate && new Date(leaveSince) <= new Date(joiningDate)) {
    toast("‚ùå Returned Date must be later than Provided Date");
    return;
  }
  if (leaveTill) {
    if (joiningDate && new Date(leaveTill) <= new Date(joiningDate)) {
      toast("‚ùå Leave Till must be later than Provided Date");
      return;
    }
    if (leaveSince && new Date(leaveTill) <= new Date(leaveSince)) {
      toast("‚ùå Leave Till must be later than Returned Date");
      return;
    }
  }

  // üîë Reset fields based on status
  if (status === "Active") {
    // check if returning from On Leave and leaveTill still valid
    if (prev?.status === "On Leave" && prev.leaveTill) {
      const leaveTillDate = new Date(prev.leaveTill);
const grace = 10 * 24 * 60 * 60 * 1000; // 10 days in ms
if (new Date() <= new Date(leaveTillDate.getTime() + grace)) {
  rec.returnedOnTime = true;  // within grace period = on time
}

    }
    rec.leaveSince = null;
    rec.leaveTill = null;
  }
  else if (status === "Resigned") {
    rec.leaveTill = null; // keep only leaveSince
  }

  await updateDoc(doc(db, COLL_DRIVERS, id), rec);
if (prev?.status !== status) {
  await logStatusChange(id, status, rec.remarks);
}


  const idx = state.drivers.findIndex(d => d.id === id);
  if (idx !== -1) state.drivers[idx] = { ...state.drivers[idx], ...rec };

  deriveAnnualLeaveList();
  updateDriverCache();
  renderAL6M();
  refreshAll();

  closeEdit();
  toast('Driver updated');
}catch (err) {
    console.error("Edit error:", err);
    toast("‚ùå Failed to update driver");
  } finally {
    hideLoader();
  }
}

window.saveEdit = saveEdit;

/* -----------------------  Log Status Function -------------------- */

async function logStatusChange(driverId, newStatus, remarks="") {
  await addDoc(collection(db, COLL_DRIVERS, driverId, "logs"), {
    status: newStatus,
    remarks,
    changedAt: serverTimestamp(),
    changedBy: state.me?.username || "system"
  });
}

/* -----------------------  open Function -------------------- */
async function openLogs(driverId, driverName) {
console.log("Opening logs for", driverId, driverName);
const container = document.getElementById("logsTimeline");
container.innerHTML = `<div style="text-align:center;padding:20px;">
  <span style="font-size:14px;color:#475569;">‚è≥ Please wait, loading logs...</span>
</div>`;
document.getElementById("logsModal").style.display = "flex";
state.currentLogDriver = { id: driverId, name: driverName }; // <-- added

  const qSnap = await getDocs(
    query(
      collection(db, COLL_DRIVERS, driverId, "logs"),
      orderBy("changedAt", "asc")
    )
  );

  //const container = document.getElementById("logsTimeline");
  container.innerHTML = `<h4>${driverName}</h4><ul style="list-style:none;padding:0;">`;

  qSnap.forEach(doc => {
    const d = doc.data();
    const date = d.changedAt?.toDate().toLocaleString() || "";
    const color = d.status === "Active" ? "green"
                : d.status === "On Leave" ? "orange"
                : d.status === "Resigned" ? "red"
                : d.status === "Transfer" ? "blue"
                : "gray";

    container.innerHTML += `
      <li style="margin:8px 0; padding:8px; border-left:4px solid ${color}; background:#f9fafb; border-radius:6px;">
        <b style="color:${color}">${d.status}</b> 
        <small>(${date} by ${d.changedBy})</small><br>
        <i>${d.remarks || ""}</i>
      </li>`;
  });
  container.innerHTML += "</ul>";

  document.getElementById("logsModal").style.display = "flex";
}

function closeLogs() {
  const modal = document.getElementById("logsModal");
  modal.style.display = "none";
}
window.closeLogs = closeLogs;


/* ----------------------- Remove Row Function -------------------- */

async function removeRow(ix) {
  if (!confirm("Are you sure you want to delete this record?")) return;

  const d = state.filtered[ix];
  if (!d) return;

  try {
    // Delete from Firestore
    await deleteDoc(doc(db, COLL_DRIVERS, d.id));

    // Remove from local state
    state.drivers = state.drivers.filter(item => item.id !== d.id);

    deriveAnnualLeaveList();   // recalc overstay list
    updateDriverCache();       // update cache
    renderAL6M();
    refreshAll();

    toast("Driver deleted successfully");
  } catch (err) {
    console.error("Delete failed", err);
    toast("‚ùå Failed to delete: " + err.message);
  }
}
window.removeRow = removeRow;

/* ----------------------- hard refresh -------------------- */

window.hardRefresh = async function(){
  localStorage.removeItem("driversCache");
  // Force one-time server fetch (snapshot will also refresh anyway)
  const snap = await getDocs(collection(db, COLL_DRIVERS));
  const arr = snap.docs.map(d=>({ id: d.id, ...d.data() }));
  arr.sort((a,b)=>{
    const ta = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
    const tb = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
    return tb - ta;
  });
  state.drivers = arr;
  deriveAnnualLeaveList();
  updateDriverCache();
  refreshAll();
  toast('Data refreshed from server');
};

/* ----------------------- Filters, Table & Pagination -------------------- */
function applyFilters() {
  const term = ($('#search')?.value || '').toLowerCase();
  const desg = $('#fDesignation')?.value || '';
  const proj = $('#fProject')?.value || ''; // Get the project filter value
  const stat = $('#fStatus')?.value || '';

  state.filtered = state.drivers.filter(d => {
const pObj = state.projects.find(p => p.p_name === d.project);
    const pId = pObj ? pObj.p_id.toLowerCase() : '';
    const mSearch = (d.name||'').toLowerCase().includes(term) || (d.empId||'').toLowerCase().includes(term);
    const mDesg   = !desg || d.designation === desg;
    const mProj   = !proj || d.project === proj; // Match the project field
    const mStat   = !stat || d.status === stat;
    return mSearch && mDesg && mProj && mStat;
  });

  state.page = 1;
  state.totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
  renderTablePage();
}
window.applyFilters = applyFilters;

function gotoPage(p){
  state.page = Math.min(Math.max(1, p), state.totalPages);
  renderTablePage();
}

window.gotoPage = gotoPage;


function renderTablePage() {
  const start = (state.page - 1) * state.pageSize;
  const rows = state.filtered.slice(start, start + state.pageSize);
  const tbody = $('#tbody');
  tbody.innerHTML = '';

  rows.forEach((d, idx) => {
    // 1. Move the lookup INSIDE the loop so 'd' is defined
    const projectObj = state.projects.find(proj => proj.p_name === d.project);
    const projectDisplay = projectObj ? `${d.project} (${projectObj.p_id})` : (d.project || 'N/A');

    const gi = start + idx;
    const tr = document.createElement('tr');
    
    tr.oncontextmenu = (e) => {
      e.preventDefault(); 
      openLogs(d.id, d.name);
    };

    tr.innerHTML = `
      <td>${d.empId || ''}</td>
      <td>${d.name || ''}</td>
      <td>${d.designation || ''}</td>
      <td>${projectDisplay}</td> <td>${d.vehicleNo || ''}</td>
      <td>${d.assetCode || ''}</td>
      <td>${d.contact || ''}</td>
      <td>${d.joiningDate || ''}</td>
      <td>${d.leaveSince || ''}</td>
      <td>${d.leaveTill || ''}</td>
      <td>${d.status || ''}</td>
      <td>${d.remarks || ''}</td>
      <td>
        ${
          state.me?.role === 'Viewer'
            ? `<button class="page-btn" onclick="openEdit(${gi})">Edit</button>`
            : `
              <button class="page-btn" onclick="openEdit(${gi})">Edit</button>
              <button class="btn warn" style="padding: 2px 8px;" onclick="removeRow(${gi})">Delete</button>
            `
        }
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Update pagination info
  $('#pageInfo').textContent = `Page ${state.page} of ${state.totalPages} ‚Äî ${state.filtered.length} rows`;

  // Enable/disable buttons
  $('#prevBtn').disabled = state.page <= 1;
  $('#nextBtn').disabled = state.page >= state.totalPages;
}

window.renderAssetTable = function() {
  const tbody = document.getElementById('assetTbody');
  tbody.innerHTML = '';

  // Get current page slice from filtered assets
  const start = (state.assetPage - 1) * state.pageSize;
  const end = start + state.pageSize;
  const pageData = state.filteredAssets.slice(start, end);

  pageData.forEach(asset => {
    // LOOKUP: Find the project details from the state.projects list
    const projectObj = state.projects.find(p => p.p_name === asset.project);
    
    // FORMAT: Show "Project Name (ID)" or just Name if ID isn't found
    const projectDisplay = projectObj 
      ? `${asset.project} (${projectObj.p_id})` 
      : (asset.project || '‚Äî');
let userDisplay = '';
    if (asset.empId && asset.name) {
      userDisplay = `${asset.empId} - ${asset.name}`;
    } else {
      userDisplay = asset.empId || asset.name || '‚Äî';
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
<td>${asset.vmNo || ''}</td>
      <td>${asset.assetNo || ''}</td>
      <td>${asset.category || ''}</td>
      <td style="font-weight:500;">${userDisplay}</td> 
	<td>${asset.designation || ''}</td>
      <td>${asset.contact || ''}</td>
      <td style="font-weight:600; color:var(--brand);">${projectDisplay}</td>
      <td>${asset.regNo || ''}</td>
      <td>${asset.regExp || ''}</td>
      <td>${asset.from || ''}</td>
      <td>${asset.till || ''}</td>
<td><span class="badge">${asset.status || 'N/A'}</span></td>
  <td>${asset.shift || '-'}</td>
      <td>${asset.remarks || ''}</td>
      <td>
        <button class="btn info" onclick="editAsset('${asset.id}')" style="padding:4px 8px; font-size:12px;">Edit</button>
        <button class="btn warn" onclick="deleteAsset('${asset.id}')" style="padding:4px 8px; font-size:12px;">Del</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Update Pagination Info for Assets
  updateAssetPagination();
};

/* ------------------------------ Import/Export --------------------------- */
// Import: allow invalids, mark bad cells (contact/assetCode), include project

window.importExcel = function(){
  const file = $('#excelFile').files[0];
  if(!file){ toast('Choose an Excel file first'); return; }
  const reader = new FileReader();
  reader.onload = async (e)=>{
    try{
      const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws);
      let added = 0;

      // Header mapping (expects same names as earlier build; project added)
      // "Employee ID","Proper Name","Designation","Project","Plate No","Asset No","Contact Number","Joining Date","Driver Status","Remarks"
      for(const r of rows){
        const empId  = r['Employee ID'] || '';
        const name   = r['Proper Name'] || '';
        const designation = r['Designation'] || '';
        const project = r['Project'] || '';
        const vehicleNo= r['Vehicle No'] || '';
        const assetCode = r['Asset No'] || '';
        const contact= r['Contact Number'] || '';
const joiningDate = normalizeDate(r['Joining Date']);
const leaveSince = normalizeDate(r['Leave Since/ Resigned Date']);
const leaveTill    = normalizeDate(r['Leave Till']);
        const status = r['Driver Status'] || '';
        const remarks= r['Remarks'] || '';

        const invalids = { contact: !validContact(contact), assetCode: !validassetCode(assetCode) };
        const payload = {
          empId,name,designation,project,vehicleNo,assetCode,contact,joiningDate,status,remarks,
          invalids,
          createdAt: serverTimestamp(),
          leaveSince: status==='On Leave' ? (new Date()).toISOString().slice(0,10) : null,
	leaveSince: leaveSince || null,

        };
if (status === "Active") {
  payload.leaveSince = null;
  payload.leaveTill = null;
}
else if (status === "Resigned") {
  payload.leaveTill = null; // keep only leaveSince
}


await addDoc(collection(db, COLL_DRIVERS), payload);
        added++;
      }
//Realtime Listener will bring the latest in; cashe will be updated there

      toast(`Import finished: ${added} rows added`);
    }catch(err){ toast('Failed to read Excel: '+err.message); }

  };
  reader.readAsArrayBuffer(file);
};

// Export current filtered to Excel
window.exportExcel = function(){
  const ws = XLSX.utils.json_to_sheet(state.filtered.map(d=>({
    "Employee ID": d.empId,
    "Proper Name": d.name,
    "Designation": d.designation,
    "Project": d.project,
    "Plate No": d.vehicleNo,
    "Asset No": d.assetCode,
    "Contact Number": d.contact,
    "Joining Date": d.joiningDate,
"Leave Since/ Resigned Date": d.leaveSince || "",
"Leave Till": d.leaveTill || "",
    "Driver Status": d.status,
    "Remarks": d.remarks
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "TouchKeys");
  XLSX.writeFile(wb, "touchkeys.xlsx");
};

// Export filtered to PDF
window.exportPDF = function(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'l', unit:'pt', format:'a4'});
  doc.setFontSize(14);
  doc.text("TouchKey - Driver/Operator List", 40, 34);
  const body = state.filtered.map(d=>[
    d.empId,d.name,d.designation,d.project,d.vehicleNo,d.assetCode,d.contact,d.joiningDate,d.leaveSince || "",d.leaveTill || "",d.status,d.remarks
  ]);
  doc.autoTable({
    startY: 50,
    head:[["Emp ID","Name","Designation","Project","TouchKey","assetCode","Contact","Joining Date","Leave Since/ Resigned Date/ Resigned Date","Leave Till","Status","Remarks"]],
    body,
    styles:{fontSize:9,cellPadding:4}
  });
  doc.save("touchkeys.pdf");
};

// Export On Leave > 6 months to Excel
window.exportAL6mExcel = function(){
  const ws = XLSX.utils.json_to_sheet(state.annualLeaveOver6M.map(d=>({
    "Employee ID": d.empId,
    "Name": d.name,
    "Designation": d.designation,
    "Project": d.project,
    "TouchKey": d.vehicleNo,
    "assetCode": d.assetCode,
    "Contact": d.contact,
    "Joining Date": d.joiningDate,
    "Leave Since/ Resigned Date": d.leaveSince,
    "Leave Till": d.leaveTill,
    "Status": d.status,
    "Remarks": d.remarks,
    "Category": d.category,
    "Overstay Days": d.overstayDays
  })));
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "AnnualLeave>6m");
  XLSX.writeFile(wb, "annual_leave_over_6m.xlsx");
};

/* -------------------------------- exportLogsPDF ----------------------------- */

window.exportLogsPDF = function() {
  const { jsPDF } = window.jspdf;
  const container = document.getElementById("logsTimeline");
  if (!container || !container.innerHTML.trim()) {
    alert("‚ö†Ô∏è No logs to export");
    return;
  }

  // Driver details
  const drv = state.currentLogDriver || { id: "Unknown", name: "Unknown" };
  const driverName = drv.name || "Unknown";
  const driverId = drv.id || "Unknown";

  // Create PDF
  const doc = new jsPDF({ orientation: "p", unit: "pt", format: "a4" });
  doc.setFontSize(14);
  doc.text(`Driver Logs Report`, 40, 40);
  doc.setFontSize(12);
  doc.text(`Name: ${driverName}`, 40, 60);
  doc.text(`Employee ID: ${driverId}`, 40, 80);

  // Collect logs into rows
  const rows = [];
  container.querySelectorAll("li").forEach(li => {
    const status = li.querySelector("b")?.textContent || "";
    const details = li.querySelector("small")?.textContent || "";
    const remarks = li.querySelector("i")?.textContent || "";
    rows.push([status, details, remarks]);
  });

  // AutoTable
  doc.autoTable({
    startY: 100,
    head: [["Status", "Details", "Remarks"]],
    body: rows,
    styles: { fontSize: 10, cellPadding: 4 },
    headStyles: { fillColor: [30, 58, 138] }
  });

  // Save with driver name & ID in filename
  const safeName = driverName.replace(/\s+/g, "_");
  doc.save(`logs_${safeName}_${driverId}.pdf`);
};

/* -------------------------------- Dashboard ----------------------------- */
let driverChart, operatorChart, projectChart,leaveChart;

function countByStatus(arr){
  const map = {
    "Active":0, "On Leave":0, "Resigned":0, "Transfer":0,
    "IDLE":0, "Others...":0
  };
  arr.forEach(d=>{ if(map[d.status]!=null) map[d.status]++; });
  return map;
}
function countByProject(arr){
  const map = {"Creation":0,"Gatex":0,"Samtech":0,"":0};
  arr.forEach(d=>{
    const v = (d.project||'').trim();
    if(map[v]==null) map[v]=0;
    map[v]++;
  });
  return map;
}

function renderDashboard(){
  const driversArr = state.drivers.filter(isDriver);
  const opsArr     = state.drivers.filter(isOperator);

  const DRV = countByStatus(driversArr);
  const OPR = countByStatus(opsArr);
  const VEN = countByProject(state.drivers);

let totalLeave = state.drivers.filter(d => d.status === "On Leave").length;
let returnedOnTime = state.drivers.filter(d => d.returnedOnTime).length;  // ‚¨Ö use flag
let overstay = state.annualLeaveOver6M.filter(d => d.category === "Overstay").length;
let leave6m  = state.annualLeaveOver6M.filter(d => d.category === "Leave > 6 Months").length;


  const LEAVE = {
    "Total On Leave": totalLeave,
    "Returned on Time": returnedOnTime,
    "Overstay": overstay,
    "Leave > 6 Months": leave6m
  };
  // KPIs
  $('#drv_total')?.replaceChildren?.(); // if you kept IDs in your earlier HTML (optional)
  // If you want live counters on cards like before, re-use those IDs; otherwise charts below suffice.

  // Destroy old charts (avoid overlay)
  if(driverChart) driverChart.destroy();
  if(operatorChart) operatorChart.destroy();
  if(projectChart) projectChart.destroy();
if(leaveChart) leaveChart.destroy();

  // Drivers status
  driverChart = new Chart($('#driverChart'), {
    type:'doughnut',
    data:{ labels:Object.keys(DRV), datasets:[{ data:Object.values(DRV) }] },
    options:{
      plugins:{ title:{display:true, text:'Drivers Status'} },
      onClick:(evt, els)=>{ if(els.length){ filterFromStatus('driver', Object.keys(DRV)[els[0].index]); } }
    }
  });

  // Operators status
  operatorChart = new Chart($('#operatorChart'), {
    type:'doughnut',
    data:{ labels:Object.keys(OPR), datasets:[{ data:Object.values(OPR) }] },
    options:{
      plugins:{ title:{display:true, text:'Operators Status'} },
      onClick:(evt, els)=>{ if(els.length){ filterFromStatus('operator', Object.keys(OPR)[els[0].index]); } }
    }
  });

  // Project distribution (full width below)
projectChart = new Chart($('#projectChart'), {
  type:'bar',
  data:{
    labels:Object.keys(VEN),
    datasets:[{
      label:'Project Status',
      data:Object.values(VEN),
      backgroundColor:['#2563eb','#16a34a','#f59e0b','#ef4444']  // optional colors
    }]
  },
  options:{
    plugins:{ title:{display:true, text:'Project Distribution'} },
    scales:{ y:{ beginAtZero:true } }
  }
});
// Leave distribution chart
leaveChart = new Chart($('#leaveChart'), {
  type:'bar',
  data:{
    labels:Object.keys(LEAVE),
    datasets:[{
      label:'Leave Analysis',
      data:Object.values(LEAVE),
      backgroundColor:['#2563eb','#16a34a','#f59e0b','#ef4444']
    }]
  },
  options:{
    plugins:{ title:{display:true, text:'Drivers Leave Analysis'} },
    scales:{ y:{ beginAtZero:true } }
  }
});

}

function filterFromStatus(role, status){
  nav('list');
  $('#fStatus').value = status;
  $('#fDesignation').value = '';
  $('#fProject').value = '';
  applyFilters();
  // Then further filter by role:
  state.filtered = state.filtered.filter(role==='driver' ? isDriver : isOperator);
  state.page=1;
  state.totalPages = Math.max(1, Math.ceil(state.filtered.length / state.pageSize));
  renderTablePage();
}

/*--------------------data Status------------------*/

function setDataStatus(text, color="#475569") {
  const el = document.getElementById("dataStatus");
  if (el) {
    el.textContent = text;
    el.style.color = color;
  }
}


/* --------------------------------- Init --------------------------------- */
function onLoad(){
  // restore page size
  const psSel = $('#pageSize');
  const savedPS = localStorage.getItem('pageSize_v2');
  if(savedPS){ psSel.value = savedPS; state.pageSize = parseInt(savedPS,10); }
  psSel.addEventListener('change', ()=>{ localStorage.setItem('pageSize_v2', psSel.value); });

  // If you want to keep a "logout" function ‚Äî optional
  // window.doLogout = function(){ location.reload(); };
listenToAssets();
}

window.addEventListener('load', onLoad);

/* Ensure SuperAdmin account exists once at startup */
await ensureDefaultSuperAdmin();


// Exporting functions to global scope so HTML onclick can find them
window.deleteAsset = deleteAsset;
window.openAssetModal = openAssetModal;
window.saveOrUpdateAsset = saveOrUpdateAsset;
window.closeAssetModal = closeAssetModal;
window.applyAssetFilters = applyAssetFilters;
</script> 
